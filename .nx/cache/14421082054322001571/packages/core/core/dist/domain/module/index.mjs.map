{"version":3,"file":"index.mjs","sources":["../../../src/domain/module/index.ts"],"sourcesContent":["import _, { type PropertyPath, flatten } from 'lodash';\r\nimport { yup } from '@strapi/utils';\r\nimport type { Core, UID, Struct } from '@strapi/types';\r\n\r\nimport { removeNamespace } from '../../registries/namespace';\r\nimport { validateModule } from './validation';\r\n\r\ninterface LifecyclesState {\r\n  bootstrap?: boolean;\r\n  register?: boolean;\r\n  destroy?: boolean;\r\n}\r\n\r\nexport interface RawModule {\r\n  config?: Record<string, unknown>;\r\n  routes?: Core.Module['routes'];\r\n  controllers?: Core.Module['controllers'];\r\n  services?: Core.Module['services'];\r\n  contentTypes?: Core.Module['contentTypes'];\r\n  policies?: Core.Module['policies'];\r\n  middlewares?: Core.Module['middlewares'];\r\n  bootstrap?: (params: { strapi: Core.Strapi }) => Promise<void>;\r\n  register?: (params: { strapi: Core.Strapi }) => Promise<void>;\r\n  destroy?: (params: { strapi: Core.Strapi }) => Promise<void>;\r\n}\r\n\r\nexport interface Module {\r\n  bootstrap: () => Promise<void>;\r\n  register: () => Promise<void>;\r\n  destroy: () => Promise<void>;\r\n  load: () => void;\r\n  routes: Core.Module['routes'];\r\n  config<T = unknown>(key: PropertyPath, defaultVal?: T): T; // TODO: this mirrors ConfigProvider.get, we should use it directly\r\n  contentType: (ctName: UID.ContentType) => Struct.ContentTypeSchema;\r\n  contentTypes: Record<string, Struct.ContentTypeSchema>;\r\n  service: (serviceName: UID.Service) => Core.Service;\r\n  services: Record<string, Core.Service>;\r\n  policy: (policyName: UID.Policy) => Core.Policy;\r\n  policies: Record<string, Core.Policy>;\r\n  middleware: (middlewareName: UID.Middleware) => Core.Middleware;\r\n  middlewares: Record<string, Core.Middleware>;\r\n  controller: (controllerName: UID.Controller) => Core.Controller;\r\n  controllers: Record<string, Core.Controller>;\r\n}\r\n\r\n// Removes the namespace from a map with keys prefixed with a namespace\r\nconst removeNamespacedKeys = <T extends Record<string, unknown>>(map: T, namespace: string) => {\r\n  return _.mapKeys(map, (value, key) => removeNamespace(key, namespace));\r\n};\r\n\r\nconst defaultModule = {\r\n  config: {},\r\n  routes: [],\r\n  controllers: {},\r\n  services: {},\r\n  contentTypes: {},\r\n  policies: {},\r\n  middlewares: {},\r\n};\r\n\r\nexport const createModule = (\r\n  namespace: string,\r\n  rawModule: RawModule,\r\n  strapi: Core.Strapi\r\n): Module => {\r\n  _.defaults(rawModule, defaultModule);\r\n\r\n  try {\r\n    validateModule(rawModule);\r\n  } catch (e) {\r\n    if (e instanceof yup.ValidationError) {\r\n      throw new Error(`strapi-server.js is invalid for '${namespace}'.\\n${e.errors.join('\\n')}`);\r\n    }\r\n  }\r\n\r\n  const called: LifecyclesState = {};\r\n  return {\r\n    async bootstrap() {\r\n      if (called.bootstrap) {\r\n        throw new Error(`Bootstrap for ${namespace} has already been called`);\r\n      }\r\n      called.bootstrap = true;\r\n      await (rawModule.bootstrap && rawModule.bootstrap({ strapi }));\r\n    },\r\n    async register() {\r\n      if (called.register) {\r\n        throw new Error(`Register for ${namespace} has already been called`);\r\n      }\r\n      called.register = true;\r\n      await (rawModule.register && rawModule.register({ strapi }));\r\n    },\r\n    async destroy() {\r\n      if (called.destroy) {\r\n        throw new Error(`Destroy for ${namespace} has already been called`);\r\n      }\r\n      called.destroy = true;\r\n      await (rawModule.destroy && rawModule.destroy({ strapi }));\r\n    },\r\n    load() {\r\n      strapi.get('content-types').add(namespace, rawModule.contentTypes);\r\n      strapi.get('services').add(namespace, rawModule.services);\r\n      strapi.get('policies').add(namespace, rawModule.policies);\r\n      strapi.get('middlewares').add(namespace, rawModule.middlewares);\r\n      strapi.get('controllers').add(namespace, rawModule.controllers);\r\n      strapi.get('config').set(namespace, rawModule.config);\r\n    },\r\n    get routes() {\r\n      return rawModule.routes ?? {};\r\n    },\r\n    config(path: PropertyPath, defaultValue: unknown) {\r\n      const pathArray = flatten([namespace, path]);\r\n      return strapi.get('config').get(pathArray, defaultValue);\r\n    },\r\n    contentType(ctName: UID.ContentType) {\r\n      return strapi.get('content-types').get(`${namespace}.${ctName}`);\r\n    },\r\n    get contentTypes() {\r\n      const contentTypes = strapi.get('content-types').getAll(namespace);\r\n      return removeNamespacedKeys(contentTypes, namespace);\r\n    },\r\n    service(serviceName: UID.Service) {\r\n      return strapi.get('services').get(`${namespace}.${serviceName}`);\r\n    },\r\n    get services() {\r\n      const services = strapi.get('services').getAll(namespace);\r\n      return removeNamespacedKeys(services, namespace);\r\n    },\r\n    policy(policyName: UID.Policy) {\r\n      return strapi.get('policies').get(`${namespace}.${policyName}`);\r\n    },\r\n    get policies() {\r\n      const policies = strapi.get('policies').getAll(namespace);\r\n      return removeNamespacedKeys(policies, namespace);\r\n    },\r\n    middleware(middlewareName: UID.Middleware) {\r\n      return strapi.get('middlewares').get(`${namespace}.${middlewareName}`);\r\n    },\r\n    get middlewares() {\r\n      const middlewares = strapi.get('middlewares').getAll(namespace);\r\n      return removeNamespacedKeys(middlewares, namespace);\r\n    },\r\n    controller(controllerName: UID.Controller) {\r\n      return strapi.get('controllers').get(`${namespace}.${controllerName}`);\r\n    },\r\n    get controllers() {\r\n      const controllers = strapi.get('controllers').getAll(namespace);\r\n      return removeNamespacedKeys(controllers, namespace);\r\n    },\r\n  };\r\n};\r\n"],"names":[],"mappings":"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"}