{"version":3,"file":"cors.mjs","sources":["../../src/middlewares/cors.ts"],"sourcesContent":["import koaCors from '@koa/cors';\r\n\r\nimport type { Core } from '@strapi/types';\r\n\r\nexport type Config = {\r\n  enabled?: boolean;\r\n  origin: string | string[] | ((ctx: any) => string | string[]);\r\n  expose?: string | string[];\r\n  maxAge?: number;\r\n  credentials?: boolean;\r\n  methods?: string | string[];\r\n  headers?: string | string[];\r\n  keepHeadersOnError?: boolean;\r\n};\r\n\r\nconst defaults: Config = {\r\n  origin: '*',\r\n  maxAge: 31536000,\r\n  credentials: true,\r\n  methods: ['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'HEAD', 'OPTIONS'],\r\n  headers: ['Content-Type', 'Authorization', 'Origin', 'Accept'],\r\n  keepHeadersOnError: false,\r\n};\r\n\r\nexport const cors: Core.MiddlewareFactory<Config> = (config) => {\r\n  const { origin, expose, maxAge, credentials, methods, headers, keepHeadersOnError } = {\r\n    ...defaults,\r\n    ...config,\r\n  };\r\n\r\n  if (config.enabled !== undefined) {\r\n    strapi.log.warn(\r\n      'The strapi::cors middleware no longer supports the `enabled` option. Using it' +\r\n        ' to conditionally enable CORS might cause an insecure default. To disable strapi::cors, remove it from' +\r\n        ' the exported array in config/middleware.js'\r\n    );\r\n  }\r\n\r\n  return koaCors({\r\n    async origin(ctx) {\r\n      if (!ctx.get('Origin')) {\r\n        return '*';\r\n      }\r\n\r\n      let originList: string | string[];\r\n\r\n      if (typeof origin === 'function') {\r\n        originList = await origin(ctx);\r\n      } else {\r\n        originList = origin;\r\n      }\r\n\r\n      if (Array.isArray(originList)) {\r\n        return originList.includes(ctx.get('Origin')) ? ctx.get('Origin') : '';\r\n      }\r\n\r\n      const parsedOrigin = originList.split(',').map((origin) => origin.trim());\r\n      if (parsedOrigin.length > 1) {\r\n        return parsedOrigin.includes(ctx.get('Origin')) ? ctx.get('Origin') : '';\r\n      }\r\n\r\n      return originList;\r\n    },\r\n    exposeHeaders: expose,\r\n    maxAge,\r\n    credentials,\r\n    allowMethods: methods,\r\n    allowHeaders: headers,\r\n    keepHeadersOnError,\r\n  });\r\n};\r\n"],"names":["origin"],"mappings":";AAeA,MAAM,WAAmB;AAAA,EACvB,QAAQ;AAAA,EACR,QAAQ;AAAA,EACR,aAAa;AAAA,EACb,SAAS,CAAC,OAAO,QAAQ,OAAO,SAAS,UAAU,QAAQ,SAAS;AAAA,EACpE,SAAS,CAAC,gBAAgB,iBAAiB,UAAU,QAAQ;AAAA,EAC7D,oBAAoB;AACtB;AAEa,MAAA,OAAuC,CAAC,WAAW;AACxD,QAAA,EAAE,QAAQ,QAAQ,QAAQ,aAAa,SAAS,SAAS,uBAAuB;AAAA,IACpF,GAAG;AAAA,IACH,GAAG;AAAA,EACL;AAEI,MAAA,OAAO,YAAY,QAAW;AAChC,WAAO,IAAI;AAAA,MACT;AAAA,IAGF;AAAA,EAAA;AAGF,SAAO,QAAQ;AAAA,IACb,MAAM,OAAO,KAAK;AAChB,UAAI,CAAC,IAAI,IAAI,QAAQ,GAAG;AACf,eAAA;AAAA,MAAA;AAGL,UAAA;AAEA,UAAA,OAAO,WAAW,YAAY;AACnB,qBAAA,MAAM,OAAO,GAAG;AAAA,MAAA,OACxB;AACQ,qBAAA;AAAA,MAAA;AAGX,UAAA,MAAM,QAAQ,UAAU,GAAG;AACtB,eAAA,WAAW,SAAS,IAAI,IAAI,QAAQ,CAAC,IAAI,IAAI,IAAI,QAAQ,IAAI;AAAA,MAAA;AAGhE,YAAA,eAAe,WAAW,MAAM,GAAG,EAAE,IAAI,CAACA,YAAWA,QAAO,MAAM;AACpE,UAAA,aAAa,SAAS,GAAG;AACpB,eAAA,aAAa,SAAS,IAAI,IAAI,QAAQ,CAAC,IAAI,IAAI,IAAI,QAAQ,IAAI;AAAA,MAAA;AAGjE,aAAA;AAAA,IACT;AAAA,IACA,eAAe;AAAA,IACf;AAAA,IACA;AAAA,IACA,cAAc;AAAA,IACd,cAAc;AAAA,IACd;AAAA,EAAA,CACD;AACH;"}