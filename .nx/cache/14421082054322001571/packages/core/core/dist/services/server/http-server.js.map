{"version":3,"file":"http-server.js","sources":["../../../src/services/server/http-server.ts"],"sourcesContent":["import http from 'http';\r\nimport type { Socket } from 'net';\r\nimport Koa from 'koa';\r\nimport type { Core } from '@strapi/types';\r\n\r\nexport interface Server extends http.Server {\r\n  destroy: () => Promise<void>;\r\n}\r\n\r\nconst createHTTPServer = (strapi: Core.Strapi, koaApp: Koa): Server => {\r\n  const connections = new Set<Socket>();\r\n\r\n  // lazy creation of the request listener\r\n  let handler: http.RequestListener;\r\n  const listener: http.RequestListener = function handleRequest(req, res) {\r\n    if (!handler) {\r\n      handler = koaApp.callback();\r\n    }\r\n\r\n    return handler(req, res);\r\n  };\r\n\r\n  const options = strapi.config.get<http.ServerOptions>('server.http.serverOptions', {});\r\n\r\n  const server: http.Server = http.createServer(options, listener);\r\n\r\n  server.on('connection', (connection) => {\r\n    connections.add(connection);\r\n\r\n    connection.on('close', () => {\r\n      connections.delete(connection);\r\n    });\r\n  });\r\n\r\n  // handle port in use cleanly\r\n  server.on('error', (err) => {\r\n    if ('code' in err && 'port' in err && err.code === 'EADDRINUSE') {\r\n      return strapi.stopWithError(`The port ${err.port} is already used by another application.`);\r\n    }\r\n\r\n    strapi.log.error(err);\r\n  });\r\n\r\n  const destroy = async () => {\r\n    for (const connection of connections) {\r\n      connection.destroy();\r\n\r\n      connections.delete(connection);\r\n    }\r\n\r\n    if (!server.listening) {\r\n      return;\r\n    }\r\n\r\n    return new Promise<void>((resolve, reject) => {\r\n      server.close((error) => {\r\n        if (error) {\r\n          reject(error);\r\n        } else {\r\n          resolve();\r\n        }\r\n      });\r\n    });\r\n  };\r\n\r\n  return Object.assign(server, { destroy });\r\n};\r\n\r\nexport { createHTTPServer };\r\n"],"names":["http"],"mappings":";;;;;AASM,MAAA,mBAAmB,CAAC,QAAqB,WAAwB;AAC/D,QAAA,kCAAkB,IAAY;AAGhC,MAAA;AACJ,QAAM,WAAiC,SAAS,cAAc,KAAK,KAAK;AACtE,QAAI,CAAC,SAAS;AACZ,gBAAU,OAAO,SAAS;AAAA,IAAA;AAGrB,WAAA,QAAQ,KAAK,GAAG;AAAA,EACzB;AAEA,QAAM,UAAU,OAAO,OAAO,IAAwB,6BAA6B,CAAA,CAAE;AAErF,QAAM,SAAsBA,cAAA,QAAK,aAAa,SAAS,QAAQ;AAExD,SAAA,GAAG,cAAc,CAAC,eAAe;AACtC,gBAAY,IAAI,UAAU;AAEf,eAAA,GAAG,SAAS,MAAM;AAC3B,kBAAY,OAAO,UAAU;AAAA,IAAA,CAC9B;AAAA,EAAA,CACF;AAGM,SAAA,GAAG,SAAS,CAAC,QAAQ;AAC1B,QAAI,UAAU,OAAO,UAAU,OAAO,IAAI,SAAS,cAAc;AAC/D,aAAO,OAAO,cAAc,YAAY,IAAI,IAAI,0CAA0C;AAAA,IAAA;AAGrF,WAAA,IAAI,MAAM,GAAG;AAAA,EAAA,CACrB;AAED,QAAM,UAAU,YAAY;AAC1B,eAAW,cAAc,aAAa;AACpC,iBAAW,QAAQ;AAEnB,kBAAY,OAAO,UAAU;AAAA,IAAA;AAG3B,QAAA,CAAC,OAAO,WAAW;AACrB;AAAA,IAAA;AAGF,WAAO,IAAI,QAAc,CAAC,SAAS,WAAW;AACrC,aAAA,MAAM,CAAC,UAAU;AACtB,YAAI,OAAO;AACT,iBAAO,KAAK;AAAA,QAAA,OACP;AACG,kBAAA;AAAA,QAAA;AAAA,MACV,CACD;AAAA,IAAA,CACF;AAAA,EACH;AAEA,SAAO,OAAO,OAAO,QAAQ,EAAE,SAAS;AAC1C;;"}