{"version":3,"file":"index.js","sources":["../../../src/services/content-api/index.ts"],"sourcesContent":["import _ from 'lodash';\r\nimport { sanitize, validate } from '@strapi/utils';\r\n\r\nimport type { Core, UID } from '@strapi/types';\r\n\r\nimport instantiatePermissionsUtilities from './permissions';\r\n\r\nconst transformRoutePrefixFor = (pluginName: string) => (route: Core.Route) => {\r\n  const prefix = route.config && route.config.prefix;\r\n  const path = prefix !== undefined ? `${prefix}${route.path}` : `/${pluginName}${route.path}`;\r\n\r\n  return {\r\n    ...route,\r\n    path,\r\n  };\r\n};\r\n\r\nconst filterContentAPI = (route: Core.Route) => route.info.type === 'content-api';\r\n\r\n/**\r\n * Create a content API container that holds logic, tools and utils. (eg: permissions, ...)\r\n */\r\nconst createContentAPI = (strapi: Core.Strapi) => {\r\n  const getRoutesMap = async () => {\r\n    const routesMap: Record<string, Core.Route[]> = {};\r\n\r\n    _.forEach(strapi.apis, (api, apiName) => {\r\n      const routes = _.flatMap(api.routes, (route) => {\r\n        if ('routes' in route) {\r\n          return route.routes;\r\n        }\r\n\r\n        return route;\r\n      }).filter(filterContentAPI);\r\n\r\n      if (routes.length === 0) {\r\n        return;\r\n      }\r\n\r\n      const apiPrefix = strapi.config.get('api.rest.prefix');\r\n      routesMap[`api::${apiName}`] = routes.map((route) => ({\r\n        ...route,\r\n        path: `${apiPrefix}${route.path}`,\r\n      }));\r\n    });\r\n\r\n    _.forEach(strapi.plugins, (plugin, pluginName) => {\r\n      const transformPrefix = transformRoutePrefixFor(pluginName);\r\n\r\n      if (Array.isArray(plugin.routes)) {\r\n        return plugin.routes.map(transformPrefix).filter(filterContentAPI);\r\n      }\r\n\r\n      const routes = _.flatMap(plugin.routes, (route) => route.routes.map(transformPrefix)).filter(\r\n        filterContentAPI\r\n      );\r\n\r\n      if (routes.length === 0) {\r\n        return;\r\n      }\r\n\r\n      const apiPrefix = strapi.config.get('api.rest.prefix');\r\n      routesMap[`plugin::${pluginName}`] = routes.map((route) => ({\r\n        ...route,\r\n        path: `${apiPrefix}${route.path}`,\r\n      }));\r\n    });\r\n\r\n    return routesMap;\r\n  };\r\n\r\n  const sanitizer = sanitize.createAPISanitizers({\r\n    getModel(uid: string) {\r\n      return strapi.getModel(uid as UID.Schema);\r\n    },\r\n    // NOTE: use lazy access to allow registration of sanitizers after the creation of the container\r\n    get sanitizers() {\r\n      return {\r\n        input: strapi.sanitizers.get('content-api.input'),\r\n        output: strapi.sanitizers.get('content-api.output'),\r\n      };\r\n    },\r\n  });\r\n\r\n  const validator = validate.createAPIValidators({\r\n    getModel(uid: string) {\r\n      return strapi.getModel(uid as UID.Schema);\r\n    },\r\n    // NOTE: use lazy access to allow registration of validators after the creation of the container\r\n    get validators() {\r\n      return {\r\n        input: strapi.validators.get('content-api.input'),\r\n      };\r\n    },\r\n  });\r\n\r\n  return {\r\n    permissions: instantiatePermissionsUtilities(strapi),\r\n    getRoutesMap,\r\n    sanitize: sanitizer,\r\n    validate: validator,\r\n  };\r\n};\r\n\r\nexport default createContentAPI;\r\n"],"names":["_","sanitize","validate","instantiatePermissionsUtilities"],"mappings":";;;;;;AAOA,MAAM,0BAA0B,CAAC,eAAuB,CAAC,UAAsB;AAC7E,QAAM,SAAS,MAAM,UAAU,MAAM,OAAO;AAC5C,QAAM,OAAO,WAAW,SAAY,GAAG,MAAM,GAAG,MAAM,IAAI,KAAK,IAAI,UAAU,GAAG,MAAM,IAAI;AAEnF,SAAA;AAAA,IACL,GAAG;AAAA,IACH;AAAA,EACF;AACF;AAEA,MAAM,mBAAmB,CAAC,UAAsB,MAAM,KAAK,SAAS;AAK9D,MAAA,mBAAmB,CAAC,WAAwB;AAChD,QAAM,eAAe,YAAY;AAC/B,UAAM,YAA0C,CAAC;AAEjDA,eAAA,QAAE,QAAQ,OAAO,MAAM,CAAC,KAAK,YAAY;AACvC,YAAM,SAASA,WAAAA,QAAE,QAAQ,IAAI,QAAQ,CAAC,UAAU;AAC9C,YAAI,YAAY,OAAO;AACrB,iBAAO,MAAM;AAAA,QAAA;AAGR,eAAA;AAAA,MAAA,CACR,EAAE,OAAO,gBAAgB;AAEtB,UAAA,OAAO,WAAW,GAAG;AACvB;AAAA,MAAA;AAGF,YAAM,YAAY,OAAO,OAAO,IAAI,iBAAiB;AACrD,gBAAU,QAAQ,OAAO,EAAE,IAAI,OAAO,IAAI,CAAC,WAAW;AAAA,QACpD,GAAG;AAAA,QACH,MAAM,GAAG,SAAS,GAAG,MAAM,IAAI;AAAA,MAAA,EAC/B;AAAA,IAAA,CACH;AAEDA,eAAA,QAAE,QAAQ,OAAO,SAAS,CAAC,QAAQ,eAAe;AAC1C,YAAA,kBAAkB,wBAAwB,UAAU;AAE1D,UAAI,MAAM,QAAQ,OAAO,MAAM,GAAG;AAChC,eAAO,OAAO,OAAO,IAAI,eAAe,EAAE,OAAO,gBAAgB;AAAA,MAAA;AAGnE,YAAM,SAASA,WAAA,QAAE,QAAQ,OAAO,QAAQ,CAAC,UAAU,MAAM,OAAO,IAAI,eAAe,CAAC,EAAE;AAAA,QACpF;AAAA,MACF;AAEI,UAAA,OAAO,WAAW,GAAG;AACvB;AAAA,MAAA;AAGF,YAAM,YAAY,OAAO,OAAO,IAAI,iBAAiB;AACrD,gBAAU,WAAW,UAAU,EAAE,IAAI,OAAO,IAAI,CAAC,WAAW;AAAA,QAC1D,GAAG;AAAA,QACH,MAAM,GAAG,SAAS,GAAG,MAAM,IAAI;AAAA,MAAA,EAC/B;AAAA,IAAA,CACH;AAEM,WAAA;AAAA,EACT;AAEM,QAAA,YAAYC,qBAAS,oBAAoB;AAAA,IAC7C,SAAS,KAAa;AACb,aAAA,OAAO,SAAS,GAAiB;AAAA,IAC1C;AAAA;AAAA,IAEA,IAAI,aAAa;AACR,aAAA;AAAA,QACL,OAAO,OAAO,WAAW,IAAI,mBAAmB;AAAA,QAChD,QAAQ,OAAO,WAAW,IAAI,oBAAoB;AAAA,MACpD;AAAA,IAAA;AAAA,EACF,CACD;AAEK,QAAA,YAAYC,qBAAS,oBAAoB;AAAA,IAC7C,SAAS,KAAa;AACb,aAAA,OAAO,SAAS,GAAiB;AAAA,IAC1C;AAAA;AAAA,IAEA,IAAI,aAAa;AACR,aAAA;AAAA,QACL,OAAO,OAAO,WAAW,IAAI,mBAAmB;AAAA,MAClD;AAAA,IAAA;AAAA,EACF,CACD;AAEM,SAAA;AAAA,IACL,aAAaC,MAAgC,MAAM;AAAA,IACnD;AAAA,IACA,UAAU;AAAA,IACV,UAAU;AAAA,EACZ;AACF;;"}