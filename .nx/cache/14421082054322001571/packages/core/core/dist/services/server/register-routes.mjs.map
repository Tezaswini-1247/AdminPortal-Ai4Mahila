{"version":3,"file":"register-routes.mjs","sources":["../../../src/services/server/register-routes.ts"],"sourcesContent":["import _ from 'lodash';\r\nimport type { Core } from '@strapi/types';\r\n\r\nconst createRouteScopeGenerator = (namespace: string) => (route: Core.RouteInput) => {\r\n  const prefix = namespace.endsWith('::') ? namespace : `${namespace}.`;\r\n\r\n  if (typeof route.handler === 'string') {\r\n    _.defaultsDeep(route, {\r\n      config: {\r\n        auth: {\r\n          scope: [`${route.handler.startsWith(prefix) ? '' : prefix}${route.handler}`],\r\n        },\r\n      },\r\n    });\r\n  }\r\n};\r\n\r\n/**\r\n * Register all routes\r\n */\r\nexport default (strapi: Core.Strapi) => {\r\n  registerAdminRoutes(strapi);\r\n  registerAPIRoutes(strapi);\r\n  registerPluginRoutes(strapi);\r\n};\r\n\r\n/**\r\n * Register admin routes\r\n * @param {import('../../').Strapi} strapi\r\n */\r\nconst registerAdminRoutes = (strapi: Core.Strapi) => {\r\n  const generateRouteScope = createRouteScopeGenerator(`admin::`);\r\n\r\n  _.forEach(strapi.admin.routes, (router) => {\r\n    router.type = router.type || 'admin';\r\n    router.prefix = router.prefix || `/admin`;\r\n    router.routes.forEach((route) => {\r\n      generateRouteScope(route);\r\n      route.info = { pluginName: 'admin' };\r\n    });\r\n    strapi.server.routes(router);\r\n  });\r\n};\r\n\r\n/**\r\n * Register plugin routes\r\n * @param {import('../../').Strapi} strapi\r\n */\r\nconst registerPluginRoutes = (strapi: Core.Strapi) => {\r\n  for (const pluginName of Object.keys(strapi.plugins)) {\r\n    const plugin = strapi.plugins[pluginName];\r\n\r\n    const generateRouteScope = createRouteScopeGenerator(`plugin::${pluginName}`);\r\n\r\n    if (Array.isArray(plugin.routes)) {\r\n      plugin.routes.forEach((route) => {\r\n        generateRouteScope(route);\r\n        route.info = { pluginName };\r\n      });\r\n\r\n      strapi.server.routes({\r\n        type: 'admin',\r\n        prefix: `/${pluginName}`,\r\n        routes: plugin.routes,\r\n      });\r\n    } else {\r\n      _.forEach(plugin.routes, (router) => {\r\n        router.type = router.type || 'admin';\r\n        router.prefix = router.prefix || `/${pluginName}`;\r\n        router.routes.forEach((route) => {\r\n          generateRouteScope(route);\r\n          route.info = { pluginName };\r\n        });\r\n\r\n        strapi.server.routes(router);\r\n      });\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Register api routes\r\n */\r\nconst registerAPIRoutes = (strapi: Core.Strapi) => {\r\n  for (const apiName of Object.keys(strapi.apis)) {\r\n    const api = strapi.api(apiName);\r\n\r\n    const generateRouteScope = createRouteScopeGenerator(`api::${apiName}`);\r\n\r\n    _.forEach(api.routes, (router) => {\r\n      // TODO: remove once auth setup\r\n      // pass meta down to compose endpoint\r\n      router.type = 'content-api';\r\n      router.routes?.forEach((route) => {\r\n        generateRouteScope(route);\r\n        route.info = { apiName };\r\n      });\r\n\r\n      return strapi.server.routes(router);\r\n    });\r\n  }\r\n};\r\n"],"names":[],"mappings":";AAGA,MAAM,4BAA4B,CAAC,cAAsB,CAAC,UAA2B;AACnF,QAAM,SAAS,UAAU,SAAS,IAAI,IAAI,YAAY,GAAG,SAAS;AAE9D,MAAA,OAAO,MAAM,YAAY,UAAU;AACrC,MAAE,aAAa,OAAO;AAAA,MACpB,QAAQ;AAAA,QACN,MAAM;AAAA,UACJ,OAAO,CAAC,GAAG,MAAM,QAAQ,WAAW,MAAM,IAAI,KAAK,MAAM,GAAG,MAAM,OAAO,EAAE;AAAA,QAAA;AAAA,MAC7E;AAAA,IACF,CACD;AAAA,EAAA;AAEL;AAKA,MAAe,oBAAA,CAAC,WAAwB;AACtC,sBAAoB,MAAM;AAC1B,oBAAkB,MAAM;AACxB,uBAAqB,MAAM;AAC7B;AAMA,MAAM,sBAAsB,CAAC,WAAwB;AAC7C,QAAA,qBAAqB,0BAA0B,SAAS;AAE9D,IAAE,QAAQ,OAAO,MAAM,QAAQ,CAAC,WAAW;AAClC,WAAA,OAAO,OAAO,QAAQ;AACtB,WAAA,SAAS,OAAO,UAAU;AAC1B,WAAA,OAAO,QAAQ,CAAC,UAAU;AAC/B,yBAAmB,KAAK;AAClB,YAAA,OAAO,EAAE,YAAY,QAAQ;AAAA,IAAA,CACpC;AACM,WAAA,OAAO,OAAO,MAAM;AAAA,EAAA,CAC5B;AACH;AAMA,MAAM,uBAAuB,CAAC,WAAwB;AACpD,aAAW,cAAc,OAAO,KAAK,OAAO,OAAO,GAAG;AAC9C,UAAA,SAAS,OAAO,QAAQ,UAAU;AAExC,UAAM,qBAAqB,0BAA0B,WAAW,UAAU,EAAE;AAE5E,QAAI,MAAM,QAAQ,OAAO,MAAM,GAAG;AACzB,aAAA,OAAO,QAAQ,CAAC,UAAU;AAC/B,2BAAmB,KAAK;AAClB,cAAA,OAAO,EAAE,WAAW;AAAA,MAAA,CAC3B;AAED,aAAO,OAAO,OAAO;AAAA,QACnB,MAAM;AAAA,QACN,QAAQ,IAAI,UAAU;AAAA,QACtB,QAAQ,OAAO;AAAA,MAAA,CAChB;AAAA,IAAA,OACI;AACL,QAAE,QAAQ,OAAO,QAAQ,CAAC,WAAW;AAC5B,eAAA,OAAO,OAAO,QAAQ;AAC7B,eAAO,SAAS,OAAO,UAAU,IAAI,UAAU;AACxC,eAAA,OAAO,QAAQ,CAAC,UAAU;AAC/B,6BAAmB,KAAK;AAClB,gBAAA,OAAO,EAAE,WAAW;AAAA,QAAA,CAC3B;AAEM,eAAA,OAAO,OAAO,MAAM;AAAA,MAAA,CAC5B;AAAA,IAAA;AAAA,EACH;AAEJ;AAKA,MAAM,oBAAoB,CAAC,WAAwB;AACjD,aAAW,WAAW,OAAO,KAAK,OAAO,IAAI,GAAG;AACxC,UAAA,MAAM,OAAO,IAAI,OAAO;AAE9B,UAAM,qBAAqB,0BAA0B,QAAQ,OAAO,EAAE;AAEtE,MAAE,QAAQ,IAAI,QAAQ,CAAC,WAAW;AAGhC,aAAO,OAAO;AACP,aAAA,QAAQ,QAAQ,CAAC,UAAU;AAChC,2BAAmB,KAAK;AAClB,cAAA,OAAO,EAAE,QAAQ;AAAA,MAAA,CACxB;AAEM,aAAA,OAAO,OAAO,OAAO,MAAM;AAAA,IAAA,CACnC;AAAA,EAAA;AAEL;"}