{"version":3,"file":"koa.mjs","sources":["../../../src/services/server/koa.ts"],"sourcesContent":["import { isNil, camelCase } from 'lodash/fp';\r\nimport Koa from 'koa';\r\nimport createError from 'http-errors';\r\nimport delegate from 'delegates';\r\nimport statuses from 'statuses';\r\nimport { formatHttpError } from '../errors';\r\n\r\ndeclare module 'koa' {\r\n  interface BaseResponse {\r\n    send: (data: any, status?: number) => void;\r\n    created: (data: any) => void;\r\n    deleted: (data: any) => void;\r\n    _explicitStatus: boolean;\r\n    [key: string]: (message: string, details?: unknown) => void;\r\n  }\r\n}\r\n\r\nconst addCustomMethods = (app: Koa) => {\r\n  const delegator = delegate(app.context, 'response');\r\n\r\n  /* errors */\r\n  statuses.codes\r\n    .filter((code) => code >= 400 && code < 600)\r\n    .forEach((code) => {\r\n      const name = statuses(code);\r\n\r\n      const camelCasedName = camelCase(name);\r\n      app.response[camelCasedName] = function responseCode(message = name, details = {}) {\r\n        const httpError = createError(code, message, { details });\r\n        const { status, body } = formatHttpError(httpError);\r\n        this.status = status;\r\n        this.body = body;\r\n      };\r\n      delegator.method(camelCasedName);\r\n    });\r\n\r\n  /* send, created, deleted */\r\n  app.response.send = function send(data, status = 200) {\r\n    this.status = status;\r\n    this.body = data;\r\n  };\r\n\r\n  app.response.created = function created(data) {\r\n    this.status = 201;\r\n    this.body = data;\r\n  };\r\n\r\n  app.response.deleted = function deleted(data) {\r\n    if (isNil(data)) {\r\n      this.status = 204;\r\n    } else {\r\n      this.status = 200;\r\n      this.body = data;\r\n    }\r\n  };\r\n\r\n  delegator.method('send').method('created').method('deleted');\r\n\r\n  return app;\r\n};\r\n\r\nconst createKoaApp = ({ proxy, keys }: { proxy: boolean; keys: string[] }) => {\r\n  const app = new Koa({ proxy });\r\n  app.keys = keys;\r\n\r\n  addCustomMethods(app);\r\n\r\n  return app;\r\n};\r\n\r\nexport default createKoaApp;\r\n"],"names":[],"mappings":";;;;;;AAiBA,MAAM,mBAAmB,CAAC,QAAa;AACrC,QAAM,YAAY,SAAS,IAAI,SAAS,UAAU;AAGzC,WAAA,MACN,OAAO,CAAC,SAAS,QAAQ,OAAO,OAAO,GAAG,EAC1C,QAAQ,CAAC,SAAS;AACX,UAAA,OAAO,SAAS,IAAI;AAEpB,UAAA,iBAAiB,UAAU,IAAI;AACjC,QAAA,SAAS,cAAc,IAAI,SAAS,aAAa,UAAU,MAAM,UAAU,IAAI;AACjF,YAAM,YAAY,YAAY,MAAM,SAAS,EAAE,SAAS;AACxD,YAAM,EAAE,QAAQ,SAAS,gBAAgB,SAAS;AAClD,WAAK,SAAS;AACd,WAAK,OAAO;AAAA,IACd;AACA,cAAU,OAAO,cAAc;AAAA,EAAA,CAChC;AAGH,MAAI,SAAS,OAAO,SAAS,KAAK,MAAM,SAAS,KAAK;AACpD,SAAK,SAAS;AACd,SAAK,OAAO;AAAA,EACd;AAEA,MAAI,SAAS,UAAU,SAAS,QAAQ,MAAM;AAC5C,SAAK,SAAS;AACd,SAAK,OAAO;AAAA,EACd;AAEA,MAAI,SAAS,UAAU,SAAS,QAAQ,MAAM;AACxC,QAAA,MAAM,IAAI,GAAG;AACf,WAAK,SAAS;AAAA,IAAA,OACT;AACL,WAAK,SAAS;AACd,WAAK,OAAO;AAAA,IAAA;AAAA,EAEhB;AAEA,YAAU,OAAO,MAAM,EAAE,OAAO,SAAS,EAAE,OAAO,SAAS;AAEpD,SAAA;AACT;AAEA,MAAM,eAAe,CAAC,EAAE,OAAO,WAA+C;AAC5E,QAAM,MAAM,IAAI,IAAI,EAAE,OAAO;AAC7B,MAAI,OAAO;AAEX,mBAAiB,GAAG;AAEb,SAAA;AACT;"}