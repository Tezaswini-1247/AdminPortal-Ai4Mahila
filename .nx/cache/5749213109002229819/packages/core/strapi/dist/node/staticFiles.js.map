{"version":3,"file":"staticFiles.js","sources":["../../src/node/staticFiles.ts"],"sourcesContent":["import fs from 'node:fs/promises';\r\nimport path from 'node:path';\r\nimport outdent from 'outdent';\r\nimport { createElement } from 'react';\r\nimport { renderToStaticMarkup } from 'react-dom/server';\r\nimport { DefaultDocument } from '@strapi/admin/_internal';\r\n\r\nimport type { BuildContext } from './create-build-context';\r\n\r\nconst getEntryModule = (ctx: BuildContext): string => {\r\n  const pluginsObject = ctx.plugins\r\n    .map(({ name, importName }) => `'${name}': ${importName}`)\r\n    .join(',\\n');\r\n\r\n  const pluginsImport = ctx.plugins\r\n    .map(({ importName, modulePath }) => `import ${importName} from '${modulePath}';`)\r\n    .join('\\n');\r\n\r\n  return outdent`\r\n        /**\r\n         * This file was automatically generated by Strapi.\r\n         * Any modifications made will be discarded.\r\n         */\r\n        ${pluginsImport}\r\n        import { renderAdmin } from \"@strapi/strapi/admin\"\r\n\r\n        ${\r\n          ctx.customisations?.modulePath\r\n            ? `import customisations from '${ctx.customisations.modulePath}'`\r\n            : ''\r\n        }\r\n\r\n        renderAdmin(\r\n          document.getElementById(\"strapi\"),\r\n          {\r\n            ${ctx.customisations?.modulePath ? 'customisations,' : ''}\r\n            ${ctx.features ? `features: ${JSON.stringify(ctx.features)},` : ''}\r\n            plugins: {\r\n        ${pluginsObject}\r\n            }\r\n        })\r\n      `;\r\n};\r\n\r\ninterface GetDocumentHTMLArgs extends Pick<BuildContext, 'logger'> {\r\n  props?: {\r\n    entryPath?: string;\r\n  };\r\n}\r\n\r\n/**\r\n * TODO: Here in the future we could add the ability\r\n * to load a user's Document component?\r\n */\r\nconst getDocumentHTML = ({ logger, props = {} }: GetDocumentHTMLArgs) => {\r\n  const result = renderToStaticMarkup(createElement(DefaultDocument, props));\r\n  logger.debug('Rendered the HTML');\r\n\r\n  return outdent`<!DOCTYPE html>${result}`;\r\n};\r\n\r\nconst AUTO_GENERATED_WARNING = `\r\nThis file was automatically generated by Strapi.\r\nAny modifications made will be discarded.\r\n`.trim();\r\n\r\n/**\r\n * Because we now auto-generate the index.html file,\r\n * we should be clear that people _should not_ modify it.\r\n *\r\n * @internal\r\n */\r\nconst decorateHTMLWithAutoGeneratedWarning = (htmlTemplate: string): string =>\r\n  htmlTemplate.replace(/<head/, `\\n<!--\\n${AUTO_GENERATED_WARNING}\\n-->\\n<head`);\r\n\r\nconst writeStaticClientFiles = async (ctx: BuildContext) => {\r\n  const prettier = await import('prettier'); // ESM-only\r\n\r\n  /**\r\n   * For everything to work effectively we create a client folder in `.strapi` at the cwd level.\r\n   * We then use the function we need to \"createAdmin\" as well as generate the Document index.html as well.\r\n   *\r\n   * All this links together an imaginary \"src/index\" that then allows vite to correctly build the admin panel.\r\n   */\r\n\r\n  await fs.mkdir(ctx.runtimeDir, { recursive: true });\r\n  ctx.logger.debug('Created the runtime directory');\r\n\r\n  const indexHtml = decorateHTMLWithAutoGeneratedWarning(\r\n    await getDocumentHTML({\r\n      logger: ctx.logger,\r\n      props:\r\n        ctx.bundler === 'vite'\r\n          ? {\r\n              entryPath: `/${ctx.entry}`,\r\n            }\r\n          : undefined,\r\n    })\r\n  );\r\n\r\n  await fs.writeFile(\r\n    path.join(ctx.runtimeDir, 'index.html'),\r\n    await prettier.format(indexHtml, {\r\n      parser: 'html',\r\n    })\r\n  );\r\n  ctx.logger.debug('Wrote the index.html file');\r\n  await fs.writeFile(\r\n    path.join(ctx.runtimeDir, 'app.js'),\r\n    await prettier.format(getEntryModule(ctx), {\r\n      parser: 'babel',\r\n    })\r\n  );\r\n  ctx.logger.debug('Wrote the app.js file');\r\n};\r\n\r\nexport { writeStaticClientFiles, getDocumentHTML };\r\n"],"names":["outdent","renderToStaticMarkup","createElement","DefaultDocument","fs","path"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AASA,MAAM,iBAAiB,CAAC,QAA8B;AACpD,QAAM,gBAAgB,IAAI,QACvB,IAAI,CAAC,EAAE,MAAM,WAAA,MAAiB,IAAI,IAAI,MAAM,UAAU,EAAE,EACxD,KAAK,KAAK;AAEb,QAAM,gBAAgB,IAAI,QACvB,IAAI,CAAC,EAAE,YAAY,WAAiB,MAAA,UAAU,UAAU,UAAU,UAAU,IAAI,EAChF,KAAK,IAAI;AAEL,SAAAA,iBAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAKC,aAAa;AAAA;AAAA;AAAA,UAIb,IAAI,gBAAgB,aAChB,+BAA+B,IAAI,eAAe,UAAU,MAC5D,EACN;AAAA;AAAA;AAAA;AAAA;AAAA,cAKM,IAAI,gBAAgB,aAAa,oBAAoB,EAAE;AAAA,cACvD,IAAI,WAAW,aAAa,KAAK,UAAU,IAAI,QAAQ,CAAC,MAAM,EAAE;AAAA;AAAA,UAEpE,aAAa;AAAA;AAAA;AAAA;AAIvB;AAYA,MAAM,kBAAkB,CAAC,EAAE,QAAQ,QAAQ,SAA8B;AACvE,QAAM,SAASC,OAAA,qBAAqBC,MAAc,cAAAC,UAAA,iBAAiB,KAAK,CAAC;AACzE,SAAO,MAAM,mBAAmB;AAEhC,SAAOH,0CAAyB,MAAM;AACxC;AAEA,MAAM,yBAAyB;AAAA;AAAA;AAAA,EAG7B,KAAK;AAQP,MAAM,uCAAuC,CAAC,iBAC5C,aAAa,QAAQ,SAAS;AAAA;AAAA,EAAW,sBAAsB;AAAA;AAAA,MAAc;AAEzE,MAAA,yBAAyB,OAAO,QAAsB;AACpD,QAAA,WAAW,MAAM,OAAO,UAAU;AASxC,QAAMI,YAAAA,QAAG,MAAM,IAAI,YAAY,EAAE,WAAW,MAAM;AAC9C,MAAA,OAAO,MAAM,+BAA+B;AAEhD,QAAM,YAAY;AAAA,IAChB,MAAM,gBAAgB;AAAA,MACpB,QAAQ,IAAI;AAAA,MACZ,OACE,IAAI,YAAY,SACZ;AAAA,QACE,WAAW,IAAI,IAAI,KAAK;AAAA,MAAA,IAE1B;AAAA,IACP,CAAA;AAAA,EACH;AAEA,QAAMA,YAAG,QAAA;AAAA,IACPC,cAAAA,QAAK,KAAK,IAAI,YAAY,YAAY;AAAA,IACtC,MAAM,SAAS,OAAO,WAAW;AAAA,MAC/B,QAAQ;AAAA,IACT,CAAA;AAAA,EACH;AACI,MAAA,OAAO,MAAM,2BAA2B;AAC5C,QAAMD,YAAG,QAAA;AAAA,IACPC,cAAAA,QAAK,KAAK,IAAI,YAAY,QAAQ;AAAA,IAClC,MAAM,SAAS,OAAO,eAAe,GAAG,GAAG;AAAA,MACzC,QAAQ;AAAA,IACT,CAAA;AAAA,EACH;AACI,MAAA,OAAO,MAAM,uBAAuB;AAC1C;;;"}