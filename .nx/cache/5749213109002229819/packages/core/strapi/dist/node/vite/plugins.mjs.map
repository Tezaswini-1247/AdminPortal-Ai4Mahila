{"version":3,"file":"plugins.mjs","sources":["../../../src/node/vite/plugins.ts"],"sourcesContent":["import type { Plugin } from 'vite';\r\n\r\nimport { getDocumentHTML } from '../staticFiles';\r\nimport type { BuildContext } from '../create-build-context';\r\n\r\nconst buildFilesPlugin = (ctx: BuildContext): Plugin => {\r\n  const CHUNK_ID = '.strapi/client/app.js';\r\n\r\n  return {\r\n    name: 'strapi/server/build-files',\r\n    apply: 'build',\r\n    buildStart() {\r\n      this.emitFile({\r\n        type: 'chunk',\r\n        id: CHUNK_ID,\r\n        name: 'strapi',\r\n      });\r\n    },\r\n    async generateBundle(_options, outputBundle) {\r\n      const bundle = outputBundle;\r\n      const entryFile = Object.values(bundle).find(\r\n        (file) =>\r\n          file.type === 'chunk' && file.name === 'strapi' && file.facadeModuleId?.endsWith(CHUNK_ID)\r\n      );\r\n\r\n      if (!entryFile) {\r\n        throw new Error(`Failed to find entry file in bundle (${CHUNK_ID})`);\r\n      }\r\n\r\n      if (entryFile.type !== 'chunk') {\r\n        throw new Error('Entry file is not a chunk');\r\n      }\r\n\r\n      const entryFileName = entryFile.fileName;\r\n      const entryPath = [ctx.basePath.replace(/\\/+$/, ''), entryFileName].join('/');\r\n\r\n      this.emitFile({\r\n        type: 'asset',\r\n        fileName: 'index.html',\r\n        source: getDocumentHTML({\r\n          logger: ctx.logger,\r\n          props: {\r\n            entryPath,\r\n          },\r\n        }),\r\n      });\r\n    },\r\n  };\r\n};\r\n\r\nexport { buildFilesPlugin };\r\n"],"names":[],"mappings":";AAKM,MAAA,mBAAmB,CAAC,QAA8B;AACtD,QAAM,WAAW;AAEV,SAAA;AAAA,IACL,MAAM;AAAA,IACN,OAAO;AAAA,IACP,aAAa;AACX,WAAK,SAAS;AAAA,QACZ,MAAM;AAAA,QACN,IAAI;AAAA,QACJ,MAAM;AAAA,MAAA,CACP;AAAA,IACH;AAAA,IACA,MAAM,eAAe,UAAU,cAAc;AAC3C,YAAM,SAAS;AACf,YAAM,YAAY,OAAO,OAAO,MAAM,EAAE;AAAA,QACtC,CAAC,SACC,KAAK,SAAS,WAAW,KAAK,SAAS,YAAY,KAAK,gBAAgB,SAAS,QAAQ;AAAA,MAC7F;AAEA,UAAI,CAAC,WAAW;AACd,cAAM,IAAI,MAAM,wCAAwC,QAAQ,GAAG;AAAA,MAAA;AAGjE,UAAA,UAAU,SAAS,SAAS;AACxB,cAAA,IAAI,MAAM,2BAA2B;AAAA,MAAA;AAG7C,YAAM,gBAAgB,UAAU;AAC1B,YAAA,YAAY,CAAC,IAAI,SAAS,QAAQ,QAAQ,EAAE,GAAG,aAAa,EAAE,KAAK,GAAG;AAE5E,WAAK,SAAS;AAAA,QACZ,MAAM;AAAA,QACN,UAAU;AAAA,QACV,QAAQ,gBAAgB;AAAA,UACtB,QAAQ,IAAI;AAAA,UACZ,OAAO;AAAA,YACL;AAAA,UAAA;AAAA,QAEH,CAAA;AAAA,MAAA,CACF;AAAA,IAAA;AAAA,EAEL;AACF;"}