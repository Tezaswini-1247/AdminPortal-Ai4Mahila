{"version":3,"file":"enable.js","sources":["../../../../src/cli/commands/telemetry/enable.ts"],"sourcesContent":["import { resolve } from 'path';\r\nimport { randomUUID } from 'crypto';\r\nimport fse from 'fs-extra';\r\nimport chalk from 'chalk';\r\nimport { createCommand } from 'commander';\r\n\r\nimport type { StrapiCommand } from '../../types';\r\nimport { runAction } from '../../utils/helpers';\r\nimport { sendEvent } from '../../utils/telemetry';\r\n\r\ntype PackageJson = {\r\n  strapi?: {\r\n    uuid?: string;\r\n    telemetryDisabled?: boolean;\r\n  };\r\n};\r\n\r\nconst readPackageJSON = async (path: string) => {\r\n  try {\r\n    const packageObj = await fse.readJson(path);\r\n    return packageObj;\r\n  } catch (err) {\r\n    if (err instanceof Error) {\r\n      console.error(`${chalk.red('Error')}: ${err.message}`);\r\n    } else {\r\n      throw err;\r\n    }\r\n  }\r\n};\r\n\r\nconst writePackageJSON = async (path: string, file: object, spacing: number) => {\r\n  try {\r\n    await fse.writeJson(path, file, { spaces: spacing });\r\n    return true;\r\n  } catch (err) {\r\n    if (err instanceof Error) {\r\n      console.error(`${chalk.red('Error')}: ${err.message}`);\r\n      console.log(\r\n        `${chalk.yellow(\r\n          'Warning'\r\n        )}: There has been an error, please set \"telemetryDisabled\": false in the \"strapi\" object of your package.json manually.`\r\n      );\r\n\r\n      return false;\r\n    }\r\n\r\n    throw err;\r\n  }\r\n};\r\n\r\nconst generateNewPackageJSON = (packageObj: PackageJson) => {\r\n  if (!packageObj.strapi) {\r\n    return {\r\n      ...packageObj,\r\n      strapi: {\r\n        uuid: randomUUID(),\r\n        telemetryDisabled: false,\r\n      },\r\n    };\r\n  }\r\n  return {\r\n    ...packageObj,\r\n    strapi: {\r\n      ...packageObj.strapi,\r\n      uuid: packageObj.strapi.uuid ? packageObj.strapi.uuid : randomUUID(),\r\n      telemetryDisabled: false,\r\n    },\r\n  };\r\n};\r\n\r\nconst action = async () => {\r\n  const packageJSONPath = resolve(process.cwd(), 'package.json');\r\n  const exists = await fse.pathExists(packageJSONPath);\r\n\r\n  if (!exists) {\r\n    console.log(`${chalk.yellow('Warning')}: could not find package.json`);\r\n    process.exit(0);\r\n  }\r\n\r\n  const packageObj = await readPackageJSON(packageJSONPath);\r\n\r\n  if (packageObj.strapi && packageObj.strapi.uuid) {\r\n    if (packageObj.strapi.telemetryDisabled === false) {\r\n      console.log(`${chalk.yellow('Warning:')} telemetry is already enabled`);\r\n      process.exit(0);\r\n    }\r\n  }\r\n\r\n  const updatedPackageJSON = generateNewPackageJSON(packageObj);\r\n\r\n  const write = await writePackageJSON(packageJSONPath, updatedPackageJSON, 2);\r\n\r\n  if (!write) {\r\n    process.exit(0);\r\n  }\r\n\r\n  await sendEvent('didOptInTelemetry', updatedPackageJSON.strapi.uuid);\r\n  console.log(`${chalk.green('Successfully opted into and enabled Strapi telemetry')}`);\r\n  process.exit(0);\r\n};\r\n\r\n/**\r\n * `$ strapi telemetry:enable`\r\n */\r\nconst command: StrapiCommand = () => {\r\n  return createCommand('telemetry:enable')\r\n    .description('Enable anonymous telemetry and metadata sending to Strapi analytics')\r\n    .action(runAction('telemetry:enable', action));\r\n};\r\n\r\nexport { action, command };\r\n"],"names":["path","fse","chalk","randomUUID","resolve","sendEvent","createCommand","runAction"],"mappings":";;;;;;;;;;;;AAiBA,MAAM,kBAAkB,OAAOA,UAAiB;AAC1C,MAAA;AACF,UAAM,aAAa,MAAMC,qBAAI,SAASD,KAAI;AACnC,WAAA;AAAA,WACA,KAAK;AACZ,QAAI,eAAe,OAAO;AAChB,cAAA,MAAM,GAAGE,eAAAA,QAAM,IAAI,OAAO,CAAC,KAAK,IAAI,OAAO,EAAE;AAAA,IAAA,OAChD;AACC,YAAA;AAAA,IAAA;AAAA,EACR;AAEJ;AAEA,MAAM,mBAAmB,OAAOF,OAAc,MAAc,YAAoB;AAC1E,MAAA;AACF,UAAMC,aAAAA,QAAI,UAAUD,OAAM,MAAM,EAAE,QAAQ,SAAS;AAC5C,WAAA;AAAA,WACA,KAAK;AACZ,QAAI,eAAe,OAAO;AAChB,cAAA,MAAM,GAAGE,eAAAA,QAAM,IAAI,OAAO,CAAC,KAAK,IAAI,OAAO,EAAE;AAC7C,cAAA;AAAA,QACN,GAAGA,eAAM,QAAA;AAAA,UACP;AAAA,QAAA,CACD;AAAA,MACH;AAEO,aAAA;AAAA,IAAA;AAGH,UAAA;AAAA,EAAA;AAEV;AAEA,MAAM,yBAAyB,CAAC,eAA4B;AACtD,MAAA,CAAC,WAAW,QAAQ;AACf,WAAA;AAAA,MACL,GAAG;AAAA,MACH,QAAQ;AAAA,QACN,MAAMC,OAAAA,WAAW;AAAA,QACjB,mBAAmB;AAAA,MAAA;AAAA,IAEvB;AAAA,EAAA;AAEK,SAAA;AAAA,IACL,GAAG;AAAA,IACH,QAAQ;AAAA,MACN,GAAG,WAAW;AAAA,MACd,MAAM,WAAW,OAAO,OAAO,WAAW,OAAO,OAAOA,kBAAW;AAAA,MACnE,mBAAmB;AAAA,IAAA;AAAA,EAEvB;AACF;AAEA,MAAM,SAAS,YAAY;AACzB,QAAM,kBAAkBC,KAAA,QAAQ,QAAQ,IAAA,GAAO,cAAc;AAC7D,QAAM,SAAS,MAAMH,qBAAI,WAAW,eAAe;AAEnD,MAAI,CAAC,QAAQ;AACX,YAAQ,IAAI,GAAGC,eAAAA,QAAM,OAAO,SAAS,CAAC,+BAA+B;AACrE,YAAQ,KAAK,CAAC;AAAA,EAAA;AAGV,QAAA,aAAa,MAAM,gBAAgB,eAAe;AAExD,MAAI,WAAW,UAAU,WAAW,OAAO,MAAM;AAC3C,QAAA,WAAW,OAAO,sBAAsB,OAAO;AACjD,cAAQ,IAAI,GAAGA,eAAAA,QAAM,OAAO,UAAU,CAAC,+BAA+B;AACtE,cAAQ,KAAK,CAAC;AAAA,IAAA;AAAA,EAChB;AAGI,QAAA,qBAAqB,uBAAuB,UAAU;AAE5D,QAAM,QAAQ,MAAM,iBAAiB,iBAAiB,oBAAoB,CAAC;AAE3E,MAAI,CAAC,OAAO;AACV,YAAQ,KAAK,CAAC;AAAA,EAAA;AAGhB,QAAMG,UAAU,UAAA,qBAAqB,mBAAmB,OAAO,IAAI;AACnE,UAAQ,IAAI,GAAGH,eAAAA,QAAM,MAAM,sDAAsD,CAAC,EAAE;AACpF,UAAQ,KAAK,CAAC;AAChB;AAKA,MAAM,UAAyB,MAAM;AAC5B,SAAAI,UAAA,cAAc,kBAAkB,EACpC,YAAY,qEAAqE,EACjF,OAAOC,QAAA,UAAU,oBAAoB,MAAM,CAAC;AACjD;;;"}