{"version":3,"file":"index.mjs","sources":["../../../src/utils/update-notifier/index.ts"],"sourcesContent":["import path from 'path';\r\nimport packageJson from 'package-json';\r\nimport Configstore from 'configstore';\r\nimport semver from 'semver';\r\nimport boxen from 'boxen';\r\nimport chalk from 'chalk';\r\nimport { env } from '@strapi/utils';\r\nimport type { Core } from '@strapi/types';\r\n\r\n// eslint-disable-next-line @typescript-eslint/no-var-requires\r\nconst pkg = require('../../../package.json');\r\n\r\nconst CHECK_INTERVAL = 1000 * 60 * 60 * 24 * 1; // 1 day\r\nconst NOTIF_INTERVAL = 1000 * 60 * 60 * 24 * 7; // 1 week\r\nconst boxenOptions: boxen.Options = {\r\n  padding: 1,\r\n  margin: 1,\r\n  align: 'center',\r\n  borderColor: 'yellow',\r\n  borderStyle: 'round',\r\n};\r\n\r\nconst getUpdateMessage = (newVersion: string, currentVersion: string) => {\r\n  const currentVersionLog = chalk.dim(currentVersion);\r\n  const newVersionLog = chalk.green(newVersion);\r\n  const releaseLink = chalk.bold('https://github.com/strapi/strapi/releases');\r\n\r\n  return `\r\nA new version of Strapi is available ${currentVersionLog} â†’ ${newVersionLog}\r\nCheck out the new releases at: ${releaseLink}\r\n`.trim();\r\n};\r\n\r\nexport const createUpdateNotifier = (strapi: Core.Strapi) => {\r\n  let config: InstanceType<typeof Configstore>;\r\n\r\n  try {\r\n    config = new Configstore(\r\n      pkg.name,\r\n      {},\r\n      { configPath: path.join(strapi.dirs.app.root, '.strapi-updater.json') }\r\n    );\r\n  } catch {\r\n    // we don't have write access to the file system\r\n    // we silence the error\r\n    return;\r\n  }\r\n\r\n  const checkUpdate = async (checkInterval: number) => {\r\n    const now = Date.now();\r\n    const lastUpdateCheck = config.get('lastUpdateCheck') || 0;\r\n    if (lastUpdateCheck + checkInterval > now) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const res = await packageJson(pkg.name);\r\n      if (res.version) {\r\n        config.set('latest', res.version);\r\n        config.set('lastUpdateCheck', now);\r\n      }\r\n    } catch {\r\n      // silence error if offline\r\n    }\r\n  };\r\n\r\n  const display = (notifInterval: number) => {\r\n    const now = Date.now();\r\n    const latestVersion = config.get('latest');\r\n    const lastNotification = config.get('lastNotification') || 0;\r\n\r\n    if (\r\n      !process.stdout.isTTY ||\r\n      lastNotification + notifInterval > now ||\r\n      !semver.valid(latestVersion) ||\r\n      !semver.valid(pkg.version) ||\r\n      semver.lte(latestVersion, pkg.version)\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const message = boxen(getUpdateMessage(latestVersion, pkg.version), boxenOptions);\r\n    config.set('lastNotification', now);\r\n    console.log(message);\r\n  };\r\n\r\n  // TODO v6: Remove this warning\r\n  if (env.bool('STRAPI_DISABLE_UPDATE_NOTIFICATION', false)) {\r\n    strapi.log.warn(\r\n      'STRAPI_DISABLE_UPDATE_NOTIFICATION is no longer supported. Instead, set logger.updates.enabled to false in your server configuration.'\r\n    );\r\n  }\r\n\r\n  if (!strapi.config.get('server.logger.updates.enabled') || !config) {\r\n    return;\r\n  }\r\n\r\n  display(NOTIF_INTERVAL);\r\n  checkUpdate(CHECK_INTERVAL); // doesn't need to await\r\n};\r\n"],"names":[],"mappings":";;;;;;;AAUA,MAAM,MAAM,QAAQ,uBAAuB;AAE3C,MAAM,iBAAiB,MAAO,KAAK,KAAK,KAAK;AAC7C,MAAM,iBAAiB,MAAO,KAAK,KAAK,KAAK;AAC7C,MAAM,eAA8B;AAAA,EAClC,SAAS;AAAA,EACT,QAAQ;AAAA,EACR,OAAO;AAAA,EACP,aAAa;AAAA,EACb,aAAa;AACf;AAEA,MAAM,mBAAmB,CAAC,YAAoB,mBAA2B;AACjE,QAAA,oBAAoB,MAAM,IAAI,cAAc;AAC5C,QAAA,gBAAgB,MAAM,MAAM,UAAU;AACtC,QAAA,cAAc,MAAM,KAAK,2CAA2C;AAEnE,SAAA;AAAA,uCAC8B,iBAAiB,MAAM,aAAa;AAAA,iCAC1C,WAAW;AAAA,EAC1C,KAAK;AACP;AAEa,MAAA,uBAAuB,CAAC,WAAwB;AACvD,MAAA;AAEA,MAAA;AACF,aAAS,IAAI;AAAA,MACX,IAAI;AAAA,MACJ,CAAC;AAAA,MACD,EAAE,YAAY,KAAK,KAAK,OAAO,KAAK,IAAI,MAAM,sBAAsB,EAAE;AAAA,IACxE;AAAA,EAAA,QACM;AAGN;AAAA,EAAA;AAGI,QAAA,cAAc,OAAO,kBAA0B;AAC7C,UAAA,MAAM,KAAK,IAAI;AACrB,UAAM,kBAAkB,OAAO,IAAI,iBAAiB,KAAK;AACrD,QAAA,kBAAkB,gBAAgB,KAAK;AACzC;AAAA,IAAA;AAGE,QAAA;AACF,YAAM,MAAM,MAAM,YAAY,IAAI,IAAI;AACtC,UAAI,IAAI,SAAS;AACR,eAAA,IAAI,UAAU,IAAI,OAAO;AACzB,eAAA,IAAI,mBAAmB,GAAG;AAAA,MAAA;AAAA,IACnC,QACM;AAAA,IAAA;AAAA,EAGV;AAEM,QAAA,UAAU,CAAC,kBAA0B;AACnC,UAAA,MAAM,KAAK,IAAI;AACf,UAAA,gBAAgB,OAAO,IAAI,QAAQ;AACzC,UAAM,mBAAmB,OAAO,IAAI,kBAAkB,KAAK;AAGzD,QAAA,CAAC,QAAQ,OAAO,SAChB,mBAAmB,gBAAgB,OACnC,CAAC,OAAO,MAAM,aAAa,KAC3B,CAAC,OAAO,MAAM,IAAI,OAAO,KACzB,OAAO,IAAI,eAAe,IAAI,OAAO,GACrC;AACA;AAAA,IAAA;AAGF,UAAM,UAAU,MAAM,iBAAiB,eAAe,IAAI,OAAO,GAAG,YAAY;AACzE,WAAA,IAAI,oBAAoB,GAAG;AAClC,YAAQ,IAAI,OAAO;AAAA,EACrB;AAGA,MAAI,IAAI,KAAK,sCAAsC,KAAK,GAAG;AACzD,WAAO,IAAI;AAAA,MACT;AAAA,IACF;AAAA,EAAA;AAGF,MAAI,CAAC,OAAO,OAAO,IAAI,+BAA+B,KAAK,CAAC,QAAQ;AAClE;AAAA,EAAA;AAGF,UAAQ,cAAc;AACtB,cAAY,cAAc;AAC5B;"}