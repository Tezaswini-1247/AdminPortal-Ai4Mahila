{"version":3,"file":"events.js","sources":["../../../src/services/document-service/events.ts"],"sourcesContent":["import { UID, Utils, Modules, Core } from '@strapi/types';\r\nimport { sanitize } from '@strapi/utils';\r\n\r\nimport { getDeepPopulate } from './utils/populate';\r\n\r\nconst EVENTS = {\r\n  ENTRY_CREATE: 'entry.create',\r\n  ENTRY_UPDATE: 'entry.update',\r\n  ENTRY_DELETE: 'entry.delete',\r\n  ENTRY_PUBLISH: 'entry.publish',\r\n  ENTRY_UNPUBLISH: 'entry.unpublish',\r\n  ENTRY_DRAFT_DISCARD: 'entry.draft-discard',\r\n};\r\n\r\ntype EventName = Utils.Object.Values<typeof EVENTS>;\r\n\r\n/**\r\n * Manager to trigger entry related events\r\n *\r\n * It will populate the entry if it is not a delete event.\r\n * So the event payload will contain the full entry.\r\n */\r\nconst createEventManager = (strapi: Core.Strapi, uid: UID.Schema) => {\r\n  const populate = getDeepPopulate(uid, {});\r\n  const model = strapi.getModel(uid);\r\n\r\n  const emitEvent = async (eventName: EventName, entry: Modules.Documents.AnyDocument) => {\r\n    // There is no need to populate the entry if it has been deleted\r\n    let populatedEntry = entry;\r\n    if (![EVENTS.ENTRY_DELETE, EVENTS.ENTRY_UNPUBLISH].includes(eventName)) {\r\n      populatedEntry = await strapi.db.query(uid).findOne({ where: { id: entry.id }, populate });\r\n    }\r\n\r\n    const sanitizedEntry = await sanitize.sanitizers.defaultSanitizeOutput(\r\n      {\r\n        schema: model,\r\n        getModel: (uid) => strapi.getModel(uid as UID.Schema),\r\n      },\r\n      populatedEntry\r\n    );\r\n\r\n    await strapi.eventHub.emit(eventName, {\r\n      model: model.modelName,\r\n      uid: model.uid,\r\n      entry: sanitizedEntry,\r\n    });\r\n  };\r\n\r\n  return {\r\n    /**\r\n     * strapi.db.query might reuse the transaction used in the doc service request,\r\n     * so this is executed after that transaction is committed.\r\n     */\r\n    emitEvent(eventName: EventName, entry: Modules.Documents.AnyDocument) {\r\n      strapi.db.transaction(({ onCommit }) => {\r\n        onCommit(() => emitEvent(eventName, entry));\r\n      });\r\n    },\r\n  };\r\n};\r\n\r\nexport { createEventManager };\r\n"],"names":["populate","getDeepPopulate","sanitize","uid"],"mappings":";;;;AAKA,MAAM,SAAS;AAAA,EACb,cAAc;AAAA,EACd,cAAc;AAAA,EACd,cAAc;AAAA,EACd,eAAe;AAAA,EACf,iBAAiB;AAAA,EACjB,qBAAqB;AACvB;AAUM,MAAA,qBAAqB,CAAC,QAAqB,QAAoB;AACnE,QAAMA,aAAWC,SAAAA,gBAAgB,KAAK,EAAE;AAClC,QAAA,QAAQ,OAAO,SAAS,GAAG;AAE3B,QAAA,YAAY,OAAO,WAAsB,UAAyC;AAEtF,QAAI,iBAAiB;AACjB,QAAA,CAAC,CAAC,OAAO,cAAc,OAAO,eAAe,EAAE,SAAS,SAAS,GAAG;AACtE,uBAAiB,MAAM,OAAO,GAAG,MAAM,GAAG,EAAE,QAAQ,EAAE,OAAO,EAAE,IAAI,MAAM,GAAG,GAAA,UAAGD,YAAU;AAAA,IAAA;AAGrF,UAAA,iBAAiB,MAAME,qBAAS,WAAW;AAAA,MAC/C;AAAA,QACE,QAAQ;AAAA,QACR,UAAU,CAACC,SAAQ,OAAO,SAASA,IAAiB;AAAA,MACtD;AAAA,MACA;AAAA,IACF;AAEM,UAAA,OAAO,SAAS,KAAK,WAAW;AAAA,MACpC,OAAO,MAAM;AAAA,MACb,KAAK,MAAM;AAAA,MACX,OAAO;AAAA,IAAA,CACR;AAAA,EACH;AAEO,SAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAKL,UAAU,WAAsB,OAAsC;AACpE,aAAO,GAAG,YAAY,CAAC,EAAE,eAAe;AACtC,iBAAS,MAAM,UAAU,WAAW,KAAK,CAAC;AAAA,MAAA,CAC3C;AAAA,IAAA;AAAA,EAEL;AACF;;"}