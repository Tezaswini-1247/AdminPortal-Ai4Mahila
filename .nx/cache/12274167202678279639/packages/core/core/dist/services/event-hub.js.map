{"version":3,"file":"event-hub.js","sources":["../../src/services/event-hub.ts"],"sourcesContent":["export type Subscriber = (eventName: string, ...args: any[]) => Promise<void>;\r\nexport type Listener = (...args: any[]) => Promise<void>;\r\n\r\nexport interface EventHub {\r\n  emit(eventName: string, ...args: unknown[]): Promise<void>;\r\n  subscribe(subscriber: Subscriber): () => void;\r\n  unsubscribe(subscriber: Subscriber): void;\r\n  on(eventName: string, listener: Listener): () => void;\r\n  off(eventName: string, listener: Listener): void;\r\n  once(eventName: string, listener: Listener): () => void;\r\n  destroy(): EventHub;\r\n  removeListener(eventName: string, listener: Listener): void;\r\n  removeAllListeners(): EventHub;\r\n  removeAllSubscribers(): EventHub;\r\n  addListener(eventName: string, listener: Listener): () => void;\r\n}\r\n\r\n/**\r\n * The event hub is Strapi's event control center.\r\n */\r\nexport default function createEventHub(): EventHub {\r\n  const listeners = new Map();\r\n\r\n  // Default subscriber to easily add listeners with the on() method\r\n  const defaultSubscriber = async (eventName: string, ...args: unknown[]) => {\r\n    if (listeners.has(eventName)) {\r\n      for (const listener of listeners.get(eventName)) {\r\n        await listener(...args);\r\n      }\r\n    }\r\n  };\r\n\r\n  // Store of subscribers that will be called when an event is emitted\r\n  const subscribers = [defaultSubscriber];\r\n\r\n  const eventHub: EventHub = {\r\n    async emit(eventName, ...args) {\r\n      for (const subscriber of subscribers) {\r\n        await subscriber(eventName, ...args);\r\n      }\r\n    },\r\n\r\n    subscribe(subscriber) {\r\n      subscribers.push(subscriber);\r\n\r\n      // Return a function to remove the subscriber\r\n      return () => {\r\n        eventHub.unsubscribe(subscriber);\r\n      };\r\n    },\r\n\r\n    unsubscribe(subscriber) {\r\n      const subscriberIndex = subscribers.indexOf(subscriber);\r\n\r\n      // Only remove the subscriber if it exists\r\n      if (subscriberIndex >= 0) {\r\n        subscribers.splice(subscriberIndex, 1);\r\n      }\r\n    },\r\n\r\n    on(eventName, listener) {\r\n      if (!listeners.has(eventName)) {\r\n        listeners.set(eventName, [listener]);\r\n      } else {\r\n        listeners.get(eventName).push(listener);\r\n      }\r\n\r\n      // Return a function to remove the listener\r\n      return () => {\r\n        eventHub.off(eventName, listener);\r\n      };\r\n    },\r\n\r\n    off(eventName, listener) {\r\n      listeners.get(eventName)?.splice(listeners.get(eventName).indexOf(listener), 1);\r\n    },\r\n\r\n    once(eventName, listener) {\r\n      return eventHub.on(eventName, async (...args) => {\r\n        eventHub.off(eventName, listener);\r\n        return listener(...args);\r\n      });\r\n    },\r\n\r\n    destroy() {\r\n      this.removeAllListeners();\r\n      this.removeAllSubscribers();\r\n      return this;\r\n    },\r\n\r\n    removeListener(eventName, listener) {\r\n      return eventHub.off(eventName, listener);\r\n    },\r\n\r\n    removeAllListeners() {\r\n      listeners.clear();\r\n      return this;\r\n    },\r\n\r\n    removeAllSubscribers() {\r\n      subscribers.length = 0;\r\n      return this;\r\n    },\r\n\r\n    addListener(eventName, listener) {\r\n      return eventHub.on(eventName, listener);\r\n    },\r\n  };\r\n\r\n  return eventHub;\r\n}\r\n"],"names":[],"mappings":";AAoBA,SAAwB,iBAA2B;AAC3C,QAAA,gCAAgB,IAAI;AAGpB,QAAA,oBAAoB,OAAO,cAAsB,SAAoB;AACrE,QAAA,UAAU,IAAI,SAAS,GAAG;AAC5B,iBAAW,YAAY,UAAU,IAAI,SAAS,GAAG;AACzC,cAAA,SAAS,GAAG,IAAI;AAAA,MAAA;AAAA,IACxB;AAAA,EAEJ;AAGM,QAAA,cAAc,CAAC,iBAAiB;AAEtC,QAAM,WAAqB;AAAA,IACzB,MAAM,KAAK,cAAc,MAAM;AAC7B,iBAAW,cAAc,aAAa;AAC9B,cAAA,WAAW,WAAW,GAAG,IAAI;AAAA,MAAA;AAAA,IAEvC;AAAA,IAEA,UAAU,YAAY;AACpB,kBAAY,KAAK,UAAU;AAG3B,aAAO,MAAM;AACX,iBAAS,YAAY,UAAU;AAAA,MACjC;AAAA,IACF;AAAA,IAEA,YAAY,YAAY;AAChB,YAAA,kBAAkB,YAAY,QAAQ,UAAU;AAGtD,UAAI,mBAAmB,GAAG;AACZ,oBAAA,OAAO,iBAAiB,CAAC;AAAA,MAAA;AAAA,IAEzC;AAAA,IAEA,GAAG,WAAW,UAAU;AACtB,UAAI,CAAC,UAAU,IAAI,SAAS,GAAG;AAC7B,kBAAU,IAAI,WAAW,CAAC,QAAQ,CAAC;AAAA,MAAA,OAC9B;AACL,kBAAU,IAAI,SAAS,EAAE,KAAK,QAAQ;AAAA,MAAA;AAIxC,aAAO,MAAM;AACF,iBAAA,IAAI,WAAW,QAAQ;AAAA,MAClC;AAAA,IACF;AAAA,IAEA,IAAI,WAAW,UAAU;AACb,gBAAA,IAAI,SAAS,GAAG,OAAO,UAAU,IAAI,SAAS,EAAE,QAAQ,QAAQ,GAAG,CAAC;AAAA,IAChF;AAAA,IAEA,KAAK,WAAW,UAAU;AACxB,aAAO,SAAS,GAAG,WAAW,UAAU,SAAS;AACtC,iBAAA,IAAI,WAAW,QAAQ;AACzB,eAAA,SAAS,GAAG,IAAI;AAAA,MAAA,CACxB;AAAA,IACH;AAAA,IAEA,UAAU;AACR,WAAK,mBAAmB;AACxB,WAAK,qBAAqB;AACnB,aAAA;AAAA,IACT;AAAA,IAEA,eAAe,WAAW,UAAU;AAC3B,aAAA,SAAS,IAAI,WAAW,QAAQ;AAAA,IACzC;AAAA,IAEA,qBAAqB;AACnB,gBAAU,MAAM;AACT,aAAA;AAAA,IACT;AAAA,IAEA,uBAAuB;AACrB,kBAAY,SAAS;AACd,aAAA;AAAA,IACT;AAAA,IAEA,YAAY,WAAW,UAAU;AACxB,aAAA,SAAS,GAAG,WAAW,QAAQ;AAAA,IAAA;AAAA,EAE1C;AAEO,SAAA;AACT;;"}