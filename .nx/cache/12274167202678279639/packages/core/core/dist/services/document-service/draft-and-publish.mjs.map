{"version":3,"file":"draft-and-publish.mjs","sources":["../../../src/services/document-service/draft-and-publish.ts"],"sourcesContent":["import { assoc, curry } from 'lodash/fp';\r\n\r\nimport { Modules, Struct } from '@strapi/types';\r\nimport { contentTypes } from '@strapi/utils';\r\n\r\ntype ParamsTransform = (params: Modules.Documents.Params.All) => Modules.Documents.Params.All;\r\n\r\ntype TransformWithContentType = (\r\n  contentType: Struct.SingleTypeSchema | Struct.CollectionTypeSchema,\r\n  params: Modules.Documents.Params.All\r\n) => Modules.Documents.Params.All;\r\n\r\n/**\r\n * DP enabled -> set status to draft\r\n * DP disabled -> Used mostly for parsing relations, so there is not a need for a default.\r\n */\r\nconst setStatusToDraft: TransformWithContentType = (contentType, params) => {\r\n  if (!contentTypes.hasDraftAndPublish(contentType) && params.status) {\r\n    return params;\r\n  }\r\n\r\n  return assoc('status', 'draft', params);\r\n};\r\n\r\n/**\r\n * Adds a default status of `draft` to the params\r\n */\r\nconst defaultToDraft: ParamsTransform = (params) => {\r\n  // Default to draft if no status is provided or it's invalid\r\n  if (!params.status || params.status !== 'published') {\r\n    return assoc('status', 'draft', params);\r\n  }\r\n\r\n  return params;\r\n};\r\n\r\n/**\r\n * DP disabled -> ignore status\r\n * DP enabled -> set status to draft if no status is provided or it's invalid\r\n */\r\nconst defaultStatus: TransformWithContentType = (contentType, params) => {\r\n  if (!contentTypes.hasDraftAndPublish(contentType)) {\r\n    return params;\r\n  }\r\n\r\n  // Default to draft if no status is provided or it's invalid\r\n  if (!params.status || params.status !== 'published') {\r\n    return defaultToDraft(params);\r\n  }\r\n\r\n  return params;\r\n};\r\n\r\n/**\r\n * In mutating actions we don't want user to set the publishedAt attribute.\r\n */\r\nconst filterDataPublishedAt: ParamsTransform = (params) => {\r\n  if (params?.data?.publishedAt) {\r\n    return assoc(['data', 'publishedAt'], null, params);\r\n  }\r\n\r\n  return params;\r\n};\r\n\r\n/**\r\n * Add status lookup query to the params\r\n */\r\nconst statusToLookup: TransformWithContentType = (contentType, params) => {\r\n  if (!contentTypes.hasDraftAndPublish(contentType)) {\r\n    return params;\r\n  }\r\n\r\n  const lookup = params.lookup || {};\r\n\r\n  switch (params?.status) {\r\n    case 'published':\r\n      return assoc(['lookup', 'publishedAt'], { $notNull: true }, params);\r\n    case 'draft':\r\n      return assoc(['lookup', 'publishedAt'], { $null: true }, params);\r\n    default:\r\n      break;\r\n  }\r\n\r\n  return assoc('lookup', lookup, params);\r\n};\r\n\r\n/**\r\n * Translate publication status parameter into the data that will be saved\r\n */\r\nconst statusToData: TransformWithContentType = (contentType, params) => {\r\n  if (!contentTypes.hasDraftAndPublish(contentType)) {\r\n    return assoc(['data', 'publishedAt'], new Date(), params);\r\n  }\r\n\r\n  switch (params?.status) {\r\n    case 'published':\r\n      return assoc(['data', 'publishedAt'], new Date(), params);\r\n    case 'draft':\r\n      return assoc(['data', 'publishedAt'], null, params);\r\n    default:\r\n      break;\r\n  }\r\n\r\n  return params;\r\n};\r\n\r\nconst setStatusToDraftCurry = curry(setStatusToDraft);\r\nconst defaultToDraftCurry = curry(defaultToDraft);\r\nconst defaultStatusCurry = curry(defaultStatus);\r\nconst filterDataPublishedAtCurry = curry(filterDataPublishedAt);\r\nconst statusToLookupCurry = curry(statusToLookup);\r\nconst statusToDataCurry = curry(statusToData);\r\n\r\nexport {\r\n  setStatusToDraftCurry as setStatusToDraft,\r\n  defaultToDraftCurry as defaultToDraft,\r\n  defaultStatusCurry as defaultStatus,\r\n  filterDataPublishedAtCurry as filterDataPublishedAt,\r\n  statusToLookupCurry as statusToLookup,\r\n  statusToDataCurry as statusToData,\r\n};\r\n"],"names":[],"mappings":";;AAgBA,MAAM,mBAA6C,CAAC,aAAa,WAAW;AAC1E,MAAI,CAAC,aAAa,mBAAmB,WAAW,KAAK,OAAO,QAAQ;AAC3D,WAAA;AAAA,EAAA;AAGF,SAAA,MAAM,UAAU,SAAS,MAAM;AACxC;AAKA,MAAM,iBAAkC,CAAC,WAAW;AAElD,MAAI,CAAC,OAAO,UAAU,OAAO,WAAW,aAAa;AAC5C,WAAA,MAAM,UAAU,SAAS,MAAM;AAAA,EAAA;AAGjC,SAAA;AACT;AAMA,MAAM,gBAA0C,CAAC,aAAa,WAAW;AACvE,MAAI,CAAC,aAAa,mBAAmB,WAAW,GAAG;AAC1C,WAAA;AAAA,EAAA;AAIT,MAAI,CAAC,OAAO,UAAU,OAAO,WAAW,aAAa;AACnD,WAAO,eAAe,MAAM;AAAA,EAAA;AAGvB,SAAA;AACT;AAKA,MAAM,wBAAyC,CAAC,WAAW;AACrD,MAAA,QAAQ,MAAM,aAAa;AAC7B,WAAO,MAAM,CAAC,QAAQ,aAAa,GAAG,MAAM,MAAM;AAAA,EAAA;AAG7C,SAAA;AACT;AAKA,MAAM,iBAA2C,CAAC,aAAa,WAAW;AACxE,MAAI,CAAC,aAAa,mBAAmB,WAAW,GAAG;AAC1C,WAAA;AAAA,EAAA;AAGH,QAAA,SAAS,OAAO,UAAU,CAAC;AAEjC,UAAQ,QAAQ,QAAQ;AAAA,IACtB,KAAK;AACI,aAAA,MAAM,CAAC,UAAU,aAAa,GAAG,EAAE,UAAU,KAAK,GAAG,MAAM;AAAA,IACpE,KAAK;AACI,aAAA,MAAM,CAAC,UAAU,aAAa,GAAG,EAAE,OAAO,KAAK,GAAG,MAAM;AAAA,EAE/D;AAGG,SAAA,MAAM,UAAU,QAAQ,MAAM;AACvC;AAKA,MAAM,eAAyC,CAAC,aAAa,WAAW;AACtE,MAAI,CAAC,aAAa,mBAAmB,WAAW,GAAG;AAC1C,WAAA,MAAM,CAAC,QAAQ,aAAa,GAAO,oBAAA,QAAQ,MAAM;AAAA,EAAA;AAG1D,UAAQ,QAAQ,QAAQ;AAAA,IACtB,KAAK;AACI,aAAA,MAAM,CAAC,QAAQ,aAAa,GAAO,oBAAA,QAAQ,MAAM;AAAA,IAC1D,KAAK;AACH,aAAO,MAAM,CAAC,QAAQ,aAAa,GAAG,MAAM,MAAM;AAAA,EAElD;AAGG,SAAA;AACT;AAEM,MAAA,wBAAwB,MAAM,gBAAgB;AAC9C,MAAA,sBAAsB,MAAM,cAAc;AAC1C,MAAA,qBAAqB,MAAM,aAAa;AACxC,MAAA,6BAA6B,MAAM,qBAAqB;AACxD,MAAA,sBAAsB,MAAM,cAAc;AAC1C,MAAA,oBAAoB,MAAM,YAAY;"}