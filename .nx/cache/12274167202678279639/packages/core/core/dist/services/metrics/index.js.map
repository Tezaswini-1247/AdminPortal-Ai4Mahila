{"version":3,"file":"index.js","sources":["../../../src/services/metrics/index.ts"],"sourcesContent":["/**\r\n * Strapi telemetry package.\r\n * You can learn more at https://docs.strapi.io/developer-docs/latest/getting-started/usage-information.html\r\n */\r\n\r\nimport { Job, scheduleJob } from 'node-schedule';\r\nimport type { Core } from '@strapi/types';\r\n\r\nimport wrapWithRateLimit from './rate-limiter';\r\nimport createSender from './sender';\r\nimport createMiddleware from './middleware';\r\nimport isTruthy from './is-truthy';\r\n\r\nconst LIMITED_EVENTS = [\r\n  'didSaveMediaWithAlternativeText',\r\n  'didSaveMediaWithCaption',\r\n  'didDisableResponsiveDimensions',\r\n  'didEnableResponsiveDimensions',\r\n  'didInitializePluginUpload',\r\n];\r\n\r\nconst createTelemetryInstance = (strapi: Core.Strapi) => {\r\n  const uuid = strapi.config.get('uuid');\r\n  const telemetryDisabled = strapi.config.get('packageJsonStrapi.telemetryDisabled');\r\n  const isDisabled =\r\n    !uuid || isTruthy(process.env.STRAPI_TELEMETRY_DISABLED) || isTruthy(telemetryDisabled);\r\n\r\n  const crons: Job[] = [];\r\n  const sender = createSender(strapi);\r\n  const sendEvent = wrapWithRateLimit(sender, { limitedEvents: LIMITED_EVENTS });\r\n\r\n  return {\r\n    get isDisabled() {\r\n      return isDisabled;\r\n    },\r\n\r\n    register() {\r\n      if (!isDisabled) {\r\n        const pingCron = scheduleJob('0 0 12 * * *', () => sendEvent('ping'));\r\n        crons.push(pingCron);\r\n\r\n        strapi.server.use(createMiddleware({ sendEvent }));\r\n      }\r\n    },\r\n\r\n    bootstrap() {},\r\n\r\n    destroy() {\r\n      // Clear open handles\r\n      crons.forEach((cron) => cron.cancel());\r\n    },\r\n\r\n    async send(event: string, payload: Record<string, unknown> = {}) {\r\n      if (isDisabled) return true;\r\n      return sendEvent(event, payload);\r\n    },\r\n  };\r\n};\r\n\r\nexport default createTelemetryInstance;\r\n"],"names":["sender","createSender","wrapWithRateLimit","scheduleJob","createMiddleware"],"mappings":";;;;;;AAaA,MAAM,iBAAiB;AAAA,EACrB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAEM,MAAA,0BAA0B,CAAC,WAAwB;AACvD,QAAM,OAAO,OAAO,OAAO,IAAI,MAAM;AACrC,QAAM,oBAAoB,OAAO,OAAO,IAAI,qCAAqC;AAC3E,QAAA,aACJ,CAAC,QAAQ,SAAS,QAAQ,IAAI,yBAAyB,KAAK,SAAS,iBAAiB;AAExF,QAAM,QAAe,CAAC;AAChB,QAAAA,WAASC,OAAa,MAAM;AAClC,QAAM,YAAYC,YAAkBF,UAAQ,EAAE,eAAe,gBAAgB;AAEtE,SAAA;AAAA,IACL,IAAI,aAAa;AACR,aAAA;AAAA,IACT;AAAA,IAEA,WAAW;AACT,UAAI,CAAC,YAAY;AACf,cAAM,WAAWG,aAAAA,YAAY,gBAAgB,MAAM,UAAU,MAAM,CAAC;AACpE,cAAM,KAAK,QAAQ;AAEnB,eAAO,OAAO,IAAIC,WAAiB,EAAE,UAAW,CAAA,CAAC;AAAA,MAAA;AAAA,IAErD;AAAA,IAEA,YAAY;AAAA,IAAC;AAAA,IAEb,UAAU;AAER,YAAM,QAAQ,CAAC,SAAS,KAAK,QAAQ;AAAA,IACvC;AAAA,IAEA,MAAM,KAAK,OAAe,UAAmC,IAAI;AAC/D,UAAI,WAAmB,QAAA;AAChB,aAAA,UAAU,OAAO,OAAO;AAAA,IAAA;AAAA,EAEnC;AACF;;"}