{"version":3,"file":"routing.mjs","sources":["../../../src/services/server/routing.ts"],"sourcesContent":["import Router from '@koa/router';\r\nimport { has } from 'lodash/fp';\r\nimport { yup } from '@strapi/utils';\r\nimport type { Core } from '@strapi/types';\r\n\r\nimport createEndpointComposer from './compose-endpoint';\r\n\r\nconst policyOrMiddlewareSchema = yup.lazy((value) => {\r\n  if (typeof value === 'string') {\r\n    return yup.string().required();\r\n  }\r\n\r\n  if (typeof value === 'function') {\r\n    return yup.mixed().isFunction();\r\n  }\r\n\r\n  return yup.object({\r\n    name: yup.string().required(),\r\n    options: yup.object().notRequired(), // any options\r\n  });\r\n});\r\n\r\nconst routeSchema = yup.object({\r\n  method: yup.string().oneOf(['GET', 'POST', 'PUT', 'PATCH', 'DELETE', 'ALL']).required(),\r\n  path: yup.string().required(),\r\n  handler: yup.lazy((value) => {\r\n    if (typeof value === 'string') {\r\n      return yup.string().required();\r\n    }\r\n\r\n    if (Array.isArray(value)) {\r\n      return yup.array().required();\r\n    }\r\n\r\n    return yup.mixed().isFunction().required();\r\n  }),\r\n  config: yup\r\n    .object({\r\n      auth: yup.lazy((value) => {\r\n        if (value === false) {\r\n          return yup.boolean().required();\r\n        }\r\n\r\n        return yup.object({\r\n          scope: yup.array().of(yup.string()).required(),\r\n        });\r\n      }),\r\n      policies: yup\r\n        .array()\r\n        // FIXME: fixed in yup v1\r\n        .of(policyOrMiddlewareSchema as any)\r\n        .notRequired(),\r\n      middlewares: yup\r\n        .array()\r\n        // FIXME: fixed in yup v1\r\n        .of(policyOrMiddlewareSchema as any)\r\n        .notRequired(),\r\n    })\r\n    .notRequired(),\r\n});\r\n\r\nconst validateRouteConfig = (routeConfig: Core.RouteInput) => {\r\n  try {\r\n    return routeSchema.validateSync(routeConfig, {\r\n      strict: true,\r\n      abortEarly: false,\r\n      stripUnknown: true,\r\n    });\r\n  } catch (error) {\r\n    if (error instanceof yup.ValidationError) {\r\n      throw new Error(`Invalid route config ${error.message}`);\r\n    }\r\n  }\r\n};\r\n\r\nconst createRouteManager = (strapi: Core.Strapi, opts: { type?: string } = {}) => {\r\n  const { type } = opts;\r\n\r\n  const composeEndpoint = createEndpointComposer(strapi);\r\n\r\n  const createRoute = (route: Core.RouteInput, router: Router) => {\r\n    validateRouteConfig(route);\r\n\r\n    // NOTE: the router type is used to tag controller actions and for authentication / authorization so we need to pass this info down to the route level\r\n    const routeWithInfo = Object.assign(route, {\r\n      info: {\r\n        ...(route.info ?? {}),\r\n        type: type || 'api',\r\n      },\r\n    });\r\n\r\n    composeEndpoint(routeWithInfo, { router });\r\n  };\r\n\r\n  const addRoutes = (routes: Core.Router | Core.RouteInput[], router: Router) => {\r\n    if (Array.isArray(routes)) {\r\n      routes.forEach((route) => createRoute(route, router));\r\n    } else if (routes.routes) {\r\n      const subRouter = new Router({ prefix: routes.prefix });\r\n\r\n      routes.routes.forEach((route) => {\r\n        const hasPrefix = has('prefix', route.config);\r\n        createRoute(route, hasPrefix ? router : subRouter);\r\n      });\r\n\r\n      return router.use(subRouter.routes(), subRouter.allowedMethods());\r\n    }\r\n  };\r\n\r\n  return {\r\n    addRoutes,\r\n  };\r\n};\r\n\r\nexport { validateRouteConfig, createRouteManager };\r\n"],"names":[],"mappings":";;;;AAOA,MAAM,2BAA2B,IAAI,KAAK,CAAC,UAAU;AAC/C,MAAA,OAAO,UAAU,UAAU;AACtB,WAAA,IAAI,OAAO,EAAE,SAAS;AAAA,EAAA;AAG3B,MAAA,OAAO,UAAU,YAAY;AACxB,WAAA,IAAI,MAAM,EAAE,WAAW;AAAA,EAAA;AAGhC,SAAO,IAAI,OAAO;AAAA,IAChB,MAAM,IAAI,OAAO,EAAE,SAAS;AAAA,IAC5B,SAAS,IAAI,OAAO,EAAE,YAAY;AAAA;AAAA,EAAA,CACnC;AACH,CAAC;AAED,MAAM,cAAc,IAAI,OAAO;AAAA,EAC7B,QAAQ,IAAI,SAAS,MAAM,CAAC,OAAO,QAAQ,OAAO,SAAS,UAAU,KAAK,CAAC,EAAE,SAAS;AAAA,EACtF,MAAM,IAAI,OAAO,EAAE,SAAS;AAAA,EAC5B,SAAS,IAAI,KAAK,CAAC,UAAU;AACvB,QAAA,OAAO,UAAU,UAAU;AACtB,aAAA,IAAI,OAAO,EAAE,SAAS;AAAA,IAAA;AAG3B,QAAA,MAAM,QAAQ,KAAK,GAAG;AACjB,aAAA,IAAI,MAAM,EAAE,SAAS;AAAA,IAAA;AAG9B,WAAO,IAAI,MAAA,EAAQ,WAAA,EAAa,SAAS;AAAA,EAAA,CAC1C;AAAA,EACD,QAAQ,IACL,OAAO;AAAA,IACN,MAAM,IAAI,KAAK,CAAC,UAAU;AACxB,UAAI,UAAU,OAAO;AACZ,eAAA,IAAI,QAAQ,EAAE,SAAS;AAAA,MAAA;AAGhC,aAAO,IAAI,OAAO;AAAA,QAChB,OAAO,IAAI,MAAM,EAAE,GAAG,IAAI,OAAQ,CAAA,EAAE,SAAS;AAAA,MAAA,CAC9C;AAAA,IAAA,CACF;AAAA,IACD,UAAU,IACP,MAAA,EAEA,GAAG,wBAA+B,EAClC,YAAY;AAAA,IACf,aAAa,IACV,MAAA,EAEA,GAAG,wBAA+B,EAClC,YAAY;AAAA,EAChB,CAAA,EACA,YAAY;AACjB,CAAC;AAEK,MAAA,sBAAsB,CAAC,gBAAiC;AACxD,MAAA;AACK,WAAA,YAAY,aAAa,aAAa;AAAA,MAC3C,QAAQ;AAAA,MACR,YAAY;AAAA,MACZ,cAAc;AAAA,IAAA,CACf;AAAA,WACM,OAAO;AACV,QAAA,iBAAiB,IAAI,iBAAiB;AACxC,YAAM,IAAI,MAAM,wBAAwB,MAAM,OAAO,EAAE;AAAA,IAAA;AAAA,EACzD;AAEJ;AAEA,MAAM,qBAAqB,CAAC,QAAqB,OAA0B,OAAO;AAC1E,QAAA,EAAE,SAAS;AAEX,QAAA,kBAAkB,uBAAuB,MAAM;AAE/C,QAAA,cAAc,CAAC,OAAwB,WAAmB;AAC9D,wBAAoB,KAAK;AAGnB,UAAA,gBAAgB,OAAO,OAAO,OAAO;AAAA,MACzC,MAAM;AAAA,QACJ,GAAI,MAAM,QAAQ,CAAC;AAAA,QACnB,MAAM,QAAQ;AAAA,MAAA;AAAA,IAChB,CACD;AAEe,oBAAA,eAAe,EAAE,QAAQ;AAAA,EAC3C;AAEM,QAAA,YAAY,CAAC,QAAyC,WAAmB;AACzE,QAAA,MAAM,QAAQ,MAAM,GAAG;AACzB,aAAO,QAAQ,CAAC,UAAU,YAAY,OAAO,MAAM,CAAC;AAAA,IAAA,WAC3C,OAAO,QAAQ;AACxB,YAAM,YAAY,IAAI,OAAO,EAAE,QAAQ,OAAO,QAAQ;AAE/C,aAAA,OAAO,QAAQ,CAAC,UAAU;AAC/B,cAAM,YAAY,IAAI,UAAU,MAAM,MAAM;AAChC,oBAAA,OAAO,YAAY,SAAS,SAAS;AAAA,MAAA,CAClD;AAED,aAAO,OAAO,IAAI,UAAU,UAAU,UAAU,gBAAgB;AAAA,IAAA;AAAA,EAEpE;AAEO,SAAA;AAAA,IACL;AAAA,EACF;AACF;"}