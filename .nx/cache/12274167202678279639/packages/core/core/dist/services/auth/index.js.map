{"version":3,"file":"index.js","sources":["../../../src/services/auth/index.ts"],"sourcesContent":["import assert from 'assert/strict';\r\nimport { has } from 'lodash/fp';\r\n\r\nimport { errors } from '@strapi/utils';\r\nimport type { Core } from '@strapi/types';\r\nimport type { ParameterizedContext } from 'koa';\r\n\r\ninterface AuthenticationResponse {\r\n  authenticated?: boolean;\r\n  credentials?: unknown;\r\n  ability?: unknown;\r\n  error?: Error | null;\r\n}\r\n\r\ninterface AuthenticationInfo {\r\n  strategy: Strategy;\r\n  credentials: unknown;\r\n  ability: unknown;\r\n}\r\n\r\ninterface Strategy {\r\n  name: string;\r\n  authenticate: (ctx: ParameterizedContext) => Promise<AuthenticationResponse>;\r\n  verify?: (auth: AuthenticationInfo, config: Core.RouteConfig['auth']) => Promise<any>;\r\n}\r\n\r\ninterface Authentication {\r\n  register: (type: string, strategy: Strategy) => Authentication;\r\n  authenticate: Core.MiddlewareHandler;\r\n  verify: (auth: AuthenticationInfo, config?: Core.RouteConfig['auth']) => Promise<any>;\r\n}\r\n\r\nconst INVALID_STRATEGY_MSG =\r\n  'Invalid auth strategy. Expecting an object with properties {name: string, authenticate: function, verify: function}';\r\n\r\nconst validStrategy = (strategy: Strategy) => {\r\n  assert(has('authenticate', strategy), INVALID_STRATEGY_MSG);\r\n  assert(typeof strategy.authenticate === 'function', INVALID_STRATEGY_MSG);\r\n\r\n  if (has('verify', strategy)) {\r\n    assert(typeof strategy.verify === 'function', INVALID_STRATEGY_MSG);\r\n  }\r\n};\r\n\r\nconst createAuthentication = (): Authentication => {\r\n  const strategies: Record<string, Strategy[]> = {};\r\n\r\n  return {\r\n    register(type, strategy) {\r\n      validStrategy(strategy);\r\n\r\n      if (!strategies[type]) {\r\n        strategies[type] = [];\r\n      }\r\n\r\n      strategies[type].push(strategy);\r\n\r\n      return this;\r\n    },\r\n\r\n    async authenticate(ctx, next) {\r\n      const route: Core.Route = ctx.state.route;\r\n\r\n      // use route strategy\r\n      const config = route?.config?.auth;\r\n\r\n      if (config === false) {\r\n        return next();\r\n      }\r\n\r\n      const routeStrategies = route.info.type ? strategies[route.info.type] : [];\r\n      const configStrategies = (config?.strategies ?? routeStrategies ?? []) as Array<\r\n        string | Strategy\r\n      >;\r\n\r\n      const strategiesToUse: Strategy[] = configStrategies.reduce(\r\n        (acc, strategy: string | Strategy) => {\r\n          // Resolve by strategy name\r\n          if (typeof strategy === 'string') {\r\n            const routeStrategy = routeStrategies.find((rs) => rs.name === strategy);\r\n\r\n            if (routeStrategy) {\r\n              acc.push(routeStrategy);\r\n            }\r\n          }\r\n\r\n          // Use the given strategy as is\r\n          else if (typeof strategy === 'object') {\r\n            validStrategy(strategy);\r\n\r\n            acc.push(strategy);\r\n          }\r\n\r\n          return acc;\r\n        },\r\n        [] as Strategy[]\r\n      );\r\n\r\n      for (const strategy of strategiesToUse) {\r\n        const result = await strategy.authenticate(ctx);\r\n\r\n        const { authenticated = false, credentials, ability = null, error = null } = result || {};\r\n\r\n        if (error !== null) {\r\n          return ctx.unauthorized(error);\r\n        }\r\n\r\n        if (authenticated) {\r\n          ctx.state.isAuthenticated = true;\r\n          ctx.state.auth = {\r\n            strategy,\r\n            credentials,\r\n            ability,\r\n          };\r\n\r\n          return next();\r\n        }\r\n      }\r\n\r\n      return ctx.unauthorized('Missing or invalid credentials');\r\n    },\r\n\r\n    async verify(auth, config = {}) {\r\n      if (config === false) {\r\n        return;\r\n      }\r\n\r\n      if (!auth) {\r\n        throw new errors.UnauthorizedError();\r\n      }\r\n\r\n      if (typeof auth.strategy.verify === 'function') {\r\n        return auth.strategy.verify(auth, config);\r\n      }\r\n    },\r\n  };\r\n};\r\n\r\nexport default createAuthentication;\r\n"],"names":["assert","has","errors"],"mappings":";;;;;;AAgCA,MAAM,uBACJ;AAEF,MAAM,gBAAgB,CAAC,aAAuB;AAC5CA,kBAAAA,QAAOC,GAAAA,IAAI,gBAAgB,QAAQ,GAAG,oBAAoB;AAC1DD,kBAAAA,QAAO,OAAO,SAAS,iBAAiB,YAAY,oBAAoB;AAEpE,MAAAC,GAAA,IAAI,UAAU,QAAQ,GAAG;AAC3BD,oBAAAA,QAAO,OAAO,SAAS,WAAW,YAAY,oBAAoB;AAAA,EAAA;AAEtE;AAEA,MAAM,uBAAuB,MAAsB;AACjD,QAAM,aAAyC,CAAC;AAEzC,SAAA;AAAA,IACL,SAAS,MAAM,UAAU;AACvB,oBAAc,QAAQ;AAElB,UAAA,CAAC,WAAW,IAAI,GAAG;AACV,mBAAA,IAAI,IAAI,CAAC;AAAA,MAAA;AAGX,iBAAA,IAAI,EAAE,KAAK,QAAQ;AAEvB,aAAA;AAAA,IACT;AAAA,IAEA,MAAM,aAAa,KAAK,MAAM;AACtB,YAAA,QAAoB,IAAI,MAAM;AAG9B,YAAA,SAAS,OAAO,QAAQ;AAE9B,UAAI,WAAW,OAAO;AACpB,eAAO,KAAK;AAAA,MAAA;AAGR,YAAA,kBAAkB,MAAM,KAAK,OAAO,WAAW,MAAM,KAAK,IAAI,IAAI,CAAC;AACzE,YAAM,mBAAoB,QAAQ,cAAc,mBAAmB,CAAC;AAIpE,YAAM,kBAA8B,iBAAiB;AAAA,QACnD,CAAC,KAAK,aAAgC;AAEhC,cAAA,OAAO,aAAa,UAAU;AAChC,kBAAM,gBAAgB,gBAAgB,KAAK,CAAC,OAAO,GAAG,SAAS,QAAQ;AAEvE,gBAAI,eAAe;AACjB,kBAAI,KAAK,aAAa;AAAA,YAAA;AAAA,UACxB,WAIO,OAAO,aAAa,UAAU;AACrC,0BAAc,QAAQ;AAEtB,gBAAI,KAAK,QAAQ;AAAA,UAAA;AAGZ,iBAAA;AAAA,QACT;AAAA,QACA,CAAA;AAAA,MACF;AAEA,iBAAW,YAAY,iBAAiB;AACtC,cAAM,SAAS,MAAM,SAAS,aAAa,GAAG;AAExC,cAAA,EAAE,gBAAgB,OAAO,aAAa,UAAU,MAAM,QAAQ,SAAS,UAAU,CAAC;AAExF,YAAI,UAAU,MAAM;AACX,iBAAA,IAAI,aAAa,KAAK;AAAA,QAAA;AAG/B,YAAI,eAAe;AACjB,cAAI,MAAM,kBAAkB;AAC5B,cAAI,MAAM,OAAO;AAAA,YACf;AAAA,YACA;AAAA,YACA;AAAA,UACF;AAEA,iBAAO,KAAK;AAAA,QAAA;AAAA,MACd;AAGK,aAAA,IAAI,aAAa,gCAAgC;AAAA,IAC1D;AAAA,IAEA,MAAM,OAAO,MAAM,SAAS,IAAI;AAC9B,UAAI,WAAW,OAAO;AACpB;AAAA,MAAA;AAGF,UAAI,CAAC,MAAM;AACH,cAAA,IAAIE,mBAAO,kBAAkB;AAAA,MAAA;AAGrC,UAAI,OAAO,KAAK,SAAS,WAAW,YAAY;AAC9C,eAAO,KAAK,SAAS,OAAO,MAAM,MAAM;AAAA,MAAA;AAAA,IAC1C;AAAA,EAEJ;AACF;;"}