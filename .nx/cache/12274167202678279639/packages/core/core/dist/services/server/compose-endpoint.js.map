{"version":3,"file":"compose-endpoint.js","sources":["../../../src/services/server/compose-endpoint.ts"],"sourcesContent":["import { toLower, castArray, trim, prop, isNil } from 'lodash/fp';\r\nimport type { Core, UID } from '@strapi/types';\r\nimport { errors } from '@strapi/utils';\r\nimport Router from '@koa/router';\r\n\r\nimport compose from 'koa-compose';\r\nimport { resolveRouteMiddlewares } from './middleware';\r\nimport { createPolicicesMiddleware } from './policy';\r\n\r\nconst getMethod = (route: Core.Route) => {\r\n  return trim(toLower(route.method)) as Lowercase<Core.Route['method']>;\r\n};\r\n\r\nconst getPath = (route: Core.Route) => trim(route.path);\r\n\r\nconst createRouteInfoMiddleware =\r\n  (routeInfo: Core.Route): Core.MiddlewareHandler =>\r\n  (ctx, next) => {\r\n    const route = {\r\n      ...routeInfo,\r\n      config: routeInfo.config || {},\r\n    };\r\n\r\n    ctx.state.route = route;\r\n    return next();\r\n  };\r\n\r\nconst getAuthConfig = prop('config.auth');\r\n\r\nconst createAuthorizeMiddleware =\r\n  (strapi: Core.Strapi): Core.MiddlewareHandler =>\r\n  async (ctx, next) => {\r\n    const { auth, route } = ctx.state;\r\n\r\n    const authService = strapi.get('auth');\r\n\r\n    try {\r\n      await authService.verify(auth, getAuthConfig(route));\r\n\r\n      return await next();\r\n    } catch (error) {\r\n      if (error instanceof errors.UnauthorizedError) {\r\n        return ctx.unauthorized();\r\n      }\r\n\r\n      if (error instanceof errors.ForbiddenError) {\r\n        // allow PolicyError as an exception to throw a publicly visible message in the API\r\n        if (error instanceof errors.PolicyError) {\r\n          throw error;\r\n        }\r\n        return ctx.forbidden();\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  };\r\n\r\nconst createAuthenticateMiddleware =\r\n  (strapi: Core.Strapi): Core.MiddlewareHandler =>\r\n  async (ctx, next) => {\r\n    return strapi.get('auth').authenticate(ctx, next);\r\n  };\r\n\r\nconst returnBodyMiddleware: Core.MiddlewareHandler = async (ctx, next) => {\r\n  const values = await next();\r\n\r\n  if (isNil(ctx.body) && !isNil(values)) {\r\n    ctx.body = values;\r\n  }\r\n};\r\n\r\nexport default (strapi: Core.Strapi) => {\r\n  const authenticate = createAuthenticateMiddleware(strapi);\r\n  const authorize = createAuthorizeMiddleware(strapi);\r\n\r\n  return (route: Core.Route, { router }: { router: Router }) => {\r\n    try {\r\n      const method = getMethod(route);\r\n      const path = getPath(route);\r\n\r\n      const middlewares = resolveRouteMiddlewares(route, strapi);\r\n\r\n      const action = getAction(route, strapi);\r\n\r\n      const routeHandler = compose([\r\n        createRouteInfoMiddleware(route),\r\n        authenticate,\r\n        authorize,\r\n        createPolicicesMiddleware(route, strapi),\r\n        ...middlewares,\r\n        returnBodyMiddleware,\r\n        ...castArray(action),\r\n      ]);\r\n\r\n      router[method](path, routeHandler);\r\n    } catch (error) {\r\n      if (error instanceof Error) {\r\n        error.message = `Error creating endpoint ${route.method} ${route.path}: ${error.message}`;\r\n      }\r\n\r\n      throw error;\r\n    }\r\n  };\r\n};\r\n\r\nconst getController = (\r\n  name: string,\r\n  { pluginName, apiName }: Core.RouteInfo,\r\n  strapi: Core.Strapi\r\n) => {\r\n  let ctrl: Core.Controller | undefined;\r\n\r\n  if (pluginName) {\r\n    if (pluginName === 'admin') {\r\n      ctrl = strapi.controller(`admin::${name}`);\r\n    } else {\r\n      ctrl = strapi.plugin(pluginName).controller(name);\r\n    }\r\n  } else if (apiName) {\r\n    ctrl = strapi.controller(`api::${apiName}.${name}`);\r\n  }\r\n\r\n  if (!ctrl) {\r\n    return strapi.controller(name as UID.Controller);\r\n  }\r\n\r\n  return ctrl;\r\n};\r\n\r\nconst extractHandlerParts = (name: string) => {\r\n  const controllerName = name.slice(0, name.lastIndexOf('.'));\r\n  const actionName = name.slice(name.lastIndexOf('.') + 1);\r\n\r\n  return { controllerName, actionName };\r\n};\r\n\r\nconst getAction = (route: Core.Route, strapi: Core.Strapi) => {\r\n  const { handler, info } = route;\r\n  const { pluginName, apiName, type } = info ?? {};\r\n\r\n  if (Array.isArray(handler) || typeof handler === 'function') {\r\n    return handler;\r\n  }\r\n\r\n  const { controllerName, actionName } = extractHandlerParts(trim(handler));\r\n\r\n  const controller = getController(controllerName, { pluginName, apiName, type }, strapi);\r\n\r\n  if (typeof controller[actionName] !== 'function') {\r\n    throw new Error(`Handler not found \"${handler}\"`);\r\n  }\r\n\r\n  if (Symbol.for('__type__') in controller[actionName]) {\r\n    (controller[actionName] as any)[Symbol.for('__type__')].push(type);\r\n  } else {\r\n    (controller[actionName] as any)[Symbol.for('__type__')] = [type];\r\n  }\r\n\r\n  return controller[actionName].bind(controller);\r\n};\r\n"],"names":["trim","toLower","prop","errors","isNil","resolveRouteMiddlewares","compose","createPolicicesMiddleware","castArray"],"mappings":"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"}