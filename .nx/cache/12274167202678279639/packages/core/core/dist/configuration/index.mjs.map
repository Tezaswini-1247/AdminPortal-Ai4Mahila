{"version":3,"file":"index.mjs","sources":["../../src/configuration/index.ts"],"sourcesContent":["/* eslint-disable @typescript-eslint/no-var-requires */\r\nimport os from 'os';\r\nimport path from 'path';\r\nimport _ from 'lodash';\r\nimport { omit } from 'lodash/fp';\r\nimport dotenv from 'dotenv';\r\nimport type { Core } from '@strapi/types';\r\n\r\nimport { getConfigUrls, getAbsoluteAdminUrl, getAbsoluteServerUrl } from './urls';\r\nimport loadConfigDir from './config-loader';\r\nimport { getDirs } from './get-dirs';\r\n\r\nimport type { StrapiOptions } from '../Strapi';\r\n\r\ndotenv.config({ path: process.env.ENV_PATH });\r\n\r\nprocess.env.NODE_ENV = process.env.NODE_ENV || 'development';\r\n\r\nconst { version: strapiVersion } = require(path.join(__dirname, '../../package.json'));\r\n\r\nconst defaultConfig = {\r\n  server: {\r\n    host: process.env.HOST || os.hostname() || 'localhost',\r\n    port: Number(process.env.PORT) || 1337,\r\n    proxy: false,\r\n    cron: { enabled: false },\r\n    admin: { autoOpen: false },\r\n    dirs: { public: './public' },\r\n    transfer: {\r\n      remote: {\r\n        enabled: true,\r\n      },\r\n    },\r\n    logger: {\r\n      updates: {\r\n        enabled: true,\r\n      },\r\n      startup: {\r\n        enabled: true,\r\n      },\r\n    },\r\n  } satisfies Partial<Core.Config.Server>,\r\n  admin: {} satisfies Partial<Core.Config.Admin>,\r\n  api: {\r\n    rest: {\r\n      prefix: '/api',\r\n    },\r\n  } satisfies Partial<Core.Config.Api>,\r\n};\r\n\r\nexport const loadConfiguration = (opts: StrapiOptions) => {\r\n  const { appDir, distDir, autoReload = false, serveAdminPanel = true } = opts;\r\n\r\n  const pkgJSON = require(path.resolve(appDir, 'package.json'));\r\n\r\n  const configDir = path.resolve(distDir || process.cwd(), 'config');\r\n\r\n  const rootConfig = {\r\n    launchedAt: Date.now(),\r\n    autoReload,\r\n    environment: process.env.NODE_ENV,\r\n    uuid: _.get(pkgJSON, 'strapi.uuid'),\r\n    packageJsonStrapi: _.omit(_.get(pkgJSON, 'strapi', {}), 'uuid'),\r\n    info: {\r\n      ...pkgJSON,\r\n      strapi: strapiVersion,\r\n    },\r\n    admin: {\r\n      serveAdminPanel,\r\n    },\r\n  };\r\n\r\n  // See packages/core/core/src/domain/module/index.ts for plugin config loading\r\n  const baseConfig = omit('plugins', loadConfigDir(configDir)); // plugin config will be loaded later\r\n\r\n  const envDir = path.resolve(configDir, 'env', process.env.NODE_ENV as string);\r\n  const envConfig = loadConfigDir(envDir);\r\n\r\n  const config = _.merge(rootConfig, defaultConfig, baseConfig, envConfig);\r\n\r\n  const { serverUrl, adminUrl, adminPath } = getConfigUrls(config);\r\n\r\n  _.set(config, 'server.url', serverUrl);\r\n  _.set(config, 'server.absoluteUrl', getAbsoluteServerUrl(config));\r\n  _.set(config, 'admin.url', adminUrl);\r\n  _.set(config, 'admin.path', adminPath);\r\n  _.set(config, 'admin.absoluteUrl', getAbsoluteAdminUrl(config));\r\n  _.set(config, 'dirs', getDirs(opts, config));\r\n\r\n  return config;\r\n};\r\n"],"names":[],"mappings":";;;;;;;;AAcA,OAAO,OAAO,EAAE,MAAM,QAAQ,IAAI,UAAU;AAE5C,QAAQ,IAAI,WAAW,QAAQ,IAAI,YAAY;AAE/C,MAAM,EAAE,SAAS,cAAc,IAAI,QAAQ,KAAK,KAAK,WAAW,oBAAoB,CAAC;AAErF,MAAM,gBAAgB;AAAA,EACpB,QAAQ;AAAA,IACN,MAAM,QAAQ,IAAI,QAAQ,GAAG,cAAc;AAAA,IAC3C,MAAM,OAAO,QAAQ,IAAI,IAAI,KAAK;AAAA,IAClC,OAAO;AAAA,IACP,MAAM,EAAE,SAAS,MAAM;AAAA,IACvB,OAAO,EAAE,UAAU,MAAM;AAAA,IACzB,MAAM,EAAE,QAAQ,WAAW;AAAA,IAC3B,UAAU;AAAA,MACR,QAAQ;AAAA,QACN,SAAS;AAAA,MAAA;AAAA,IAEb;AAAA,IACA,QAAQ;AAAA,MACN,SAAS;AAAA,QACP,SAAS;AAAA,MACX;AAAA,MACA,SAAS;AAAA,QACP,SAAS;AAAA,MAAA;AAAA,IACX;AAAA,EAEJ;AAAA,EACA,OAAO,CAAC;AAAA,EACR,KAAK;AAAA,IACH,MAAM;AAAA,MACJ,QAAQ;AAAA,IAAA;AAAA,EACV;AAEJ;AAEa,MAAA,oBAAoB,CAAC,SAAwB;AACxD,QAAM,EAAE,QAAQ,SAAS,aAAa,OAAO,kBAAkB,SAAS;AAExE,QAAM,UAAU,QAAQ,KAAK,QAAQ,QAAQ,cAAc,CAAC;AAE5D,QAAM,YAAY,KAAK,QAAQ,WAAW,QAAQ,OAAO,QAAQ;AAEjE,QAAM,aAAa;AAAA,IACjB,YAAY,KAAK,IAAI;AAAA,IACrB;AAAA,IACA,aAAa,QAAQ,IAAI;AAAA,IACzB,MAAM,EAAE,IAAI,SAAS,aAAa;AAAA,IAClC,mBAAmB,EAAE,KAAK,EAAE,IAAI,SAAS,UAAU,EAAE,GAAG,MAAM;AAAA,IAC9D,MAAM;AAAA,MACJ,GAAG;AAAA,MACH,QAAQ;AAAA,IACV;AAAA,IACA,OAAO;AAAA,MACL;AAAA,IAAA;AAAA,EAEJ;AAGA,QAAM,aAAa,KAAK,WAAW,cAAc,SAAS,CAAC;AAE3D,QAAM,SAAS,KAAK,QAAQ,WAAW,OAAO,QAAQ,IAAI,QAAkB;AACtE,QAAA,YAAY,cAAc,MAAM;AAEtC,QAAM,SAAS,EAAE,MAAM,YAAY,eAAe,YAAY,SAAS;AAEvE,QAAM,EAAE,WAAW,UAAU,UAAU,IAAI,cAAc,MAAM;AAE7D,IAAA,IAAI,QAAQ,cAAc,SAAS;AACrC,IAAE,IAAI,QAAQ,sBAAsB,qBAAqB,MAAM,CAAC;AAC9D,IAAA,IAAI,QAAQ,aAAa,QAAQ;AACjC,IAAA,IAAI,QAAQ,cAAc,SAAS;AACrC,IAAE,IAAI,QAAQ,qBAAqB,oBAAoB,MAAM,CAAC;AAC9D,IAAE,IAAI,QAAQ,QAAQ,QAAQ,MAAM,MAAM,CAAC;AAEpC,SAAA;AACT;"}