{"version":3,"file":"urls.mjs","sources":["../../src/configuration/urls.ts"],"sourcesContent":["import _ from 'lodash';\r\nimport { strings } from '@strapi/utils';\r\n\r\ninterface ServerConfig {\r\n  url: string;\r\n  host: string;\r\n  port: number | string;\r\n}\r\n\r\nexport const getConfigUrls = (config: Record<string, unknown>, forAdminBuild = false) => {\r\n  const serverConfig = config.server as ServerConfig;\r\n  const adminConfig = config.admin;\r\n\r\n  // Defines serverUrl value\r\n  let serverUrl = _.get(serverConfig, 'url', '');\r\n  serverUrl = _.trim(serverUrl, '/ ');\r\n  if (typeof serverUrl !== 'string') {\r\n    throw new Error('Invalid server url config. Make sure the url is a string.');\r\n  }\r\n\r\n  if (serverUrl.startsWith('http')) {\r\n    try {\r\n      serverUrl = _.trim(new URL(serverConfig.url).toString(), '/');\r\n    } catch (e) {\r\n      throw new Error(\r\n        'Invalid server url config. Make sure the url defined in server.js is valid.'\r\n      );\r\n    }\r\n  } else if (serverUrl !== '') {\r\n    serverUrl = `/${serverUrl}`;\r\n  }\r\n\r\n  // Defines adminUrl value\r\n  let adminUrl = _.get(adminConfig, 'url', '/admin');\r\n  adminUrl = _.trim(adminUrl, '/ ');\r\n  if (typeof adminUrl !== 'string') {\r\n    throw new Error('Invalid admin url config. Make sure the url is a non-empty string.');\r\n  }\r\n  if (adminUrl.startsWith('http')) {\r\n    try {\r\n      adminUrl = _.trim(new URL(adminUrl).toString(), '/');\r\n    } catch (e) {\r\n      throw new Error('Invalid admin url config. Make sure the url defined in server.js is valid.');\r\n    }\r\n  } else {\r\n    adminUrl = `${serverUrl}/${adminUrl}`;\r\n  }\r\n\r\n  // Defines adminPath value\r\n  let adminPath = adminUrl;\r\n  if (\r\n    serverUrl.startsWith('http') &&\r\n    adminUrl.startsWith('http') &&\r\n    new URL(adminUrl).origin === new URL(serverUrl).origin &&\r\n    !forAdminBuild\r\n  ) {\r\n    adminPath = adminUrl.replace(strings.getCommonPath(serverUrl, adminUrl), '');\r\n    adminPath = `/${_.trim(adminPath, '/')}`;\r\n  } else if (adminUrl.startsWith('http')) {\r\n    adminPath = new URL(adminUrl).pathname;\r\n  }\r\n\r\n  return {\r\n    serverUrl,\r\n    adminUrl,\r\n    adminPath,\r\n  };\r\n};\r\n\r\nconst getAbsoluteUrl =\r\n  (adminOrServer: 'admin' | 'server') =>\r\n  (config: Record<string, unknown>, forAdminBuild = false) => {\r\n    const { serverUrl, adminUrl } = getConfigUrls(config, forAdminBuild);\r\n    const url = adminOrServer === 'server' ? serverUrl : adminUrl;\r\n\r\n    if (url.startsWith('http')) {\r\n      return url;\r\n    }\r\n\r\n    const serverConfig = config.server as ServerConfig;\r\n    const hostname =\r\n      config.environment === 'development' && ['127.0.0.1', '0.0.0.0'].includes(serverConfig.host)\r\n        ? 'localhost'\r\n        : serverConfig.host;\r\n\r\n    return `http://${hostname}:${serverConfig.port}${url}`;\r\n  };\r\n\r\nexport const getAbsoluteAdminUrl = getAbsoluteUrl('admin');\r\nexport const getAbsoluteServerUrl = getAbsoluteUrl('server');\r\n"],"names":[],"mappings":";;AASO,MAAM,gBAAgB,CAAC,QAAiC,gBAAgB,UAAU;AACvF,QAAM,eAAe,OAAO;AAC5B,QAAM,cAAc,OAAO;AAG3B,MAAI,YAAY,EAAE,IAAI,cAAc,OAAO,EAAE;AACjC,cAAA,EAAE,KAAK,WAAW,IAAI;AAC9B,MAAA,OAAO,cAAc,UAAU;AAC3B,UAAA,IAAI,MAAM,2DAA2D;AAAA,EAAA;AAGzE,MAAA,UAAU,WAAW,MAAM,GAAG;AAC5B,QAAA;AACU,kBAAA,EAAE,KAAK,IAAI,IAAI,aAAa,GAAG,EAAE,SAAS,GAAG,GAAG;AAAA,aACrD,GAAG;AACV,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAAA,IAAA;AAAA,EACF,WACS,cAAc,IAAI;AAC3B,gBAAY,IAAI,SAAS;AAAA,EAAA;AAI3B,MAAI,WAAW,EAAE,IAAI,aAAa,OAAO,QAAQ;AACtC,aAAA,EAAE,KAAK,UAAU,IAAI;AAC5B,MAAA,OAAO,aAAa,UAAU;AAC1B,UAAA,IAAI,MAAM,oEAAoE;AAAA,EAAA;AAElF,MAAA,SAAS,WAAW,MAAM,GAAG;AAC3B,QAAA;AACS,iBAAA,EAAE,KAAK,IAAI,IAAI,QAAQ,EAAE,YAAY,GAAG;AAAA,aAC5C,GAAG;AACJ,YAAA,IAAI,MAAM,4EAA4E;AAAA,IAAA;AAAA,EAC9F,OACK;AACM,eAAA,GAAG,SAAS,IAAI,QAAQ;AAAA,EAAA;AAIrC,MAAI,YAAY;AAChB,MACE,UAAU,WAAW,MAAM,KAC3B,SAAS,WAAW,MAAM,KAC1B,IAAI,IAAI,QAAQ,EAAE,WAAW,IAAI,IAAI,SAAS,EAAE,UAChD,CAAC,eACD;AACA,gBAAY,SAAS,QAAQ,QAAQ,cAAc,WAAW,QAAQ,GAAG,EAAE;AAC3E,gBAAY,IAAI,EAAE,KAAK,WAAW,GAAG,CAAC;AAAA,EAC7B,WAAA,SAAS,WAAW,MAAM,GAAG;AAC1B,gBAAA,IAAI,IAAI,QAAQ,EAAE;AAAA,EAAA;AAGzB,SAAA;AAAA,IACL;AAAA,IACA;AAAA,IACA;AAAA,EACF;AACF;AAEA,MAAM,iBACJ,CAAC,kBACD,CAAC,QAAiC,gBAAgB,UAAU;AAC1D,QAAM,EAAE,WAAW,SAAA,IAAa,cAAc,QAAQ,aAAa;AAC7D,QAAA,MAAM,kBAAkB,WAAW,YAAY;AAEjD,MAAA,IAAI,WAAW,MAAM,GAAG;AACnB,WAAA;AAAA,EAAA;AAGT,QAAM,eAAe,OAAO;AAC5B,QAAM,WACJ,OAAO,gBAAgB,iBAAiB,CAAC,aAAa,SAAS,EAAE,SAAS,aAAa,IAAI,IACvF,cACA,aAAa;AAEnB,SAAO,UAAU,QAAQ,IAAI,aAAa,IAAI,GAAG,GAAG;AACtD;AAEW,MAAA,sBAAsB,eAAe,OAAO;AAC5C,MAAA,uBAAuB,eAAe,QAAQ;"}