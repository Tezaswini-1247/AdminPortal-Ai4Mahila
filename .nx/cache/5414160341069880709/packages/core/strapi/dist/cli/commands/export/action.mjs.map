{"version":3,"file":"action.mjs","sources":["../../../../src/cli/commands/export/action.ts"],"sourcesContent":["import { isObject, isString, isFinite, toNumber } from 'lodash/fp';\r\nimport fs from 'fs-extra';\r\nimport chalk from 'chalk';\r\nimport type { Core } from '@strapi/types';\r\n\r\nimport {\r\n  engine as engineDataTransfer,\r\n  strapi as strapiDataTransfer,\r\n  file as fileDataTransfer,\r\n} from '@strapi/data-transfer';\r\n\r\nimport {\r\n  getDefaultExportName,\r\n  buildTransferTable,\r\n  DEFAULT_IGNORED_CONTENT_TYPES,\r\n  createStrapiInstance,\r\n  formatDiagnostic,\r\n  loadersFactory,\r\n  exitMessageText,\r\n  abortTransfer,\r\n  getTransferTelemetryPayload,\r\n  setSignalHandler,\r\n} from '../../utils/data-transfer';\r\nimport { exitWith } from '../../utils/helpers';\r\n\r\nconst {\r\n  providers: { createLocalFileDestinationProvider },\r\n} = fileDataTransfer;\r\nconst {\r\n  providers: { createLocalStrapiSourceProvider },\r\n} = strapiDataTransfer;\r\n\r\nconst BYTES_IN_MB = 1024 * 1024;\r\n\r\ninterface CmdOptions {\r\n  file?: string;\r\n  encrypt?: boolean;\r\n  verbose?: boolean;\r\n  key?: string;\r\n  compress?: boolean;\r\n  only?: (keyof engineDataTransfer.TransferGroupFilter)[];\r\n  exclude?: (keyof engineDataTransfer.TransferGroupFilter)[];\r\n  throttle?: number;\r\n  maxSizeJsonl?: number;\r\n}\r\n\r\n/**\r\n * Export command.\r\n *\r\n * It transfers data from a local Strapi instance to a file\r\n *\r\n * @param {ExportCommandOptions} opts\r\n */\r\nexport default async (opts: CmdOptions) => {\r\n  // Validate inputs from Commander\r\n  if (!isObject(opts)) {\r\n    exitWith(1, 'Could not parse command arguments');\r\n  }\r\n\r\n  const strapi = await createStrapiInstance();\r\n\r\n  const source = createSourceProvider(strapi);\r\n  const destination = createDestinationProvider(opts);\r\n\r\n  const engine = engineDataTransfer.createTransferEngine(source, destination, {\r\n    versionStrategy: 'ignore', // for an export to file, versionStrategy will always be skipped\r\n    schemaStrategy: 'ignore', // for an export to file, schemaStrategy will always be skipped\r\n    exclude: opts.exclude,\r\n    only: opts.only,\r\n    throttle: opts.throttle,\r\n    transforms: {\r\n      links: [\r\n        {\r\n          filter(link) {\r\n            return (\r\n              !DEFAULT_IGNORED_CONTENT_TYPES.includes(link.left.type) &&\r\n              !DEFAULT_IGNORED_CONTENT_TYPES.includes(link.right.type)\r\n            );\r\n          },\r\n        },\r\n      ],\r\n      entities: [\r\n        {\r\n          filter(entity) {\r\n            return !DEFAULT_IGNORED_CONTENT_TYPES.includes(entity.type);\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  });\r\n\r\n  engine.diagnostics.onDiagnostic(formatDiagnostic('export', opts.verbose));\r\n\r\n  const progress = engine.progress.stream;\r\n\r\n  const { updateLoader } = loadersFactory();\r\n\r\n  progress.on(`stage::start`, ({ stage, data }) => {\r\n    updateLoader(stage, data).start();\r\n  });\r\n\r\n  progress.on('stage::finish', ({ stage, data }) => {\r\n    updateLoader(stage, data).succeed();\r\n  });\r\n\r\n  progress.on('stage::progress', ({ stage, data }) => {\r\n    updateLoader(stage, data);\r\n  });\r\n\r\n  progress.on('transfer::start', async () => {\r\n    console.log(`Starting export...`);\r\n\r\n    await strapi.telemetry.send('didDEITSProcessStart', getTransferTelemetryPayload(engine));\r\n  });\r\n\r\n  let results: engineDataTransfer.ITransferResults<typeof source, typeof destination>;\r\n  let outFile: string;\r\n  try {\r\n    // Abort transfer if user interrupts process\r\n    setSignalHandler(() => abortTransfer({ engine, strapi }));\r\n\r\n    results = await engine.transfer();\r\n    outFile = results.destination?.file?.path ?? '';\r\n    const outFileExists = await fs.pathExists(outFile);\r\n    if (!outFileExists) {\r\n      throw new engineDataTransfer.errors.TransferEngineTransferError(\r\n        `Export file not created \"${outFile}\"`\r\n      );\r\n    }\r\n\r\n    // Note: we need to await telemetry or else the process ends before it is sent\r\n    await strapi.telemetry.send('didDEITSProcessFinish', getTransferTelemetryPayload(engine));\r\n\r\n    try {\r\n      const table = buildTransferTable(results.engine);\r\n      console.log(table?.toString());\r\n    } catch (e) {\r\n      console.error('There was an error displaying the results of the transfer.');\r\n    }\r\n\r\n    console.log(`Export archive is in ${chalk.green(outFile)}`);\r\n    exitWith(0, exitMessageText('export'));\r\n  } catch {\r\n    await strapi.telemetry.send('didDEITSProcessFail', getTransferTelemetryPayload(engine));\r\n    exitWith(1, exitMessageText('export', true));\r\n  }\r\n};\r\n\r\n/**\r\n * It creates a local strapi destination provider\r\n */\r\nconst createSourceProvider = (strapi: Core.Strapi) => {\r\n  return createLocalStrapiSourceProvider({\r\n    async getStrapi() {\r\n      return strapi;\r\n    },\r\n  });\r\n};\r\n\r\n/**\r\n * It creates a local file destination provider based on the given options\r\n */\r\nconst createDestinationProvider = (opts: CmdOptions) => {\r\n  const { file, compress, encrypt, key, maxSizeJsonl } = opts;\r\n\r\n  const filepath = isString(file) && file.length > 0 ? file : getDefaultExportName();\r\n\r\n  const maxSizeJsonlInMb = isFinite(toNumber(maxSizeJsonl))\r\n    ? toNumber(maxSizeJsonl) * BYTES_IN_MB\r\n    : undefined;\r\n\r\n  return createLocalFileDestinationProvider({\r\n    file: {\r\n      path: filepath,\r\n      maxSizeJsonl: maxSizeJsonlInMb,\r\n    },\r\n    encryption: {\r\n      enabled: encrypt ?? false,\r\n      key: encrypt ? key : undefined,\r\n    },\r\n    compression: {\r\n      enabled: compress ?? false,\r\n    },\r\n  });\r\n};\r\n"],"names":["fileDataTransfer","strapiDataTransfer","strapi","engine","engineDataTransfer","fs","file"],"mappings":"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"}