{"version":3,"file":"commander.js","sources":["../../../src/cli/utils/commander.ts"],"sourcesContent":["/**\r\n * This file includes hooks to use for commander.hook and argParsers for commander.argParser\r\n */\r\n\r\nimport inquirer from 'inquirer';\r\nimport { Command, InvalidOptionArgumentError, Option } from 'commander';\r\nimport chalk from 'chalk';\r\nimport { isNaN } from 'lodash/fp';\r\nimport { exitWith } from './helpers';\r\n\r\n/**\r\n * argParser: Parse a comma-delimited string as an array\r\n */\r\nconst parseList = (value: string) => {\r\n  try {\r\n    return value.split(',').map((item) => item.trim()); // trim shouldn't be necessary but might help catch unexpected whitespace characters\r\n  } catch (e) {\r\n    exitWith(1, `Unrecognized input: ${value}`);\r\n  }\r\n\r\n  return [];\r\n};\r\n\r\n/**\r\n * Returns an argParser that returns a list\r\n */\r\nconst getParseListWithChoices = (choices: string[], errorMessage = 'Invalid options:') => {\r\n  return (value: string) => {\r\n    const list = parseList(value);\r\n    const invalid = list.filter((item) => {\r\n      return !choices.includes(item);\r\n    });\r\n\r\n    if (invalid.length > 0) {\r\n      exitWith(1, `${errorMessage}: ${invalid.join(',')}`);\r\n    }\r\n\r\n    return list;\r\n  };\r\n};\r\n\r\n/**\r\n * argParser: Parse a string as an integer\r\n */\r\nconst parseInteger = (value: string) => {\r\n  // parseInt takes a string and a radix\r\n  const parsedValue = parseInt(value, 10);\r\n  if (isNaN(parsedValue)) {\r\n    throw new InvalidOptionArgumentError(`Not an integer: ${value}`);\r\n  }\r\n  return parsedValue;\r\n};\r\n\r\n/**\r\n * argParser: Parse a string as a URL object\r\n */\r\nconst parseURL = (value: string) => {\r\n  try {\r\n    const url = new URL(value);\r\n    if (!url.host) {\r\n      throw new InvalidOptionArgumentError(`Could not parse url ${value}`);\r\n    }\r\n\r\n    return url;\r\n  } catch (e) {\r\n    throw new InvalidOptionArgumentError(`Could not parse url ${value}`);\r\n  }\r\n};\r\n\r\n/**\r\n * hook: if encrypt==true and key not provided, prompt for it\r\n */\r\nconst promptEncryptionKey = async (thisCommand: Command) => {\r\n  const opts = thisCommand.opts();\r\n\r\n  if (!opts.encrypt && opts.key) {\r\n    return exitWith(1, 'Key may not be present unless encryption is used');\r\n  }\r\n\r\n  // if encrypt==true but we have no key, prompt for it\r\n  if (opts.encrypt && !(opts.key && opts.key.length > 0)) {\r\n    try {\r\n      const answers = await inquirer.prompt([\r\n        {\r\n          type: 'password',\r\n          message: 'Please enter an encryption key',\r\n          name: 'key',\r\n          validate(key) {\r\n            if (key.length > 0) return true;\r\n\r\n            return 'Key must be present when using the encrypt option';\r\n          },\r\n        },\r\n      ]);\r\n      opts.key = answers.key;\r\n    } catch (e) {\r\n      return exitWith(1, 'Failed to get encryption key');\r\n    }\r\n    if (!opts.key) {\r\n      return exitWith(1, 'Failed to get encryption key');\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * hook: require a confirmation message to be accepted unless forceOption (-f,--force) is used\r\n */\r\nconst getCommanderConfirmMessage = (\r\n  message: string,\r\n  { failMessage }: { failMessage?: string } = {}\r\n) => {\r\n  return async (command: Command) => {\r\n    const confirmed = await confirmMessage(message, { force: command.opts().force });\r\n    if (!confirmed) {\r\n      exitWith(1, failMessage);\r\n    }\r\n  };\r\n};\r\n\r\nconst confirmMessage = async (message: string, { force }: { force?: boolean } = {}) => {\r\n  // if we have a force option, respond yes\r\n  if (force === true) {\r\n    // attempt to mimic the inquirer prompt exactly\r\n    console.log(`${chalk.green('?')} ${chalk.bold(message)} ${chalk.cyan('Yes')}`);\r\n    return true;\r\n  }\r\n\r\n  const answers = await inquirer.prompt([\r\n    {\r\n      type: 'confirm',\r\n      message,\r\n      name: `confirm`,\r\n      default: false,\r\n    },\r\n  ]);\r\n\r\n  return answers.confirm;\r\n};\r\n\r\nconst forceOption = new Option(\r\n  '--force',\r\n  `Automatically answer \"yes\" to all prompts, including potentially destructive requests, and run non-interactively.`\r\n);\r\n\r\nexport {\r\n  getParseListWithChoices,\r\n  parseList,\r\n  parseURL,\r\n  parseInteger,\r\n  promptEncryptionKey,\r\n  getCommanderConfirmMessage,\r\n  confirmMessage,\r\n  forceOption,\r\n};\r\n"],"names":["exitWith","isNaN","InvalidOptionArgumentError","inquirer","chalk","Option"],"mappings":"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"}