{"version":3,"file":"watch.mjs","sources":["../../../src/node/webpack/watch.ts"],"sourcesContent":["import os from 'node:os';\r\nimport path from 'node:path';\r\nimport { promisify } from 'node:util';\r\nimport webpackDevMiddleware from 'webpack-dev-middleware';\r\nimport webpackHotMiddleware from 'webpack-hot-middleware';\r\nimport { webpack } from 'webpack';\r\nimport { Core } from '@strapi/types';\r\nimport type { BuildContext } from '../create-build-context';\r\nimport { mergeConfigWithUserConfig, resolveDevelopmentConfig } from './config';\r\n\r\ninterface WebpackWatcher {\r\n  close(): Promise<void>;\r\n}\r\n\r\nconst watch = async (ctx: BuildContext): Promise<WebpackWatcher> => {\r\n  const config = await resolveDevelopmentConfig(ctx);\r\n  const finalConfig = await mergeConfigWithUserConfig(config, ctx);\r\n\r\n  ctx.logger.debug('Final webpack config:', os.EOL, finalConfig);\r\n\r\n  return new Promise<WebpackWatcher>((res) => {\r\n    const compiler = webpack(finalConfig);\r\n\r\n    const devMiddleware = webpackDevMiddleware(compiler);\r\n\r\n    const hotMiddleware = webpackHotMiddleware(compiler, {\r\n      log: false,\r\n      path: '/__webpack_hmr',\r\n    });\r\n\r\n    ctx.strapi.server.app.use((ctx, next) => {\r\n      return new Promise((resolve, reject) => {\r\n        hotMiddleware(ctx.req, ctx.res, (err) => {\r\n          if (err) reject(err);\r\n          else resolve(next());\r\n        });\r\n      });\r\n    });\r\n\r\n    ctx.strapi.server.app.use((context, next) => {\r\n      // wait for webpack-dev-middleware to signal that the build is ready\r\n      const ready = new Promise((resolve) => {\r\n        devMiddleware.waitUntilValid(() => {\r\n          resolve(true);\r\n        });\r\n      });\r\n      // tell webpack-dev-middleware to handle the request\r\n      const init = new Promise((resolve) => {\r\n        devMiddleware(\r\n          context.req,\r\n          {\r\n            // @ts-expect-error ignored\r\n            end(content) {\r\n              // eslint-disable-next-line no-param-reassign\r\n              context.body = content;\r\n              resolve(true);\r\n            },\r\n            getHeader: context.get.bind(context),\r\n            // @ts-expect-error ignored\r\n            setHeader: context.set.bind(context),\r\n            locals: context.state,\r\n          },\r\n          () => resolve(next())\r\n        );\r\n      });\r\n\r\n      return Promise.all([ready, init]);\r\n    });\r\n\r\n    const serveAdmin: Core.MiddlewareHandler = async (ctx, next) => {\r\n      await next();\r\n\r\n      if (devMiddleware.context.outputFileSystem.createReadStream) {\r\n        if (ctx.method !== 'HEAD' && ctx.method !== 'GET') {\r\n          return;\r\n        }\r\n\r\n        if (ctx.body != null || ctx.status !== 404) {\r\n          return;\r\n        }\r\n\r\n        // eslint-disable-next-line @typescript-eslint/no-non-null-asserted-optional-chain\r\n        const filename = path.resolve(finalConfig.output?.path!, 'index.html');\r\n        ctx.type = 'html';\r\n        ctx.body = devMiddleware.context.outputFileSystem.createReadStream(filename);\r\n      }\r\n    };\r\n\r\n    ctx.strapi.server.routes([\r\n      {\r\n        method: 'GET',\r\n        path: `${ctx.basePath}:path*`,\r\n        handler: serveAdmin,\r\n        config: { auth: false },\r\n      },\r\n    ]);\r\n\r\n    devMiddleware.waitUntilValid(() => {\r\n      res({\r\n        async close() {\r\n          await Promise.all([\r\n            promisify(devMiddleware.close.bind(devMiddleware))(),\r\n            hotMiddleware.close(),\r\n            promisify(compiler.close.bind(compiler))(),\r\n          ]);\r\n        },\r\n      });\r\n    });\r\n  });\r\n};\r\n\r\nexport { watch };\r\nexport type { WebpackWatcher };\r\n"],"names":["ctx"],"mappings":";;;;;;;AAcM,MAAA,QAAQ,OAAO,QAA+C;AAC5D,QAAA,SAAS,MAAM,yBAAyB,GAAG;AACjD,QAAM,cAAc,MAAM,0BAA0B,QAAQ,GAAG;AAE/D,MAAI,OAAO,MAAM,yBAAyB,GAAG,KAAK,WAAW;AAEtD,SAAA,IAAI,QAAwB,CAAC,QAAQ;AACpC,UAAA,WAAW,QAAQ,WAAW;AAE9B,UAAA,gBAAgB,qBAAqB,QAAQ;AAE7C,UAAA,gBAAgB,qBAAqB,UAAU;AAAA,MACnD,KAAK;AAAA,MACL,MAAM;AAAA,IAAA,CACP;AAED,QAAI,OAAO,OAAO,IAAI,IAAI,CAACA,MAAK,SAAS;AACvC,aAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AACtC,sBAAcA,KAAI,KAAKA,KAAI,KAAK,CAAC,QAAQ;AACnC,cAAA,YAAY,GAAG;AAAA,cACd,SAAQ,MAAM;AAAA,QAAA,CACpB;AAAA,MAAA,CACF;AAAA,IAAA,CACF;AAED,QAAI,OAAO,OAAO,IAAI,IAAI,CAAC,SAAS,SAAS;AAE3C,YAAM,QAAQ,IAAI,QAAQ,CAAC,YAAY;AACrC,sBAAc,eAAe,MAAM;AACjC,kBAAQ,IAAI;AAAA,QAAA,CACb;AAAA,MAAA,CACF;AAED,YAAM,OAAO,IAAI,QAAQ,CAAC,YAAY;AACpC;AAAA,UACE,QAAQ;AAAA,UACR;AAAA;AAAA,YAEE,IAAI,SAAS;AAEX,sBAAQ,OAAO;AACf,sBAAQ,IAAI;AAAA,YACd;AAAA,YACA,WAAW,QAAQ,IAAI,KAAK,OAAO;AAAA;AAAA,YAEnC,WAAW,QAAQ,IAAI,KAAK,OAAO;AAAA,YACnC,QAAQ,QAAQ;AAAA,UAClB;AAAA,UACA,MAAM,QAAQ,KAAM,CAAA;AAAA,QACtB;AAAA,MAAA,CACD;AAED,aAAO,QAAQ,IAAI,CAAC,OAAO,IAAI,CAAC;AAAA,IAAA,CACjC;AAEK,UAAA,aAAqC,OAAOA,MAAK,SAAS;AAC9D,YAAM,KAAK;AAEP,UAAA,cAAc,QAAQ,iBAAiB,kBAAkB;AAC3D,YAAIA,KAAI,WAAW,UAAUA,KAAI,WAAW,OAAO;AACjD;AAAA,QAAA;AAGF,YAAIA,KAAI,QAAQ,QAAQA,KAAI,WAAW,KAAK;AAC1C;AAAA,QAAA;AAIF,cAAM,WAAW,KAAK,QAAQ,YAAY,QAAQ,MAAO,YAAY;AACrEA,aAAI,OAAO;AACXA,aAAI,OAAO,cAAc,QAAQ,iBAAiB,iBAAiB,QAAQ;AAAA,MAAA;AAAA,IAE/E;AAEI,QAAA,OAAO,OAAO,OAAO;AAAA,MACvB;AAAA,QACE,QAAQ;AAAA,QACR,MAAM,GAAG,IAAI,QAAQ;AAAA,QACrB,SAAS;AAAA,QACT,QAAQ,EAAE,MAAM,MAAM;AAAA,MAAA;AAAA,IACxB,CACD;AAED,kBAAc,eAAe,MAAM;AAC7B,UAAA;AAAA,QACF,MAAM,QAAQ;AACZ,gBAAM,QAAQ,IAAI;AAAA,YAChB,UAAU,cAAc,MAAM,KAAK,aAAa,CAAC,EAAE;AAAA,YACnD,cAAc,MAAM;AAAA,YACpB,UAAU,SAAS,MAAM,KAAK,QAAQ,CAAC,EAAE;AAAA,UAAA,CAC1C;AAAA,QAAA;AAAA,MACH,CACD;AAAA,IAAA,CACF;AAAA,EAAA,CACF;AACH;"}