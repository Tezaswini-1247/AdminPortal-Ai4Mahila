{"version":3,"file":"license.js","sources":["../../src/ee/license.ts"],"sourcesContent":["import fs from 'fs';\r\nimport { join, resolve } from 'path';\r\nimport crypto from 'crypto';\r\nimport type { Core } from '@strapi/types';\r\n\r\nimport { machineID } from '@strapi/utils';\r\n\r\ninterface LicenseInfo {\r\n  type: 'bronze' | 'silver' | 'gold';\r\n  expireAt?: string;\r\n  seats?: number;\r\n  features?: Array<{ name: string; options?: Record<string, unknown> }>;\r\n}\r\n\r\nconst DEFAULT_FEATURES = {\r\n  bronze: [],\r\n  silver: [],\r\n  gold: [\r\n    { name: 'sso' },\r\n    // Set a null retention duration to allow the user to override it\r\n    // The default of 90 days is set in the audit logs service\r\n    { name: 'audit-logs', options: { retentionDays: null } },\r\n    { name: 'review-workflows' },\r\n    { name: 'cms-content-releases' },\r\n    { name: 'cms-content-history', options: { retentionDays: 99999 } },\r\n  ],\r\n};\r\n\r\nconst publicKey = fs.readFileSync(resolve(__dirname, '../../resources/key.pub'));\r\n\r\nclass LicenseCheckError extends Error {\r\n  shouldFallback = false;\r\n\r\n  constructor(message: string, shouldFallback = false) {\r\n    super(message);\r\n\r\n    this.shouldFallback = shouldFallback;\r\n  }\r\n}\r\n\r\nconst readLicense = (directory: string) => {\r\n  try {\r\n    const path = join(directory, 'license.txt');\r\n    return fs.readFileSync(path).toString();\r\n  } catch (error) {\r\n    if (typeof error === 'object' && error !== null && 'code' in error && error.code !== 'ENOENT') {\r\n      throw Error('License file not readable, review its format and access rules.');\r\n    }\r\n  }\r\n};\r\n\r\nconst verifyLicense = (license: string) => {\r\n  const [signature, base64Content] = Buffer.from(license, 'base64').toString().split('\\n');\r\n\r\n  if (!signature || !base64Content) {\r\n    throw new Error('Invalid license.');\r\n  }\r\n\r\n  const stringifiedContent = Buffer.from(base64Content, 'base64').toString();\r\n\r\n  const verify = crypto.createVerify('RSA-SHA256');\r\n  verify.update(stringifiedContent);\r\n  verify.end();\r\n\r\n  const verified = verify.verify(publicKey, signature, 'base64');\r\n\r\n  if (!verified) {\r\n    throw new Error('Invalid license.');\r\n  }\r\n\r\n  const licenseInfo: LicenseInfo = JSON.parse(stringifiedContent);\r\n\r\n  if (!licenseInfo.features) {\r\n    licenseInfo.features = DEFAULT_FEATURES[licenseInfo.type];\r\n  }\r\n\r\n  Object.freeze(licenseInfo.features);\r\n  return licenseInfo;\r\n};\r\n\r\nconst throwError = () => {\r\n  throw new LicenseCheckError('Could not proceed to the online validation of your license.', true);\r\n};\r\n\r\nconst fetchLicense = async (\r\n  { strapi }: { strapi: Core.Strapi },\r\n  key: string,\r\n  projectId: string\r\n) => {\r\n  const response = await strapi\r\n    .fetch(`https://license.strapi.io/api/licenses/validate`, {\r\n      method: 'POST',\r\n      headers: { 'Content-Type': 'application/json' },\r\n      body: JSON.stringify({ key, projectId, deviceId: machineID() }),\r\n    })\r\n    .catch(throwError);\r\n\r\n  const contentType = response.headers.get('Content-Type');\r\n\r\n  if (contentType?.includes('application/json')) {\r\n    const { data, error } = await response.json();\r\n\r\n    switch (response.status) {\r\n      case 200:\r\n        return data.license;\r\n      case 400:\r\n        throw new LicenseCheckError(error.message);\r\n      case 404:\r\n        throw new LicenseCheckError('The license used does not exists.');\r\n      default:\r\n        throwError();\r\n    }\r\n  } else {\r\n    throwError();\r\n  }\r\n};\r\n\r\nexport { readLicense, verifyLicense, fetchLicense, LicenseCheckError };\r\n"],"names":["fs","resolve","path","join","crypto","machineID"],"mappings":";;;;;;;;;AAcA,MAAM,mBAAmB;AAAA,EACvB,QAAQ,CAAC;AAAA,EACT,QAAQ,CAAC;AAAA,EACT,MAAM;AAAA,IACJ,EAAE,MAAM,MAAM;AAAA;AAAA;AAAA,IAGd,EAAE,MAAM,cAAc,SAAS,EAAE,eAAe,OAAO;AAAA,IACvD,EAAE,MAAM,mBAAmB;AAAA,IAC3B,EAAE,MAAM,uBAAuB;AAAA,IAC/B,EAAE,MAAM,uBAAuB,SAAS,EAAE,eAAe,MAAQ,EAAA;AAAA,EAAA;AAErE;AAEA,MAAM,YAAYA,YAAG,QAAA,aAAaC,KAAQ,QAAA,WAAW,yBAAyB,CAAC;AAE/E,MAAM,0BAA0B,MAAM;AAAA,EACpC,iBAAiB;AAAA,EAEjB,YAAY,SAAiB,iBAAiB,OAAO;AACnD,UAAM,OAAO;AAEb,SAAK,iBAAiB;AAAA,EAAA;AAE1B;AAEM,MAAA,cAAc,CAAC,cAAsB;AACrC,MAAA;AACI,UAAAC,SAAOC,KAAAA,KAAK,WAAW,aAAa;AAC1C,WAAOH,oBAAG,aAAaE,MAAI,EAAE,SAAS;AAAA,WAC/B,OAAO;AACV,QAAA,OAAO,UAAU,YAAY,UAAU,QAAQ,UAAU,SAAS,MAAM,SAAS,UAAU;AAC7F,YAAM,MAAM,gEAAgE;AAAA,IAAA;AAAA,EAC9E;AAEJ;AAEM,MAAA,gBAAgB,CAAC,YAAoB;AACzC,QAAM,CAAC,WAAW,aAAa,IAAI,OAAO,KAAK,SAAS,QAAQ,EAAE,WAAW,MAAM,IAAI;AAEnF,MAAA,CAAC,aAAa,CAAC,eAAe;AAC1B,UAAA,IAAI,MAAM,kBAAkB;AAAA,EAAA;AAGpC,QAAM,qBAAqB,OAAO,KAAK,eAAe,QAAQ,EAAE,SAAS;AAEnE,QAAA,SAASE,gBAAAA,QAAO,aAAa,YAAY;AAC/C,SAAO,OAAO,kBAAkB;AAChC,SAAO,IAAI;AAEX,QAAM,WAAW,OAAO,OAAO,WAAW,WAAW,QAAQ;AAE7D,MAAI,CAAC,UAAU;AACP,UAAA,IAAI,MAAM,kBAAkB;AAAA,EAAA;AAG9B,QAAA,cAA2B,KAAK,MAAM,kBAAkB;AAE1D,MAAA,CAAC,YAAY,UAAU;AACb,gBAAA,WAAW,iBAAiB,YAAY,IAAI;AAAA,EAAA;AAGnD,SAAA,OAAO,YAAY,QAAQ;AAC3B,SAAA;AACT;AAEA,MAAM,aAAa,MAAM;AACjB,QAAA,IAAI,kBAAkB,+DAA+D,IAAI;AACjG;AAEA,MAAM,eAAe,OACnB,EAAE,UACF,KACA,cACG;AACH,QAAM,WAAW,MAAM,OACpB,MAAM,mDAAmD;AAAA,IACxD,QAAQ;AAAA,IACR,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,IAC9C,MAAM,KAAK,UAAU,EAAE,KAAK,WAAW,UAAUC,YAAAA,YAAa,CAAA;AAAA,EAAA,CAC/D,EACA,MAAM,UAAU;AAEnB,QAAM,cAAc,SAAS,QAAQ,IAAI,cAAc;AAEnD,MAAA,aAAa,SAAS,kBAAkB,GAAG;AAC7C,UAAM,EAAE,MAAM,MAAU,IAAA,MAAM,SAAS,KAAK;AAE5C,YAAQ,SAAS,QAAQ;AAAA,MACvB,KAAK;AACH,eAAO,KAAK;AAAA,MACd,KAAK;AACG,cAAA,IAAI,kBAAkB,MAAM,OAAO;AAAA,MAC3C,KAAK;AACG,cAAA,IAAI,kBAAkB,mCAAmC;AAAA,MACjE;AACa,mBAAA;AAAA,IAAA;AAAA,EACf,OACK;AACM,eAAA;AAAA,EAAA;AAEf;;;;;"}