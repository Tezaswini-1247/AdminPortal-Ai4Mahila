{"version":3,"file":"core-store.mjs","sources":["../../src/services/core-store.ts"],"sourcesContent":["import { toString } from 'lodash/fp';\r\nimport type { Database, Model } from '@strapi/database';\r\n\r\nconst coreStoreModel: Model = {\r\n  uid: 'strapi::core-store',\r\n  singularName: 'strapi_core_store_settings',\r\n  tableName: 'strapi_core_store_settings',\r\n  attributes: {\r\n    id: {\r\n      type: 'increments',\r\n    },\r\n    key: {\r\n      type: 'string',\r\n    },\r\n    value: {\r\n      type: 'text',\r\n    },\r\n    type: {\r\n      type: 'string',\r\n    },\r\n    environment: {\r\n      type: 'string',\r\n    },\r\n    tag: {\r\n      type: 'string',\r\n    },\r\n  },\r\n};\r\n\r\ntype SetParams = {\r\n  key: string;\r\n  value: unknown;\r\n  type?: string;\r\n  environment?: string;\r\n  name?: string;\r\n  tag?: string;\r\n};\r\n\r\ntype GetParams = {\r\n  key: string;\r\n  type?: string;\r\n  environment?: string;\r\n  name?: string;\r\n  tag?: string;\r\n};\r\n\r\ntype Params = SetParams & GetParams;\r\n\r\ninterface CoreStore {\r\n  (defaultParams: Partial<Params>): {\r\n    get(params: Partial<GetParams>): Promise<unknown>;\r\n    set(params: Partial<SetParams>): Promise<void>;\r\n    delete(params: Partial<GetParams>): Promise<void>;\r\n  };\r\n  get(params: GetParams): Promise<unknown>;\r\n  set(params: SetParams): Promise<void>;\r\n  delete(params: GetParams): Promise<void>;\r\n}\r\n\r\nconst createCoreStore = ({ db }: { db: Database }) => {\r\n  const mergeParams = (defaultParams: Partial<Params>, params: Params): Params => {\r\n    return {\r\n      ...defaultParams,\r\n      ...params,\r\n    };\r\n  };\r\n\r\n  const store: CoreStore = function (defaultParams: Partial<Params>) {\r\n    return {\r\n      get: (params: Params) => store.get(mergeParams(defaultParams, params)),\r\n      set: (params: Params) => store.set(mergeParams(defaultParams, params)),\r\n      delete: (params: Params) => store.delete(mergeParams(defaultParams, params)),\r\n    };\r\n  };\r\n\r\n  /**\r\n   * Get value from the core store\r\n   */\r\n  store.get = async (params) => {\r\n    const { key, type = 'core', environment, name, tag } = params;\r\n\r\n    const prefix = `${type}${name ? `_${name}` : ''}`;\r\n\r\n    const where = {\r\n      key: `${prefix}_${key}`,\r\n      environment: environment || null,\r\n      tag: tag || null,\r\n    };\r\n\r\n    const data = await db.query('strapi::core-store').findOne({ where });\r\n\r\n    if (!data) {\r\n      return null;\r\n    }\r\n\r\n    if (\r\n      data.type === 'object' ||\r\n      data.type === 'array' ||\r\n      data.type === 'boolean' ||\r\n      data.type === 'string'\r\n    ) {\r\n      try {\r\n        return JSON.parse(data.value);\r\n      } catch (err) {\r\n        return new Date(data.value);\r\n      }\r\n    } else if (data.type === 'number') {\r\n      return Number(data.value);\r\n    } else {\r\n      return null;\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Set value in the core store\r\n   * @param {Object} params\r\n   * @returns {*}\r\n   */\r\n  store.set = async (params) => {\r\n    const { key, value, type, environment, name, tag } = params;\r\n\r\n    const prefix = `${type}${name ? `_${name}` : ''}`;\r\n\r\n    const where = {\r\n      key: `${prefix}_${key}`,\r\n      environment: environment || null,\r\n      tag: tag || null,\r\n    };\r\n\r\n    const data = await db.query('strapi::core-store').findOne({ where });\r\n\r\n    if (data) {\r\n      return db.query('strapi::core-store').update({\r\n        where: { id: data.id },\r\n        data: {\r\n          value: JSON.stringify(value) || toString(value),\r\n          type: typeof value,\r\n        },\r\n      });\r\n    }\r\n\r\n    return db.query('strapi::core-store').create({\r\n      data: {\r\n        ...where,\r\n        value: JSON.stringify(value) || toString(value),\r\n        type: typeof value,\r\n      },\r\n    });\r\n  };\r\n\r\n  /**\r\n   * Deletes a value from the core store\r\n   * @param {Object} params\r\n   * @returns {*}\r\n   */\r\n  store.delete = async (params) => {\r\n    const { key, environment, type, name, tag } = params;\r\n\r\n    const prefix = `${type}${name ? `_${name}` : ''}`;\r\n\r\n    const where = {\r\n      key: `${prefix}_${key}`,\r\n      environment: environment || null,\r\n      tag: tag || null,\r\n    };\r\n\r\n    return db.query('strapi::core-store').delete({ where });\r\n  };\r\n\r\n  return store;\r\n};\r\n\r\nexport { coreStoreModel, createCoreStore };\r\n"],"names":[],"mappings":"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"}