{"version":3,"file":"middlewares.mjs","sources":["../../src/registries/middlewares.ts"],"sourcesContent":["import { pickBy, has } from 'lodash/fp';\r\nimport type { Core, UID } from '@strapi/types';\r\nimport { addNamespace, hasNamespace } from './namespace';\r\n\r\ntype MiddlewareExtendFn = (middleware: Core.Middleware) => Core.Middleware;\r\n\r\n// TODO: move instantiation part here instead of in the server service\r\nconst middlewaresRegistry = () => {\r\n  const middlewares: Record<UID.Middleware, Core.Middleware> = {};\r\n\r\n  return {\r\n    /**\r\n     * Returns this list of registered middlewares uids\r\n     */\r\n    keys() {\r\n      return Object.keys(middlewares);\r\n    },\r\n\r\n    /**\r\n     * Returns the instance of a middleware. Instantiate the middleware if not already done\r\n     */\r\n    get(uid: UID.Middleware) {\r\n      return middlewares[uid];\r\n    },\r\n\r\n    /**\r\n     * Returns a map with all the middlewares in a namespace\r\n     */\r\n    getAll(namespace: string) {\r\n      return pickBy((_, uid) => hasNamespace(uid, namespace))(middlewares);\r\n    },\r\n\r\n    /**\r\n     * Registers a middleware\r\n     */\r\n    set(uid: UID.Middleware, middleware: Core.Middleware) {\r\n      middlewares[uid] = middleware;\r\n      return this;\r\n    },\r\n\r\n    /**\r\n     * Registers a map of middlewares for a specific namespace\r\n     */\r\n    add(namespace: string, rawMiddlewares: Record<string, Core.Middleware> = {}) {\r\n      for (const middlewareName of Object.keys(rawMiddlewares)) {\r\n        const middleware = rawMiddlewares[middlewareName];\r\n        const uid = addNamespace(middlewareName, namespace) as UID.Middleware;\r\n\r\n        if (has(uid, middlewares)) {\r\n          throw new Error(`Middleware ${uid} has already been registered.`);\r\n        }\r\n        middlewares[uid] = middleware;\r\n      }\r\n    },\r\n\r\n    /**\r\n     * Wraps a middleware to extend it\r\n     */\r\n    extend(uid: UID.Middleware, extendFn: MiddlewareExtendFn) {\r\n      const currentMiddleware = this.get(uid);\r\n\r\n      if (!currentMiddleware) {\r\n        throw new Error(`Middleware ${uid} doesn't exist`);\r\n      }\r\n\r\n      const newMiddleware = extendFn(currentMiddleware);\r\n      middlewares[uid] = newMiddleware;\r\n\r\n      return this;\r\n    },\r\n  };\r\n};\r\n\r\nexport default middlewaresRegistry;\r\n"],"names":[],"mappings":";;AAOA,MAAM,sBAAsB,MAAM;AAChC,QAAM,cAAuD,CAAC;AAEvD,SAAA;AAAA;AAAA;AAAA;AAAA,IAIL,OAAO;AACE,aAAA,OAAO,KAAK,WAAW;AAAA,IAChC;AAAA;AAAA;AAAA;AAAA,IAKA,IAAI,KAAqB;AACvB,aAAO,YAAY,GAAG;AAAA,IACxB;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,WAAmB;AACjB,aAAA,OAAO,CAAC,GAAG,QAAQ,aAAa,KAAK,SAAS,CAAC,EAAE,WAAW;AAAA,IACrE;AAAA;AAAA;AAAA;AAAA,IAKA,IAAI,KAAqB,YAA6B;AACpD,kBAAY,GAAG,IAAI;AACZ,aAAA;AAAA,IACT;AAAA;AAAA;AAAA;AAAA,IAKA,IAAI,WAAmB,iBAAkD,IAAI;AAC3E,iBAAW,kBAAkB,OAAO,KAAK,cAAc,GAAG;AAClD,cAAA,aAAa,eAAe,cAAc;AAC1C,cAAA,MAAM,aAAa,gBAAgB,SAAS;AAE9C,YAAA,IAAI,KAAK,WAAW,GAAG;AACzB,gBAAM,IAAI,MAAM,cAAc,GAAG,+BAA+B;AAAA,QAAA;AAElE,oBAAY,GAAG,IAAI;AAAA,MAAA;AAAA,IAEvB;AAAA;AAAA;AAAA;AAAA,IAKA,OAAO,KAAqB,UAA8B;AAClD,YAAA,oBAAoB,KAAK,IAAI,GAAG;AAEtC,UAAI,CAAC,mBAAmB;AACtB,cAAM,IAAI,MAAM,cAAc,GAAG,gBAAgB;AAAA,MAAA;AAG7C,YAAA,gBAAgB,SAAS,iBAAiB;AAChD,kBAAY,GAAG,IAAI;AAEZ,aAAA;AAAA,IAAA;AAAA,EAEX;AACF;"}