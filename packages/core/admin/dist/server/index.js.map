{"version":3,"file":"index.js","sources":["../../server/src/utils/index.js","../../server/src/config/admin-actions.ts","../../server/src/config/admin-conditions.ts","../../server/src/bootstrap.ts","../../server/src/routes/serve-admin-panel.ts","../../server/src/strategies/admin.ts","../../server/src/services/constants.ts","../../server/src/strategies/api-token.ts","../../server/src/register.ts","../../server/src/destroy.ts","../../server/src/config/email-templates/forgot-password.ts","../../server/src/config/index.ts","../../server/src/policies/isAuthenticatedAdmin.ts","../../server/src/validation/policies/hasPermissions.ts","../../server/src/policies/hasPermissions.ts","../../server/src/policies/isTelemetryEnabled.ts","../../server/src/policies/index.ts","../../server/src/routes/admin.ts","../../server/src/routes/authentication.ts","../../server/src/routes/permissions.ts","../../server/src/routes/users.ts","../../server/src/routes/roles.ts","../../server/src/routes/webhooks.ts","../../server/src/routes/api-tokens.ts","../../server/src/routes/content-api.ts","../../server/src/strategies/data-transfer.ts","../../server/src/routes/transfer.ts","../../server/src/routes/index.ts","../../server/src/services/auth.ts","../../server/src/domain/user.ts","../../server/src/domain/action/index.ts","../../server/src/validation/common-functions/check-fields-are-correctly-nested.ts","../../server/src/validation/common-functions/check-fields-dont-have-duplicates.ts","../../server/src/validation/common-validators.ts","../../server/src/services/user.ts","../../server/src/domain/permission/index.ts","../../server/src/validation/permission.ts","../../server/src/services/role.ts","../../server/src/services/passport/local-strategy.ts","../../server/src/services/passport.ts","../../server/src/services/metrics.ts","../../server/src/services/token.ts","../../server/src/validation/action-provider.ts","../../server/src/domain/action/provider.ts","../../server/src/domain/condition/index.ts","../../server/src/domain/condition/provider.ts","../../server/src/services/permission/permissions-manager/sanitize.ts","../../server/src/services/permission/permissions-manager/validate.ts","../../server/src/services/permission/permissions-manager/query-builders.ts","../../server/src/services/permission/permissions-manager/index.ts","../../server/src/services/permission/engine.ts","../../server/src/services/permission/sections-builder/section.ts","../../server/src/services/permission/sections-builder/builder.ts","../../server/src/services/permission/sections-builder/utils.ts","../../server/src/services/permission/sections-builder/handlers.ts","../../server/src/services/permission/sections-builder/index.ts","../../server/src/services/permission/queries.ts","../../server/src/services/permission.ts","../../server/src/services/content-type.ts","../../server/src/services/condition.ts","../../server/src/services/action.ts","../../server/src/services/api-token.ts","../../server/src/services/transfer/permission.ts","../../server/src/services/transfer/token.ts","../../server/src/services/transfer/utils.ts","../../server/src/services/project-settings.ts","../../server/src/services/index.ts","../../server/src/validation/project-settings.ts","../../server/src/controllers/admin.ts","../../server/src/validation/api-tokens.ts","../../server/src/controllers/api-token.ts","../../server/src/validation/user.ts","../../server/src/controllers/authenticated-user.ts","../../server/src/validation/authentication/register.ts","../../server/src/validation/authentication/forgot-password.ts","../../server/src/validation/authentication/reset-password.ts","../../server/src/validation/authentication/renew-token.ts","../../server/src/controllers/authentication.ts","../../server/src/controllers/formatters/conditions.ts","../../server/src/controllers/permission.ts","../../server/src/validation/role.ts","../../server/src/controllers/role.ts","../../server/src/controllers/transfer/runner.ts","../../server/src/validation/transfer/token.ts","../../server/src/controllers/transfer/token.ts","../../server/src/controllers/transfer/index.ts","../../server/src/controllers/user.ts","../../server/src/controllers/webhooks.ts","../../server/src/controllers/content-api.ts","../../server/src/controllers/index.ts","../../server/src/content-types/Permission.ts","../../server/src/content-types/User.ts","../../server/src/content-types/Role.ts","../../server/src/content-types/api-token.ts","../../server/src/content-types/api-token-permission.ts","../../server/src/content-types/transfer-token.ts","../../server/src/content-types/transfer-token-permission.ts","../../server/src/content-types/index.ts","../../server/src/middlewares/rateLimit.ts","../../server/src/middlewares/data-transfer.ts","../../server/src/middlewares/index.ts","../../ee/server/src/register.ts","../../ee/server/src/utils/index.ts","../../ee/server/src/config/admin-actions.ts","../../ee/server/src/bootstrap.ts","../../ee/server/src/destroy.ts","../../ee/server/src/content-types/index.ts","../../ee/server/src/utils/sso-lock.ts","../../ee/server/src/services/auth.ts","../../ee/server/src/services/passport/provider-registry.ts","../../ee/server/src/services/passport/sso.ts","../../ee/server/src/services/passport.ts","../../ee/server/src/services/role.ts","../../ee/server/src/services/user.ts","../../ee/server/src/services/metrics.ts","../../ee/server/src/services/seat-enforcement.ts","../../ee/server/src/services/persist-tables.ts","../../ee/server/src/services/index.ts","../../ee/server/src/validation/authentication.ts","../../ee/server/src/controllers/authentication-utils/constants.ts","../../ee/server/src/controllers/authentication-utils/utils.ts","../../ee/server/src/controllers/authentication-utils/middlewares.ts","../../ee/server/src/controllers/authentication.ts","../../ee/server/src/validation/role.ts","../../ee/server/src/controllers/role.ts","../../ee/server/src/validation/user.ts","../../ee/server/src/controllers/user.ts","../../ee/server/src/controllers/admin.ts","../../ee/server/src/controllers/index.ts","../../ee/server/src/routes/utils.ts","../../ee/server/src/routes/sso.ts","../../ee/server/src/routes/license-limit.ts","../../ee/server/src/routes/index.ts","../../ee/server/src/audit-logs/routes/audit-logs.ts","../../ee/server/src/audit-logs/validation/audit-logs.ts","../../ee/server/src/audit-logs/controllers/audit-logs.ts","../../ee/server/src/audit-logs/services/audit-logs.ts","../../ee/server/src/audit-logs/services/lifecycles.ts","../../ee/server/src/audit-logs/content-types/audit-log.ts","../../ee/server/src/index.ts","../../server/src/index.ts"],"sourcesContent":["const getService = (name) => {\n  return strapi.service(`admin::${name}`);\n};\n\nexport { getService };\n","export const actions = [\r\n  {\r\n    uid: 'marketplace.read',\r\n    displayName: 'Access the marketplace',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'plugins and marketplace',\r\n    subCategory: 'marketplace',\r\n  },\r\n  {\r\n    uid: 'webhooks.create',\r\n    displayName: 'Create',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'webhooks',\r\n  },\r\n  {\r\n    uid: 'webhooks.read',\r\n    displayName: 'Read',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'webhooks',\r\n  },\r\n  {\r\n    uid: 'webhooks.update',\r\n    displayName: 'Update',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'webhooks',\r\n  },\r\n  {\r\n    uid: 'webhooks.delete',\r\n    displayName: 'Delete',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'webhooks',\r\n  },\r\n  {\r\n    uid: 'users.create',\r\n    displayName: 'Create (invite)',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'users',\r\n  },\r\n  {\r\n    uid: 'users.read',\r\n    displayName: 'Read',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'users',\r\n    aliases: [\r\n      {\r\n        actionId: 'plugin::content-manager.explorer.read',\r\n        subjects: ['admin::user'],\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    uid: 'users.update',\r\n    displayName: 'Update',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'users',\r\n  },\r\n  {\r\n    uid: 'users.delete',\r\n    displayName: 'Delete',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'users',\r\n  },\r\n  {\r\n    uid: 'roles.create',\r\n    displayName: 'Create',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'roles',\r\n  },\r\n  {\r\n    uid: 'roles.read',\r\n    displayName: 'Read',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'roles',\r\n    aliases: [\r\n      {\r\n        actionId: 'plugin::content-manager.explorer.read',\r\n        subjects: ['admin::role'],\r\n      },\r\n    ],\r\n  },\r\n  {\r\n    uid: 'roles.update',\r\n    displayName: 'Update',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'roles',\r\n  },\r\n  {\r\n    uid: 'roles.delete',\r\n    displayName: 'Delete',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'users and roles',\r\n    subCategory: 'roles',\r\n  },\r\n  {\r\n    uid: 'api-tokens.access',\r\n    displayName: 'Access the API tokens settings page',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'api tokens',\r\n    subCategory: 'api Tokens',\r\n  },\r\n  {\r\n    uid: 'api-tokens.create',\r\n    displayName: 'Create (generate)',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'api tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'api-tokens.read',\r\n    displayName: 'Read',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'api tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'api-tokens.update',\r\n    displayName: 'Update',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'api tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'api-tokens.regenerate',\r\n    displayName: 'Regenerate',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'api tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'api-tokens.delete',\r\n    displayName: 'Delete (revoke)',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'api tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'project-settings.update',\r\n    displayName: 'Update the project level settings',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'project',\r\n  },\r\n  {\r\n    uid: 'project-settings.read',\r\n    displayName: 'Read the project level settings',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'project',\r\n  },\r\n  {\r\n    uid: 'transfer.tokens.access',\r\n    displayName: 'Access the transfer tokens settings page',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'transfer tokens',\r\n    subCategory: 'transfer tokens',\r\n  },\r\n  {\r\n    uid: 'transfer.tokens.create',\r\n    displayName: 'Create (generate)',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'transfer tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'transfer.tokens.read',\r\n    displayName: 'Read',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'transfer tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'transfer.tokens.update',\r\n    displayName: 'Update',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'transfer tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'transfer.tokens.regenerate',\r\n    displayName: 'Regenerate',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'transfer tokens',\r\n    subCategory: 'general',\r\n  },\r\n  {\r\n    uid: 'transfer.tokens.delete',\r\n    displayName: 'Delete (revoke)',\r\n    pluginName: 'admin',\r\n    section: 'settings',\r\n    category: 'transfer tokens',\r\n    subCategory: 'general',\r\n  },\r\n];\r\n\r\nexport default {\r\n  actions,\r\n};\r\n","// TODO: TS User and role type\r\ntype User = any;\r\ntype Role = any;\r\n\r\nexport const conditions = [\r\n  {\r\n    displayName: 'Is creator',\r\n    name: 'is-creator',\r\n    plugin: 'admin',\r\n    handler: (user: User) => ({ 'createdBy.id': user.id }),\r\n  },\r\n  {\r\n    displayName: 'Has same role as creator',\r\n    name: 'has-same-role-as-creator',\r\n    plugin: 'admin',\r\n    handler: (user: User) => ({\r\n      'createdBy.roles': {\r\n        $elemMatch: {\r\n          id: {\r\n            $in: user.roles.map((r: Role) => r.id),\r\n          },\r\n        },\r\n      },\r\n    }),\r\n  },\r\n];\r\n\r\nexport default {\r\n  conditions,\r\n};\r\n","import { merge, map, difference, uniq } from 'lodash/fp';\r\nimport type { Core } from '@strapi/types';\r\nimport { async } from '@strapi/utils';\r\nimport { getService } from './utils';\r\nimport adminActions from './config/admin-actions';\r\nimport adminConditions from './config/admin-conditions';\r\n\r\nconst defaultAdminAuthSettings = {\r\n  providers: {\r\n    autoRegister: false,\r\n    defaultRole: null,\r\n    ssoLockedRoles: null,\r\n  },\r\n};\r\n\r\nconst registerPermissionActions = async () => {\r\n  await getService('permission').actionProvider.registerMany(adminActions.actions);\r\n};\r\n\r\nconst registerAdminConditions = async () => {\r\n  await getService('permission').conditionProvider.registerMany(adminConditions.conditions);\r\n};\r\n\r\nconst registerModelHooks = () => {\r\n  const { sendDidChangeInterfaceLanguage } = getService('metrics');\r\n\r\n  strapi.db.lifecycles.subscribe({\r\n    models: ['admin::user'],\r\n    afterCreate: sendDidChangeInterfaceLanguage,\r\n    afterDelete: sendDidChangeInterfaceLanguage,\r\n    afterUpdate({ params }) {\r\n      if (params.data.preferedLanguage) {\r\n        sendDidChangeInterfaceLanguage();\r\n      }\r\n    },\r\n  });\r\n};\r\n\r\nconst syncAuthSettings = async () => {\r\n  const adminStore = await strapi.store({ type: 'core', name: 'admin' });\r\n  const adminAuthSettings = await adminStore.get({ key: 'auth' });\r\n  const newAuthSettings = merge(defaultAdminAuthSettings, adminAuthSettings);\r\n\r\n  const roleExists = await getService('role').exists({\r\n    id: newAuthSettings.providers.defaultRole,\r\n  });\r\n\r\n  // Reset the default SSO role if it has been deleted manually\r\n  if (!roleExists) {\r\n    newAuthSettings.providers.defaultRole = null;\r\n  }\r\n\r\n  await adminStore.set({ key: 'auth', value: newAuthSettings });\r\n};\r\n\r\nconst syncAPITokensPermissions = async () => {\r\n  const validPermissions = strapi.contentAPI.permissions.providers.action.keys();\r\n  const permissionsInDB = await async.pipe(\r\n    strapi.db.query('admin::api-token-permission').findMany,\r\n    map('action')\r\n  )();\r\n\r\n  const unknownPermissions = uniq(difference(permissionsInDB, validPermissions));\r\n\r\n  if (unknownPermissions.length > 0) {\r\n    await strapi.db\r\n      .query('admin::api-token-permission')\r\n      .deleteMany({ where: { action: { $in: unknownPermissions } } });\r\n  }\r\n};\r\n\r\nexport default async ({ strapi }: { strapi: Core.Strapi }) => {\r\n  await registerAdminConditions();\r\n  await registerPermissionActions();\r\n  registerModelHooks();\r\n\r\n  const permissionService = getService('permission');\r\n  const userService = getService('user');\r\n  const roleService = getService('role');\r\n  const apiTokenService = getService('api-token');\r\n  const transferService = getService('transfer');\r\n  const tokenService = getService('token');\r\n\r\n  await roleService.createRolesIfNoneExist();\r\n  await roleService.resetSuperAdminPermissions();\r\n  await roleService.displayWarningIfNoSuperAdmin();\r\n\r\n  await permissionService.cleanPermissionsInDatabase();\r\n\r\n  await userService.displayWarningIfUsersDontHaveRole();\r\n\r\n  await syncAuthSettings();\r\n  await syncAPITokensPermissions();\r\n\r\n  await getService('metrics').sendUpdateProjectInformation(strapi);\r\n  getService('metrics').startCron(strapi);\r\n\r\n  apiTokenService.checkSaltIsDefined();\r\n  transferService.token.checkSaltIsDefined();\r\n  tokenService.checkSecretIsDefined();\r\n};\r\n","import type { Context, Next } from 'koa';\r\nimport { resolve, join, extname, basename } from 'path';\r\nimport fse from 'fs-extra';\r\nimport koaStatic from 'koa-static';\r\nimport type { Core } from '@strapi/types';\r\n\r\nconst registerAdminPanelRoute = ({ strapi }: { strapi: Core.Strapi }) => {\r\n  let buildDir = resolve(strapi.dirs.dist.root, 'build');\r\n\r\n  if (!fse.pathExistsSync(buildDir)) {\r\n    buildDir = resolve(__dirname, '../../build');\r\n  }\r\n\r\n  const serveAdminMiddleware = async (ctx: Context, next: Next) => {\r\n    await next();\r\n\r\n    if (ctx.method !== 'HEAD' && ctx.method !== 'GET') {\r\n      return;\r\n    }\r\n\r\n    if (ctx.body != null || ctx.status !== 404) {\r\n      return;\r\n    }\r\n\r\n    ctx.type = 'html';\r\n    ctx.body = fse.createReadStream(join(buildDir, 'index.html'));\r\n  };\r\n\r\n  strapi.server.routes([\r\n    {\r\n      method: 'GET',\r\n      path: `${strapi.config.admin.path}/:path*`,\r\n      handler: [\r\n        serveAdminMiddleware,\r\n        serveStatic(buildDir, {\r\n          maxage: 31536000,\r\n          defer: false,\r\n          index: 'index.html',\r\n          setHeaders(res: any, path: any) {\r\n            const ext = extname(path);\r\n            // publicly cache static files to avoid unnecessary network & disk access\r\n            if (ext !== '.html') {\r\n              res.setHeader('cache-control', 'public, max-age=31536000, immutable');\r\n            }\r\n          },\r\n        }),\r\n      ],\r\n      config: { auth: false },\r\n    },\r\n  ]);\r\n};\r\n\r\n// serveStatic is not supposed to be used to serve a folder that have sub-folders\r\nconst serveStatic = (filesDir: any, koaStaticOptions = {}) => {\r\n  const serve = koaStatic(filesDir, koaStaticOptions);\r\n\r\n  return async (ctx: Context, next: Next) => {\r\n    const prev = ctx.path;\r\n    const newPath = basename(ctx.path);\r\n\r\n    ctx.path = newPath;\r\n    await serve(ctx, async () => {\r\n      ctx.path = prev;\r\n      await next();\r\n      ctx.path = newPath;\r\n    });\r\n    ctx.path = prev;\r\n  };\r\n};\r\n\r\nexport default registerAdminPanelRoute;\r\n","import type { Context } from 'koa';\r\nimport { getService } from '../utils';\r\n\r\n/** @type {import('.').AuthenticateFunction} */\r\nexport const authenticate = async (ctx: Context) => {\r\n  const { authorization } = ctx.request.header;\r\n\r\n  if (!authorization) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  const parts = authorization.split(/\\s+/);\r\n\r\n  if (parts[0].toLowerCase() !== 'bearer' || parts.length !== 2) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  const token = parts[1];\r\n  const { payload, isValid } = getService('token').decodeJwtToken(token);\r\n\r\n  if (!isValid) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  const user = await strapi.db\r\n    .query('admin::user')\r\n    .findOne({ where: { id: payload.id }, populate: ['roles'] });\r\n\r\n  if (!user || !(user.isActive === true)) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  const userAbility = await getService('permission').engine.generateUserAbility(user);\r\n\r\n  // TODO: use the ability from ctx.state.auth instead of\r\n  // ctx.state.userAbility, and remove the assign below\r\n  ctx.state.userAbility = userAbility;\r\n  ctx.state.user = user;\r\n\r\n  return {\r\n    authenticated: true,\r\n    credentials: user,\r\n    ability: userAbility,\r\n  };\r\n};\r\n\r\nexport const name = 'admin';\r\n\r\n/** @type {import('.').AuthStrategy} */\r\nexport default {\r\n  name,\r\n  authenticate,\r\n};\r\n","const DAY_IN_MS = 24 * 60 * 60 * 1000;\r\n\r\nconst constants = {\r\n  CONTENT_TYPE_SECTION: 'contentTypes',\r\n  SUPER_ADMIN_CODE: 'strapi-super-admin',\r\n  EDITOR_CODE: 'strapi-editor',\r\n  AUTHOR_CODE: 'strapi-author',\r\n  READ_ACTION: 'plugin::content-manager.explorer.read',\r\n  CREATE_ACTION: 'plugin::content-manager.explorer.create',\r\n  UPDATE_ACTION: 'plugin::content-manager.explorer.update',\r\n  DELETE_ACTION: 'plugin::content-manager.explorer.delete',\r\n  PUBLISH_ACTION: 'plugin::content-manager.explorer.publish',\r\n  API_TOKEN_TYPE: {\r\n    READ_ONLY: 'read-only',\r\n    FULL_ACCESS: 'full-access',\r\n    CUSTOM: 'custom',\r\n  },\r\n  // The front-end only displays these values\r\n  API_TOKEN_LIFESPANS: {\r\n    UNLIMITED: null,\r\n    DAYS_7: 7 * DAY_IN_MS,\r\n    DAYS_30: 30 * DAY_IN_MS,\r\n    DAYS_90: 90 * DAY_IN_MS,\r\n  },\r\n  TRANSFER_TOKEN_TYPE: {\r\n    PUSH: 'push',\r\n    PULL: 'pull',\r\n  },\r\n  TRANSFER_TOKEN_LIFESPANS: {\r\n    UNLIMITED: null,\r\n    DAYS_7: 7 * DAY_IN_MS,\r\n    DAYS_30: 30 * DAY_IN_MS,\r\n    DAYS_90: 90 * DAY_IN_MS,\r\n  },\r\n};\r\n\r\nexport default constants;\r\n","import type { Context } from 'koa';\r\nimport { castArray, isNil } from 'lodash/fp';\r\nimport { differenceInHours, parseISO } from 'date-fns';\r\nimport { errors } from '@strapi/utils';\r\nimport constants from '../services/constants';\r\nimport { getService } from '../utils';\r\nimport '@strapi/types';\r\n\r\nconst { UnauthorizedError, ForbiddenError } = errors;\r\n\r\nconst isReadScope = (scope: any) => scope.endsWith('find') || scope.endsWith('findOne');\r\n\r\nconst extractToken = (ctx: Context) => {\r\n  if (ctx.request && ctx.request.header && ctx.request.header.authorization) {\r\n    const parts = ctx.request.header.authorization.split(/\\s+/);\r\n\r\n    if (parts[0].toLowerCase() !== 'bearer' || parts.length !== 2) {\r\n      return null;\r\n    }\r\n\r\n    return parts[1];\r\n  }\r\n\r\n  return null;\r\n};\r\n\r\n/**\r\n * Authenticate the validity of the token\r\n */\r\nexport const authenticate = async (ctx: Context) => {\r\n  const apiTokenService = getService('api-token');\r\n  const token = extractToken(ctx);\r\n\r\n  if (!token) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  const apiToken = await apiTokenService.getBy({\r\n    accessKey: apiTokenService.hash(token),\r\n  });\r\n\r\n  // token not found\r\n  if (!apiToken) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  const currentDate = new Date();\r\n\r\n  if (!isNil(apiToken.expiresAt)) {\r\n    const expirationDate = new Date(apiToken.expiresAt);\r\n    // token has expired\r\n    if (expirationDate < currentDate) {\r\n      return { authenticated: false, error: new UnauthorizedError('Token expired') };\r\n    }\r\n  }\r\n\r\n  // update lastUsedAt if the token has not been used in the last hour\r\n  // @ts-expect-error - FIXME: verify lastUsedAt is defined\r\n  const hoursSinceLastUsed = differenceInHours(currentDate, parseISO(apiToken.lastUsedAt));\r\n  if (hoursSinceLastUsed >= 1) {\r\n    await strapi.db.query('admin::api-token').update({\r\n      where: { id: apiToken.id },\r\n      data: { lastUsedAt: currentDate },\r\n    });\r\n  }\r\n\r\n  if (apiToken.type === constants.API_TOKEN_TYPE.CUSTOM) {\r\n    const ability = await strapi.contentAPI.permissions.engine.generateAbility(\r\n      apiToken.permissions.map((action: any) => ({ action }))\r\n    );\r\n\r\n    return { authenticated: true, ability, credentials: apiToken };\r\n  }\r\n\r\n  return { authenticated: true, credentials: apiToken };\r\n};\r\n\r\n/**\r\n * Verify the token has the required abilities for the requested scope\r\n *\r\n *  @type {import('.').VerifyFunction}\r\n */\r\nexport const verify = (auth: any, config: any) => {\r\n  const { credentials: apiToken, ability } = auth;\r\n\r\n  if (!apiToken) {\r\n    throw new UnauthorizedError('Token not found');\r\n  }\r\n\r\n  const currentDate = new Date();\r\n\r\n  if (!isNil(apiToken.expiresAt)) {\r\n    const expirationDate = new Date(apiToken.expiresAt);\r\n    // token has expired\r\n    if (expirationDate < currentDate) {\r\n      throw new UnauthorizedError('Token expired');\r\n    }\r\n  }\r\n\r\n  // Full access\r\n  if (apiToken.type === constants.API_TOKEN_TYPE.FULL_ACCESS) {\r\n    return;\r\n  }\r\n\r\n  // Read only\r\n  if (apiToken.type === constants.API_TOKEN_TYPE.READ_ONLY) {\r\n    /**\r\n     * If you don't have `full-access` you can only access `find` and `findOne`\r\n     * scopes. If the route has no scope, then you can't get access to it.\r\n     */\r\n    const scopes = castArray(config.scope);\r\n\r\n    if (config.scope && scopes.every(isReadScope)) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  // Custom\r\n  else if (apiToken.type === constants.API_TOKEN_TYPE.CUSTOM) {\r\n    if (!ability) {\r\n      throw new ForbiddenError();\r\n    }\r\n\r\n    const scopes = castArray(config.scope);\r\n\r\n    const isAllowed = scopes.every((scope) => ability.can(scope));\r\n\r\n    if (isAllowed) {\r\n      return;\r\n    }\r\n  }\r\n\r\n  throw new ForbiddenError();\r\n};\r\n\r\nexport const name = 'api-token';\r\n\r\nexport default {\r\n  name: 'api-token',\r\n  authenticate,\r\n  verify,\r\n};\r\n","import type { Core } from '@strapi/types';\r\nimport registerAdminPanelRoute from './routes/serve-admin-panel';\r\nimport adminAuthStrategy from './strategies/admin';\r\nimport apiTokenAuthStrategy from './strategies/api-token';\r\n\r\nexport default ({ strapi }: { strapi: Core.Strapi }) => {\r\n  const passportMiddleware = strapi.service('admin::passport').init();\r\n\r\n  strapi.server.api('admin').use(passportMiddleware);\r\n  strapi.get('auth').register('admin', adminAuthStrategy);\r\n  strapi.get('auth').register('content-api', apiTokenAuthStrategy);\r\n\r\n  if (strapi.config.get('admin.serveAdminPanel')) {\r\n    registerAdminPanelRoute({ strapi });\r\n  }\r\n};\r\n","import { getService } from './utils';\r\n\r\nexport default async () => {\r\n  const { conditionProvider, actionProvider } = getService('permission');\r\n\r\n  await conditionProvider.clear();\r\n  await actionProvider.clear();\r\n};\r\n","const subject = `Reset password`;\r\n\r\nconst html = `<p>We heard that you lost your password. Sorry about that!</p>\r\n\r\n<p>But don’t worry! You can use the following link to reset your password:</p>\r\n\r\n<p><%= url %></p>\r\n\r\n<p>Thanks.</p>`;\r\n\r\nconst text = `We heard that you lost your password. Sorry about that!\r\n\r\nBut don’t worry! You can use the following link to reset your password:\r\n\r\n<%= url %>\r\n\r\nThanks.`;\r\n\r\nexport default { subject, text, html };\r\n","import forgotPasswordTemplate from './email-templates/forgot-password';\r\n\r\nexport const forgotPassword = {\r\n  emailTemplate: forgotPasswordTemplate,\r\n};\r\n\r\nexport default {\r\n  forgotPassword,\r\n};\r\n","export default (policyCtx: any) => {\r\n  return Boolean(policyCtx.state.isAuthenticated);\r\n};\r\n","import _ from 'lodash';\r\nimport { yup, validateYupSchema } from '@strapi/utils';\r\n\r\nconst hasPermissionsSchema = yup.object({\r\n  actions: yup.array().of(\r\n    // @ts-expect-error yup types\r\n    yup.lazy((val) => {\r\n      if (_.isArray(val)) {\r\n        return yup.array().of(yup.string()).min(1).max(2);\r\n      }\r\n\r\n      if (_.isString(val)) {\r\n        return yup.string().required();\r\n      }\r\n\r\n      return yup.object().shape({\r\n        action: yup.string().required(),\r\n        subject: yup.string(),\r\n      });\r\n    })\r\n  ),\r\n});\r\n\r\nexport const validateHasPermissionsInput = validateYupSchema(hasPermissionsSchema);\r\n\r\nexport default {\r\n  validateHasPermissionsInput,\r\n};\r\n","import _ from 'lodash';\r\nimport { policy } from '@strapi/utils';\r\nimport { validateHasPermissionsInput } from '../validation/policies/hasPermissions';\r\n\r\nconst { createPolicy } = policy;\r\n\r\nconst inputModifiers = [\r\n  {\r\n    check: _.isString,\r\n    transform: (action: any) => ({ action }),\r\n  },\r\n  {\r\n    check: _.isArray,\r\n    transform: (arr: any) => ({ action: arr[0], subject: arr[1] }),\r\n  },\r\n  {\r\n    // Has to be after the isArray check since _.isObject also matches arrays\r\n    check: _.isObject,\r\n    transform: (perm: any) => perm,\r\n  },\r\n];\r\n\r\nexport default createPolicy({\r\n  name: 'admin::hasPermissions',\r\n  validator: validateHasPermissionsInput,\r\n  handler(ctx, config) {\r\n    const { actions } = config;\r\n    const { userAbility: ability } = ctx.state;\r\n\r\n    const permissions = actions.map((action: any) =>\r\n      inputModifiers.find((modifier) => modifier.check(action))?.transform(action)\r\n    );\r\n\r\n    const isAuthorized = permissions.every(({ action, subject }: any) =>\r\n      ability.can(action, subject)\r\n    );\r\n\r\n    return isAuthorized;\r\n  },\r\n});\r\n","import { policy } from '@strapi/utils';\r\n\r\n// TODO: TS - Try to make { policy: { createPolicy } } from '@strapi/utils'; work\r\nconst { createPolicy } = policy;\r\n\r\n/**\r\n * This policy is used for routes dealing with telemetry and analytics content.\r\n * It will fails when the telemetry has been disabled on the server.\r\n */\r\nexport default createPolicy({\r\n  name: 'admin::isTelemetryEnabled',\r\n  handler(_ctx, _config, { strapi }) {\r\n    if (strapi.telemetry.isDisabled) {\r\n      return false;\r\n    }\r\n  },\r\n});\r\n","import isAuthenticatedAdmin from './isAuthenticatedAdmin';\r\nimport hasPermissions from './hasPermissions';\r\nimport isTelemetryEnabled from './isTelemetryEnabled';\r\n\r\nexport default { isAuthenticatedAdmin, hasPermissions, isTelemetryEnabled };\r\n","export default [\r\n  {\r\n    method: 'GET',\r\n    path: '/init',\r\n    handler: 'admin.init',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/project-settings',\r\n    handler: 'admin.getProjectSettings',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        {\r\n          name: 'admin::hasPermissions',\r\n          config: { actions: ['admin::project-settings.read'] },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/project-settings',\r\n    handler: 'admin.updateProjectSettings',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        {\r\n          name: 'admin::hasPermissions',\r\n          config: { actions: ['admin::project-settings.update'] },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/project-type',\r\n    handler: 'admin.getProjectType',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/information',\r\n    handler: 'admin.information',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/telemetry-properties',\r\n    handler: 'admin.telemetryProperties',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/plugins',\r\n    handler: 'admin.plugins',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::marketplace.read'] } },\r\n      ],\r\n    },\r\n  },\r\n];\r\n","export default [\r\n  {\r\n    method: 'POST',\r\n    path: '/login',\r\n    handler: 'authentication.login',\r\n    config: {\r\n      auth: false,\r\n      middlewares: ['admin::rateLimit'],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/renew-token',\r\n    handler: 'authentication.renewToken',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/register-admin',\r\n    handler: 'authentication.registerAdmin',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/registration-info',\r\n    handler: 'authentication.registrationInfo',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/register',\r\n    handler: 'authentication.register',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/forgot-password',\r\n    handler: 'authentication.forgotPassword',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/reset-password',\r\n    handler: 'authentication.resetPassword',\r\n    config: { auth: false },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/logout',\r\n    handler: 'authentication.logout',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n];\r\n","export default [\r\n  {\r\n    method: 'GET',\r\n    path: '/permissions',\r\n    handler: 'permission.getAll',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/permissions/check',\r\n    handler: 'permission.check',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n];\r\n","export default [\r\n  {\r\n    method: 'GET',\r\n    path: '/users/me',\r\n    handler: 'authenticated-user.getMe',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n  {\r\n    method: 'PUT',\r\n    path: '/users/me',\r\n    handler: 'authenticated-user.updateMe',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/users/me/permissions',\r\n    handler: 'authenticated-user.getOwnPermissions',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/users',\r\n    handler: 'user.create',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::users.create'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/users',\r\n    handler: 'user.find',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::users.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/users/:id',\r\n    handler: 'user.findOne',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::users.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'PUT',\r\n    path: '/users/:id',\r\n    handler: 'user.update',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::users.update'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'DELETE',\r\n    path: '/users/:id',\r\n    handler: 'user.deleteOne',\r\n    config: {\r\n      policies: [{ name: 'admin::hasPermissions', config: { actions: ['admin::users.delete'] } }],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/users/batch-delete',\r\n    handler: 'user.deleteMany',\r\n    config: {\r\n      policies: [{ name: 'admin::hasPermissions', config: { actions: ['admin::users.delete'] } }],\r\n    },\r\n  },\r\n];\r\n","export default [\r\n  {\r\n    method: 'GET',\r\n    path: '/roles/:id/permissions',\r\n    handler: 'role.getPermissions',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::roles.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'PUT',\r\n    path: '/roles/:id/permissions',\r\n    handler: 'role.updatePermissions',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::roles.update'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/roles/:id',\r\n    handler: 'role.findOne',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::roles.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/roles',\r\n    handler: 'role.findAll',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::roles.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/roles',\r\n    handler: 'role.create',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        {\r\n          name: 'admin::hasPermissions',\r\n          config: {\r\n            actions: ['admin::roles.create'],\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'PUT',\r\n    path: '/roles/:id',\r\n    handler: 'role.update',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::roles.update'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'DELETE',\r\n    path: '/roles/:id',\r\n    handler: 'role.deleteOne',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        {\r\n          name: 'admin::hasPermissions',\r\n          config: {\r\n            actions: ['admin::roles.delete'],\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/roles/batch-delete',\r\n    handler: 'role.deleteMany',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        {\r\n          name: 'admin::hasPermissions',\r\n          config: {\r\n            actions: ['admin::roles.delete'],\r\n          },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n];\r\n","export default [\r\n  {\r\n    method: 'GET',\r\n    path: '/webhooks',\r\n    handler: 'webhooks.listWebhooks',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::webhooks.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/webhooks',\r\n    handler: 'webhooks.createWebhook',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::webhooks.create'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/webhooks/:id',\r\n    handler: 'webhooks.getWebhook',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::webhooks.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'PUT',\r\n    path: '/webhooks/:id',\r\n    handler: 'webhooks.updateWebhook',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::webhooks.update'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'DELETE',\r\n    path: '/webhooks/:id',\r\n    handler: 'webhooks.deleteWebhook',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::webhooks.delete'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/webhooks/batch-delete',\r\n    handler: 'webhooks.deleteWebhooks',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::webhooks.delete'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/webhooks/:id/trigger',\r\n    handler: 'webhooks.triggerWebhook',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::webhooks.update'] } },\r\n      ],\r\n    },\r\n  },\r\n];\r\n","export default [\r\n  {\r\n    method: 'POST',\r\n    path: '/api-tokens',\r\n    handler: 'api-token.create',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::api-tokens.create'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/api-tokens',\r\n    handler: 'api-token.list',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::api-tokens.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'DELETE',\r\n    path: '/api-tokens/:id',\r\n    handler: 'api-token.revoke',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::api-tokens.delete'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/api-tokens/:id',\r\n    handler: 'api-token.get',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::api-tokens.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'PUT',\r\n    path: '/api-tokens/:id',\r\n    handler: 'api-token.update',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::api-tokens.update'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/api-tokens/:id/regenerate',\r\n    handler: 'api-token.regenerate',\r\n    config: {\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::api-tokens.regenerate'] } },\r\n      ],\r\n    },\r\n  },\r\n];\r\n","export default [\r\n  {\r\n    method: 'GET',\r\n    path: '/content-api/permissions',\r\n    handler: 'content-api.getPermissions',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/content-api/routes',\r\n    handler: 'content-api.getRoutes',\r\n    config: {\r\n      policies: ['admin::isAuthenticatedAdmin'],\r\n    },\r\n  },\r\n];\r\n","import type { Context } from 'koa';\r\nimport { differenceInHours, parseISO } from 'date-fns';\r\nimport { errors } from '@strapi/utils';\r\nimport { castArray, isNil } from 'lodash/fp';\r\n\r\nimport { getService } from '../utils';\r\n\r\nconst { UnauthorizedError, ForbiddenError } = errors;\r\n\r\nconst extractToken = (ctx: Context) => {\r\n  if (ctx.request && ctx.request.header && ctx.request.header.authorization) {\r\n    const parts = ctx.request.header.authorization.split(/\\s+/);\r\n\r\n    if (parts[0].toLowerCase() !== 'bearer' || parts.length !== 2) {\r\n      return null;\r\n    }\r\n\r\n    return parts[1];\r\n  }\r\n\r\n  return null;\r\n};\r\n\r\n/**\r\n * Authenticate the validity of the token\r\n *\r\n *  @type {import('.').AuthenticateFunction}\r\n */\r\nexport const authenticate = async (ctx: Context) => {\r\n  const { token: tokenService } = getService('transfer');\r\n  const token = extractToken(ctx);\r\n\r\n  if (!token) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  const transferToken = await tokenService.getBy({ accessKey: tokenService.hash(token) });\r\n\r\n  // Check if the token exists\r\n  if (!transferToken) {\r\n    return { authenticated: false };\r\n  }\r\n\r\n  // Check if the token has expired\r\n  const currentDate = new Date();\r\n\r\n  if (!isNil(transferToken.expiresAt)) {\r\n    const expirationDate = new Date(transferToken.expiresAt);\r\n\r\n    if (expirationDate < currentDate) {\r\n      return { authenticated: false, error: new UnauthorizedError('Token expired') };\r\n    }\r\n  }\r\n\r\n  // Update token metadata if the token has not been used in the last hour\r\n  // @ts-expect-error - FIXME: verify lastUsedAt is defined\r\n  const hoursSinceLastUsed = differenceInHours(currentDate, parseISO(transferToken.lastUsedAt));\r\n  if (hoursSinceLastUsed >= 1) {\r\n    await strapi.db.query('admin::api-token').update({\r\n      where: { id: transferToken.id },\r\n      data: { lastUsedAt: currentDate },\r\n    });\r\n  }\r\n\r\n  // Generate an ability based on the token permissions\r\n  const ability = await getService('transfer').permission.engine.generateAbility(\r\n    transferToken.permissions.map((action: any) => ({ action }))\r\n  );\r\n\r\n  return { authenticated: true, ability, credentials: transferToken };\r\n};\r\n\r\n/**\r\n * Verify the token has the required abilities for the requested scope\r\n *\r\n *  @type {import('.').VerifyFunction}\r\n */\r\nexport const verify = async (auth: any, config: any = {}) => {\r\n  const { credentials: transferToken, ability } = auth;\r\n\r\n  if (!transferToken) {\r\n    throw new UnauthorizedError('Token not found');\r\n  }\r\n\r\n  const currentDate = new Date();\r\n\r\n  if (!isNil(transferToken.expiresAt)) {\r\n    const expirationDate = new Date(transferToken.expiresAt);\r\n    // token has expired\r\n    if (expirationDate < currentDate) {\r\n      throw new UnauthorizedError('Token expired');\r\n    }\r\n  }\r\n\r\n  if (!ability) {\r\n    throw new ForbiddenError();\r\n  }\r\n\r\n  const scopes = castArray(config.scope ?? []);\r\n\r\n  const isAllowed = scopes.every((scope) => ability.can(scope));\r\n\r\n  if (!isAllowed) {\r\n    throw new ForbiddenError();\r\n  }\r\n};\r\n\r\nexport const name = 'data-transfer';\r\n\r\n/** @type {import('.').AuthStrategy} */\r\nexport default {\r\n  name,\r\n  authenticate,\r\n  verify,\r\n};\r\n","import dataTransferAuthStrategy from '../strategies/data-transfer';\r\n\r\nexport default [\r\n  // Transfer Push\r\n  {\r\n    method: 'GET',\r\n    path: '/transfer/runner/push',\r\n    handler: 'transfer.runner-push',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      auth: { strategies: [dataTransferAuthStrategy], scope: ['push'] },\r\n    },\r\n  },\r\n  // Transfer Pull\r\n  {\r\n    method: 'GET',\r\n    path: '/transfer/runner/pull',\r\n    handler: 'transfer.runner-pull',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      auth: { strategies: [dataTransferAuthStrategy], scope: ['pull'] },\r\n    },\r\n  },\r\n  // Transfer Tokens\r\n  {\r\n    method: 'POST',\r\n    path: '/transfer/tokens',\r\n    handler: 'transfer.token-create',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::transfer.tokens.create'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/transfer/tokens',\r\n    handler: 'transfer.token-list',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::transfer.tokens.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'DELETE',\r\n    path: '/transfer/tokens/:id',\r\n    handler: 'transfer.token-revoke',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::transfer.tokens.delete'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'GET',\r\n    path: '/transfer/tokens/:id',\r\n    handler: 'transfer.token-getById',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::transfer.tokens.read'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'PUT',\r\n    path: '/transfer/tokens/:id',\r\n    handler: 'transfer.token-update',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        { name: 'admin::hasPermissions', config: { actions: ['admin::transfer.tokens.update'] } },\r\n      ],\r\n    },\r\n  },\r\n  {\r\n    method: 'POST',\r\n    path: '/transfer/tokens/:id/regenerate',\r\n    handler: 'transfer.token-regenerate',\r\n    config: {\r\n      middlewares: ['admin::data-transfer'],\r\n      policies: [\r\n        'admin::isAuthenticatedAdmin',\r\n        {\r\n          name: 'admin::hasPermissions',\r\n          config: { actions: ['admin::transfer.tokens.regenerate'] },\r\n        },\r\n      ],\r\n    },\r\n  },\r\n];\r\n","import admin from './admin';\r\nimport authentication from './authentication';\r\nimport permissions from './permissions';\r\nimport users from './users';\r\nimport roles from './roles';\r\nimport webhooks from './webhooks';\r\nimport apiTokens from './api-tokens';\r\nimport contentApi from './content-api';\r\nimport transfer from './transfer';\r\n\r\nconst routes = {\r\n  admin: {\r\n    type: 'admin',\r\n    routes: [\r\n      ...admin,\r\n      ...authentication,\r\n      ...permissions,\r\n      ...users,\r\n      ...roles,\r\n      ...webhooks,\r\n      ...apiTokens,\r\n      ...contentApi,\r\n      ...transfer,\r\n    ],\r\n  },\r\n};\r\n\r\nexport default routes;\r\n","import bcrypt from 'bcryptjs';\r\nimport _ from 'lodash';\r\nimport { errors } from '@strapi/utils';\r\nimport { getService } from '../utils';\r\nimport type { AdminUser } from '../../../shared/contracts/shared';\r\nimport '@strapi/types';\r\n\r\nconst { ApplicationError } = errors;\r\n\r\n/**\r\n * hashes a password\r\n * @param password - password to hash\r\n * @returns hashed password\r\n */\r\nconst hashPassword = (password: string) => bcrypt.hash(password, 10);\r\n\r\n/**\r\n * Validate a password\r\n * @param password\r\n * @param hash\r\n * @returns {Promise<boolean>} is the password valid\r\n */\r\nconst validatePassword = (password: string, hash: string) => bcrypt.compare(password, hash);\r\n\r\n/**\r\n * Check login credentials\r\n * @param email the users email address\r\n * @param password the users password\r\n */\r\nconst checkCredentials = async ({ email, password }: { email: string; password: string }) => {\r\n  const user: AdminUser = await strapi.db.query('admin::user').findOne({ where: { email } });\r\n\r\n  if (!user || !user.password) {\r\n    return [null, false, { message: 'Invalid credentials' }];\r\n  }\r\n\r\n  const isValid = await validatePassword(password, user.password);\r\n\r\n  if (!isValid) {\r\n    return [null, false, { message: 'Invalid credentials' }];\r\n  }\r\n\r\n  if (!(user.isActive === true)) {\r\n    return [null, false, { message: 'User not active' }];\r\n  }\r\n\r\n  return [null, user];\r\n};\r\n\r\n/**\r\n * Send an email to the user if it exists or do nothing\r\n * @param email user email for which to reset the password\r\n */\r\nconst forgotPassword = async ({ email } = {} as { email: string }) => {\r\n  const user: AdminUser = await strapi.db\r\n    .query('admin::user')\r\n    .findOne({ where: { email, isActive: true } });\r\n  if (!user) {\r\n    return;\r\n  }\r\n\r\n  const resetPasswordToken = getService('token').createToken();\r\n  await getService('user').updateById(user.id, { resetPasswordToken });\r\n\r\n  // Send an email to the admin.\r\n  const url = `${strapi.config.get(\r\n    'admin.absoluteUrl'\r\n  )}/auth/reset-password?code=${resetPasswordToken}`;\r\n\r\n  return strapi\r\n    .plugin('email')\r\n    .service('email')\r\n    .sendTemplatedEmail(\r\n      {\r\n        to: user.email,\r\n        from: strapi.config.get('admin.forgotPassword.from'),\r\n        replyTo: strapi.config.get('admin.forgotPassword.replyTo'),\r\n      },\r\n      strapi.config.get('admin.forgotPassword.emailTemplate'),\r\n      {\r\n        url,\r\n        user: _.pick(user, ['email', 'firstname', 'lastname', 'username']),\r\n      }\r\n    )\r\n    .catch((err: unknown) => {\r\n      // log error server side but do not disclose it to the user to avoid leaking informations\r\n      strapi.log.error(err);\r\n    });\r\n};\r\n\r\n/**\r\n * Reset a user password\r\n * @param resetPasswordToken token generated to request a password reset\r\n * @param password new user password\r\n */\r\nconst resetPassword = async (\r\n  { resetPasswordToken, password } = {} as { resetPasswordToken: string; password: string }\r\n) => {\r\n  const matchingUser: AdminUser | undefined = await strapi.db\r\n    .query('admin::user')\r\n    .findOne({ where: { resetPasswordToken, isActive: true } });\r\n\r\n  if (!matchingUser) {\r\n    throw new ApplicationError();\r\n  }\r\n\r\n  return getService('user').updateById(matchingUser.id, {\r\n    password,\r\n    resetPasswordToken: null,\r\n  });\r\n};\r\n\r\nexport default { checkCredentials, validatePassword, hashPassword, forgotPassword, resetPassword };\r\n","import constants from '../services/constants';\r\n\r\nimport type {\r\n  AdminUser,\r\n  AdminRole,\r\n  AdminUserCreationPayload,\r\n} from '../../../shared/contracts/shared';\r\n\r\nconst { SUPER_ADMIN_CODE } = constants;\r\n\r\n/**\r\n * Create a new user model by merging default and specified attributes\r\n * @param attributes A partial user object\r\n */\r\nexport function createUser(attributes: Partial<AdminUserCreationPayload>) {\r\n  return {\r\n    roles: [],\r\n    isActive: false,\r\n    username: null,\r\n    ...attributes,\r\n  };\r\n}\r\n\r\nexport const hasSuperAdminRole = (user: AdminUser) => {\r\n  return user.roles.filter((role: AdminRole) => role.code === SUPER_ADMIN_CODE).length > 0;\r\n};\r\n\r\nexport const ADMIN_USER_ALLOWED_FIELDS = ['id', 'firstname', 'lastname', 'username'];\r\n\r\nexport default {\r\n  createUser,\r\n  hasSuperAdminRole,\r\n  ADMIN_USER_ALLOWED_FIELDS,\r\n};\r\n","import type { Utils } from '@strapi/types';\r\n\r\nimport { curry, pipe, merge, set, pick, omit, includes, isArray, prop } from 'lodash/fp';\r\n\r\nexport interface ActionAlias {\r\n  /**\r\n   * The action ID to alias\r\n   */\r\n  actionId: string;\r\n\r\n  /**\r\n   * An optional array of subject to restrict the alias usage\r\n   */\r\n  subjects?: string[];\r\n}\r\n\r\nexport type Action = {\r\n  /**\r\n   * The unique identifier of the action\r\n   */\r\n  actionId: string;\r\n\r\n  /**\r\n   * The section linked to the action - These can be 'contentTypes' | 'plugins' | 'settings' | 'internal'\r\n   */\r\n  section: string;\r\n\r\n  /**\r\n   * The human readable name of an action\r\n   */\r\n  displayName: string;\r\n\r\n  /**\r\n   * The main category of an action\r\n   */\r\n  category: string;\r\n\r\n  /**\r\n   * The secondary category of an action (only for settings and plugins section)\r\n   */\r\n  subCategory?: string;\r\n\r\n  /**\r\n   * The plugin that provides the action\r\n   */\r\n  pluginName?: string;\r\n\r\n  /**\r\n   * A list of subjects on which the action can be applied\r\n   */\r\n  subjects?: string[];\r\n\r\n  /**\r\n   * The options of an action\r\n   */\r\n  options: {\r\n    /**\r\n     * The list of properties that can be associated with an action\r\n     */\r\n    applyToProperties: string[] | null;\r\n  };\r\n\r\n  /**\r\n   * An optional array of @see {@link ActionAlias}.\r\n   *\r\n   * It represents the possible aliases for the current action.\r\n   *\r\n   * Aliases are unidirectional.\r\n   *\r\n   * Note: This is an internal property and probably shouldn't be used outside Strapi core features.\r\n   *       Its behavior might change at any time without notice.\r\n   *\r\n   * @internal\r\n   */\r\n  aliases?: ActionAlias[];\r\n};\r\n\r\n/**\r\n * Set of attributes used to create a new {@link Action} object\r\n * @typedef {Action, { uid: string }} CreateActionPayload\r\n */\r\nexport type CreateActionPayload = Utils.Intersect<\r\n  [\r\n    Utils.Object.PartialBy<\r\n      // Action Id is computed from the uid value\r\n      Omit<Action, 'actionId'>,\r\n      // Options is filled with default values\r\n      'options'\r\n    >,\r\n    { uid: string },\r\n  ]\r\n>;\r\n\r\n/**\r\n * Return the default attributes of a new {@link Action}\r\n * @return Partial<Action>\r\n */\r\nconst getDefaultActionAttributes = (): Partial<Action> => ({\r\n  options: {\r\n    applyToProperties: null,\r\n  },\r\n});\r\n\r\n/**\r\n * Get the list of all the valid attributes of an {@link Action}\r\n */\r\nconst actionFields = [\r\n  'section',\r\n  'displayName',\r\n  'category',\r\n  'subCategory',\r\n  'pluginName',\r\n  'subjects',\r\n  'options',\r\n  'actionId',\r\n  'aliases',\r\n] as const;\r\n\r\n/**\r\n * Remove unwanted attributes from an {@link Action}\r\n */\r\nconst sanitizeActionAttributes = pick(actionFields) as (\r\n  action: Action | CreateActionPayload\r\n) => Action;\r\n\r\n/**\r\n * Create and return an identifier for an {@link CreateActionPayload}.\r\n * The format is based on the action's source ({@link CreateActionPayload.pluginName} or 'application') and {@link CreateActionPayload.uid}.\r\n * @param {CreateActionPayload} attributes\r\n * @return {string}\r\n */\r\n// TODO: TS - Use Common.UID\r\nconst computeActionId = (attributes: CreateActionPayload): string => {\r\n  const { pluginName, uid } = attributes;\r\n\r\n  if (!pluginName) {\r\n    return `api::${uid}`;\r\n  }\r\n\r\n  if (pluginName === 'admin') {\r\n    return `admin::${uid}`;\r\n  }\r\n\r\n  return `plugin::${pluginName}.${uid}`;\r\n};\r\n\r\n/**\r\n * Assign an actionId attribute to an {@link CreateActionPayload} object\r\n */\r\nconst assignActionId = (attrs: CreateActionPayload) =>\r\n  set('actionId', computeActionId(attrs), attrs);\r\n\r\n/**\r\n * Transform an action by adding or removing the {@link Action.subCategory} attribute\r\n * @param {Action} action - The action to process\r\n * @return {Action}\r\n */\r\nconst assignOrOmitSubCategory = (action: Action): Action => {\r\n  const shouldHaveSubCategory = ['settings', 'plugins'].includes(action.section);\r\n\r\n  return shouldHaveSubCategory\r\n    ? set('subCategory', action.subCategory || 'general', action)\r\n    : omit('subCategory', action);\r\n};\r\n\r\n/**\r\n * Check if a property can be applied to an {@link Action}\r\n */\r\nconst appliesToProperty = curry((property: string, action: Action): boolean => {\r\n  return pipe(prop('options.applyToProperties'), includes(property))(action);\r\n});\r\n\r\n/**\r\n * Check if an action applies to a subject\r\n */\r\nconst appliesToSubject = curry((subject: string, action: Action): boolean => {\r\n  return isArray(action.subjects) && includes(subject, action.subjects);\r\n});\r\n\r\n/**\r\n * Transform the given attributes into a domain representation of an Action\r\n */\r\nconst create: (payload: CreateActionPayload) => Action = pipe(\r\n  // Create and assign an action identifier to the action\r\n  // (need to be done before the sanitizeActionAttributes since we need the uid here)\r\n  assignActionId,\r\n  // Add or remove the sub category field based on the pluginName attribute\r\n  assignOrOmitSubCategory,\r\n  // Remove unwanted attributes from the payload\r\n  sanitizeActionAttributes,\r\n  // Complete the action creation by adding default values for some attributes\r\n  merge(getDefaultActionAttributes())\r\n);\r\n\r\nexport default {\r\n  actionFields,\r\n  appliesToProperty,\r\n  appliesToSubject,\r\n  assignActionId,\r\n  assignOrOmitSubCategory,\r\n  create,\r\n  computeActionId,\r\n  getDefaultActionAttributes,\r\n  sanitizeActionAttributes,\r\n};\r\n","import _ from 'lodash';\r\n\r\nconst checkFieldsAreCorrectlyNested = (fields: unknown) => {\r\n  if (_.isNil(fields)) {\r\n    // Only check if the fields exist\r\n    return true;\r\n  }\r\n  if (!Array.isArray(fields)) {\r\n    return false;\r\n  }\r\n\r\n  let failed = false;\r\n  for (let indexA = 0; indexA < fields.length; indexA += 1) {\r\n    failed = fields\r\n      .slice(indexA + 1)\r\n      .some(\r\n        (fieldB) =>\r\n          fieldB.startsWith(`${fields[indexA]}.`) || fields[indexA].startsWith(`${fieldB}.`)\r\n      );\r\n    if (failed) break;\r\n  }\r\n\r\n  return !failed;\r\n};\r\n\r\nexport default checkFieldsAreCorrectlyNested;\r\n","import _ from 'lodash';\r\n\r\nconst checkFieldsDontHaveDuplicates = (fields: unknown) => {\r\n  if (_.isNil(fields)) {\r\n    // Only check if the fields exist\r\n    return true;\r\n  }\r\n  if (!Array.isArray(fields)) {\r\n    return false;\r\n  }\r\n\r\n  return _.uniq(fields).length === fields.length;\r\n};\r\n\r\nexport default checkFieldsDontHaveDuplicates;\r\n","import { yup } from '@strapi/utils';\r\nimport _ from 'lodash';\r\nimport { isEmpty, has, isNil, isArray } from 'lodash/fp';\r\nimport { getService } from '../utils';\r\nimport actionDomain, { type Action } from '../domain/action';\r\nimport { checkFieldsAreCorrectlyNested, checkFieldsDontHaveDuplicates } from './common-functions';\r\nimport actions from '../domain/action/index';\r\n\r\nconst { actionFields } = actions;\r\n\r\nconst getActionFromProvider = (actionId: string) => {\r\n  return getService('permission').actionProvider.get(actionId);\r\n};\r\n\r\nexport const email = yup.string().email().lowercase();\r\n\r\nexport const firstname = yup.string().trim().min(1);\r\n\r\nexport const lastname = yup.string();\r\n\r\nexport const username = yup.string().min(1);\r\n\r\nexport const password = yup\r\n  .string()\r\n  .min(8)\r\n  .matches(/[a-z]/, '${path} must contain at least one lowercase character')\r\n  .matches(/[A-Z]/, '${path} must contain at least one uppercase character')\r\n  .matches(/\\d/, '${path} must contain at least one number');\r\n\r\nexport const roles = yup.array(yup.strapiID()).min(1);\r\n\r\nconst isAPluginName = yup\r\n  .string()\r\n  .test('is-a-plugin-name', 'is not a plugin name', function (value) {\r\n    return [undefined, 'admin', ...Object.keys(strapi.plugins)].includes(value)\r\n      ? true\r\n      : this.createError({ path: this.path, message: `${this.path} is not an existing plugin` });\r\n  });\r\n\r\nexport const arrayOfConditionNames = yup\r\n  .array()\r\n  .of(yup.string())\r\n  .test('is-an-array-of-conditions', 'is not a plugin name', function (value) {\r\n    const ids = strapi.service('admin::permission').conditionProvider.keys();\r\n    return _.isUndefined(value) || _.difference(value, ids).length === 0\r\n      ? true\r\n      : this.createError({ path: this.path, message: `contains conditions that don't exist` });\r\n  });\r\n\r\nexport const permissionsAreEquals = (a: any, b: any) =>\r\n  a.action === b.action && (a.subject === b.subject || (_.isNil(a.subject) && _.isNil(b.subject)));\r\n\r\nconst checkNoDuplicatedPermissions = (permissions: unknown) =>\r\n  !Array.isArray(permissions) ||\r\n  permissions.every((permA, i) =>\r\n    permissions.slice(i + 1).every((permB) => !permissionsAreEquals(permA, permB))\r\n  );\r\n\r\nconst checkNilFields = (action: Action) =>\r\n  function (fields: typeof actionFields) {\r\n    // If the parent has no action field, then we ignore this test\r\n    if (isNil(action)) {\r\n      return true;\r\n    }\r\n\r\n    return actionDomain.appliesToProperty('fields', action) || isNil(fields);\r\n  };\r\n\r\nconst fieldsPropertyValidation = (action: Action) =>\r\n  yup\r\n    .array()\r\n    .of(yup.string())\r\n    .nullable()\r\n    .test(\r\n      'field-nested',\r\n      'Fields format are incorrect (bad nesting).',\r\n      checkFieldsAreCorrectlyNested\r\n    )\r\n    .test(\r\n      'field-nested',\r\n      'Fields format are incorrect (duplicates).',\r\n      checkFieldsDontHaveDuplicates\r\n    )\r\n    .test(\r\n      'fields-restriction',\r\n      'The permission at ${path} must have fields set to null or undefined',\r\n      // @ts-expect-error yup types\r\n      checkNilFields(action)\r\n    );\r\n\r\nexport const permission = yup\r\n  .object()\r\n  .shape({\r\n    action: yup\r\n      .string()\r\n      .required()\r\n      .test('action-validity', 'action is not an existing permission action', function (actionId) {\r\n        // If the action field is Nil, ignore the test and let the required check handle the error\r\n        if (isNil(actionId)) {\r\n          return true;\r\n        }\r\n\r\n        return !!getActionFromProvider(actionId);\r\n      }),\r\n    actionParameters: yup.object().nullable(),\r\n    subject: yup\r\n      .string()\r\n      .nullable()\r\n      .test('subject-validity', 'Invalid subject submitted', function (subject) {\r\n        // @ts-expect-error yup types\r\n        const action = getActionFromProvider(this.options.parent.action);\r\n\r\n        if (!action) {\r\n          return true;\r\n        }\r\n\r\n        if (isNil(action.subjects)) {\r\n          return isNil(subject);\r\n        }\r\n\r\n        if (isArray(action.subjects) && !isNil(subject)) {\r\n          return action.subjects.includes(subject);\r\n        }\r\n\r\n        return false;\r\n      }),\r\n    properties: yup\r\n      .object()\r\n      .test('properties-structure', 'Invalid property set at ${path}', function (properties) {\r\n        // @ts-expect-error yup types\r\n        const action = getActionFromProvider(this.options.parent.action) as any;\r\n        const hasNoProperties = isEmpty(properties) || isNil(properties);\r\n\r\n        if (!has('options.applyToProperties', action)) {\r\n          return hasNoProperties;\r\n        }\r\n\r\n        if (hasNoProperties) {\r\n          return true;\r\n        }\r\n\r\n        const { applyToProperties } = action.options;\r\n\r\n        if (!isArray(applyToProperties)) {\r\n          return false;\r\n        }\r\n\r\n        return Object.keys(properties).every((property) => applyToProperties.includes(property));\r\n      })\r\n      .test(\r\n        'fields-property',\r\n        'Invalid fields property at ${path}',\r\n        async function (properties = {}) {\r\n          // @ts-expect-error yup types\r\n          const action = getActionFromProvider(this.options.parent.action) as any;\r\n\r\n          if (!action || !properties) {\r\n            return true;\r\n          }\r\n\r\n          if (!actionDomain.appliesToProperty('fields', action)) {\r\n            return true;\r\n          }\r\n\r\n          try {\r\n            await fieldsPropertyValidation(action).validate(properties.fields, {\r\n              strict: true,\r\n              abortEarly: false,\r\n            });\r\n            return true;\r\n          } catch (e: any) {\r\n            // Propagate fieldsPropertyValidation error with updated path\r\n            throw this.createError({\r\n              message: e.message,\r\n              path: `${this.path}.fields`,\r\n            });\r\n          }\r\n        }\r\n      ),\r\n    conditions: yup.array().of(yup.string()),\r\n  })\r\n  .noUnknown();\r\n\r\nexport const updatePermissions = yup\r\n  .object()\r\n  .shape({\r\n    permissions: yup\r\n      .array()\r\n      .required()\r\n      .of(permission)\r\n      .test(\r\n        'duplicated-permissions',\r\n        'Some permissions are duplicated (same action and subject)',\r\n        checkNoDuplicatedPermissions\r\n      ),\r\n  })\r\n  .required()\r\n  .noUnknown();\r\n\r\nexport default {\r\n  email,\r\n  firstname,\r\n  lastname,\r\n  username,\r\n  password,\r\n  roles,\r\n  isAPluginName,\r\n  arrayOfConditionNames,\r\n  permission,\r\n  updatePermissions,\r\n};\r\n","/* eslint-disable @typescript-eslint/no-non-null-assertion */\r\nimport _ from 'lodash';\r\nimport { defaults } from 'lodash/fp';\r\nimport { arrays, errors } from '@strapi/utils';\r\nimport type { Data } from '@strapi/types';\r\nimport { createUser, hasSuperAdminRole } from '../domain/user';\r\nimport type {\r\n  AdminUser,\r\n  AdminRole,\r\n  AdminUserCreationPayload,\r\n  SanitizedAdminUser,\r\n  SanitizedAdminRole,\r\n  AdminUserUpdatePayload,\r\n  // eslint-disable-next-line node/no-unpublished-import\r\n} from '../../../shared/contracts/shared';\r\nimport { password as passwordValidator } from '../validation/common-validators';\r\nimport { getService } from '../utils';\r\nimport constants from './constants';\r\n\r\nconst { SUPER_ADMIN_CODE } = constants;\r\n\r\nconst { ValidationError } = errors;\r\nconst sanitizeUserRoles = (role: AdminRole): SanitizedAdminRole =>\r\n  _.pick(role, ['id', 'name', 'description', 'code']);\r\n\r\n/**\r\n * Remove private user fields\r\n * @param  user - user to sanitize\r\n */\r\nconst sanitizeUser = (user: AdminUser): SanitizedAdminUser => {\r\n  return {\r\n    ..._.omit(user, ['password', 'resetPasswordToken', 'registrationToken', 'roles']),\r\n    roles: user.roles && user.roles.map(sanitizeUserRoles),\r\n  };\r\n};\r\n\r\n/**\r\n * Create and save a user in database\r\n * @param attributes A partial user object\r\n */\r\nconst create = async (\r\n  // isActive is added in the controller, it's not sent by the API.\r\n  attributes: Partial<AdminUserCreationPayload> & { isActive?: true }\r\n): Promise<AdminUser> => {\r\n  const userInfo = {\r\n    registrationToken: getService('token').createToken(),\r\n    ...attributes,\r\n  };\r\n\r\n  if (_.has(attributes, 'password')) {\r\n    userInfo.password = await getService('auth').hashPassword(attributes.password!);\r\n  }\r\n\r\n  const user = createUser(userInfo);\r\n\r\n  const createdUser = await strapi.db\r\n    .query('admin::user')\r\n    .create({ data: user, populate: ['roles'] });\r\n\r\n  getService('metrics').sendDidInviteUser();\r\n\r\n  strapi.eventHub.emit('user.create', { user: sanitizeUser(createdUser) });\r\n\r\n  return createdUser;\r\n};\r\n\r\n/**\r\n * Update a user in database\r\n * @param id query params to find the user to update\r\n * @param attributes A partial user object\r\n */\r\nconst updateById = async (\r\n  id: Data.ID,\r\n  attributes: Partial<AdminUserUpdatePayload>\r\n): Promise<AdminUser> => {\r\n  // Check at least one super admin remains\r\n  if (_.has(attributes, 'roles')) {\r\n    const lastAdminUser = await isLastSuperAdminUser(id);\r\n    const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n    const willRemoveSuperAdminRole = !arrays.includesString(attributes.roles!, superAdminRole.id);\r\n\r\n    if (lastAdminUser && willRemoveSuperAdminRole) {\r\n      throw new ValidationError('You must have at least one user with super admin role.');\r\n    }\r\n  }\r\n\r\n  // cannot disable last super admin\r\n  if (attributes.isActive === false) {\r\n    const lastAdminUser = await isLastSuperAdminUser(id);\r\n    if (lastAdminUser) {\r\n      throw new ValidationError('You must have at least one user with super admin role.');\r\n    }\r\n  }\r\n\r\n  // hash password if a new one is sent\r\n  if (_.has(attributes, 'password')) {\r\n    const hashedPassword = await getService('auth').hashPassword(attributes.password!);\r\n\r\n    const updatedUser = await strapi.db.query('admin::user').update({\r\n      where: { id },\r\n      data: {\r\n        ...attributes,\r\n        password: hashedPassword,\r\n      },\r\n      populate: ['roles'],\r\n    });\r\n\r\n    strapi.eventHub.emit('user.update', { user: sanitizeUser(updatedUser) });\r\n\r\n    return updatedUser;\r\n  }\r\n\r\n  const updatedUser = await strapi.db.query('admin::user').update({\r\n    where: { id },\r\n    data: attributes,\r\n    populate: ['roles'],\r\n  });\r\n\r\n  if (updatedUser) {\r\n    strapi.eventHub.emit('user.update', { user: sanitizeUser(updatedUser) });\r\n  }\r\n\r\n  return updatedUser;\r\n};\r\n\r\n/**\r\n * Reset a user password by email. (Used in admin:reset CLI)\r\n * @param email - user email\r\n * @param password - new password\r\n */\r\nconst resetPasswordByEmail = async (email: string, password: string) => {\r\n  const user = await strapi.db\r\n    .query('admin::user')\r\n    .findOne({ where: { email }, populate: ['roles'] });\r\n\r\n  if (!user) {\r\n    throw new Error(`User not found for email: ${email}`);\r\n  }\r\n\r\n  try {\r\n    await passwordValidator.validate(password);\r\n  } catch (error) {\r\n    throw new ValidationError(\r\n      'Invalid password. Expected a minimum of 8 characters with at least one number and one uppercase letter'\r\n    );\r\n  }\r\n\r\n  await updateById(user.id, { password });\r\n};\r\n\r\n/**\r\n * Check if a user is the last super admin\r\n * @param userId user's id to look for\r\n */\r\nconst isLastSuperAdminUser = async (userId: Data.ID): Promise<boolean> => {\r\n  const user = (await findOne(userId)) as AdminUser | null;\r\n  if (!user) return false;\r\n\r\n  const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n\r\n  return superAdminRole.usersCount === 1 && hasSuperAdminRole(user);\r\n};\r\n\r\n/**\r\n * Check if a user with specific attributes exists in the database\r\n * @param attributes A partial user object\r\n */\r\nconst exists = async (attributes = {} as unknown): Promise<boolean> => {\r\n  return (await strapi.db.query('admin::user').count({ where: attributes })) > 0;\r\n};\r\n\r\n/**\r\n * Returns a user registration info\r\n * @param registrationToken - a user registration token\r\n * @returns - Returns user email, firstname and lastname\r\n */\r\nconst findRegistrationInfo = async (\r\n  registrationToken: string\r\n): Promise<Pick<AdminUser, 'email' | 'firstname' | 'lastname'> | undefined> => {\r\n  const user = await strapi.db.query('admin::user').findOne({ where: { registrationToken } });\r\n\r\n  if (!user) {\r\n    return undefined;\r\n  }\r\n\r\n  return _.pick(user, ['email', 'firstname', 'lastname']);\r\n};\r\n\r\n/**\r\n * Registers a user based on a registrationToken and some informations to update\r\n * @param params\r\n * @param params.registrationToken registration token\r\n * @param params.userInfo user info\r\n */\r\nconst register = async ({\r\n  registrationToken,\r\n  userInfo,\r\n}: {\r\n  registrationToken: string;\r\n  userInfo: Partial<AdminUser>;\r\n}) => {\r\n  const matchingUser = await strapi.db\r\n    .query('admin::user')\r\n    .findOne({ where: { registrationToken } });\r\n\r\n  if (!matchingUser) {\r\n    throw new ValidationError('Invalid registration info');\r\n  }\r\n\r\n  return getService('user').updateById(matchingUser.id, {\r\n    password: userInfo.password,\r\n    firstname: userInfo.firstname,\r\n    lastname: userInfo.lastname,\r\n    registrationToken: null,\r\n    isActive: true,\r\n  });\r\n};\r\n\r\n/**\r\n * Find one user\r\n */\r\nconst findOne = async (id: Data.ID, populate = ['roles']) => {\r\n  return strapi.db.query('admin::user').findOne({ where: { id }, populate });\r\n};\r\n\r\n/**\r\n * Find one user by its email\r\n * @param email\r\n * @param populate\r\n * @returns\r\n */\r\nconst findOneByEmail = async (email: string, populate = []) => {\r\n  return strapi.db.query('admin::user').findOne({\r\n    where: { email: { $eqi: email } },\r\n    populate,\r\n  });\r\n};\r\n\r\n/** Find many users (paginated)\r\n * @param params\r\n */\r\nconst findPage = async (params = {}): Promise<unknown> => {\r\n  const query = strapi\r\n    .get('query-params')\r\n    .transform('admin::user', defaults({ populate: ['roles'] }, params));\r\n\r\n  return strapi.db.query('admin::user').findPage(query);\r\n};\r\n\r\n/** Delete a user\r\n * @param id id of the user to delete\r\n */\r\nconst deleteById = async (id: Data.ID): Promise<AdminUser | null> => {\r\n  // Check at least one super admin remains\r\n  const userToDelete: AdminUser | null = await strapi.db.query('admin::user').findOne({\r\n    where: { id },\r\n    populate: ['roles'],\r\n  });\r\n\r\n  if (!userToDelete) {\r\n    return null;\r\n  }\r\n\r\n  if (userToDelete) {\r\n    if (userToDelete.roles.some((r) => r.code === SUPER_ADMIN_CODE)) {\r\n      const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n      if (superAdminRole.usersCount === 1) {\r\n        throw new ValidationError('You must have at least one user with super admin role.');\r\n      }\r\n    }\r\n  }\r\n\r\n  const deletedUser = await strapi.db\r\n    .query('admin::user')\r\n    .delete({ where: { id }, populate: ['roles'] });\r\n\r\n  strapi.eventHub.emit('user.delete', { user: sanitizeUser(deletedUser) });\r\n\r\n  return deletedUser;\r\n};\r\n\r\n/** Delete a user\r\n * @param ids ids of the users to delete\r\n */\r\nconst deleteByIds = async (ids: (string | number)[]): Promise<AdminUser[]> => {\r\n  // Check at least one super admin remains\r\n  const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n  const nbOfSuperAdminToDelete = await strapi.db.query('admin::user').count({\r\n    where: {\r\n      id: ids,\r\n      roles: { id: superAdminRole.id },\r\n    },\r\n  });\r\n\r\n  if (superAdminRole.usersCount === nbOfSuperAdminToDelete) {\r\n    throw new ValidationError('You must have at least one user with super admin role.');\r\n  }\r\n\r\n  const deletedUsers = [] as AdminUser[];\r\n  for (const id of ids) {\r\n    const deletedUser = await strapi.db.query('admin::user').delete({\r\n      where: { id },\r\n      populate: ['roles'],\r\n    });\r\n\r\n    deletedUsers.push(deletedUser);\r\n  }\r\n\r\n  strapi.eventHub.emit('user.delete', {\r\n    users: deletedUsers.map((deletedUser) => sanitizeUser(deletedUser)),\r\n  });\r\n\r\n  return deletedUsers;\r\n};\r\n\r\n/** Count the users that don't have any associated roles\r\n */\r\nconst countUsersWithoutRole = async (): Promise<number> => {\r\n  return strapi.db.query('admin::user').count({\r\n    where: {\r\n      roles: {\r\n        id: { $null: true },\r\n      },\r\n    },\r\n  });\r\n};\r\n\r\n/**\r\n * Count the number of users based on search params\r\n * @param params params used for the query\r\n */\r\nconst count = async (where = {}): Promise<number> => {\r\n  return strapi.db.query('admin::user').count({ where });\r\n};\r\n\r\n/**\r\n * Assign some roles to several users\r\n */\r\nconst assignARoleToAll = async (roleId: Data.ID): Promise<void> => {\r\n  const users = await strapi.db.query('admin::user').findMany({\r\n    select: ['id'],\r\n    where: {\r\n      roles: { id: { $null: true } },\r\n    },\r\n  });\r\n\r\n  await Promise.all(\r\n    users.map((user) => {\r\n      return strapi.db.query('admin::user').update({\r\n        where: { id: user.id },\r\n        data: { roles: [roleId] },\r\n      });\r\n    })\r\n  );\r\n};\r\n\r\n/** Display a warning if some users don't have at least one role\r\n */\r\nconst displayWarningIfUsersDontHaveRole = async (): Promise<void> => {\r\n  const count = await countUsersWithoutRole();\r\n\r\n  if (count > 0) {\r\n    strapi.log.warn(`Some users (${count}) don't have any role.`);\r\n  }\r\n};\r\n\r\n/** Returns an array of interface languages currently used by users\r\n */\r\nconst getLanguagesInUse = async (): Promise<string[]> => {\r\n  const users = await strapi.db.query('admin::user').findMany({ select: ['preferedLanguage'] });\r\n\r\n  return users.map((user) => user.preferedLanguage || 'en');\r\n};\r\n\r\nexport default {\r\n  create,\r\n  updateById,\r\n  exists,\r\n  findRegistrationInfo,\r\n  register,\r\n  sanitizeUser,\r\n  findOne,\r\n  findOneByEmail,\r\n  findPage,\r\n  deleteById,\r\n  deleteByIds,\r\n  countUsersWithoutRole,\r\n  count,\r\n  assignARoleToAll,\r\n  displayWarningIfUsersDontHaveRole,\r\n  resetPasswordByEmail,\r\n  getLanguagesInUse,\r\n};\r\n","import type { Utils } from '@strapi/types';\r\n\r\nimport { providerFactory } from '@strapi/utils';\r\nimport {\r\n  pipe,\r\n  set,\r\n  pick,\r\n  eq,\r\n  omit,\r\n  remove,\r\n  get,\r\n  uniq,\r\n  isArray,\r\n  map,\r\n  curry,\r\n  merge,\r\n} from 'lodash/fp';\r\nimport { Permission } from '../../../../shared/contracts/shared';\r\nimport { SanitizedPermission } from '../../../../shared/contracts/roles';\r\n\r\nexport type CreatePermissionPayload = Utils.Object.PartialBy<\r\n  Permission,\r\n  'actionParameters' | 'conditions' | 'properties' | 'subject' | 'id' | 'createdAt' | 'updatedAt'\r\n>;\r\n\r\ntype Provider = ReturnType<typeof providerFactory>;\r\n\r\nexport const permissionFields = [\r\n  'id',\r\n  'action',\r\n  'actionParameters',\r\n  'subject',\r\n  'properties',\r\n  'conditions',\r\n  'role',\r\n];\r\nexport const sanitizedPermissionFields = [\r\n  'id',\r\n  'action',\r\n  'actionParameters',\r\n  'subject',\r\n  'properties',\r\n  'conditions',\r\n] as const;\r\n\r\nexport const sanitizePermissionFields: (p: Permission) => SanitizedPermission =\r\n  pick(sanitizedPermissionFields);\r\n\r\n/**\r\n * Creates a permission with default values\r\n */\r\nconst getDefaultPermission = () => ({\r\n  actionParameters: {},\r\n  conditions: [],\r\n  properties: {},\r\n  subject: null,\r\n});\r\n\r\n/**\r\n * Returns a new permission with the given condition\r\n * @param condition - The condition to add\r\n * @param permission - The permission on which we want to add the condition\r\n * @return\r\n */\r\nexport const addCondition = curry((condition: string, permission: Permission): Permission => {\r\n  const { conditions } = permission;\r\n  const newConditions = Array.isArray(conditions)\r\n    ? uniq(conditions.concat(condition))\r\n    : [condition];\r\n\r\n  return set('conditions', newConditions, permission);\r\n});\r\n\r\n/**\r\n * Returns a new permission without the given condition\r\n * @param condition - The condition to remove\r\n * @param permission - The permission on which we want to remove the condition\r\n */\r\nexport const removeCondition = curry((condition: string, permission: Permission): Permission => {\r\n  return set('conditions', remove(eq(condition), permission.conditions), permission);\r\n});\r\n\r\n/**\r\n * Gets a property or a part of a property from a permission.\r\n * @param property - The property to get\r\n * @param permission - The permission on which we want to access the property\r\n */\r\nexport const getProperty = curry(\r\n  (property: string, permission: Permission): Permission =>\r\n    get(`properties.${property}`, permission)\r\n);\r\n\r\n/**\r\n * Set a value for a given property on a new permission object\r\n * @param property - The name of the property\r\n * @param value - The value of the property\r\n * @param permission - The permission on which we want to set the property\r\n */\r\nexport const setProperty = (\r\n  property: string,\r\n  value: unknown,\r\n  permission: Permission\r\n): Permission => {\r\n  return set(`properties.${property}`, value, permission);\r\n};\r\n\r\n/**\r\n * Returns a new permission without the given property name set\r\n * @param property - The name of the property to delete\r\n * @param permission - The permission on which we want to remove the property\r\n */\r\nexport const deleteProperty = <TProperty extends string>(\r\n  property: TProperty,\r\n  permission: Permission\r\n) => omit(`properties.${property}`, permission) as Omit<Permission, TProperty>;\r\n\r\n/**\r\n * Creates a new {@link Permission} object from raw attributes. Set default values for certain fields\r\n * @param  attributes\r\n */\r\nexport const create = (attributes: CreatePermissionPayload) => {\r\n  return pipe(pick(permissionFields), merge(getDefaultPermission()))(attributes) as Permission;\r\n};\r\n\r\n/**\r\n * Using the given condition provider, check and remove invalid condition from the permission's condition array.\r\n * @param provider - The condition provider used to do the checks\r\n * @param permission - The condition to sanitize\r\n */\r\nexport const sanitizeConditions = curry(\r\n  (provider: Provider, permission: Permission): Permission => {\r\n    if (!isArray(permission.conditions)) {\r\n      return permission;\r\n    }\r\n\r\n    return permission.conditions\r\n      .filter((condition: string) => !provider.has(condition))\r\n      .reduce(\r\n        (perm: Permission, condition: string) => removeCondition(condition, perm),\r\n        permission\r\n      );\r\n  }\r\n);\r\n\r\n/**\r\n * Transform raw attributes into valid permissions using the create domain function.\r\n * @param  payload - Can either be a single object of attributes or an array of those objects.\r\n */\r\n\r\nfunction toPermission<T extends CreatePermissionPayload>(payload: T[]): Permission[];\r\nfunction toPermission<T extends CreatePermissionPayload>(payload: T): Permission;\r\nfunction toPermission<T extends CreatePermissionPayload>(\r\n  payload: T[] | T\r\n): Permission[] | Permission {\r\n  if (isArray(payload)) {\r\n    return map((value) => create(value), payload);\r\n  }\r\n\r\n  return create(payload);\r\n}\r\n\r\nexport { toPermission };\r\n\r\nexport default {\r\n  addCondition,\r\n  removeCondition,\r\n  create,\r\n  deleteProperty,\r\n  permissionFields,\r\n  getProperty,\r\n  sanitizedPermissionFields,\r\n  sanitizeConditions,\r\n  sanitizePermissionFields,\r\n  setProperty,\r\n  toPermission,\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\nimport { getService } from '../utils';\r\nimport validators from './common-validators';\r\n\r\nconst checkPermissionsSchema = yup.object().shape({\r\n  permissions: yup.array().of(\r\n    yup\r\n      .object()\r\n      .shape({\r\n        action: yup.string().required(),\r\n        subject: yup.string().nullable(),\r\n        field: yup.string(),\r\n      })\r\n      .noUnknown()\r\n  ),\r\n});\r\n\r\nconst checkPermissionsExist = function (permissions: any) {\r\n  const existingActions = getService('permission').actionProvider.values();\r\n  const failIndex = permissions.findIndex(\r\n    (permission: any) =>\r\n      !existingActions.some(\r\n        (action: any) =>\r\n          action.actionId === permission.action &&\r\n          (action.section !== 'contentTypes' || action.subjects.includes(permission.subject))\r\n      )\r\n  );\r\n\r\n  return failIndex === -1\r\n    ? true\r\n    : // @ts-expect-error yup types\r\n      this.createError({\r\n        path: 'permissions',\r\n        message: `[${failIndex}] is not an existing permission action`,\r\n      });\r\n};\r\n\r\nconst actionsExistSchema = yup\r\n  .array()\r\n  .of(\r\n    yup.object().shape({\r\n      conditions: yup.array().of(yup.string()),\r\n    })\r\n  )\r\n  .test('actions-exist', '', checkPermissionsExist);\r\n\r\nexport const validatePermissionsExist = validateYupSchema(actionsExistSchema);\r\nexport const validateCheckPermissionsInput = validateYupSchema(checkPermissionsSchema);\r\nexport const validatedUpdatePermissionsInput = validateYupSchema(validators.updatePermissions);\r\n\r\nexport default {\r\n  validatedUpdatePermissionsInput,\r\n  validatePermissionsExist,\r\n  validateCheckPermissionsInput,\r\n};\r\n","/* eslint-disable @typescript-eslint/no-explicit-any */ // TODO: TS - Use database parameters interface when they are ready\r\n/* eslint-disable @typescript-eslint/default-param-last */\r\nimport _ from 'lodash';\r\nimport { set, omit, pick, prop, isArray, differenceWith, differenceBy, isEqual } from 'lodash/fp';\r\n\r\nimport { dates, arrays, hooks as hooksUtils, errors } from '@strapi/utils';\r\nimport type { Data } from '@strapi/types';\r\n\r\nimport permissionDomain from '../domain/permission';\r\nimport type { AdminUser, AdminRole, Permission } from '../../../shared/contracts/shared';\r\nimport type { Action } from '../domain/action';\r\n\r\nimport { validatePermissionsExist } from '../validation/permission';\r\nimport roleConstants from './constants';\r\nimport { getService } from '../utils';\r\n\r\nconst { SUPER_ADMIN_CODE, CONTENT_TYPE_SECTION } = roleConstants;\r\n\r\nconst { createAsyncSeriesWaterfallHook } = hooksUtils;\r\nconst { ApplicationError } = errors;\r\n\r\nconst hooks = {\r\n  willResetSuperAdminPermissions: createAsyncSeriesWaterfallHook(),\r\n};\r\n\r\nconst ACTIONS = {\r\n  publish: 'plugin::content-manager.explorer.publish',\r\n};\r\n\r\n// @ts-expect-error lodash types\r\nconst sanitizeRole: <T extends object>(obj: T) => Omit<T, 'users' | 'permissions'> = omit([\r\n  'users',\r\n  'permissions',\r\n] as const);\r\n\r\nexport type AdminRoleWithUsersCount = AdminRole & { usersCount: number };\r\n\r\nconst COMPARABLE_FIELDS = ['conditions', 'properties', 'subject', 'action', 'actionParameters'];\r\nconst pickComparableFields = pick(COMPARABLE_FIELDS);\r\n\r\nconst jsonClean = <T extends object>(data: T): T => JSON.parse(JSON.stringify(data));\r\n\r\n/**\r\n * Compare two permissions\r\n */\r\nconst arePermissionsEqual = (p1: Permission, p2: Permission): boolean => {\r\n  if (p1.action === p2.action) {\r\n    return isEqual(jsonClean(pickComparableFields(p1)), jsonClean(pickComparableFields(p2)));\r\n  }\r\n\r\n  return false;\r\n};\r\n\r\n/**\r\n * Create and save a role in database\r\n * @param attributes A partial role object\r\n */\r\nconst create = async (attributes: Partial<AdminRole>): Promise<AdminRole> => {\r\n  const alreadyExists = await exists({ name: attributes.name });\r\n\r\n  if (alreadyExists) {\r\n    throw new ApplicationError(\r\n      `The name must be unique and a role with name \\`${attributes.name}\\` already exists.`\r\n    );\r\n  }\r\n  const autoGeneratedCode = `${_.kebabCase(attributes.name)}-${dates.timestampCode()}`;\r\n\r\n  const rolesWithCode = {\r\n    ...attributes,\r\n    code: attributes.code || autoGeneratedCode,\r\n  };\r\n\r\n  const result = await strapi.db.query('admin::role').create({ data: rolesWithCode });\r\n  strapi.eventHub.emit('role.create', { role: sanitizeRole(result) });\r\n\r\n  return result;\r\n};\r\n\r\n/**\r\n * Find a role in database\r\n * @param params query params to find the role\r\n * @param populate\r\n */\r\nconst findOne = (params = {}, populate?: unknown): Promise<AdminRole> => {\r\n  return strapi.db.query('admin::role').findOne({ where: params, populate });\r\n};\r\n\r\n/**\r\n * Find a role in database with usersCounts\r\n * @param params query params to find the role\r\n * @param populate\r\n */\r\nconst findOneWithUsersCount = async (\r\n  params = {},\r\n  populate?: unknown\r\n): Promise<AdminRoleWithUsersCount> => {\r\n  const role = await strapi.db.query('admin::role').findOne({ where: params, populate });\r\n\r\n  if (role) {\r\n    role.usersCount = await getUsersCount(role.id);\r\n  }\r\n\r\n  return role;\r\n};\r\n\r\n/**\r\n * Find roles in database\r\n * @param params query params to find the roles\r\n * @param populate\r\n */\r\nconst find = (params = {}, populate: unknown): Promise<AdminRole[]> => {\r\n  return strapi.db.query('admin::role').findMany({ where: params, populate });\r\n};\r\n\r\n/**\r\n * Find all roles in database\r\n */\r\nconst findAllWithUsersCount = async (params: any): Promise<AdminRoleWithUsersCount[]> => {\r\n  const roles: AdminRoleWithUsersCount[] = await strapi.db\r\n    .query('admin::role')\r\n    .findMany(strapi.get('query-params').transform('admin::role', params));\r\n\r\n  for (const role of roles) {\r\n    role.usersCount = await getUsersCount(role.id);\r\n  }\r\n\r\n  return roles;\r\n};\r\n\r\n/**\r\n * Update a role in database\r\n * @param params query params to find the role to update\r\n * @param attributes A partial role object\r\n */\r\nconst update = async (params: any, attributes: Partial<AdminRole>): Promise<AdminRole> => {\r\n  const sanitizedAttributes = _.omit(attributes, ['code']);\r\n\r\n  if (_.has(params, 'id') && _.has(sanitizedAttributes, 'name')) {\r\n    const alreadyExists = await exists({\r\n      name: sanitizedAttributes.name,\r\n      id: { $ne: params.id },\r\n    });\r\n    if (alreadyExists) {\r\n      throw new ApplicationError(\r\n        `The name must be unique and a role with name \\`${sanitizedAttributes.name}\\` already exists.`\r\n      );\r\n    }\r\n  }\r\n\r\n  const result = await strapi.db\r\n    .query('admin::role')\r\n    .update({ where: params, data: sanitizedAttributes });\r\n\r\n  strapi.eventHub.emit('role.update', { role: sanitizeRole(result) });\r\n\r\n  return result;\r\n};\r\n\r\n/**\r\n * Check if a role exists in database\r\n * @param params query params to find the role\r\n */\r\nconst exists = async (params = {} as unknown): Promise<boolean> => {\r\n  const count = await strapi.db.query('admin::role').count({ where: params });\r\n  return count > 0;\r\n};\r\n\r\n/**\r\n * Count the number of roles based on search params\r\n * @param params params used for the query\r\n */\r\nconst count = async (params = {} as any): Promise<number> => {\r\n  return strapi.db.query('admin::role').count(params);\r\n};\r\n\r\n/**\r\n * Check if the given roles id can be deleted safely, throw otherwise\r\n * @param ids\r\n */\r\nconst checkRolesIdForDeletion = async (ids = [] as Data.ID[]) => {\r\n  const superAdminRole = await getSuperAdmin();\r\n\r\n  if (superAdminRole && arrays.includesString(ids, superAdminRole.id)) {\r\n    throw new ApplicationError('You cannot delete the super admin role');\r\n  }\r\n\r\n  for (const roleId of ids) {\r\n    const usersCount = await getUsersCount(roleId);\r\n    if (usersCount !== 0) {\r\n      throw new ApplicationError('Some roles are still assigned to some users');\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Delete roles in database if they have no user assigned\r\n * @param ids query params to find the roles\r\n */\r\nconst deleteByIds = async (ids = [] as Data.ID[]): Promise<AdminRole[]> => {\r\n  await checkRolesIdForDeletion(ids);\r\n\r\n  await getService('permission').deleteByRolesIds(ids);\r\n\r\n  const deletedRoles: AdminRole[] = [];\r\n  for (const id of ids) {\r\n    const deletedRole = await strapi.db.query('admin::role').delete({ where: { id } });\r\n\r\n    if (deletedRole) {\r\n      strapi.eventHub.emit('role.delete', { role: deletedRole });\r\n      deletedRoles.push(deletedRole);\r\n    }\r\n  }\r\n\r\n  return deletedRoles;\r\n};\r\n\r\n/** Count the number of users for some roles\r\n */\r\nconst getUsersCount = async (roleId: Data.ID): Promise<number> => {\r\n  return strapi.db.query('admin::user').count({ where: { roles: { id: roleId } } });\r\n};\r\n\r\n/** Returns admin role\r\n */\r\nconst getSuperAdmin = (): Promise<AdminRole | undefined> => findOne({ code: SUPER_ADMIN_CODE });\r\n\r\n/** Returns admin role with userCount\r\n * @returns {Promise<role>}\r\n */\r\nconst getSuperAdminWithUsersCount = () => findOneWithUsersCount({ code: SUPER_ADMIN_CODE });\r\n\r\n/** Create superAdmin, Author and Editor role is no role already exist\r\n */\r\nconst createRolesIfNoneExist = async () => {\r\n  const someRolesExist = await exists();\r\n  if (someRolesExist) {\r\n    return;\r\n  }\r\n\r\n  const { actionProvider } = getService('permission');\r\n\r\n  const allActions = actionProvider.values();\r\n  const contentTypesActions = allActions.filter((a) => a.section === 'contentTypes');\r\n\r\n  // create 3 roles\r\n  const superAdminRole = await create({\r\n    name: 'Super Admin',\r\n    code: 'strapi-super-admin',\r\n    description: 'Super Admins can access and manage all features and settings.',\r\n  });\r\n\r\n  await getService('user').assignARoleToAll(superAdminRole.id);\r\n\r\n  const editorRole = await create({\r\n    name: 'Editor',\r\n    code: 'strapi-editor',\r\n    description: 'Editors can manage and publish contents including those of other users.',\r\n  });\r\n\r\n  const authorRole = await create({\r\n    name: 'Author',\r\n    code: 'strapi-author',\r\n    description: 'Authors can manage the content they have created.',\r\n  });\r\n\r\n  // create content-type permissions for each role\r\n  const editorPermissions = getService('content-type').getPermissionsWithNestedFields(\r\n    contentTypesActions,\r\n    {\r\n      restrictedSubjects: ['plugin::users-permissions.user'],\r\n    }\r\n  );\r\n\r\n  const authorPermissions = editorPermissions\r\n    .filter(({ action }: any) => action !== ACTIONS.publish)\r\n    .map((permission: any) =>\r\n      permissionDomain.create({ ...permission, conditions: ['admin::is-creator'] })\r\n    );\r\n\r\n  editorPermissions.push(...getDefaultPluginPermissions());\r\n  authorPermissions.push(...getDefaultPluginPermissions({ isAuthor: true }));\r\n\r\n  // assign permissions to roles\r\n  await addPermissions(editorRole.id, editorPermissions);\r\n  await addPermissions(authorRole.id, authorPermissions);\r\n};\r\n\r\nconst getDefaultPluginPermissions = ({ isAuthor = false } = {}) => {\r\n  const conditions = isAuthor ? ['admin::is-creator'] : [];\r\n\r\n  // add plugin permissions for each role\r\n  return [\r\n    { action: 'plugin::upload.read', conditions },\r\n    { action: 'plugin::upload.configure-view' },\r\n    { action: 'plugin::upload.assets.create' },\r\n    { action: 'plugin::upload.assets.update', conditions },\r\n    { action: 'plugin::upload.assets.download' },\r\n    { action: 'plugin::upload.assets.copy-link' },\r\n  ].map(permissionDomain.create);\r\n};\r\n\r\n/** Display a warning if the role superAdmin doesn't exist\r\n *  or if the role is not assigned to at least one user\r\n */\r\nconst displayWarningIfNoSuperAdmin = async () => {\r\n  const superAdminRole = await getSuperAdminWithUsersCount();\r\n  const someUsersExists = await getService('user').exists();\r\n\r\n  if (!superAdminRole) {\r\n    strapi.log.warn(\"Your application doesn't have a super admin role.\");\r\n  } else if (someUsersExists && superAdminRole.usersCount === 0) {\r\n    strapi.log.warn(\"Your application doesn't have a super admin user.\");\r\n  }\r\n};\r\n\r\n/**\r\n * Assign permissions to a role\r\n * @param roleId - role Data.ID\r\n * @param {Array<Permission{action,subject,fields,conditions}>} permissions - permissions to assign to the role\r\n */\r\nconst assignPermissions = async (\r\n  roleId: Data.ID,\r\n  permissions: Array<Pick<Permission, 'action' | 'subject' | 'conditions'>> = []\r\n) => {\r\n  await validatePermissionsExist(permissions);\r\n\r\n  // Internal actions are not handled by the role service, so any permission\r\n  // with an internal action is filtered out\r\n  const internalActions = getService('permission')\r\n    .actionProvider.values()\r\n    .filter((action) => action.section === 'internal')\r\n    .map((action) => action.actionId);\r\n\r\n  const superAdmin = await getService('role').getSuperAdmin();\r\n  const isSuperAdmin = superAdmin && superAdmin.id === roleId;\r\n  const assignRole = set('role', roleId);\r\n\r\n  const permissionsWithRole = permissions\r\n    // Add the role attribute to every permission\r\n    .map(assignRole)\r\n    // Transform each permission into a Permission instance\r\n    // @ts-expect-error - lodash set doesn't resolve the type appropriately\r\n    .map(permissionDomain.create);\r\n\r\n  const existingPermissions = await getService('permission').findMany({\r\n    where: { role: { id: roleId } },\r\n    populate: ['role'],\r\n  });\r\n\r\n  const permissionsToAdd = differenceWith(\r\n    arePermissionsEqual,\r\n    permissionsWithRole,\r\n    existingPermissions\r\n  ).filter((permission: Permission) => !internalActions.includes(permission.action));\r\n\r\n  const permissionsToDelete = differenceWith(\r\n    arePermissionsEqual,\r\n    existingPermissions,\r\n    permissionsWithRole\r\n  ).filter((permission: Permission) => !internalActions.includes(permission.action));\r\n\r\n  const permissionsToReturn = differenceBy('id', permissionsToDelete, existingPermissions);\r\n\r\n  if (permissionsToDelete.length > 0) {\r\n    // @ts-expect-error - lodash prop doesn't resolve the type appropriately\r\n    await getService('permission').deleteByIds(permissionsToDelete.map(prop('id')));\r\n  }\r\n\r\n  if (permissionsToAdd.length > 0) {\r\n    const newPermissions = await addPermissions(roleId, permissionsToAdd);\r\n    permissionsToReturn.push(...newPermissions);\r\n  }\r\n\r\n  if (!isSuperAdmin && (permissionsToAdd.length || permissionsToDelete.length)) {\r\n    await getService('metrics').sendDidUpdateRolePermissions();\r\n  }\r\n\r\n  return permissionsToReturn;\r\n};\r\n\r\nconst addPermissions = async (roleId: Data.ID, permissions: any) => {\r\n  const { conditionProvider, createMany } = getService('permission');\r\n  const { sanitizeConditions } = permissionDomain;\r\n\r\n  const permissionsWithRole = permissions\r\n    .map(set('role', roleId))\r\n    // @ts-expect-error - refactor domain/permission Condition type, as it's now expecting\r\n    // a string but it should be a Condition interface\r\n    .map(sanitizeConditions(conditionProvider))\r\n    .map(permissionDomain.create);\r\n\r\n  return createMany(permissionsWithRole);\r\n};\r\n\r\nconst isContentTypeAction = (action: Action) => action.section === CONTENT_TYPE_SECTION;\r\n\r\n/**\r\n * Reset super admin permissions (giving it all permissions)\r\n */\r\nconst resetSuperAdminPermissions = async () => {\r\n  const superAdminRole = await getService('role').getSuperAdmin();\r\n  if (!superAdminRole) {\r\n    return;\r\n  }\r\n\r\n  const permissionService = getService('permission');\r\n  const contentTypeService = getService('content-type');\r\n\r\n  const allActions = permissionService.actionProvider.values() as Action[];\r\n\r\n  const contentTypesActions = allActions.filter((action) => isContentTypeAction(action));\r\n  const otherActions = allActions.filter((action) => !isContentTypeAction(action));\r\n\r\n  // First, get the content-types permissions\r\n  const permissions = contentTypeService.getPermissionsWithNestedFields(\r\n    contentTypesActions\r\n  ) as Permission[];\r\n\r\n  // Then add every other permission\r\n  const otherPermissions = otherActions.reduce((acc, action) => {\r\n    const { actionId, subjects } = action;\r\n\r\n    if (isArray(subjects)) {\r\n      acc.push(\r\n        ...subjects.map((subject) => permissionDomain.create({ action: actionId, subject }))\r\n      );\r\n    } else {\r\n      acc.push(permissionDomain.create({ action: actionId }));\r\n    }\r\n\r\n    return acc;\r\n  }, [] as Permission[]);\r\n\r\n  permissions.push(...otherPermissions);\r\n\r\n  const transformedPermissions = (await hooks.willResetSuperAdminPermissions.call(\r\n    permissions\r\n  )) as Permission[];\r\n\r\n  await assignPermissions(superAdminRole.id, transformedPermissions);\r\n};\r\n\r\n/**\r\n * Check if a user object includes the super admin role\r\n */\r\nconst hasSuperAdminRole = (user: AdminUser): boolean => {\r\n  const roles = _.get(user, 'roles', []) as AdminRole[];\r\n\r\n  return roles.map(prop('code')).includes(SUPER_ADMIN_CODE);\r\n};\r\n\r\nconst constants = {\r\n  superAdminCode: SUPER_ADMIN_CODE,\r\n};\r\n\r\nexport default {\r\n  hooks,\r\n  sanitizeRole,\r\n  create,\r\n  findOne,\r\n  findOneWithUsersCount,\r\n  find,\r\n  findAllWithUsersCount,\r\n  update,\r\n  exists,\r\n  count,\r\n  deleteByIds,\r\n  getUsersCount,\r\n  getSuperAdmin,\r\n  getSuperAdminWithUsersCount,\r\n  createRolesIfNoneExist,\r\n  displayWarningIfNoSuperAdmin,\r\n  addPermissions,\r\n  hasSuperAdminRole,\r\n  assignPermissions,\r\n  resetSuperAdminPermissions,\r\n  checkRolesIdForDeletion,\r\n  constants,\r\n};\r\n","import { toLower } from 'lodash/fp';\r\nimport { Strategy as LocalStrategy } from 'passport-local';\r\nimport type { Core } from '@strapi/types';\r\nimport { getService } from '../../utils';\r\n\r\nconst createLocalStrategy = (strapi: Core.Strapi, middleware?: any) => {\r\n  return new LocalStrategy(\r\n    {\r\n      usernameField: 'email',\r\n      passwordField: 'password',\r\n      session: false,\r\n    },\r\n    (email: string, password: string, done: any) => {\r\n      return getService('auth')\r\n        .checkCredentials({ email: toLower(email), password })\r\n        .then(async ([error, user, message]) => {\r\n          if (middleware) {\r\n            return middleware([error, user, message], done);\r\n          }\r\n\r\n          return done(error, user, message);\r\n        })\r\n        .catch((error) => done(error));\r\n    }\r\n  );\r\n};\r\n\r\nexport default createLocalStrategy;\r\n","import passport from 'koa-passport';\r\nimport type { Strategy } from 'passport-local';\r\nimport { isFunction } from 'lodash/fp';\r\n\r\nimport createLocalStrategy from './passport/local-strategy';\r\n\r\nconst authEventsMapper = {\r\n  onConnectionSuccess: 'admin.auth.success',\r\n  onConnectionError: 'admin.auth.error',\r\n};\r\n\r\nconst valueIsFunctionType = ([, value]: [any, any]) => isFunction(value);\r\nconst keyIsValidEventName = ([key]: any) => {\r\n  return Object.keys(strapi.service('admin::passport').authEventsMapper).includes(key);\r\n};\r\n\r\nconst getPassportStrategies = () => [createLocalStrategy(strapi)] as Strategy[];\r\n\r\nconst registerAuthEvents = () => {\r\n  // @ts-expect-error - TODO: migrate auth service to TS\r\n  const { events = {} } = strapi.config.get('admin.auth', {});\r\n  const { authEventsMapper } = strapi.service('admin::passport');\r\n\r\n  const eventList = Object.entries(events).filter(keyIsValidEventName).filter(valueIsFunctionType);\r\n\r\n  for (const [eventName, handler] of eventList) {\r\n    // TODO - TS: ensure the handler is an EventHub.Listener\r\n    strapi.eventHub.on(authEventsMapper[eventName], handler as any);\r\n  }\r\n};\r\n\r\nconst init = () => {\r\n  strapi\r\n    .service('admin::passport')\r\n    .getPassportStrategies()\r\n    .forEach((strategy: Strategy) => passport.use(strategy));\r\n\r\n  registerAuthEvents();\r\n\r\n  return passport.initialize();\r\n};\r\n\r\nexport default { init, getPassportStrategies, authEventsMapper };\r\n","import type { Core } from '@strapi/types';\r\nimport { getService } from '../utils';\r\n\r\nconst sendDidInviteUser = async () => {\r\n  const numberOfUsers = await getService('user').count();\r\n  const numberOfRoles = await getService('role').count();\r\n  strapi.telemetry.send('didInviteUser', {\r\n    groupProperties: { numberOfRoles, numberOfUsers },\r\n  });\r\n};\r\n\r\nconst sendDidUpdateRolePermissions = async () => {\r\n  strapi.telemetry.send('didUpdateRolePermissions');\r\n};\r\n\r\nconst sendDidChangeInterfaceLanguage = async () => {\r\n  const languagesInUse = await getService('user').getLanguagesInUse();\r\n  // This event is anonymous\r\n  strapi.telemetry.send('didChangeInterfaceLanguage', { userProperties: { languagesInUse } });\r\n};\r\n\r\nconst sendUpdateProjectInformation = async (strapi: Core.Strapi) => {\r\n  const numberOfActiveAdminUsers = await getService('user').count({ isActive: true });\r\n  const numberOfAdminUsers = await getService('user').count();\r\n\r\n  strapi.telemetry.send('didUpdateProjectInformation', {\r\n    groupProperties: { numberOfActiveAdminUsers, numberOfAdminUsers },\r\n  });\r\n};\r\n\r\nconst startCron = (strapi: Core.Strapi) => {\r\n  strapi.cron.add({\r\n    sendProjectInformation: {\r\n      task: () => sendUpdateProjectInformation(strapi),\r\n      options: '0 0 0 * * *',\r\n    },\r\n  });\r\n};\r\n\r\nexport default {\r\n  sendDidInviteUser,\r\n  sendDidUpdateRolePermissions,\r\n  sendDidChangeInterfaceLanguage,\r\n  sendUpdateProjectInformation,\r\n  startCron,\r\n};\r\n","import crypto from 'crypto';\r\nimport _ from 'lodash';\r\nimport jwt from 'jsonwebtoken';\r\nimport type { AdminUser } from '../../../shared/contracts/shared';\r\n\r\nconst defaultJwtOptions = { expiresIn: '30d' };\r\n\r\nexport type TokenOptions = {\r\n  expiresIn?: string;\r\n  [key: string]: unknown;\r\n};\r\n\r\nexport type TokenPayload = {\r\n  id: AdminUser['id'];\r\n};\r\n\r\nexport type AdminAuthConfig = {\r\n  secret: string;\r\n  options: TokenOptions;\r\n};\r\n\r\nconst getTokenOptions = () => {\r\n  const { options, secret } = strapi.config.get<AdminAuthConfig>(\r\n    'admin.auth',\r\n    {} as AdminAuthConfig\r\n  );\r\n\r\n  return {\r\n    secret,\r\n    options: _.merge(defaultJwtOptions, options),\r\n  };\r\n};\r\n\r\n/**\r\n * Create a random token\r\n */\r\nconst createToken = (): string => {\r\n  return crypto.randomBytes(20).toString('hex');\r\n};\r\n\r\n/**\r\n * Creates a JWT token for an administration user\r\n * @param user - admin user\r\n */\r\nconst createJwtToken = (user: { id: AdminUser['id'] }) => {\r\n  const { options, secret } = getTokenOptions();\r\n\r\n  return jwt.sign({ id: user.id }, secret, options);\r\n};\r\n\r\n/**\r\n * Tries to decode a token an return its payload and if it is valid\r\n * @param token - a token to decode\r\n * @return decodeInfo - the decoded info\r\n */\r\nconst decodeJwtToken = (\r\n  token: string\r\n): { payload: TokenPayload; isValid: true } | { payload: null; isValid: false } => {\r\n  const { secret } = getTokenOptions();\r\n\r\n  try {\r\n    const payload = jwt.verify(token, secret) as TokenPayload;\r\n    return { payload, isValid: true };\r\n  } catch (err) {\r\n    return { payload: null, isValid: false };\r\n  }\r\n};\r\n\r\nconst checkSecretIsDefined = () => {\r\n  if (strapi.config.get('admin.serveAdminPanel') && !strapi.config.get('admin.auth.secret')) {\r\n    throw new Error(\r\n      `Missing auth.secret. Please set auth.secret in config/admin.js (ex: you can generate one using Node with \\`crypto.randomBytes(16).toString('base64')\\`).\r\nFor security reasons, prefer storing the secret in an environment variable and read it in config/admin.js. See https://docs.strapi.io/developer-docs/latest/setup-deployment-guides/configurations/optional/environment.html#configuration-using-environment-variables.`\r\n    );\r\n  }\r\n};\r\n\r\nexport { createToken, createJwtToken, getTokenOptions, decodeJwtToken, checkSecretIsDefined };\r\n","import { yup, validateYupSchemaSync } from '@strapi/utils';\r\nimport validators from './common-validators';\r\n\r\nconst registerProviderActionSchema = yup\r\n  .array()\r\n  .required()\r\n  .of(\r\n    yup\r\n      .object()\r\n      .shape({\r\n        uid: yup\r\n          .string()\r\n          .matches(\r\n            /^[a-z]([a-z|.|-]+)[a-z]$/,\r\n            (v) => `${v.path}: The id can only contain lowercase letters, dots and hyphens.`\r\n          )\r\n          .required(),\r\n        section: yup.string().oneOf(['contentTypes', 'plugins', 'settings', 'internal']).required(),\r\n        pluginName: yup.mixed().when('section', {\r\n          is: 'plugins',\r\n          then: validators.isAPluginName.required(),\r\n          otherwise: validators.isAPluginName,\r\n        }),\r\n        subjects: yup.mixed().when('section', {\r\n          is: 'contentTypes',\r\n          then: yup.array().of(yup.string()).required(),\r\n          otherwise: yup\r\n            .mixed()\r\n            .oneOf([undefined], 'subjects should only be defined for the \"contentTypes\" section'),\r\n        }),\r\n        displayName: yup.string().required(),\r\n        category: yup.mixed().when('section', {\r\n          is: 'settings',\r\n          then: yup.string().required(),\r\n          otherwise: yup\r\n            .mixed()\r\n            .test(\r\n              'settingsCategory',\r\n              'category should only be defined for the \"settings\" section',\r\n              (cat) => cat === undefined\r\n            ),\r\n        }),\r\n        subCategory: yup.mixed().when('section', {\r\n          is: (section: any) => ['settings', 'plugins'].includes(section),\r\n          then: yup.string(),\r\n          otherwise: yup\r\n            .mixed()\r\n            .test(\r\n              'settingsSubCategory',\r\n              'subCategory should only be defined for \"plugins\" and \"settings\" sections',\r\n              (subCat) => {\r\n                return subCat === undefined;\r\n              }\r\n            ),\r\n        }),\r\n        options: yup.object({\r\n          applyToProperties: yup.array().of(yup.string()),\r\n        }),\r\n        aliases: yup\r\n          .array(\r\n            yup.object({\r\n              actionId: yup.string(),\r\n              subjects: yup.array(yup.string()).nullable(),\r\n            })\r\n          )\r\n          .nullable(),\r\n      })\r\n      .noUnknown()\r\n  );\r\n\r\nexport const validateRegisterProviderAction = validateYupSchemaSync(registerProviderActionSchema);\r\n\r\nexport default {\r\n  validateRegisterProviderAction,\r\n};\r\n","import { providerFactory, hooks, errors } from '@strapi/utils';\r\nimport { validateRegisterProviderAction } from '../../validation/action-provider';\r\n\r\nimport domain from './index';\r\nimport type { Action, CreateActionPayload } from './index';\r\nimport type { Permission } from '../../../../shared/contracts/shared';\r\n\r\ntype Options = Parameters<typeof providerFactory>['0'];\r\n\r\nconst { ApplicationError } = errors;\r\n\r\n/**\r\n * Creates a new instance of an action provider\r\n */\r\nconst createActionProvider = (options?: Options) => {\r\n  const provider = providerFactory<Action>(options);\r\n  const actionHooks = {\r\n    appliesPropertyToSubject: hooks.createAsyncParallelHook(),\r\n  };\r\n\r\n  return {\r\n    ...provider,\r\n\r\n    hooks: {\r\n      ...provider.hooks,\r\n      ...actionHooks,\r\n    },\r\n\r\n    async register(actionAttributes: CreateActionPayload) {\r\n      if (strapi.isLoaded) {\r\n        throw new Error(`You can't register new actions outside of the bootstrap function.`);\r\n      }\r\n\r\n      validateRegisterProviderAction([actionAttributes]);\r\n\r\n      const action = domain.create(actionAttributes);\r\n\r\n      return provider.register(action.actionId, action);\r\n    },\r\n\r\n    async registerMany(actionsAttributes: CreateActionPayload[]) {\r\n      validateRegisterProviderAction(actionsAttributes);\r\n\r\n      for (const attributes of actionsAttributes) {\r\n        await this.register(attributes);\r\n      }\r\n\r\n      return this;\r\n    },\r\n\r\n    async appliesToProperty(property: string, actionId: string, subject: Permission['subject']) {\r\n      const action = provider.get(actionId) as Action | undefined;\r\n      if (!action) {\r\n        throw new ApplicationError(`No action found with id \"${actionId}\"`);\r\n      }\r\n\r\n      const appliesToAction = domain.appliesToProperty(property, action);\r\n\r\n      // If the property isn't valid for this action, ignore the rest of the checks\r\n      if (!appliesToAction) {\r\n        return false;\r\n      }\r\n\r\n      // If the property is valid for this action and there isn't any subject\r\n      if (!subject) {\r\n        return true;\r\n      }\r\n\r\n      // If the property is valid for this action and the subject is not handled by the action\r\n      if (!domain.appliesToSubject(subject, action)) {\r\n        return false;\r\n      }\r\n\r\n      const results = await actionHooks.appliesPropertyToSubject.call({\r\n        property,\r\n        action,\r\n        subject,\r\n      });\r\n\r\n      return results.every((result) => result !== false);\r\n    },\r\n\r\n    /**\r\n     * @experimental\r\n     */\r\n    unstable_aliases(actionId: string, subject?: string | null): string[] {\r\n      const isRegistered = this.has(actionId);\r\n\r\n      if (!isRegistered) {\r\n        return [];\r\n      }\r\n\r\n      return this.values()\r\n        .filter((action) =>\r\n          action.aliases?.some((alias) => {\r\n            // Only look at alias with the correct actionId\r\n            if (alias.actionId !== actionId) {\r\n              return false;\r\n            }\r\n\r\n            // If the alias don't have a list of required subjects, keep it\r\n            if (!Array.isArray(alias.subjects)) {\r\n              return true;\r\n            }\r\n\r\n            // If the alias require specific subjects but none is provided, skip it\r\n            if (!subject) {\r\n              return false;\r\n            }\r\n\r\n            // Else, make sure the given subject is allowed\r\n            return alias.subjects.includes(subject);\r\n          })\r\n        )\r\n        .map((action) => action.actionId);\r\n    },\r\n  };\r\n};\r\n\r\nexport default createActionProvider;\r\n","import { pipe, merge, set, pick } from 'lodash/fp';\r\n\r\nexport type Condition = {\r\n  id: string;\r\n  displayName: string;\r\n  name: string;\r\n  plugin?: string;\r\n  category?: string;\r\n  /**\r\n   * The handler of a {@link Condition}\r\n   */\r\n  handler: (user: object, options: object) => object | boolean;\r\n};\r\n\r\n/**\r\n * Set of attributes used to create a new {@link Action} object\r\n */\r\nexport type CreateConditionPayload = Omit<Condition, 'id'>;\r\n\r\nconst DEFAULT_CATEGORY = 'default';\r\n\r\n/**\r\n * Get the default value used for every condition\r\n * @return {Condition}\r\n */\r\nexport const getDefaultConditionAttributes = () => ({\r\n  category: DEFAULT_CATEGORY,\r\n});\r\n\r\n/**\r\n * Get the list of all the valid attributes of a {@link Condition}\r\n * @return {string[]}\r\n */\r\nexport const conditionFields = ['id', 'displayName', 'handler', 'plugin', 'category'] as const;\r\n\r\n/**\r\n * Remove unwanted attributes from a {@link Condition}\r\n */\r\nexport const sanitizeConditionAttributes = pick(conditionFields);\r\n\r\nexport const computeConditionId = (condition: CreateConditionPayload) => {\r\n  const { name, plugin } = condition;\r\n\r\n  if (!plugin) {\r\n    return `api::${name}`;\r\n  }\r\n\r\n  if (plugin === 'admin') {\r\n    return `admin::${name}`;\r\n  }\r\n\r\n  return `plugin::${plugin}.${name}`;\r\n};\r\n\r\n/**\r\n * Assign an id attribute to a {@link CreateConditionPayload} object\r\n * @param  attrs - Payload used to create a condition\r\n */\r\nexport const assignConditionId = (attrs: CreateConditionPayload): Condition => {\r\n  const condition = set('id', computeConditionId(attrs), attrs) as CreateConditionPayload & {\r\n    id: string;\r\n  };\r\n  return condition;\r\n};\r\n\r\n/**\r\n * Transform the given attributes into a domain representation of a Condition\r\n * @param payload - The condition payload containing the attributes needed to create a {@link Condition}\r\n */\r\nexport const create = pipe(\r\n  assignConditionId,\r\n  sanitizeConditionAttributes,\r\n  merge(getDefaultConditionAttributes())\r\n) as (payload: CreateConditionPayload) => Condition;\r\n\r\nexport default {\r\n  assignConditionId,\r\n  computeConditionId,\r\n  conditionFields,\r\n  create,\r\n  getDefaultConditionAttributes,\r\n  sanitizeConditionAttributes,\r\n};\r\n","import { providerFactory } from '@strapi/utils';\r\nimport domain from '.';\r\nimport type { CreateConditionPayload } from '.';\r\n\r\n/**\r\n * @typedef ConditionProviderOverride\r\n * @property {function(CreateConditionPayload)} register\r\n * @property {function(attributes CreateConditionPayload[]): Promise<this>} registerMany\r\n */\r\n\r\n/**\r\n * Creates a new instance of a condition provider\r\n * @return {Provider & ConditionProviderOverride}\r\n */\r\nconst createConditionProvider = () => {\r\n  const provider = providerFactory();\r\n\r\n  return {\r\n    ...provider,\r\n\r\n    async register(conditionAttributes: CreateConditionPayload) {\r\n      if (strapi.isLoaded) {\r\n        throw new Error(`You can't register new conditions outside of the bootstrap function.`);\r\n      }\r\n\r\n      const condition = domain.create(conditionAttributes);\r\n\r\n      return provider.register(condition.id, condition);\r\n    },\r\n\r\n    async registerMany(conditionsAttributes: CreateConditionPayload[]) {\r\n      for (const attributes of conditionsAttributes) {\r\n        await this.register(attributes);\r\n      }\r\n\r\n      return this;\r\n    },\r\n  };\r\n};\r\n\r\nexport default createConditionProvider;\r\n","import { subject as asSubject, detectSubjectType } from '@casl/ability';\r\nimport { permittedFieldsOf } from '@casl/ability/extra';\r\nimport {\r\n  defaults,\r\n  omit,\r\n  isArray,\r\n  isEmpty,\r\n  isNil,\r\n  flatMap,\r\n  some,\r\n  prop,\r\n  uniq,\r\n  intersection,\r\n  pick,\r\n  getOr,\r\n  isObject,\r\n  cloneDeep,\r\n} from 'lodash/fp';\r\n\r\nimport type { UID } from '@strapi/types';\r\n\r\nimport { contentTypes, traverseEntity, sanitize, async, traverse } from '@strapi/utils';\r\nimport { ADMIN_USER_ALLOWED_FIELDS } from '../../../domain/user';\r\n\r\nconst {\r\n  visitors: { removePassword, expandWildcardPopulate },\r\n} = sanitize;\r\n\r\nconst {\r\n  constants,\r\n  isScalarAttribute,\r\n  getNonVisibleAttributes,\r\n  getNonWritableAttributes,\r\n  getWritableAttributes,\r\n} = contentTypes;\r\nconst {\r\n  ID_ATTRIBUTE,\r\n  DOC_ID_ATTRIBUTE,\r\n  CREATED_AT_ATTRIBUTE,\r\n  UPDATED_AT_ATTRIBUTE,\r\n  PUBLISHED_AT_ATTRIBUTE,\r\n  CREATED_BY_ATTRIBUTE,\r\n  UPDATED_BY_ATTRIBUTE,\r\n} = constants;\r\n\r\nconst COMPONENT_FIELDS = ['__component'];\r\nconst STATIC_FIELDS = [ID_ATTRIBUTE, DOC_ID_ATTRIBUTE];\r\n\r\nexport default ({ action, ability, model }: any) => {\r\n  const schema = strapi.getModel(model);\r\n\r\n  const { removeDisallowedFields } = sanitize.visitors;\r\n\r\n  const ctx = {\r\n    schema,\r\n    getModel: strapi.getModel.bind(strapi),\r\n  };\r\n\r\n  const createSanitizeQuery = (options = {} as any) => {\r\n    const { fields } = options;\r\n\r\n    // TODO: sanitize relations to admin users in all sanitizers\r\n    const permittedFields = fields.shouldIncludeAll ? null : getQueryFields(fields.permitted);\r\n\r\n    const sanitizeFilters = async.pipe(\r\n      traverse.traverseQueryFilters(removeDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQueryFilters(omitDisallowedAdminUserFields, ctx),\r\n      traverse.traverseQueryFilters(omitHiddenFields, ctx),\r\n      traverse.traverseQueryFilters(removePassword, ctx),\r\n      traverse.traverseQueryFilters(({ key, value }, { remove }) => {\r\n        if (isObject(value) && isEmpty(value)) {\r\n          remove(key);\r\n        }\r\n      }, ctx)\r\n    );\r\n\r\n    const sanitizeSort = async.pipe(\r\n      traverse.traverseQuerySort(removeDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQuerySort(omitDisallowedAdminUserFields, ctx),\r\n      traverse.traverseQuerySort(omitHiddenFields, ctx),\r\n      traverse.traverseQuerySort(removePassword, ctx),\r\n      traverse.traverseQuerySort(({ key, attribute, value }, { remove }) => {\r\n        if (!isScalarAttribute(attribute) && isEmpty(value)) {\r\n          remove(key);\r\n        }\r\n      }, ctx)\r\n    );\r\n\r\n    const sanitizePopulate = async.pipe(\r\n      traverse.traverseQueryPopulate(expandWildcardPopulate, ctx),\r\n      traverse.traverseQueryPopulate(removeDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQueryPopulate(omitDisallowedAdminUserFields, ctx),\r\n      traverse.traverseQueryPopulate(omitHiddenFields, ctx),\r\n      traverse.traverseQueryPopulate(removePassword, ctx)\r\n    );\r\n\r\n    const sanitizeFields = async.pipe(\r\n      traverse.traverseQueryFields(removeDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQueryFields(omitHiddenFields, ctx),\r\n      traverse.traverseQueryFields(removePassword, ctx)\r\n    );\r\n\r\n    return async (query: any) => {\r\n      const sanitizedQuery = cloneDeep(query);\r\n\r\n      if (query.filters) {\r\n        Object.assign(sanitizedQuery, { filters: await sanitizeFilters(query.filters) });\r\n      }\r\n\r\n      if (query.sort) {\r\n        Object.assign(sanitizedQuery, { sort: await sanitizeSort(query.sort) });\r\n      }\r\n\r\n      if (query.populate) {\r\n        Object.assign(sanitizedQuery, { populate: await sanitizePopulate(query.populate) });\r\n      }\r\n\r\n      if (query.fields) {\r\n        Object.assign(sanitizedQuery, { fields: await sanitizeFields(query.fields) });\r\n      }\r\n\r\n      return sanitizedQuery;\r\n    };\r\n  };\r\n\r\n  const createSanitizeOutput = (options = {} as any) => {\r\n    const { fields } = options;\r\n\r\n    const permittedFields = fields.shouldIncludeAll ? null : getOutputFields(fields.permitted);\r\n\r\n    return async.pipe(\r\n      // Remove fields hidden from the admin\r\n      traverseEntity(omitHiddenFields, ctx),\r\n      // Remove unallowed fields from admin::user relations\r\n      traverseEntity(pickAllowedAdminUserFields, ctx),\r\n      // Remove not allowed fields (RBAC)\r\n      traverseEntity(removeDisallowedFields(permittedFields), ctx),\r\n      // Remove all fields of type 'password'\r\n      sanitize.sanitizers.sanitizePasswords({\r\n        schema,\r\n        getModel(uid: string) {\r\n          return strapi.getModel(uid as UID.Schema);\r\n        },\r\n      })\r\n    );\r\n  };\r\n\r\n  const createSanitizeInput = (options = {} as any) => {\r\n    const { fields } = options;\r\n\r\n    const permittedFields = fields.shouldIncludeAll ? null : getInputFields(fields.permitted);\r\n\r\n    return async.pipe(\r\n      // Remove fields hidden from the admin\r\n      traverseEntity(omitHiddenFields, ctx),\r\n      // Remove not allowed fields (RBAC)\r\n      traverseEntity(removeDisallowedFields(permittedFields), ctx),\r\n      // Remove roles from createdBy & updatedBy fields\r\n      omitCreatorRoles\r\n    );\r\n  };\r\n\r\n  const wrapSanitize = (createSanitizeFunction: any) => {\r\n    // TODO\r\n    // @ts-expect-error define the correct return type\r\n    const wrappedSanitize = async (data: unknown, options = {} as any) => {\r\n      if (isArray(data)) {\r\n        return Promise.all(data.map((entity: unknown) => wrappedSanitize(entity, options)));\r\n      }\r\n\r\n      const { subject, action: actionOverride } = getDefaultOptions(data, options);\r\n\r\n      const permittedFields = permittedFieldsOf(ability, actionOverride, subject, {\r\n        fieldsFrom: (rule) => rule.fields || [],\r\n      });\r\n\r\n      const hasAtLeastOneRegistered = some(\r\n        (fields) => !isNil(fields),\r\n        flatMap(prop('fields'), ability.rulesFor(actionOverride, detectSubjectType(subject)))\r\n      );\r\n      const shouldIncludeAllFields = isEmpty(permittedFields) && !hasAtLeastOneRegistered;\r\n\r\n      const sanitizeOptions = {\r\n        ...options,\r\n        fields: {\r\n          shouldIncludeAll: shouldIncludeAllFields,\r\n          permitted: permittedFields,\r\n          hasAtLeastOneRegistered,\r\n        },\r\n      };\r\n\r\n      const sanitizeFunction = createSanitizeFunction(sanitizeOptions);\r\n\r\n      return sanitizeFunction(data);\r\n    };\r\n\r\n    return wrappedSanitize;\r\n  };\r\n\r\n  const getDefaultOptions = (data: any, options: unknown) => {\r\n    return defaults({ subject: asSubject(model, data), action }, options);\r\n  };\r\n\r\n  /**\r\n   * Omit creator fields' (createdBy & updatedBy) roles from the admin API responses\r\n   */\r\n  const omitCreatorRoles = omit([`${CREATED_BY_ATTRIBUTE}.roles`, `${UPDATED_BY_ATTRIBUTE}.roles`]);\r\n\r\n  /**\r\n   * Visitor used to remove hidden fields from the admin API responses\r\n   */\r\n  const omitHiddenFields = ({ key, schema }: any, { remove }: any) => {\r\n    const isHidden = getOr(false, ['config', 'attributes', key, 'hidden'], schema);\r\n\r\n    if (isHidden) {\r\n      remove(key);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Visitor used to only select needed fields from the admin users entities & avoid leaking sensitive information\r\n   */\r\n  const pickAllowedAdminUserFields = ({ attribute, key, value }: any, { set }: any) => {\r\n    const pickAllowedFields = pick(ADMIN_USER_ALLOWED_FIELDS);\r\n    if (!attribute) {\r\n      return;\r\n    }\r\n\r\n    if (attribute.type === 'relation' && attribute.target === 'admin::user' && value) {\r\n      if (Array.isArray(value)) {\r\n        set(key, value.map(pickAllowedFields));\r\n      } else {\r\n        set(key, pickAllowedFields(value));\r\n      }\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Visitor used to omit disallowed fields from the admin users entities & avoid leaking sensitive information\r\n   */\r\n  const omitDisallowedAdminUserFields = ({ key, attribute, schema }: any, { remove }: any) => {\r\n    if (schema.uid === 'admin::user' && attribute && !ADMIN_USER_ALLOWED_FIELDS.includes(key)) {\r\n      remove(key);\r\n    }\r\n  };\r\n\r\n  const getInputFields = (fields = []) => {\r\n    const nonVisibleAttributes = getNonVisibleAttributes(schema);\r\n    const writableAttributes = getWritableAttributes(schema);\r\n\r\n    const nonVisibleWritableAttributes = intersection(nonVisibleAttributes, writableAttributes);\r\n\r\n    return uniq([...fields, ...COMPONENT_FIELDS, ...nonVisibleWritableAttributes]);\r\n  };\r\n\r\n  const getOutputFields = (fields = []) => {\r\n    const nonWritableAttributes = getNonWritableAttributes(schema);\r\n    const nonVisibleAttributes = getNonVisibleAttributes(schema);\r\n\r\n    return uniq([\r\n      ...fields,\r\n      ...STATIC_FIELDS,\r\n      ...COMPONENT_FIELDS,\r\n      ...nonWritableAttributes,\r\n      ...nonVisibleAttributes,\r\n      CREATED_AT_ATTRIBUTE,\r\n      UPDATED_AT_ATTRIBUTE,\r\n    ]);\r\n  };\r\n\r\n  const getQueryFields = (fields = []) => {\r\n    const nonVisibleAttributes = getNonVisibleAttributes(schema);\r\n    const writableAttributes = getWritableAttributes(schema);\r\n\r\n    const nonVisibleWritableAttributes = intersection(nonVisibleAttributes, writableAttributes);\r\n\r\n    return uniq([\r\n      ...fields,\r\n      ...STATIC_FIELDS,\r\n      ...COMPONENT_FIELDS,\r\n      ...nonVisibleWritableAttributes,\r\n      CREATED_AT_ATTRIBUTE,\r\n      UPDATED_AT_ATTRIBUTE,\r\n      PUBLISHED_AT_ATTRIBUTE,\r\n      CREATED_BY_ATTRIBUTE,\r\n      UPDATED_BY_ATTRIBUTE,\r\n    ]);\r\n  };\r\n\r\n  return {\r\n    sanitizeOutput: wrapSanitize(createSanitizeOutput),\r\n    sanitizeInput: wrapSanitize(createSanitizeInput),\r\n    sanitizeQuery: wrapSanitize(createSanitizeQuery),\r\n  };\r\n};\r\n","import { subject as asSubject, detectSubjectType } from '@casl/ability';\r\nimport { permittedFieldsOf } from '@casl/ability/extra';\r\nimport {\r\n  defaults,\r\n  omit,\r\n  isArray,\r\n  isEmpty,\r\n  isNil,\r\n  flatMap,\r\n  some,\r\n  prop,\r\n  uniq,\r\n  intersection,\r\n  getOr,\r\n  isObject,\r\n} from 'lodash/fp';\r\n\r\nimport { contentTypes, traverseEntity, traverse, validate, async, errors } from '@strapi/utils';\r\nimport { ADMIN_USER_ALLOWED_FIELDS } from '../../../domain/user';\r\n\r\nconst { ValidationError } = errors;\r\nconst { throwPassword, throwDisallowedFields } = validate.visitors;\r\n\r\nconst { constants, isScalarAttribute, getNonVisibleAttributes, getWritableAttributes } =\r\n  contentTypes;\r\nconst {\r\n  ID_ATTRIBUTE,\r\n  DOC_ID_ATTRIBUTE,\r\n  CREATED_AT_ATTRIBUTE,\r\n  UPDATED_AT_ATTRIBUTE,\r\n  PUBLISHED_AT_ATTRIBUTE,\r\n  CREATED_BY_ATTRIBUTE,\r\n  UPDATED_BY_ATTRIBUTE,\r\n} = constants;\r\n\r\nconst COMPONENT_FIELDS = ['__component'];\r\n\r\nconst STATIC_FIELDS = [ID_ATTRIBUTE, DOC_ID_ATTRIBUTE];\r\n\r\nconst throwInvalidKey = ({ key, path }: { key: string; path?: string | null }) => {\r\n  const msg = path && path !== key ? `Invalid key ${key} at ${path}` : `Invalid key ${key}`;\r\n\r\n  throw new ValidationError(msg);\r\n};\r\n\r\nexport default ({ action, ability, model }: any) => {\r\n  const schema = strapi.getModel(model);\r\n\r\n  const ctx = {\r\n    schema,\r\n    getModel: strapi.getModel.bind(strapi),\r\n  };\r\n\r\n  const createValidateQuery = (options = {} as any) => {\r\n    const { fields } = options;\r\n\r\n    // TODO: validate relations to admin users in all validators\r\n    const permittedFields = fields.shouldIncludeAll ? null : getQueryFields(fields.permitted);\r\n\r\n    const validateFilters = async.pipe(\r\n      traverse.traverseQueryFilters(throwDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQueryFilters(throwDisallowedAdminUserFields, ctx),\r\n      traverse.traverseQueryFilters(throwPassword, ctx),\r\n      traverse.traverseQueryFilters(({ key, value, path }) => {\r\n        if (isObject(value) && isEmpty(value)) {\r\n          throwInvalidKey({ key, path: path.attribute });\r\n        }\r\n      }, ctx)\r\n    );\r\n\r\n    const validateSort = async.pipe(\r\n      traverse.traverseQuerySort(throwDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQuerySort(throwDisallowedAdminUserFields, ctx),\r\n      traverse.traverseQuerySort(throwPassword, ctx),\r\n      traverse.traverseQuerySort(({ key, attribute, value, path }) => {\r\n        if (!isScalarAttribute(attribute) && isEmpty(value)) {\r\n          throwInvalidKey({ key, path: path.attribute });\r\n        }\r\n      }, ctx)\r\n    );\r\n\r\n    const validateFields = async.pipe(\r\n      traverse.traverseQueryFields(throwDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQueryFields(throwPassword, ctx)\r\n    );\r\n\r\n    const validatePopulate = async.pipe(\r\n      traverse.traverseQueryPopulate(throwDisallowedFields(permittedFields), ctx),\r\n      traverse.traverseQueryPopulate(throwDisallowedAdminUserFields, ctx),\r\n      traverse.traverseQueryPopulate(throwHiddenFields, ctx),\r\n      traverse.traverseQueryPopulate(throwPassword, ctx)\r\n    );\r\n\r\n    return async (query: any) => {\r\n      if (query.filters) {\r\n        await validateFilters(query.filters);\r\n      }\r\n\r\n      if (query.sort) {\r\n        await validateSort(query.sort);\r\n      }\r\n\r\n      if (query.fields) {\r\n        await validateFields(query.fields);\r\n      }\r\n\r\n      // a wildcard is always valid; its conversion will be handled by the entity service and can be optimized with sanitizer\r\n      if (query.populate && query.populate !== '*') {\r\n        await validatePopulate(query.populate);\r\n      }\r\n\r\n      return true;\r\n    };\r\n  };\r\n\r\n  const createValidateInput = (options = {} as any) => {\r\n    const { fields } = options;\r\n\r\n    const permittedFields = fields.shouldIncludeAll ? null : getInputFields(fields.permitted);\r\n\r\n    return async.pipe(\r\n      // Remove fields hidden from the admin\r\n      traverseEntity(throwHiddenFields, ctx),\r\n      // Remove not allowed fields (RBAC)\r\n      traverseEntity(throwDisallowedFields(permittedFields), ctx),\r\n      // Remove roles from createdBy & updatedBy fields\r\n      omitCreatorRoles\r\n    );\r\n  };\r\n\r\n  const wrapValidate = (createValidateFunction: any) => {\r\n    // TODO\r\n    // @ts-expect-error define the correct return type\r\n    const wrappedValidate = async (data, options = {}): Promise<unknown> => {\r\n      if (isArray(data)) {\r\n        return Promise.all(data.map((entity: unknown) => wrappedValidate(entity, options)));\r\n      }\r\n\r\n      const { subject, action: actionOverride } = getDefaultOptions(data, options);\r\n\r\n      const permittedFields = permittedFieldsOf(ability, actionOverride, subject, {\r\n        fieldsFrom: (rule) => rule.fields || [],\r\n      });\r\n\r\n      const hasAtLeastOneRegistered = some(\r\n        (fields) => !isNil(fields),\r\n        flatMap(prop('fields'), ability.rulesFor(actionOverride, detectSubjectType(subject)))\r\n      );\r\n      const shouldIncludeAllFields = isEmpty(permittedFields) && !hasAtLeastOneRegistered;\r\n\r\n      const validateOptions = {\r\n        ...options,\r\n        fields: {\r\n          shouldIncludeAll: shouldIncludeAllFields,\r\n          permitted: permittedFields,\r\n          hasAtLeastOneRegistered,\r\n        },\r\n      };\r\n\r\n      const validateFunction = createValidateFunction(validateOptions);\r\n\r\n      return validateFunction(data);\r\n    };\r\n\r\n    return wrappedValidate;\r\n  };\r\n\r\n  const getDefaultOptions = (data: any, options: unknown) => {\r\n    return defaults({ subject: asSubject(model, data), action }, options);\r\n  };\r\n\r\n  /**\r\n   * Omit creator fields' (createdBy & updatedBy) roles from the admin API responses\r\n   */\r\n  const omitCreatorRoles = omit([`${CREATED_BY_ATTRIBUTE}.roles`, `${UPDATED_BY_ATTRIBUTE}.roles`]);\r\n\r\n  /**\r\n   * Visitor used to remove hidden fields from the admin API responses\r\n   */\r\n  const throwHiddenFields = ({ key, schema, path }: any) => {\r\n    const isHidden = getOr(false, ['config', 'attributes', key, 'hidden'], schema);\r\n\r\n    if (isHidden) {\r\n      throwInvalidKey({ key, path: path.attribute });\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Visitor used to omit disallowed fields from the admin users entities & avoid leaking sensitive information\r\n   */\r\n  const throwDisallowedAdminUserFields = ({ key, attribute, schema, path }: any) => {\r\n    if (schema.uid === 'admin::user' && attribute && !ADMIN_USER_ALLOWED_FIELDS.includes(key)) {\r\n      throwInvalidKey({ key, path: path.attribute });\r\n    }\r\n  };\r\n\r\n  const getInputFields = (fields = []) => {\r\n    const nonVisibleAttributes = getNonVisibleAttributes(schema);\r\n    const writableAttributes = getWritableAttributes(schema);\r\n\r\n    const nonVisibleWritableAttributes = intersection(nonVisibleAttributes, writableAttributes);\r\n\r\n    return uniq([...fields, ...COMPONENT_FIELDS, ...nonVisibleWritableAttributes]);\r\n  };\r\n\r\n  const getQueryFields = (fields = []) => {\r\n    return uniq([\r\n      ...fields,\r\n      ...STATIC_FIELDS,\r\n      ...COMPONENT_FIELDS,\r\n      CREATED_AT_ATTRIBUTE,\r\n      UPDATED_AT_ATTRIBUTE,\r\n      PUBLISHED_AT_ATTRIBUTE,\r\n    ]);\r\n  };\r\n\r\n  return {\r\n    validateQuery: wrapValidate(createValidateQuery),\r\n    validateInput: wrapValidate(createValidateInput),\r\n  };\r\n};\r\n","// TODO: migration\r\nimport _ from 'lodash';\r\nimport { rulesToQuery } from '@casl/ability/extra';\r\n\r\nconst operatorsMap = {\r\n  $in: '$in',\r\n  $nin: '$notIn',\r\n  $exists: '$notNull',\r\n  $gte: '$gte',\r\n  $gt: '$gt',\r\n  $lte: '$lte',\r\n  $lt: '$lt',\r\n  $eq: '$eq',\r\n  $ne: '$ne',\r\n  $and: '$and',\r\n  $or: '$or',\r\n  $not: '$not',\r\n} as const;\r\n\r\nconst mapKey = (key: keyof typeof operatorsMap) => {\r\n  if (_.isString(key) && key.startsWith('$') && key in operatorsMap) {\r\n    return operatorsMap[key];\r\n  }\r\n  return key;\r\n};\r\n\r\nconst buildCaslQuery = (ability: unknown, action: unknown, model: unknown) => {\r\n  // @ts-expect-error casl types\r\n  return rulesToQuery(ability, action, model, (o) => o.conditions);\r\n};\r\n\r\nconst buildStrapiQuery = (caslQuery: unknown) => {\r\n  return unwrapDeep(caslQuery);\r\n};\r\n\r\nconst unwrapDeep = (obj: any): unknown => {\r\n  if (!_.isPlainObject(obj) && !_.isArray(obj)) {\r\n    return obj;\r\n  }\r\n  if (_.isArray(obj)) {\r\n    return obj.map((v: unknown) => unwrapDeep(v));\r\n  }\r\n\r\n  return _.reduce(\r\n    obj,\r\n    (acc, v, k: any) => {\r\n      const key = mapKey(k);\r\n\r\n      if (_.isPlainObject(v)) {\r\n        if ('$elemMatch' in v) {\r\n          _.setWith(acc, key, unwrapDeep(v.$elemMatch));\r\n        } else {\r\n          _.setWith(acc, key, unwrapDeep(v));\r\n        }\r\n      } else if (_.isArray(v)) {\r\n        // prettier-ignore\r\n        _.setWith(acc, key, v.map(v => unwrapDeep(v)));\r\n      } else {\r\n        _.setWith(acc, key, v);\r\n      }\r\n\r\n      return acc;\r\n    },\r\n    {}\r\n  );\r\n};\r\n\r\nexport { buildCaslQuery, buildStrapiQuery };\r\n","import _ from 'lodash';\r\nimport { cloneDeep, isPlainObject } from 'lodash/fp';\r\nimport { subject as asSubject } from '@casl/ability';\r\nimport createSanitizeHelpers from './sanitize';\r\nimport createValidateHelpers from './validate';\r\n\r\nimport { buildStrapiQuery, buildCaslQuery } from './query-builders';\r\n\r\nexport default ({ ability, action, model }: any) => ({\r\n  ability,\r\n  action,\r\n  model,\r\n\r\n  get isAllowed(): unknown {\r\n    return this.ability.can(action, model);\r\n  },\r\n\r\n  toSubject(target: any, subjectType = model) {\r\n    return asSubject(subjectType, target);\r\n  },\r\n\r\n  pickPermittedFieldsOf(data: unknown, options = {}) {\r\n    return this.sanitizeInput(data, options);\r\n  },\r\n\r\n  getQuery(queryAction = action) {\r\n    if (_.isUndefined(queryAction)) {\r\n      throw new Error('Action must be defined to build a permission query');\r\n    }\r\n\r\n    return buildStrapiQuery(buildCaslQuery(ability, queryAction, model));\r\n  },\r\n\r\n  // eslint-disable-next-line @typescript-eslint/default-param-last\r\n  addPermissionsQueryTo(query = {} as any, action: unknown) {\r\n    const newQuery = cloneDeep(query);\r\n    const permissionQuery = this.getQuery(action) ?? undefined;\r\n\r\n    if (isPlainObject(query.filters)) {\r\n      newQuery.filters = permissionQuery\r\n        ? { $and: [query.filters, permissionQuery] }\r\n        : query.filters;\r\n    } else {\r\n      newQuery.filters = permissionQuery;\r\n    }\r\n\r\n    return newQuery;\r\n  },\r\n\r\n  ...createSanitizeHelpers({ action, ability, model }),\r\n  ...createValidateHelpers({ action, ability, model }),\r\n});\r\n","import { curry, isArray, isEmpty, difference } from 'lodash/fp';\r\nimport permissions, { type engine } from '@strapi/permissions';\r\nimport type { Ability } from '@casl/ability';\r\nimport permissionDomain from '../../domain/permission';\r\nimport { getService } from '../../utils';\r\nimport { Action } from '../../domain/action';\r\nimport type { AdminUser, Permission } from '../../../../shared/contracts/shared';\r\n\r\nexport default (params: { providers: engine.EngineParams['providers'] }) => {\r\n  const { providers } = params;\r\n\r\n  const engine = permissions.engine\r\n    .new({ providers })\r\n    /**\r\n     * Validate the permission's action exists in the action registry\r\n     */\r\n    .on('before-format::validate.permission', ({ permission }) => {\r\n      const action = providers.action.get(permission.action);\r\n\r\n      // If the action isn't registered into the action provider, then ignore the permission\r\n      if (!action) {\r\n        strapi.log.debug(\r\n          `Unknown action \"${permission.action}\" supplied when registering a new permission in engine`\r\n        );\r\n        return false;\r\n      }\r\n    })\r\n\r\n    /**\r\n     * Remove invalid properties from the permission based on the action (applyToProperties)\r\n     */\r\n    .on('format.permission', (permission: Permission) => {\r\n      const action = providers.action.get(permission.action) as Action;\r\n      const properties = permission.properties || {};\r\n\r\n      // Only keep the properties allowed by the action (action.applyToProperties)\r\n      const propertiesName = Object.keys(properties);\r\n      const invalidProperties = difference(\r\n        propertiesName,\r\n        // @ts-expect-error - applyToProperties is defined inside the options of an action\r\n        action.applyToProperties || propertiesName\r\n      );\r\n\r\n      const permissionWithSanitizedProperties = invalidProperties.reduce(\r\n        // @ts-expect-error - fix reduce, property should be a string but it's actually the permission object\r\n        (property) => permissionDomain.deleteProperty(property, permission) as Permission,\r\n        permission\r\n      );\r\n\r\n      return permissionWithSanitizedProperties;\r\n    })\r\n\r\n    /**\r\n     * Ignore the permission if the fields property is an empty array (access to no field)\r\n     */\r\n    .on('after-format::validate.permission', ({ permission }) => {\r\n      const { fields } = permission.properties;\r\n\r\n      if (isArray(fields) && isEmpty(fields)) {\r\n        return false;\r\n      }\r\n    });\r\n\r\n  return {\r\n    get hooks() {\r\n      return engine.hooks;\r\n    },\r\n\r\n    /**\r\n     * Generate an ability based on the given user (using associated roles & permissions)\r\n     * @param user\r\n     */\r\n    async generateUserAbility(user: AdminUser): Promise<Ability> {\r\n      const permissions = (await getService('permission').findUserPermissions(user)) as any;\r\n\r\n      return engine.generateAbility(permissions, user);\r\n    },\r\n\r\n    /**\r\n     * Check many permissions based on an ability\r\n     */\r\n    checkMany: curry((ability: Ability, permissions: Permission[]) => {\r\n      // @ts-expect-error - Permissions does not contain any field property\r\n      return permissions.map(({ action, subject, field }) => ability.can(action, subject, field));\r\n    }),\r\n  };\r\n};\r\n","import { eq } from 'lodash/fp';\r\nimport { hooks } from '@strapi/utils';\r\nimport type { Action } from '../../../domain/action';\r\n\r\nexport type SectionOptions = {\r\n  initialStateFactory?: (...args: any) => unknown; // A factory function that returns the default shape of the section\r\n  handlers?: ((...args: any) => unknown)[]; // An initial collection of handlers which will be registered in the handlers hook\r\n  matchers?: ((...args: any) => unknown)[]; // An initial collection of matchers which will be registered in the matchers hook\r\n};\r\n\r\nconst emptyObjectFactory = () => ({});\r\n\r\n/**\r\n * Upon call, creates a new section object\r\n */\r\nconst createSection = (\r\n  { initialStateFactory = emptyObjectFactory, handlers = [], matchers = [] } = {} as SectionOptions\r\n) => {\r\n  const state = {\r\n    hooks: {\r\n      handlers: hooks.createAsyncSeriesHook(),\r\n      matchers: hooks.createAsyncParallelHook(),\r\n    },\r\n  };\r\n\r\n  // Register initial hooks\r\n  handlers.forEach((handler) => state.hooks.handlers.register(handler));\r\n  matchers.forEach((matcher) => state.hooks.matchers.register(matcher));\r\n\r\n  return {\r\n    hooks: state.hooks,\r\n\r\n    /**\r\n     * Verifies if an action can be applied to the section by running the matchers hook.\r\n     * If any of the registered matcher functions returns true, then the condition applies.\r\n     */\r\n    async appliesToAction(action: Action): Promise<boolean> {\r\n      const results = await state.hooks.matchers.call(action);\r\n\r\n      return results.some(eq(true));\r\n    },\r\n\r\n    /**\r\n     * Init, build and returns a section object based on the given actions\r\n     * @param  actions - A list of actions used to populate the section\r\n     */\r\n    async build(actions = [] as Action[]) {\r\n      const section = initialStateFactory();\r\n\r\n      for (const action of actions) {\r\n        const applies = await this.appliesToAction(action);\r\n\r\n        if (applies) {\r\n          await state.hooks.handlers.call({ action, section });\r\n        }\r\n      }\r\n\r\n      return section;\r\n    },\r\n  };\r\n};\r\n\r\nexport default createSection;\r\n","import { Action } from '../../../domain/action';\r\nimport createSection, { SectionOptions } from './section';\r\n\r\n/**\r\n * Create a new section builder with its own sections registry\r\n */\r\nconst createSectionBuilder = () => {\r\n  const state = {\r\n    sections: new Map(),\r\n  };\r\n\r\n  return {\r\n    /**\r\n     * Create & add a section to the builder's registry\r\n     * @param sectionName - The unique name of the section\r\n     * @param options - The options used to build a {@link Section}\r\n     */\r\n    createSection(sectionName: string, options: SectionOptions) {\r\n      const section = createSection(options);\r\n\r\n      state.sections.set(sectionName, section);\r\n\r\n      return this;\r\n    },\r\n\r\n    /**\r\n     * Removes a section from the builder's registry using its unique name\r\n     * @param sectionName - The name of the section to delete\r\n     */\r\n    deleteSection(sectionName: string) {\r\n      state.sections.delete(sectionName);\r\n\r\n      return this;\r\n    },\r\n\r\n    /**\r\n     * Register a handler function for a given section\r\n     * @param  sectionName - The name of the section\r\n     * @param  handler - The handler to register\r\n     */\r\n    addHandler(sectionName: string, handler: () => unknown) {\r\n      if (state.sections.has(sectionName)) {\r\n        state.sections.get(sectionName).hooks.handlers.register(handler);\r\n      }\r\n\r\n      return this;\r\n    },\r\n\r\n    /**\r\n     * Register a matcher function for a given section\r\n     * @param sectionName - The name of the section\r\n     * @param matcher - The handler to register\r\n\r\n     */\r\n    addMatcher(sectionName: string, matcher: () => unknown) {\r\n      if (state.sections.has(sectionName)) {\r\n        state.sections.get(sectionName).hooks.matchers.register(matcher);\r\n      }\r\n\r\n      return this;\r\n    },\r\n\r\n    /**\r\n     * Build a section tree based on the registered actions and the given actions\r\n     * @param actions - The actions used to build each section\r\n     */\r\n    async build(actions = [] as Action[]) {\r\n      const sections = {} as any;\r\n\r\n      for (const [sectionName, section] of state.sections.entries()) {\r\n        sections[sectionName] = await section.build(actions);\r\n      }\r\n\r\n      return sections;\r\n    },\r\n  };\r\n};\r\n\r\nexport default createSectionBuilder;\r\n","import { curry, matchesProperty, pick } from 'lodash/fp';\r\nimport type { Internal, Struct } from '@strapi/types';\r\n\r\nconst isOfKind = (kind: unknown) => matchesProperty('kind', kind);\r\n\r\nconst resolveContentType = (uid: Internal.UID.ContentType): Struct.ContentTypeSchema => {\r\n  return strapi.contentTypes[uid];\r\n};\r\n\r\nconst isNotInSubjects = (subjects: any) => (uid: unknown) =>\r\n  !subjects.find((subject: any) => subject.uid === uid);\r\n\r\nconst hasProperty = curry((property: unknown, subject: any) => {\r\n  return !!subject.properties.find((prop: any) => prop.value === property);\r\n});\r\n\r\nconst getValidOptions = pick(['applyToProperties']);\r\n\r\nconst toSubjectTemplate = (ct: any) => ({\r\n  uid: ct.uid,\r\n  label: ct.info.singularName,\r\n  properties: [],\r\n});\r\n\r\nexport {\r\n  isOfKind,\r\n  resolveContentType,\r\n  isNotInSubjects,\r\n  hasProperty,\r\n  getValidOptions,\r\n  toSubjectTemplate,\r\n};\r\n","import type { Internal } from '@strapi/types';\r\nimport { contentTypes } from '@strapi/utils';\r\nimport {\r\n  toSubjectTemplate,\r\n  getValidOptions,\r\n  hasProperty,\r\n  isNotInSubjects,\r\n  resolveContentType,\r\n  isOfKind,\r\n} from './utils';\r\nimport type { Action } from '../../../domain/action';\r\n\r\nconst { isVisibleAttribute } = contentTypes;\r\n\r\nexport type ContentTypesSection = {\r\n  actions: Action[];\r\n  subjects: any[];\r\n};\r\n\r\nexport type ActionArraySection = Action[];\r\n\r\n/**\r\n * Transforms & adds the given  setting action to the section\r\n * Note: The action is transformed to a setting specific format\r\n * @param options\r\n * @param options.action\r\n * @param section\r\n */\r\nconst settings = ({ action, section }: { action: Action; section: ActionArraySection }) => {\r\n  const { category, subCategory, displayName, actionId } = action;\r\n\r\n  section.push({\r\n    displayName,\r\n    category,\r\n    subCategory,\r\n    // TODO: Investigate at which point the action property is transformed to actionId\r\n    // @ts-expect-error - action should be actionID\r\n    action: actionId,\r\n  });\r\n};\r\n\r\n/**\r\n * Transforms & adds the given plugin action to the section\r\n * Note: The action is transformed to a plugin specific format\r\n * @param {object} options\r\n * @param {Action} options.action\r\n * @param {ActionArraySection} section\r\n */\r\nconst plugins = ({ action, section }: { action: Action; section: ActionArraySection }) => {\r\n  const { pluginName, subCategory, displayName, actionId } = action;\r\n\r\n  section.push({\r\n    displayName,\r\n    // @ts-expect-error - plugin should be pluginName, TODO: Investigate at which point the plugin property\r\n    plugin: pluginName,\r\n    subCategory,\r\n    action: actionId,\r\n  });\r\n};\r\n\r\n/**\r\n * Transforms & adds the given action to the section's actions field\r\n * Note: The action is transformed to a content-type specific format\r\n * @param {object} options\r\n * @param {Action} options.action\r\n * @param {ContentTypesSection} section\r\n */\r\nconst contentTypesBase = ({\r\n  action,\r\n  section,\r\n}: {\r\n  action: Action;\r\n  section: ContentTypesSection;\r\n}) => {\r\n  const { displayName, actionId, subjects, options } = action;\r\n\r\n  section.actions.push({\r\n    // @ts-expect-error - label should be displayName, TODO: Investigate at which point the label property\r\n    label: displayName,\r\n    actionId,\r\n    subjects,\r\n    ...getValidOptions(options),\r\n  });\r\n};\r\n\r\n/**\r\n * Initialize the subjects array of a section based on the action's subjects\r\n */\r\nconst subjectsHandlerFor =\r\n  (kind: string) =>\r\n  ({ action, section: contentTypesSection }: { action: Action; section: ContentTypesSection }) => {\r\n    // TODO: add a type guard for UID.ContentType\r\n    const subjects = action.subjects as Internal.UID.ContentType[];\r\n\r\n    if (!subjects?.length) {\r\n      return;\r\n    }\r\n\r\n    const newSubjects = subjects\r\n      // Ignore already added subjects\r\n      .filter(isNotInSubjects(contentTypesSection.subjects))\r\n      // Transform UIDs into content-types\r\n      .map(resolveContentType)\r\n      // Only keep specific kind of content-types\r\n      .filter(isOfKind(kind))\r\n      // Transform the content-types into section's subjects\r\n      .map(toSubjectTemplate);\r\n\r\n    contentTypesSection.subjects.push(...newSubjects);\r\n  };\r\n\r\nconst buildNode = (model: any, attributeName: string, attribute: any) => {\r\n  if (!isVisibleAttribute(model, attributeName)) {\r\n    return null;\r\n  }\r\n\r\n  const node = { label: attributeName, value: attributeName };\r\n\r\n  if (attribute.required) {\r\n    Object.assign(node, { required: true });\r\n  }\r\n\r\n  if (attribute.type === 'component') {\r\n    const component = strapi.components[attribute.component];\r\n    return { ...node, children: buildDeepAttributesCollection(component) };\r\n  }\r\n\r\n  return node;\r\n};\r\n\r\nconst buildDeepAttributesCollection = (model: any): unknown => {\r\n  return Object.entries(model.attributes)\r\n    .map(([attributeName, attribute]) => buildNode(model, attributeName, attribute))\r\n    .filter((node) => node !== null);\r\n};\r\n\r\n/**\r\n * Create and populate the fields property for section's subjects based on the action's subjects list\r\n */\r\nconst fieldsProperty = ({ action, section }: { action: Action; section: ContentTypesSection }) => {\r\n  const { subjects } = action;\r\n\r\n  section.subjects\r\n    .filter((subject) => subjects?.includes(subject.uid))\r\n    .forEach((subject) => {\r\n      const { uid } = subject;\r\n      const contentType = resolveContentType(uid);\r\n\r\n      if (hasProperty('fields', subject)) {\r\n        return;\r\n      }\r\n\r\n      const fields = buildDeepAttributesCollection(contentType);\r\n      const fieldsProp = { label: 'Fields', value: 'fields', children: fields };\r\n\r\n      subject.properties.push(fieldsProp);\r\n    });\r\n};\r\n\r\nexport { plugins, settings, subjectsHandlerFor, contentTypesBase, fieldsProperty };\r\n","import { propEq } from 'lodash/fp';\r\nimport createSectionBuilder from './builder';\r\nimport {\r\n  subjectsHandlerFor,\r\n  contentTypesBase,\r\n  fieldsProperty,\r\n  plugins as pluginsHandler,\r\n  settings as settingsHandler,\r\n} from './handlers';\r\n\r\nconst sectionPropMatcher = propEq('section');\r\n\r\nconst createContentTypesInitialState = () => ({\r\n  actions: [],\r\n  subjects: [],\r\n});\r\n\r\nconst createDefaultSectionBuilder = () => {\r\n  const builder = createSectionBuilder();\r\n\r\n  builder.createSection('plugins', {\r\n    initialStateFactory: () => [],\r\n    handlers: [pluginsHandler],\r\n    matchers: [sectionPropMatcher('plugins')],\r\n  });\r\n\r\n  builder.createSection('settings', {\r\n    initialStateFactory: () => [],\r\n    handlers: [settingsHandler],\r\n    matchers: [sectionPropMatcher('settings')],\r\n  });\r\n\r\n  builder.createSection('singleTypes', {\r\n    initialStateFactory: createContentTypesInitialState,\r\n    handlers: [contentTypesBase, subjectsHandlerFor('singleType'), fieldsProperty],\r\n    matchers: [sectionPropMatcher('contentTypes')],\r\n  });\r\n\r\n  builder.createSection('collectionTypes', {\r\n    initialStateFactory: createContentTypesInitialState,\r\n    handlers: [contentTypesBase, subjectsHandlerFor('collectionType'), fieldsProperty],\r\n    matchers: [sectionPropMatcher('contentTypes')],\r\n  });\r\n\r\n  return builder;\r\n};\r\n\r\nexport default createDefaultSectionBuilder;\r\n","import { isNil, isArray, prop, xor, eq, map, differenceWith } from 'lodash/fp';\r\nimport pmap from 'p-map';\r\nimport type { Data } from '@strapi/types';\r\nimport { getService } from '../../utils';\r\nimport permissionDomain, { CreatePermissionPayload } from '../../domain/permission';\r\nimport type { AdminUser, Permission } from '../../../../shared/contracts/shared';\r\nimport { Action } from '../../domain/action';\r\n\r\n/**\r\n * Delete permissions of roles in database\r\n * @param rolesIds ids of roles\r\n */\r\nexport const deleteByRolesIds = async (rolesIds: Data.ID[]): Promise<void> => {\r\n  const permissionsToDelete = await strapi.db.query('admin::permission').findMany({\r\n    select: ['id'],\r\n    where: {\r\n      role: { id: rolesIds },\r\n    },\r\n  });\r\n\r\n  if (permissionsToDelete.length > 0) {\r\n    await deleteByIds(permissionsToDelete.map(prop('id')));\r\n  }\r\n};\r\n\r\n/**\r\n * Delete permissions\r\n * @param ids ids of permissions\r\n */\r\nexport const deleteByIds = async (ids: Data.ID[]): Promise<void> => {\r\n  const result: unknown[] = [];\r\n  for (const id of ids) {\r\n    const queryResult = await strapi.db.query('admin::permission').delete({ where: { id } });\r\n    result.push(queryResult);\r\n  }\r\n  strapi.eventHub.emit('permission.delete', { permissions: result });\r\n};\r\n\r\n/**\r\n * Create many permissions\r\n * @param permissions\r\n */\r\nexport const createMany = async (permissions: CreatePermissionPayload[]): Promise<Permission[]> => {\r\n  const createdPermissions: CreatePermissionPayload[] = [];\r\n  for (const permission of permissions) {\r\n    const newPerm = await strapi.db.query('admin::permission').create({ data: permission });\r\n    createdPermissions.push(newPerm);\r\n  }\r\n\r\n  const permissionsToReturn = permissionDomain.toPermission(createdPermissions);\r\n  strapi.eventHub.emit('permission.create', { permissions: permissionsToReturn });\r\n\r\n  return permissionsToReturn;\r\n};\r\n\r\n/**\r\n * Update a permission\r\n * @param params\r\n * @param attributes\r\n */\r\nconst update = async (params: unknown, attributes: Partial<Permission>) => {\r\n  const updatedPermission = (await strapi.db\r\n    .query('admin::permission')\r\n    .update({ where: params, data: attributes })) as Permission;\r\n\r\n  const permissionToReturn = permissionDomain.toPermission(updatedPermission);\r\n  strapi.eventHub.emit('permission.update', { permissions: permissionToReturn });\r\n\r\n  return permissionToReturn;\r\n};\r\n\r\n/**\r\n * Find assigned permissions in the database\r\n * @param params query params to find the permissions\r\n */\r\nexport const findMany = async (params = {}): Promise<Permission[]> => {\r\n  const rawPermissions = await strapi.db.query('admin::permission').findMany(params);\r\n\r\n  return permissionDomain.toPermission(rawPermissions);\r\n};\r\n\r\n/**\r\n * Find all permissions for a user\r\n * @param user - user\r\n */\r\nexport const findUserPermissions = async (user: AdminUser): Promise<Permission[]> => {\r\n  return findMany({ where: { role: { users: { id: user.id } } } });\r\n};\r\n\r\nconst filterPermissionsToRemove = async (permissions: Permission[]) => {\r\n  const { actionProvider } = getService('permission');\r\n\r\n  const permissionsToRemove: Permission[] = [];\r\n\r\n  for (const permission of permissions) {\r\n    const { subjects, options = {} as Action['options'] } =\r\n      (actionProvider.get(permission.action) as Action) || {};\r\n    const { applyToProperties } = options;\r\n\r\n    const invalidProperties = await Promise.all(\r\n      (applyToProperties || []).map(async (property) => {\r\n        const applies = await actionProvider.appliesToProperty(\r\n          property,\r\n          permission.action,\r\n          permission.subject\r\n        );\r\n\r\n        return applies && isNil(permissionDomain.getProperty(property, permission));\r\n      })\r\n    );\r\n\r\n    const isRegisteredAction = actionProvider.has(permission.action);\r\n    const hasInvalidProperties = isArray(applyToProperties) && invalidProperties.every(eq(true));\r\n    const isInvalidSubject = isArray(subjects) && !subjects.includes(permission.subject as string);\r\n\r\n    // If the permission has an invalid action, an invalid subject or invalid properties, then add it to the toBeRemoved collection\r\n    if (!isRegisteredAction || isInvalidSubject || hasInvalidProperties) {\r\n      permissionsToRemove.push(permission);\r\n    }\r\n  }\r\n\r\n  return permissionsToRemove;\r\n};\r\n\r\n/**\r\n * Removes permissions in database that don't exist anymore\r\n */\r\nexport const cleanPermissionsInDatabase = async (): Promise<void> => {\r\n  const pageSize = 200;\r\n\r\n  const contentTypeService = getService('content-type');\r\n\r\n  const total = await strapi.db.query('admin::permission').count();\r\n  const pageCount = Math.ceil(total / pageSize);\r\n\r\n  for (let page = 0; page < pageCount; page += 1) {\r\n    // 1. Find invalid permissions and collect their ID to delete them later\r\n    const results = (await strapi.db\r\n      .query('admin::permission')\r\n      .findMany({ limit: pageSize, offset: page * pageSize })) as Permission[];\r\n\r\n    const permissions = permissionDomain.toPermission(results);\r\n    const permissionsToRemove = await filterPermissionsToRemove(permissions);\r\n    const permissionsIdToRemove = map(prop('id'), permissionsToRemove);\r\n\r\n    // 2. Clean permissions' fields (add required ones, remove the non-existing ones)\r\n    const remainingPermissions = permissions.filter(\r\n      (permission: Permission) => !permissionsIdToRemove.includes(permission.id)\r\n    );\r\n\r\n    const permissionsWithCleanFields = contentTypeService.cleanPermissionFields(\r\n      remainingPermissions\r\n    ) as Permission[];\r\n\r\n    // Update only the ones that need to be updated\r\n    const permissionsNeedingToBeUpdated = differenceWith(\r\n      (a: Permission, b: Permission) => {\r\n        return a.id === b.id && xor(a.properties.fields, b.properties.fields).length === 0;\r\n      },\r\n      permissionsWithCleanFields,\r\n      remainingPermissions\r\n    );\r\n\r\n    const updatePromiseProvider = (permission: Permission) => {\r\n      return update({ id: permission.id }, permission);\r\n    };\r\n\r\n    // Execute all the queries, update the database\r\n    await Promise.all([\r\n      deleteByIds(permissionsIdToRemove),\r\n      pmap(permissionsNeedingToBeUpdated, updatePromiseProvider, {\r\n        concurrency: 100,\r\n        stopOnError: true,\r\n      }),\r\n    ]);\r\n  }\r\n};\r\n\r\nexport default {\r\n  createMany,\r\n  findMany,\r\n  deleteByRolesIds,\r\n  deleteByIds,\r\n  findUserPermissions,\r\n  cleanPermissionsInDatabase,\r\n};\r\n","import domain from '../domain/permission';\r\nimport createActionProvider from '../domain/action/provider';\r\nimport createConditionProvider from '../domain/condition/provider';\r\nimport createPermissionsManager from './permission/permissions-manager';\r\nimport createPermissionEngine from './permission/engine';\r\nimport createSectionsBuilder from './permission/sections-builder';\r\nimport {\r\n  cleanPermissionsInDatabase,\r\n  createMany,\r\n  deleteByIds,\r\n  deleteByRolesIds,\r\n  findMany,\r\n  findUserPermissions,\r\n} from './permission/queries';\r\n\r\nconst actionProvider = createActionProvider();\r\nconst conditionProvider = createConditionProvider();\r\nconst sectionsBuilder = createSectionsBuilder();\r\n\r\nconst sanitizePermission = domain.sanitizePermissionFields;\r\n\r\nconst engine = createPermissionEngine({\r\n  providers: { action: actionProvider, condition: conditionProvider },\r\n});\r\n\r\nexport {\r\n  // Queries / Actions\r\n  cleanPermissionsInDatabase,\r\n  createMany,\r\n  deleteByIds,\r\n  deleteByRolesIds,\r\n  findMany,\r\n  findUserPermissions,\r\n  // Utils\r\n  createPermissionsManager,\r\n  sectionsBuilder,\r\n  sanitizePermission,\r\n  // Engine\r\n  engine,\r\n  // Providers\r\n  actionProvider,\r\n  conditionProvider,\r\n};\r\n","import _ from 'lodash';\r\nimport { uniq, startsWith, intersection } from 'lodash/fp';\r\nimport { contentTypes as contentTypesUtils } from '@strapi/utils';\r\nimport type { Modules, Struct } from '@strapi/types';\r\nimport { getService } from '../utils';\r\nimport actionDomain from '../domain/action';\r\nimport permissionDomain from '../domain/permission';\r\n\r\ninterface FieldOptions {\r\n  prefix?: string; // prefix to add to the path\r\n  nestingLevel?: number; // level of nesting to achieve\r\n  requiredOnly?: boolean; // only returns required nestedFields\r\n  existingFields?: string[]; // fields that are already selected, meaning that some sub-fields may be required\r\n  restrictedSubjects?: string[]; // subjectsId to ignore\r\n  components?: {\r\n    // components where components attributes can be found\r\n    [key: string]: any;\r\n  };\r\n}\r\n\r\n/**\r\n * Creates an array of paths to the fields and nested fields, without path nodes\r\n */\r\nconst getNestedFields = (\r\n  model: Struct.ContentTypeSchema,\r\n  {\r\n    prefix = '',\r\n    nestingLevel = 15,\r\n    components = {},\r\n    requiredOnly = false,\r\n    existingFields = [],\r\n  }: FieldOptions\r\n): string[] => {\r\n  if (nestingLevel === 0) {\r\n    return prefix ? [prefix] : [];\r\n  }\r\n\r\n  const nonAuthorizableFields = contentTypesUtils.getNonVisibleAttributes(model);\r\n\r\n  return _.reduce(\r\n    model.attributes,\r\n    (fields: any, attr: any, key: any) => {\r\n      if (nonAuthorizableFields.includes(key)) return fields;\r\n\r\n      const fieldPath = prefix ? `${prefix}.${key}` : key;\r\n      const shouldBeIncluded = !requiredOnly || attr.required === true;\r\n      const insideExistingFields = existingFields && existingFields.some(startsWith(fieldPath));\r\n\r\n      if (attr.type === 'component') {\r\n        if (shouldBeIncluded || insideExistingFields) {\r\n          const compoFields = getNestedFields(components[attr.component], {\r\n            nestingLevel: nestingLevel - 1,\r\n            prefix: fieldPath,\r\n            components,\r\n            requiredOnly,\r\n            existingFields,\r\n          });\r\n\r\n          if (compoFields.length === 0 && shouldBeIncluded) {\r\n            return fields.concat(fieldPath);\r\n          }\r\n\r\n          return fields.concat(compoFields);\r\n        }\r\n        return fields;\r\n      }\r\n\r\n      if (shouldBeIncluded) {\r\n        return fields.concat(fieldPath);\r\n      }\r\n\r\n      return fields;\r\n    },\r\n    []\r\n  );\r\n};\r\n\r\n/**\r\n * Creates an array of paths to the fields and nested fields, with path nodes\r\n */\r\nconst getNestedFieldsWithIntermediate = (\r\n  model: Struct.ContentTypeSchema,\r\n  { prefix = '', nestingLevel = 15, components = {} }: FieldOptions\r\n): string[] => {\r\n  if (nestingLevel === 0) {\r\n    return [];\r\n  }\r\n\r\n  const nonAuthorizableFields = contentTypesUtils.getNonVisibleAttributes(model);\r\n\r\n  return _.reduce(\r\n    model.attributes,\r\n    (fields: any, attr: any, key: any) => {\r\n      if (nonAuthorizableFields.includes(key)) return fields;\r\n\r\n      const fieldPath = prefix ? `${prefix}.${key}` : key;\r\n      fields.push(fieldPath);\r\n\r\n      if (attr.type === 'component') {\r\n        const compoFields = getNestedFieldsWithIntermediate(components[attr.component], {\r\n          nestingLevel: nestingLevel - 1,\r\n          prefix: fieldPath,\r\n          components,\r\n        });\r\n\r\n        fields.push(...compoFields);\r\n      }\r\n\r\n      return fields;\r\n    },\r\n    []\r\n  );\r\n};\r\n\r\n/**\r\n * Creates an array of permissions with the \"properties.fields\" attribute filled\r\n */\r\nconst getPermissionsWithNestedFields = (\r\n  actions: any[],\r\n  { nestingLevel, restrictedSubjects = [] }: FieldOptions = {}\r\n): Modules.Permissions.PermissionRule[] => {\r\n  return actions.reduce((permissions, action) => {\r\n    const validSubjects = action.subjects.filter(\r\n      (subject: any) => !restrictedSubjects.includes(subject)\r\n    );\r\n\r\n    // Create a Permission for each subject (content-type uid) within the action\r\n    for (const subject of validSubjects) {\r\n      const fields = actionDomain.appliesToProperty('fields', action)\r\n        ? getNestedFields(strapi.contentTypes[subject], {\r\n            components: strapi.components,\r\n            nestingLevel,\r\n          })\r\n        : undefined;\r\n\r\n      const permission = permissionDomain.create({\r\n        action: action.actionId,\r\n        subject,\r\n        properties: { fields },\r\n      });\r\n\r\n      permissions.push(permission);\r\n    }\r\n\r\n    return permissions;\r\n  }, []);\r\n};\r\n\r\n/**\r\n * Cleans permissions' fields (add required ones, remove the non-existing ones)\r\n */\r\nconst cleanPermissionFields = (\r\n  permissions: Modules.Permissions.PermissionRule[],\r\n  { nestingLevel }: FieldOptions = {}\r\n): Modules.Permissions.PermissionRule[] => {\r\n  const { actionProvider } = getService('permission');\r\n\r\n  return permissions.map((permission: any) => {\r\n    const {\r\n      action: actionId,\r\n      subject,\r\n      properties: { fields },\r\n    } = permission;\r\n\r\n    const action = actionProvider.get(actionId) as any;\r\n\r\n    // todo see if it's possible to check property on action + subject (async)\r\n    if (!actionDomain.appliesToProperty('fields', action)) {\r\n      return permissionDomain.deleteProperty('fields', permission);\r\n    }\r\n\r\n    if (!subject || !strapi.contentTypes[subject]) {\r\n      return permission;\r\n    }\r\n\r\n    const possibleFields = getNestedFieldsWithIntermediate(strapi.contentTypes[subject], {\r\n      components: strapi.components,\r\n      nestingLevel,\r\n    });\r\n\r\n    const requiredFields = getNestedFields(strapi.contentTypes[subject], {\r\n      components: strapi.components,\r\n      requiredOnly: true,\r\n      nestingLevel,\r\n      existingFields: fields,\r\n    });\r\n\r\n    // @ts-expect-error lodash types\r\n    const badNestedFields = uniq([...intersection(fields, possibleFields), ...requiredFields]);\r\n\r\n    const newFields = badNestedFields.filter(\r\n      (field) => !badNestedFields.some(startsWith(`${field}.`))\r\n    );\r\n\r\n    return permissionDomain.setProperty('fields', newFields, permission);\r\n  }, []);\r\n};\r\n\r\nexport {\r\n  getNestedFields,\r\n  getPermissionsWithNestedFields,\r\n  cleanPermissionFields,\r\n  getNestedFieldsWithIntermediate,\r\n};\r\n","import { isString } from 'lodash/fp';\r\nimport { getService } from '../utils';\r\n\r\nconst isValidCondition = (condition: unknown) => {\r\n  const { conditionProvider } = getService('permission');\r\n\r\n  return isString(condition) && conditionProvider.has(condition);\r\n};\r\n\r\nexport { isValidCondition };\r\n","import { isNil } from 'lodash/fp';\r\nimport { errors } from '@strapi/utils';\r\nimport { getService } from '../utils';\r\nimport constants from './constants';\r\nimport type { AdminRole } from '../../../shared/contracts/shared';\r\n\r\nconst { AUTHOR_CODE, PUBLISH_ACTION } = constants;\r\n\r\nconst { NotFoundError } = errors;\r\n// TODO: move actionProvider here instead of in the permission service\r\n\r\n/**\r\n * Returns actions available for a role.\r\n * @param {string|number} roleId\r\n * @returns {object[]}\r\n */\r\nconst getAllowedActionsForRole = async (roleId?: string) => {\r\n  const { actionProvider } = getService('permission');\r\n\r\n  if (!isNil(roleId)) {\r\n    const role: AdminRole = await getService('role').findOne({ id: roleId });\r\n\r\n    if (!role) {\r\n      throw new NotFoundError('role.notFound');\r\n    }\r\n\r\n    if (role.code === AUTHOR_CODE) {\r\n      return actionProvider.values().filter(({ actionId }: any) => actionId !== PUBLISH_ACTION);\r\n    }\r\n  }\r\n\r\n  return actionProvider.values();\r\n};\r\n\r\nexport { getAllowedActionsForRole };\r\n","import crypto from 'crypto';\r\nimport { omit, difference, isNil, isEmpty, map, isArray, uniq, isNumber } from 'lodash/fp';\r\nimport { errors } from '@strapi/utils';\r\nimport type { Update, ApiToken, ApiTokenBody } from '../../../shared/contracts/api-token';\r\nimport constants from './constants';\r\n\r\nconst { ValidationError, NotFoundError } = errors;\r\n\r\ntype ApiTokenPermission = {\r\n  id: number | `${number}`;\r\n  action: string;\r\n  token: DBApiToken | number;\r\n};\r\n\r\ntype DBApiToken = ApiToken & {\r\n  permissions: (number | ApiTokenPermission)[];\r\n};\r\n\r\nconst SELECT_FIELDS = [\r\n  'id',\r\n  'name',\r\n  'description',\r\n  'lastUsedAt',\r\n  'type',\r\n  'lifespan',\r\n  'expiresAt',\r\n  'createdAt',\r\n  'updatedAt',\r\n];\r\n\r\nconst POPULATE_FIELDS = ['permissions'];\r\n\r\n// TODO: we need to ensure the permissions are actually valid registered permissions!\r\n\r\n/**\r\n * Assert that a token's permissions attribute is valid for its type\r\n */\r\nconst assertCustomTokenPermissionsValidity = (\r\n  type: ApiTokenBody['type'],\r\n  permissions: ApiTokenBody['permissions']\r\n) => {\r\n  // Ensure non-custom tokens doesn't have permissions\r\n  if (type !== constants.API_TOKEN_TYPE.CUSTOM && !isEmpty(permissions)) {\r\n    throw new ValidationError('Non-custom tokens should not reference permissions');\r\n  }\r\n\r\n  // Custom type tokens should always have permissions attached to them\r\n  if (type === constants.API_TOKEN_TYPE.CUSTOM && !isArray(permissions)) {\r\n    throw new ValidationError('Missing permissions attribute for custom token');\r\n  }\r\n\r\n  // Permissions provided for a custom type token should be valid/registered permissions UID\r\n  if (type === constants.API_TOKEN_TYPE.CUSTOM) {\r\n    const validPermissions = strapi.contentAPI.permissions.providers.action.keys();\r\n    const invalidPermissions = difference(permissions, validPermissions) as string[];\r\n\r\n    if (!isEmpty(invalidPermissions)) {\r\n      throw new ValidationError(`Unknown permissions provided: ${invalidPermissions.join(', ')}`);\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Check if a token's lifespan is valid\r\n */\r\nconst isValidLifespan = (lifespan: unknown) => {\r\n  if (isNil(lifespan)) {\r\n    return true;\r\n  }\r\n\r\n  if (!isNumber(lifespan) || !Object.values(constants.API_TOKEN_LIFESPANS).includes(lifespan)) {\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\n/**\r\n * Assert that a token's lifespan is valid\r\n */\r\nconst assertValidLifespan = (lifespan: unknown) => {\r\n  if (!isValidLifespan(lifespan)) {\r\n    throw new ValidationError(\r\n      `lifespan must be one of the following values:\r\n      ${Object.values(constants.API_TOKEN_LIFESPANS).join(', ')}`\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Flatten a token's database permissions objects to an array of strings\r\n */\r\nconst flattenTokenPermissions = (token: DBApiToken): ApiToken => {\r\n  if (!token) {\r\n    return token;\r\n  }\r\n\r\n  return {\r\n    ...token,\r\n    permissions: isArray(token.permissions) ? map('action', token.permissions) : token.permissions,\r\n  };\r\n};\r\n\r\ntype WhereParams = {\r\n  id?: string | number;\r\n  name?: string;\r\n  lastUsedAt?: number;\r\n  description?: string;\r\n  accessKey?: string;\r\n};\r\n\r\n/**\r\n *  Get a token\r\n */\r\nconst getBy = async (whereParams: WhereParams = {}): Promise<ApiToken | null> => {\r\n  if (Object.keys(whereParams).length === 0) {\r\n    return null;\r\n  }\r\n\r\n  const token = await strapi.db\r\n    .query('admin::api-token')\r\n    .findOne({ select: SELECT_FIELDS, populate: POPULATE_FIELDS, where: whereParams });\r\n\r\n  if (!token) {\r\n    return token;\r\n  }\r\n\r\n  return flattenTokenPermissions(token);\r\n};\r\n\r\n/**\r\n * Check if token exists\r\n */\r\nconst exists = async (whereParams: WhereParams = {}): Promise<boolean> => {\r\n  const apiToken = await getBy(whereParams);\r\n\r\n  return !!apiToken;\r\n};\r\n\r\n/**\r\n * Return a secure sha512 hash of an accessKey\r\n */\r\nconst hash = (accessKey: string) => {\r\n  return crypto\r\n    .createHmac('sha512', strapi.config.get('admin.apiToken.salt'))\r\n    .update(accessKey)\r\n    .digest('hex');\r\n};\r\n\r\nconst getExpirationFields = (lifespan: ApiTokenBody['lifespan']) => {\r\n  // it must be nil or a finite number >= 0\r\n  const isValidNumber = isNumber(lifespan) && Number.isFinite(lifespan) && lifespan > 0;\r\n  if (!isValidNumber && !isNil(lifespan)) {\r\n    throw new ValidationError('lifespan must be a positive number or null');\r\n  }\r\n\r\n  return {\r\n    lifespan: lifespan || null,\r\n    expiresAt: lifespan ? Date.now() + lifespan : null,\r\n  };\r\n};\r\n\r\n/**\r\n * Create a token and its permissions\r\n */\r\nconst create = async (attributes: ApiTokenBody): Promise<ApiToken> => {\r\n  const accessKey = crypto.randomBytes(128).toString('hex');\r\n\r\n  assertCustomTokenPermissionsValidity(attributes.type, attributes.permissions);\r\n  assertValidLifespan(attributes.lifespan);\r\n\r\n  // Create the token\r\n  const apiToken: ApiToken = await strapi.db.query('admin::api-token').create({\r\n    select: SELECT_FIELDS,\r\n    populate: POPULATE_FIELDS,\r\n    data: {\r\n      ...omit('permissions', attributes),\r\n      accessKey: hash(accessKey),\r\n      ...getExpirationFields(attributes.lifespan),\r\n    },\r\n  });\r\n\r\n  const result: ApiToken = { ...apiToken, accessKey };\r\n\r\n  // If this is a custom type token, create and the related permissions\r\n  if (attributes.type === constants.API_TOKEN_TYPE.CUSTOM) {\r\n    // TODO: createMany doesn't seem to create relation properly, implement a better way rather than a ton of queries\r\n    // const permissionsCount = await strapi.db.query('admin::api-token-permission').createMany({\r\n    //   populate: POPULATE_FIELDS,\r\n    //   data: attributes.permissions.map(action => ({ action, token: apiToken })),\r\n    // });\r\n    await Promise.all(\r\n      uniq(attributes.permissions).map((action) =>\r\n        strapi.db.query('admin::api-token-permission').create({\r\n          data: { action, token: apiToken },\r\n        })\r\n      )\r\n    );\r\n\r\n    const currentPermissions = await strapi.db\r\n      .query('admin::api-token')\r\n      .load(apiToken, 'permissions');\r\n\r\n    if (currentPermissions) {\r\n      Object.assign(result, { permissions: map('action', currentPermissions) });\r\n    }\r\n  }\r\n\r\n  return result;\r\n};\r\n\r\nconst regenerate = async (id: string | number): Promise<ApiToken> => {\r\n  const accessKey = crypto.randomBytes(128).toString('hex');\r\n\r\n  const apiToken: ApiToken = await strapi.db.query('admin::api-token').update({\r\n    select: ['id', 'accessKey'],\r\n    where: { id },\r\n    data: {\r\n      accessKey: hash(accessKey),\r\n    },\r\n  });\r\n\r\n  if (!apiToken) {\r\n    throw new NotFoundError('The provided token id does not exist');\r\n  }\r\n\r\n  return {\r\n    ...apiToken,\r\n    accessKey,\r\n  };\r\n};\r\n\r\nconst checkSaltIsDefined = () => {\r\n  if (!strapi.config.get('admin.apiToken.salt')) {\r\n    // TODO V5: stop reading API_TOKEN_SALT\r\n    if (process.env.API_TOKEN_SALT) {\r\n      process.emitWarning(`[deprecated] In future versions, Strapi will stop reading directly from the environment variable API_TOKEN_SALT. Please set apiToken.salt in config/admin.js instead.\r\nFor security reasons, keep storing the secret in an environment variable and use env() to read it in config/admin.js (ex: \\`apiToken: { salt: env('API_TOKEN_SALT') }\\`). See https://docs.strapi.io/developer-docs/latest/setup-deployment-guides/configurations/optional/environment.html#configuration-using-environment-variables.`);\r\n\r\n      strapi.config.set('admin.apiToken.salt', process.env.API_TOKEN_SALT);\r\n    } else {\r\n      throw new Error(\r\n        `Missing apiToken.salt. Please set apiToken.salt in config/admin.js (ex: you can generate one using Node with \\`crypto.randomBytes(16).toString('base64')\\`).\r\nFor security reasons, prefer storing the secret in an environment variable and read it in config/admin.js. See https://docs.strapi.io/developer-docs/latest/setup-deployment-guides/configurations/optional/environment.html#configuration-using-environment-variables.`\r\n      );\r\n    }\r\n  }\r\n};\r\n\r\n/**\r\n * Return a list of all tokens and their permissions\r\n */\r\nconst list = async (): Promise<Array<ApiToken>> => {\r\n  const tokens: Array<DBApiToken> = await strapi.db.query('admin::api-token').findMany({\r\n    select: SELECT_FIELDS,\r\n    populate: POPULATE_FIELDS,\r\n    orderBy: { name: 'ASC' },\r\n  });\r\n\r\n  if (!tokens) {\r\n    return tokens;\r\n  }\r\n\r\n  return tokens.map((token) => flattenTokenPermissions(token));\r\n};\r\n\r\n/**\r\n * Revoke (delete) a token\r\n */\r\nconst revoke = async (id: string | number): Promise<ApiToken> => {\r\n  return strapi.db\r\n    .query('admin::api-token')\r\n    .delete({ select: SELECT_FIELDS, populate: POPULATE_FIELDS, where: { id } });\r\n};\r\n\r\n/**\r\n * Retrieve a token by id\r\n */\r\nconst getById = async (id: string | number) => {\r\n  return getBy({ id });\r\n};\r\n\r\n/**\r\n * Retrieve a token by name\r\n */\r\nconst getByName = async (name: string) => {\r\n  return getBy({ name });\r\n};\r\n\r\n/**\r\n * Update a token and its permissions\r\n */\r\nconst update = async (\r\n  id: string | number,\r\n  attributes: Update.Request['body']\r\n): Promise<ApiToken> => {\r\n  // retrieve token without permissions\r\n  const originalToken: DBApiToken = await strapi.db\r\n    .query('admin::api-token')\r\n    .findOne({ where: { id } });\r\n\r\n  if (!originalToken) {\r\n    throw new NotFoundError('Token not found');\r\n  }\r\n\r\n  const changingTypeToCustom =\r\n    attributes.type === constants.API_TOKEN_TYPE.CUSTOM &&\r\n    originalToken.type !== constants.API_TOKEN_TYPE.CUSTOM;\r\n\r\n  // if we're updating the permissions on any token type, or changing from non-custom to custom, ensure they're still valid\r\n  // if neither type nor permissions are changing, we don't need to validate again or else we can't allow partial update\r\n  if (attributes.permissions || changingTypeToCustom) {\r\n    assertCustomTokenPermissionsValidity(\r\n      attributes.type || originalToken.type,\r\n      attributes.permissions || originalToken.permissions\r\n    );\r\n  }\r\n\r\n  assertValidLifespan(attributes.lifespan);\r\n\r\n  const updatedToken: ApiToken = await strapi.db.query('admin::api-token').update({\r\n    select: SELECT_FIELDS,\r\n    where: { id },\r\n    data: omit('permissions', attributes),\r\n  });\r\n\r\n  // custom tokens need to have their permissions updated as well\r\n  if (updatedToken.type === constants.API_TOKEN_TYPE.CUSTOM && attributes.permissions) {\r\n    const currentPermissionsResult = await strapi.db\r\n      .query('admin::api-token')\r\n      .load(updatedToken, 'permissions');\r\n\r\n    const currentPermissions = map('action', currentPermissionsResult || []);\r\n    const newPermissions = uniq(attributes.permissions);\r\n\r\n    const actionsToDelete = difference(currentPermissions, newPermissions);\r\n    const actionsToAdd = difference(newPermissions, currentPermissions);\r\n\r\n    // TODO: improve efficiency here\r\n    // method using a loop -- works but very inefficient\r\n    await Promise.all(\r\n      actionsToDelete.map((action) =>\r\n        strapi.db.query('admin::api-token-permission').delete({\r\n          where: { action, token: id },\r\n        })\r\n      )\r\n    );\r\n\r\n    // TODO: improve efficiency here\r\n    // using a loop -- works but very inefficient\r\n    await Promise.all(\r\n      actionsToAdd.map((action) =>\r\n        strapi.db.query('admin::api-token-permission').create({\r\n          data: { action, token: id },\r\n        })\r\n      )\r\n    );\r\n  }\r\n  // if type is not custom, make sure any old permissions get removed\r\n  else if (updatedToken.type !== constants.API_TOKEN_TYPE.CUSTOM) {\r\n    await strapi.db.query('admin::api-token-permission').delete({\r\n      where: { token: id },\r\n    });\r\n  }\r\n\r\n  // retrieve permissions\r\n  const permissionsFromDb = await strapi.db\r\n    .query('admin::api-token')\r\n    .load(updatedToken, 'permissions');\r\n\r\n  return {\r\n    ...updatedToken,\r\n    permissions: permissionsFromDb ? permissionsFromDb.map((p: any) => p.action) : undefined,\r\n  };\r\n};\r\n\r\nexport {\r\n  create,\r\n  regenerate,\r\n  exists,\r\n  checkSaltIsDefined,\r\n  hash,\r\n  list,\r\n  revoke,\r\n  getById,\r\n  update,\r\n  getByName,\r\n  getBy,\r\n};\r\n","import permissions from '@strapi/permissions';\r\nimport { providerFactory } from '@strapi/utils';\r\n\r\nconst DEFAULT_TRANSFER_ACTIONS = ['push', 'pull'];\r\n\r\nconst providers = {\r\n  action: providerFactory(),\r\n  condition: providerFactory(),\r\n};\r\n\r\nDEFAULT_TRANSFER_ACTIONS.forEach((action) => {\r\n  providers.action.register(action, { action });\r\n});\r\n\r\nconst engine = permissions.engine.new({ providers });\r\n\r\nexport { engine, providers };\r\n","import crypto from 'crypto';\r\nimport assert from 'assert';\r\nimport { map, isArray, omit, uniq, isNil, difference, isEmpty, isNumber } from 'lodash/fp';\r\nimport { errors } from '@strapi/utils';\r\nimport '@strapi/types';\r\nimport constants from '../constants';\r\nimport { getService } from '../../utils';\r\nimport {\r\n  DatabaseTransferToken,\r\n  SanitizedTransferToken,\r\n  TokenCreatePayload,\r\n  TokenUpdatePayload,\r\n  TransferToken,\r\n  TransferTokenPermission,\r\n} from '../../../../shared/contracts/transfer';\r\n\r\nconst { ValidationError, NotFoundError } = errors;\r\n\r\nconst TRANSFER_TOKEN_UID = 'admin::transfer-token';\r\nconst TRANSFER_TOKEN_PERMISSION_UID = 'admin::transfer-token-permission';\r\n\r\nconst SELECT_FIELDS = [\r\n  'id',\r\n  'name',\r\n  'description',\r\n  'lastUsedAt',\r\n  'lifespan',\r\n  'expiresAt',\r\n  'createdAt',\r\n  'updatedAt',\r\n] as const;\r\n\r\nconst POPULATE_FIELDS = ['permissions'] as const;\r\n\r\n/**\r\n * Return a list of all tokens and their permissions\r\n */\r\nconst list = async (): Promise<SanitizedTransferToken[]> => {\r\n  const tokens: DatabaseTransferToken[] = await strapi.db.query(TRANSFER_TOKEN_UID).findMany({\r\n    select: SELECT_FIELDS,\r\n    populate: POPULATE_FIELDS,\r\n    orderBy: { name: 'ASC' },\r\n  });\r\n\r\n  if (!tokens) return tokens;\r\n  return tokens.map((token) => flattenTokenPermissions(token));\r\n};\r\n\r\n/**\r\n * Create a random token's access key\r\n */\r\nconst generateRandomAccessKey = (): string => crypto.randomBytes(128).toString('hex');\r\n\r\n/**\r\n * Validate the given access key's format and returns it if valid\r\n */\r\nconst validateAccessKey = (accessKey: string): string => {\r\n  assert(typeof accessKey === 'string', 'Access key needs to be a string');\r\n  assert(accessKey.length >= 15, 'Access key needs to have at least 15 characters');\r\n\r\n  return accessKey;\r\n};\r\n\r\nexport const hasAccessKey = <T extends { accessKey?: string }>(\r\n  attributes: T\r\n): attributes is T & { accessKey: string } => {\r\n  return 'accessKey' in attributes;\r\n};\r\n\r\n/**\r\n * Create a token and its permissions\r\n */\r\nconst create = async (attributes: TokenCreatePayload): Promise<TransferToken> => {\r\n  const accessKey = hasAccessKey(attributes)\r\n    ? validateAccessKey(attributes.accessKey)\r\n    : generateRandomAccessKey();\r\n\r\n  // Make sure the access key isn't picked up directly from the attributes for the next steps\r\n  delete attributes.accessKey;\r\n\r\n  assertTokenPermissionsValidity(attributes);\r\n  assertValidLifespan(attributes.lifespan);\r\n\r\n  const result = (await strapi.db.transaction(async () => {\r\n    const transferToken = await strapi.db.query(TRANSFER_TOKEN_UID).create({\r\n      select: SELECT_FIELDS,\r\n      populate: POPULATE_FIELDS,\r\n      data: {\r\n        ...omit('permissions', attributes),\r\n        accessKey: hash(accessKey),\r\n        ...getExpirationFields(attributes.lifespan),\r\n      },\r\n    });\r\n\r\n    await Promise.all(\r\n      uniq(attributes.permissions).map((action) =>\r\n        strapi.db\r\n          .query(TRANSFER_TOKEN_PERMISSION_UID)\r\n          .create({ data: { action, token: transferToken } })\r\n      )\r\n    );\r\n\r\n    const currentPermissions: TransferTokenPermission[] = await strapi.db\r\n      .query(TRANSFER_TOKEN_UID)\r\n      .load(transferToken, 'permissions');\r\n\r\n    if (currentPermissions) {\r\n      Object.assign(transferToken, { permissions: map('action', currentPermissions) });\r\n    }\r\n\r\n    return transferToken;\r\n  })) as TransferToken;\r\n\r\n  return { ...result, accessKey };\r\n};\r\n\r\n/**\r\n * Update a token and its permissions\r\n */\r\nconst update = async (\r\n  id: string | number,\r\n  attributes: TokenUpdatePayload\r\n): Promise<SanitizedTransferToken> => {\r\n  // retrieve token without permissions\r\n  const originalToken = await strapi.db.query(TRANSFER_TOKEN_UID).findOne({ where: { id } });\r\n\r\n  if (!originalToken) {\r\n    throw new NotFoundError('Token not found');\r\n  }\r\n\r\n  assertTokenPermissionsValidity(attributes);\r\n  assertValidLifespan(attributes.lifespan);\r\n\r\n  return strapi.db.transaction(async () => {\r\n    const updatedToken = await strapi.db.query(TRANSFER_TOKEN_UID).update({\r\n      select: SELECT_FIELDS,\r\n      where: { id },\r\n      data: {\r\n        ...omit('permissions', attributes),\r\n      },\r\n    });\r\n\r\n    if (attributes.permissions) {\r\n      const currentPermissionsResult = await strapi.db\r\n        .query(TRANSFER_TOKEN_UID)\r\n        .load(updatedToken, 'permissions');\r\n\r\n      const currentPermissions = map('action', currentPermissionsResult || []);\r\n      const newPermissions = uniq(attributes.permissions);\r\n\r\n      const actionsToDelete = difference(currentPermissions, newPermissions);\r\n      const actionsToAdd = difference(newPermissions, currentPermissions);\r\n\r\n      // TODO: improve efficiency here\r\n      // method using a loop -- works but very inefficient\r\n      await Promise.all(\r\n        actionsToDelete.map((action) =>\r\n          strapi.db.query(TRANSFER_TOKEN_PERMISSION_UID).delete({\r\n            where: { action, token: id },\r\n          })\r\n        )\r\n      );\r\n\r\n      // TODO: improve efficiency here\r\n      // using a loop -- works but very inefficient\r\n      await Promise.all(\r\n        actionsToAdd.map((action) =>\r\n          strapi.db.query(TRANSFER_TOKEN_PERMISSION_UID).create({\r\n            data: { action, token: id },\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    // retrieve permissions\r\n    const permissionsFromDb: TransferTokenPermission[] = await strapi.db\r\n      .query(TRANSFER_TOKEN_UID)\r\n      .load(updatedToken, 'permissions');\r\n\r\n    return {\r\n      ...updatedToken,\r\n      permissions: permissionsFromDb ? permissionsFromDb.map((p) => p.action) : undefined,\r\n    };\r\n  }) as unknown as Promise<SanitizedTransferToken>;\r\n};\r\n\r\n/**\r\n * Revoke (delete) a token\r\n */\r\nconst revoke = async (id: string | number): Promise<SanitizedTransferToken> => {\r\n  return strapi.db.transaction(async () =>\r\n    strapi.db\r\n      .query(TRANSFER_TOKEN_UID)\r\n      .delete({ select: SELECT_FIELDS, populate: POPULATE_FIELDS, where: { id } })\r\n  ) as unknown as Promise<SanitizedTransferToken>;\r\n};\r\n\r\n/**\r\n *  Get a token\r\n */\r\nconst getBy = async (\r\n  whereParams = {} as {\r\n    id?: string | number;\r\n    name?: string;\r\n    lastUsedAt?: number;\r\n    description?: string;\r\n    accessKey?: string;\r\n  }\r\n): Promise<SanitizedTransferToken | null> => {\r\n  if (Object.keys(whereParams).length === 0) {\r\n    return null;\r\n  }\r\n\r\n  const token = await strapi.db\r\n    .query(TRANSFER_TOKEN_UID)\r\n    .findOne({ select: SELECT_FIELDS, populate: POPULATE_FIELDS, where: whereParams });\r\n\r\n  if (!token) {\r\n    return token;\r\n  }\r\n\r\n  return flattenTokenPermissions(token);\r\n};\r\n\r\n/**\r\n * Retrieve a token by id\r\n */\r\nconst getById = async (id: string | number): Promise<SanitizedTransferToken | null> => {\r\n  return getBy({ id });\r\n};\r\n\r\n/**\r\n * Retrieve a token by name\r\n */\r\nconst getByName = async (name: string): Promise<SanitizedTransferToken | null> => {\r\n  return getBy({ name });\r\n};\r\n\r\n/**\r\n * Check if token exists\r\n */\r\nconst exists = async (\r\n  whereParams = {} as {\r\n    id?: string | number;\r\n    name?: string;\r\n    lastUsedAt?: number;\r\n    description?: string;\r\n    accessKey?: string;\r\n  }\r\n): Promise<boolean> => {\r\n  const transferToken = await getBy(whereParams);\r\n\r\n  return !!transferToken;\r\n};\r\n\r\nconst regenerate = async (id: string | number): Promise<TransferToken> => {\r\n  const accessKey = crypto.randomBytes(128).toString('hex');\r\n  const transferToken = (await strapi.db.transaction(async () =>\r\n    strapi.db.query(TRANSFER_TOKEN_UID).update({\r\n      select: ['id', 'accessKey'],\r\n      where: { id },\r\n      data: {\r\n        accessKey: hash(accessKey),\r\n      },\r\n    })\r\n  )) as Promise<TransferToken>;\r\n\r\n  if (!transferToken) {\r\n    throw new NotFoundError('The provided token id does not exist');\r\n  }\r\n\r\n  return {\r\n    ...transferToken,\r\n    accessKey,\r\n  };\r\n};\r\n\r\nconst getExpirationFields = (lifespan: TransferToken['lifespan']) => {\r\n  // it must be nil or a finite number >= 0\r\n  const isValidNumber = isNumber(lifespan) && Number.isFinite(lifespan) && lifespan > 0;\r\n  if (!isValidNumber && !isNil(lifespan)) {\r\n    throw new ValidationError('lifespan must be a positive number or null');\r\n  }\r\n\r\n  return {\r\n    lifespan: lifespan || null,\r\n    expiresAt: lifespan ? Date.now() + lifespan : null,\r\n  };\r\n};\r\n\r\n/**\r\n * Return a secure sha512 hash of an accessKey\r\n */\r\nconst hash = (accessKey: string): string => {\r\n  const { hasValidTokenSalt } = getService('transfer').utils;\r\n\r\n  if (!hasValidTokenSalt()) {\r\n    throw new TypeError('Required token salt is not defined');\r\n  }\r\n\r\n  return crypto\r\n    .createHmac('sha512', strapi.config.get('admin.transfer.token.salt'))\r\n    .update(accessKey)\r\n    .digest('hex');\r\n};\r\n\r\nconst checkSaltIsDefined = () => {\r\n  const { hasValidTokenSalt } = getService('transfer').utils;\r\n\r\n  // Ignore the check if the data-transfer feature is manually disabled\r\n  if (!strapi.config.get('server.transfer.remote.enabled')) {\r\n    return;\r\n  }\r\n\r\n  if (!hasValidTokenSalt()) {\r\n    process.emitWarning(\r\n      `Missing transfer.token.salt: Data transfer features have been disabled.\r\nPlease set transfer.token.salt in config/admin.js (ex: you can generate one using Node with \\`crypto.randomBytes(16).toString('base64')\\`)\r\nFor security reasons, prefer storing the secret in an environment variable and read it in config/admin.js. See https://docs.strapi.io/developer-docs/latest/setup-deployment-guides/configurations/optional/environment.html#configuration-using-environment-variables.`\r\n    );\r\n  }\r\n};\r\n\r\n/**\r\n * Flatten a token's database permissions objects to an array of strings\r\n */\r\nconst flattenTokenPermissions = (token: DatabaseTransferToken): TransferToken => {\r\n  if (!token) {\r\n    return token;\r\n  }\r\n\r\n  return {\r\n    ...token,\r\n    permissions: isArray(token.permissions)\r\n      ? map('action', token.permissions as TransferTokenPermission[])\r\n      : token.permissions,\r\n  };\r\n};\r\n\r\n/**\r\n * Assert that a token's permissions are valid\r\n */\r\nconst assertTokenPermissionsValidity = (attributes: TokenUpdatePayload) => {\r\n  const permissionService = strapi.service('admin::transfer').permission;\r\n  const validPermissions = permissionService.providers.action.keys();\r\n  const invalidPermissions = difference(attributes.permissions, validPermissions);\r\n\r\n  if (!isEmpty(invalidPermissions)) {\r\n    throw new ValidationError(`Unknown permissions provided: ${invalidPermissions.join(', ')}`);\r\n  }\r\n};\r\n\r\n/**\r\n * Check if a token's lifespan is valid\r\n */\r\nconst isValidLifespan = (lifespan: unknown) => {\r\n  if (isNil(lifespan)) {\r\n    return true;\r\n  }\r\n\r\n  if (\r\n    !isNumber(lifespan) ||\r\n    !Object.values(constants.TRANSFER_TOKEN_LIFESPANS).includes(lifespan)\r\n  ) {\r\n    return false;\r\n  }\r\n\r\n  return true;\r\n};\r\n\r\n/**\r\n * Assert that a token's lifespan is valid\r\n */\r\nconst assertValidLifespan = (lifespan: unknown) => {\r\n  if (!isValidLifespan(lifespan)) {\r\n    throw new ValidationError(\r\n      `lifespan must be one of the following values:\r\n      ${Object.values(constants.TRANSFER_TOKEN_LIFESPANS).join(', ')}`\r\n    );\r\n  }\r\n};\r\n\r\nexport {\r\n  create,\r\n  list,\r\n  exists,\r\n  getBy,\r\n  getById,\r\n  getByName,\r\n  update,\r\n  revoke,\r\n  regenerate,\r\n  hash,\r\n  checkSaltIsDefined,\r\n};\r\n","import { env } from '@strapi/utils';\r\nimport { getService } from '../../utils';\r\n\r\n/**\r\n * A valid transfer token salt must be a non-empty string defined in the Strapi config\r\n */\r\nconst hasValidTokenSalt = (): boolean => {\r\n  const salt = strapi.config.get('admin.transfer.token.salt', null) as string | null;\r\n\r\n  return typeof salt === 'string' && salt.length > 0;\r\n};\r\n\r\n/**\r\n * Checks whether data transfer features are enabled\r\n */\r\nconst isRemoteTransferEnabled = (): boolean => {\r\n  const { utils } = getService('transfer');\r\n\r\n  // TODO v6: Remove this warning\r\n  if (env.bool('STRAPI_DISABLE_REMOTE_DATA_TRANSFER') !== undefined) {\r\n    strapi.log.warn(\r\n      'STRAPI_DISABLE_REMOTE_DATA_TRANSFER is no longer supported. Instead, set transfer.remote.enabled to false in your server configuration'\r\n    );\r\n  }\r\n\r\n  return utils.hasValidTokenSalt() && strapi.config.get('server.transfer.remote.enabled');\r\n};\r\n\r\nexport { isRemoteTransferEnabled, hasValidTokenSalt };\r\n","import fs from 'fs';\r\nimport { pick } from 'lodash';\r\nimport { GetProjectSettings, UpdateProjectSettings } from '../../../shared/contracts/admin';\r\n\r\nconst PROJECT_SETTINGS_FILE_INPUTS = ['menuLogo', 'authLogo'] as const;\r\n\r\ninterface UploadFile {\r\n  name: string;\r\n  path: string;\r\n  type: string;\r\n  size: number;\r\n  stream: fs.ReadStream;\r\n  tmpPath: string;\r\n  hash: string;\r\n  url: string;\r\n  width: number;\r\n  height: number;\r\n  ext: string;\r\n  provider: unknown;\r\n}\r\n\r\ntype FormattedFiles = Partial<\r\n  Record<keyof UpdateProjectSettings.Request['files'], Partial<UploadFile>>\r\n>;\r\n\r\nconst parseFilesData = async (files: UpdateProjectSettings.Request['files']) => {\r\n  const formatedFilesData: FormattedFiles = {};\r\n\r\n  await Promise.all(\r\n    PROJECT_SETTINGS_FILE_INPUTS.map(async (inputName) => {\r\n      const file = files[inputName];\r\n\r\n      // Skip empty file inputs\r\n      if (!file) {\r\n        return;\r\n      }\r\n\r\n      const getStream = () => fs.createReadStream(file.filepath);\r\n\r\n      // Add formated data for the upload provider\r\n      formatedFilesData[inputName] = await strapi\r\n        .plugin('upload')\r\n        .service('upload')\r\n        .formatFileInfo({\r\n          filename: file.originalFilename,\r\n          type: file.mimetype,\r\n          size: file.size,\r\n        });\r\n\r\n      // Add image dimensions\r\n      Object.assign(\r\n        formatedFilesData[inputName]!,\r\n        await strapi.plugin('upload').service('image-manipulation').getDimensions({ getStream })\r\n      );\r\n\r\n      // Add file path, and stream\r\n      Object.assign(formatedFilesData[inputName]!, {\r\n        stream: getStream(),\r\n        tmpPath: file.filepath,\r\n        // TODO\r\n        // @ts-expect-error define the correct return type\r\n        provider: strapi.config.get('plugin::upload').provider,\r\n      });\r\n    })\r\n  );\r\n\r\n  return formatedFilesData;\r\n};\r\n\r\nconst getProjectSettings = async (): Promise<GetProjectSettings.Response> => {\r\n  const store = strapi.store({ type: 'core', name: 'admin' });\r\n\r\n  // Returns an object with file inputs names as key and null as value\r\n  const defaultProjectSettings = PROJECT_SETTINGS_FILE_INPUTS.reduce((prev: any, cur: any) => {\r\n    prev[cur] = null;\r\n    return prev;\r\n  }, {});\r\n\r\n  const projectSettings = {\r\n    ...defaultProjectSettings,\r\n    // @ts-expect-error spread can be applied to return value\r\n    ...(await store.get({ key: 'project-settings' })),\r\n  };\r\n\r\n  // Filter file input fields\r\n  PROJECT_SETTINGS_FILE_INPUTS.forEach((inputName) => {\r\n    if (!projectSettings[inputName]) {\r\n      return;\r\n    }\r\n\r\n    projectSettings[inputName] = pick(projectSettings[inputName], [\r\n      'name',\r\n      'url',\r\n      'width',\r\n      'height',\r\n      'ext',\r\n      'size',\r\n    ]);\r\n  });\r\n\r\n  return projectSettings;\r\n};\r\n\r\nconst uploadFiles = async (files: LogoFiles = {}) => {\r\n  // Call the provider upload function for each file\r\n  return Promise.all(\r\n    Object.values(files)\r\n      .filter((file) => file?.stream instanceof fs.ReadStream)\r\n      .map((file) => strapi.plugin('upload').provider.uploadStream(file))\r\n  );\r\n};\r\n\r\nconst deleteOldFiles = async ({ previousSettings, newSettings }: any) => {\r\n  return Promise.all(\r\n    PROJECT_SETTINGS_FILE_INPUTS.map(async (inputName) => {\r\n      // Skip if the store doesn't contain project settings\r\n      if (!previousSettings) {\r\n        return;\r\n      }\r\n\r\n      // Skip if there was no previous file\r\n      if (!previousSettings[inputName]) {\r\n        return;\r\n      }\r\n\r\n      // Skip if the file was not changed\r\n      if (\r\n        newSettings[inputName] &&\r\n        previousSettings[inputName].hash === newSettings[inputName].hash\r\n      ) {\r\n        return;\r\n      }\r\n\r\n      // Skip if the file was not uploaded with the current provider\r\n      // TODO\r\n      // @ts-expect-error define the correct return type\r\n      if (strapi.config.get('plugin::upload').provider !== previousSettings[inputName].provider) {\r\n        return;\r\n      }\r\n\r\n      // There was a previous file and an new file was uploaded\r\n      // Remove the previous file\r\n      strapi.plugin('upload').provider.delete(previousSettings[inputName]);\r\n    })\r\n  );\r\n};\r\n\r\ntype LogoFiles = { [K in keyof FormattedFiles]: FormattedFiles[K] | null };\r\n\r\nconst updateProjectSettings = async (\r\n  newSettings: Omit<UpdateProjectSettings.Request['body'], 'menuLogo' | 'authLogo'> & LogoFiles\r\n) => {\r\n  const store = strapi.store({ type: 'core', name: 'admin' });\r\n  const previousSettings = (await store.get({ key: 'project-settings' })) as any;\r\n  const files = pick(newSettings, PROJECT_SETTINGS_FILE_INPUTS);\r\n\r\n  await uploadFiles(files);\r\n\r\n  PROJECT_SETTINGS_FILE_INPUTS.forEach((inputName) => {\r\n    // If the user input exists but is not a formdata \"file\" remove it\r\n    if (newSettings[inputName] !== undefined && !(typeof newSettings[inputName] === 'object')) {\r\n      newSettings[inputName] = null;\r\n      return;\r\n    }\r\n\r\n    // If the user input is undefined reuse previous setting (do not update field)\r\n    if (!newSettings[inputName] && previousSettings) {\r\n      newSettings[inputName] = previousSettings[inputName];\r\n      return;\r\n    }\r\n\r\n    // Update the file\r\n    newSettings[inputName] = pick(newSettings[inputName], [\r\n      'name',\r\n      'hash',\r\n      'url',\r\n      'width',\r\n      'height',\r\n      'ext',\r\n      'size',\r\n      'provider',\r\n    ]);\r\n  });\r\n\r\n  // No await to proceed asynchronously\r\n  deleteOldFiles({ previousSettings, newSettings });\r\n\r\n  await store.set({\r\n    key: 'project-settings',\r\n    value: { ...previousSettings, ...newSettings },\r\n  });\r\n\r\n  return getProjectSettings();\r\n};\r\n\r\nexport { deleteOldFiles, parseFilesData, getProjectSettings, updateProjectSettings };\r\n","// NOTE: Make sure to use default export for services overwritten in EE\r\nimport auth from './auth';\r\nimport user from './user';\r\nimport role from './role';\r\nimport passport from './passport';\r\nimport metrics from './metrics';\r\nimport * as token from './token';\r\nimport * as permission from './permission';\r\nimport * as contentType from './content-type';\r\nimport * as constants from './constants';\r\nimport * as condition from './condition';\r\nimport * as action from './action';\r\nimport * as apiToken from './api-token';\r\nimport * as transfer from './transfer';\r\nimport * as projectSettings from './project-settings';\r\n\r\n// TODO: TS - Export services one by one as this export is cjs\r\nexport default {\r\n  auth,\r\n  user,\r\n  role,\r\n  passport,\r\n  token,\r\n  permission,\r\n  metrics,\r\n  'content-type': contentType,\r\n  constants,\r\n  condition,\r\n  action,\r\n  'api-token': apiToken,\r\n  transfer,\r\n  'project-settings': projectSettings,\r\n};\r\n","import { z } from 'zod';\r\nimport { validateZod } from '@strapi/utils';\r\n\r\nconst MAX_IMAGE_WIDTH = 750;\r\nconst MAX_IMAGE_HEIGHT = MAX_IMAGE_WIDTH;\r\nconst MAX_IMAGE_FILE_SIZE = 1024 * 1024; // 1Mo\r\n\r\nconst updateProjectSettings = z\r\n  .object({\r\n    menuLogo: z.string().nullish(),\r\n    authLogo: z.string().nullish(),\r\n  })\r\n  .strict();\r\n\r\nconst updateProjectSettingsLogo = z.object({\r\n  originalFilename: z.string().nullish(),\r\n  mimetype: z.enum(['image/jpeg', 'image/png', 'image/svg+xml']),\r\n  size: z.number().max(MAX_IMAGE_FILE_SIZE).nullish(),\r\n});\r\n\r\nconst updateProjectSettingsFiles = z\r\n  .object({\r\n    menuLogo: updateProjectSettingsLogo.nullish(),\r\n    authLogo: updateProjectSettingsLogo.nullish(),\r\n  })\r\n  .strict();\r\n\r\nconst logoDimensions = z.object({\r\n  width: z.number().max(MAX_IMAGE_WIDTH).nullish(),\r\n  height: z.number().max(MAX_IMAGE_HEIGHT).nullish(),\r\n});\r\n\r\nconst updateProjectSettingsImagesDimensions = z\r\n  .object({\r\n    menuLogo: logoDimensions.nullish(),\r\n    authLogo: logoDimensions.nullish(),\r\n  })\r\n  .strict();\r\n\r\nexport const validateUpdateProjectSettings = validateZod(updateProjectSettings);\r\nexport const validateUpdateProjectSettingsFiles = validateZod(updateProjectSettingsFiles);\r\nexport const validateUpdateProjectSettingsImagesDimensions = validateZod(\r\n  updateProjectSettingsImagesDimensions\r\n);\r\n\r\nexport default {\r\n  validateUpdateProjectSettings,\r\n  validateUpdateProjectSettingsFiles,\r\n  validateUpdateProjectSettingsImagesDimensions,\r\n};\r\n","import type { Context } from 'koa';\r\n\r\nimport path from 'path';\r\n\r\nimport { map, values, sumBy, pipe, flatMap, propEq } from 'lodash/fp';\r\nimport _ from 'lodash';\r\nimport { exists } from 'fs-extra';\r\nimport '@strapi/types';\r\nimport { env } from '@strapi/utils';\r\nimport tsUtils from '@strapi/typescript-utils';\r\nimport {\r\n  validateUpdateProjectSettings,\r\n  validateUpdateProjectSettingsFiles,\r\n  validateUpdateProjectSettingsImagesDimensions,\r\n} from '../validation/project-settings';\r\nimport { getService } from '../utils';\r\n\r\nimport type {\r\n  Init,\r\n  GetProjectSettings,\r\n  Information,\r\n  Plugins,\r\n  TelemetryProperties,\r\n  UpdateProjectSettings,\r\n} from '../../../shared/contracts/admin';\r\n\r\nconst { isUsingTypeScript } = tsUtils;\r\n\r\n/**\r\n * A set of functions called \"actions\" for `Admin`\r\n */\r\nexport default {\r\n  // TODO very temporary to check the switch ee/ce\r\n  // When removing this we need to update the /admin/src/index.js file\r\n  // whe,re we set the strapi.window.isEE value\r\n\r\n  // NOTE: admin/ee/server overrides this controller, and adds the EE features\r\n  // This returns an empty feature list for CE\r\n  async getProjectType() {\r\n    const flags = strapi.config.get('admin.flags', {});\r\n    return { data: { isEE: false, features: [], flags } };\r\n  },\r\n\r\n  async init() {\r\n    let uuid = strapi.config.get('uuid', false);\r\n    const hasAdmin = await getService('user').exists();\r\n    const { menuLogo, authLogo } = await getService('project-settings').getProjectSettings();\r\n    // set to null if telemetryDisabled flag not avaialble in package.json\r\n    const telemetryDisabled: boolean | null = strapi.config.get(\r\n      'packageJsonStrapi.telemetryDisabled',\r\n      null\r\n    );\r\n\r\n    if (telemetryDisabled !== null && telemetryDisabled === true) {\r\n      uuid = false;\r\n    }\r\n\r\n    return {\r\n      data: {\r\n        uuid,\r\n        hasAdmin,\r\n        menuLogo: menuLogo ? menuLogo.url : null,\r\n        authLogo: authLogo ? authLogo.url : null,\r\n      },\r\n    } satisfies Init.Response;\r\n  },\r\n\r\n  async getProjectSettings() {\r\n    return getService(\r\n      'project-settings'\r\n    ).getProjectSettings() satisfies Promise<GetProjectSettings.Response>;\r\n  },\r\n\r\n  async updateProjectSettings(ctx: Context) {\r\n    const {\r\n      request: { files, body },\r\n    } = ctx as { request: UpdateProjectSettings.Request };\r\n\r\n    const projectSettingsService = getService('project-settings');\r\n\r\n    await validateUpdateProjectSettings(body);\r\n    await validateUpdateProjectSettingsFiles(files);\r\n\r\n    const formatedFiles = await projectSettingsService.parseFilesData(files);\r\n    await validateUpdateProjectSettingsImagesDimensions(formatedFiles);\r\n\r\n    return projectSettingsService.updateProjectSettings({\r\n      ...body,\r\n      ...formatedFiles,\r\n    }) satisfies Promise<UpdateProjectSettings.Response>;\r\n  },\r\n\r\n  async telemetryProperties(ctx: Context) {\r\n    // If the telemetry is disabled, ignore the request and return early\r\n    if (strapi.telemetry.isDisabled) {\r\n      ctx.status = 204;\r\n      return;\r\n    }\r\n\r\n    const useTypescriptOnServer = await isUsingTypeScript(strapi.dirs.app.root);\r\n    const useTypescriptOnAdmin = await isUsingTypeScript(\r\n      path.join(strapi.dirs.app.root, 'src', 'admin')\r\n    );\r\n    const isHostedOnStrapiCloud = env('STRAPI_HOSTING', null) === 'strapi.cloud';\r\n\r\n    const numberOfAllContentTypes = _.size(strapi.contentTypes);\r\n    const numberOfComponents = _.size(strapi.components);\r\n\r\n    const getNumberOfDynamicZones = () => {\r\n      return pipe(\r\n        map('attributes'),\r\n        flatMap(values),\r\n        // @ts-expect-error lodash types\r\n        sumBy(propEq('type', 'dynamiczone'))\r\n      )(strapi.contentTypes as any);\r\n    };\r\n\r\n    return {\r\n      data: {\r\n        useTypescriptOnServer,\r\n        useTypescriptOnAdmin,\r\n        isHostedOnStrapiCloud,\r\n        numberOfAllContentTypes, // TODO: V5: This event should be renamed numberOfContentTypes in V5 as the name is already taken to describe the number of content types using i18n.\r\n        numberOfComponents,\r\n        numberOfDynamicZones: getNumberOfDynamicZones(),\r\n      },\r\n    } satisfies TelemetryProperties.Response;\r\n  },\r\n\r\n  async information() {\r\n    const currentEnvironment: string = strapi.config.get('environment');\r\n    const autoReload = strapi.config.get('autoReload', false);\r\n    const strapiVersion = strapi.config.get('info.strapi', null);\r\n    const dependencies = strapi.config.get('info.dependencies', {});\r\n    const projectId = strapi.config.get('uuid', null);\r\n    const nodeVersion = process.version;\r\n    const communityEdition = !strapi.EE;\r\n    const useYarn: boolean = await exists(path.join(process.cwd(), 'yarn.lock'));\r\n\r\n    return {\r\n      data: {\r\n        currentEnvironment,\r\n        autoReload,\r\n        strapiVersion,\r\n        dependencies,\r\n        projectId,\r\n        nodeVersion,\r\n        communityEdition,\r\n        useYarn,\r\n      },\r\n    } satisfies Information.Response;\r\n  },\r\n\r\n  async plugins(ctx: Context) {\r\n    const enabledPlugins = strapi.config.get('enabledPlugins') as any;\r\n\r\n    // List of core plugins that are always enabled,\r\n    // and so it's not necessary to display them in the plugins list\r\n    const CORE_PLUGINS = [\r\n      'content-manager',\r\n      'content-type-builder',\r\n      'email',\r\n      'upload',\r\n      'i18n',\r\n      'content-releases',\r\n      'review-workflows',\r\n    ];\r\n\r\n    const plugins = Object.entries(enabledPlugins)\r\n      .filter(([key]: any) => !CORE_PLUGINS.includes(key))\r\n      .map(([key, plugin]: any) => ({\r\n        name: plugin.info.name || key,\r\n        displayName: plugin.info.displayName || plugin.info.name || key,\r\n        description: plugin.info.description || '',\r\n        packageName: plugin.info.packageName,\r\n      }));\r\n\r\n    ctx.send({ plugins }) satisfies Plugins.Response;\r\n  },\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\nimport constants from '../services/constants';\r\n\r\nconst apiTokenCreationSchema = yup\r\n  .object()\r\n  .shape({\r\n    name: yup.string().min(1).required(),\r\n    description: yup.string().optional(),\r\n    type: yup.string().oneOf(Object.values(constants.API_TOKEN_TYPE)).required(),\r\n    permissions: yup.array().of(yup.string()).nullable(),\r\n    lifespan: yup.number().min(1).oneOf(Object.values(constants.API_TOKEN_LIFESPANS)).nullable(),\r\n  })\r\n  .noUnknown()\r\n  .strict();\r\n\r\nconst apiTokenUpdateSchema = yup\r\n  .object()\r\n  .shape({\r\n    name: yup.string().min(1).notNull(),\r\n    description: yup.string().nullable(),\r\n    type: yup.string().oneOf(Object.values(constants.API_TOKEN_TYPE)).notNull(),\r\n    permissions: yup.array().of(yup.string()).nullable(),\r\n  })\r\n  .noUnknown()\r\n  .strict();\r\n\r\nexport const validateApiTokenCreationInput = validateYupSchema(apiTokenCreationSchema);\r\nexport const validateApiTokenUpdateInput = validateYupSchema(apiTokenUpdateSchema);\r\n\r\nexport default {\r\n  validateApiTokenCreationInput,\r\n  validateApiTokenUpdateInput,\r\n};\r\n","import type { Context } from 'koa';\r\n\r\nimport { strings, errors } from '@strapi/utils';\r\nimport { trim, has } from 'lodash/fp';\r\nimport { getService } from '../utils';\r\nimport {\r\n  validateApiTokenCreationInput,\r\n  validateApiTokenUpdateInput,\r\n} from '../validation/api-tokens';\r\n\r\nimport { Create, List, Revoke, Get, Update } from '../../../shared/contracts/api-token';\r\n\r\nconst { ApplicationError } = errors;\r\n\r\nexport default {\r\n  async create(ctx: Context) {\r\n    const { body } = ctx.request as Create.Request;\r\n    const apiTokenService = getService('api-token');\r\n\r\n    /**\r\n     * We trim both field to avoid having issues with either:\r\n     * - having a space at the end or start of the value.\r\n     * - having only spaces as value;\r\n     */\r\n    const attributes = {\r\n      name: trim(body.name),\r\n      description: trim(body.description),\r\n      type: body.type,\r\n      permissions: body.permissions,\r\n      lifespan: body.lifespan,\r\n    };\r\n\r\n    await validateApiTokenCreationInput(attributes);\r\n\r\n    const alreadyExists = await apiTokenService.exists({ name: attributes.name });\r\n    if (alreadyExists) {\r\n      throw new ApplicationError('Name already taken');\r\n    }\r\n\r\n    const apiToken = await apiTokenService.create(attributes);\r\n    ctx.created({ data: apiToken } satisfies Create.Response);\r\n  },\r\n\r\n  async regenerate(ctx: Context) {\r\n    const { id } = ctx.params;\r\n    const apiTokenService = getService('api-token');\r\n\r\n    const apiTokenExists = await apiTokenService.getById(id);\r\n    if (!apiTokenExists) {\r\n      ctx.notFound('API Token not found');\r\n      return;\r\n    }\r\n\r\n    const accessToken = await apiTokenService.regenerate(id);\r\n\r\n    ctx.created({ data: accessToken });\r\n  },\r\n\r\n  async list(ctx: Context) {\r\n    const apiTokenService = getService('api-token');\r\n    const apiTokens = await apiTokenService.list();\r\n\r\n    ctx.send({ data: apiTokens } satisfies List.Response);\r\n  },\r\n\r\n  async revoke(ctx: Context) {\r\n    const { id } = ctx.params as Revoke.Params;\r\n    const apiTokenService = getService('api-token');\r\n    const apiToken = await apiTokenService.revoke(id);\r\n\r\n    ctx.deleted({ data: apiToken } satisfies Revoke.Response);\r\n  },\r\n\r\n  async get(ctx: Context) {\r\n    const { id } = ctx.params;\r\n    const apiTokenService = getService('api-token');\r\n    const apiToken = await apiTokenService.getById(id);\r\n\r\n    if (!apiToken) {\r\n      ctx.notFound('API Token not found');\r\n      return;\r\n    }\r\n\r\n    ctx.send({ data: apiToken } satisfies Get.Response);\r\n  },\r\n\r\n  async update(ctx: Context) {\r\n    const { body } = ctx.request as Update.Request;\r\n    const { id } = ctx.params as Update.Params;\r\n    const apiTokenService = getService('api-token');\r\n\r\n    const attributes = body;\r\n    /**\r\n     * We trim both field to avoid having issues with either:\r\n     * - having a space at the end or start of the value.\r\n     * - having only spaces as value;\r\n     */\r\n    if (has('name', attributes)) {\r\n      attributes.name = trim(body.name);\r\n    }\r\n\r\n    if (has('description', attributes) || attributes.description === null) {\r\n      attributes.description = trim(body.description);\r\n    }\r\n\r\n    await validateApiTokenUpdateInput(attributes);\r\n\r\n    const apiTokenExists = await apiTokenService.getById(id);\r\n    if (!apiTokenExists) {\r\n      return ctx.notFound('API Token not found');\r\n    }\r\n\r\n    if (has('name', attributes)) {\r\n      const nameAlreadyTaken = await apiTokenService.getByName(attributes.name);\r\n\r\n      /**\r\n       * We cast the ids as string as the one coming from the ctx isn't cast\r\n       * as a Number in case it is supposed to be an integer. It remains\r\n       * as a string. This way we avoid issues with integers in the db.\r\n       */\r\n      if (!!nameAlreadyTaken && !strings.isEqual(nameAlreadyTaken.id, id)) {\r\n        throw new ApplicationError('Name already taken');\r\n      }\r\n    }\r\n\r\n    const apiToken = await apiTokenService.update(id, attributes);\r\n    ctx.send({ data: apiToken } satisfies Update.Response);\r\n  },\r\n\r\n  async getLayout(ctx: Context) {\r\n    const apiTokenService = getService('api-token');\r\n    // TODO\r\n    // @ts-expect-error remove this controller if not used\r\n    const layout = await apiTokenService.getApiTokenLayout();\r\n\r\n    ctx.send({ data: layout });\r\n  },\r\n};\r\n","import { isUndefined } from 'lodash/fp';\r\nimport { yup, validateYupSchema } from '@strapi/utils';\r\nimport validators from './common-validators';\r\n\r\nconst userCreationSchema = yup\r\n  .object()\r\n  .shape({\r\n    email: validators.email.required(),\r\n    firstname: validators.firstname.required(),\r\n    lastname: validators.lastname,\r\n    roles: validators.roles.min(1),\r\n    preferedLanguage: yup.string().nullable(),\r\n  })\r\n  .noUnknown();\r\n\r\nconst profileUpdateSchema = yup\r\n  .object()\r\n  .shape({\r\n    email: validators.email.notNull(),\r\n    firstname: validators.firstname.notNull(),\r\n    lastname: validators.lastname.nullable(),\r\n    username: validators.username.nullable(),\r\n    password: validators.password.notNull(),\r\n    currentPassword: yup\r\n      .string()\r\n      .when('password', (password: string, schema: any) =>\r\n        !isUndefined(password) ? schema.required() : schema\r\n      )\r\n      .notNull(),\r\n    preferedLanguage: yup.string().nullable(),\r\n  })\r\n  .noUnknown();\r\n\r\nconst userUpdateSchema = yup\r\n  .object()\r\n  .shape({\r\n    email: validators.email.notNull(),\r\n    firstname: validators.firstname.notNull(),\r\n    lastname: validators.lastname.nullable(),\r\n    username: validators.username.nullable(),\r\n    password: validators.password.notNull(),\r\n    isActive: yup.bool().notNull(),\r\n    roles: validators.roles.min(1).notNull(),\r\n  })\r\n  .noUnknown();\r\n\r\nconst usersDeleteSchema = yup\r\n  .object()\r\n  .shape({\r\n    ids: yup.array().of(yup.strapiID()).min(1).required(),\r\n  })\r\n  .noUnknown();\r\n\r\nexport const validateUserCreationInput = validateYupSchema(userCreationSchema);\r\nexport const validateProfileUpdateInput = validateYupSchema(profileUpdateSchema);\r\nexport const validateUserUpdateInput = validateYupSchema(userUpdateSchema);\r\nexport const validateUsersDeleteInput = validateYupSchema(usersDeleteSchema);\r\nexport const schemas = {\r\n  userCreationSchema,\r\n  usersDeleteSchema,\r\n  userUpdateSchema,\r\n};\r\n\r\nexport default {\r\n  validateUserCreationInput,\r\n  validateProfileUpdateInput,\r\n  validateUserUpdateInput,\r\n  validateUsersDeleteInput,\r\n  schemas,\r\n};\r\n","import type { Context } from 'koa';\r\nimport type { AdminUser } from '../../../shared/contracts/shared';\r\n\r\nimport { getService } from '../utils';\r\nimport { validateProfileUpdateInput } from '../validation/user';\r\nimport { GetMe, GetOwnPermissions, UpdateMe } from '../../../shared/contracts/users';\r\n\r\nexport default {\r\n  async getMe(ctx: Context) {\r\n    const userInfo = getService('user').sanitizeUser(ctx.state.user as AdminUser);\r\n\r\n    ctx.body = {\r\n      data: userInfo,\r\n    } satisfies GetMe.Response;\r\n  },\r\n\r\n  async updateMe(ctx: Context) {\r\n    const input = ctx.request.body as UpdateMe.Request['body'];\r\n\r\n    await validateProfileUpdateInput(input);\r\n\r\n    const userService = getService('user');\r\n    const authServer = getService('auth');\r\n\r\n    const { currentPassword, ...userInfo } = input;\r\n\r\n    if (currentPassword && userInfo.password) {\r\n      const isValid = await authServer.validatePassword(currentPassword, ctx.state.user.password);\r\n\r\n      if (!isValid) {\r\n        // @ts-expect-error - refactor ctx bad request to take a second argument\r\n        return ctx.badRequest('ValidationError', {\r\n          currentPassword: ['Invalid credentials'],\r\n        });\r\n      }\r\n    }\r\n\r\n    const updatedUser = await userService.updateById(ctx.state.user.id, userInfo);\r\n\r\n    ctx.body = {\r\n      data: userService.sanitizeUser(updatedUser),\r\n    } satisfies UpdateMe.Response;\r\n  },\r\n\r\n  async getOwnPermissions(ctx: Context) {\r\n    const { findUserPermissions, sanitizePermission } = getService('permission');\r\n    const { user } = ctx.state;\r\n\r\n    const userPermissions = await findUserPermissions(user as AdminUser);\r\n\r\n    ctx.body = {\r\n      // @ts-expect-error - transform response type to sanitized permission\r\n      data: userPermissions.map(sanitizePermission),\r\n    } satisfies GetOwnPermissions.Response;\r\n  },\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\nimport validators from '../common-validators';\r\n\r\nconst registrationSchema = yup\r\n  .object()\r\n  .shape({\r\n    registrationToken: yup.string().required(),\r\n    userInfo: yup\r\n      .object()\r\n      .shape({\r\n        firstname: validators.firstname.required(),\r\n        lastname: validators.lastname.nullable(),\r\n        password: validators.password.required(),\r\n      })\r\n      .required()\r\n      .noUnknown(),\r\n  })\r\n  .noUnknown();\r\n\r\nconst registrationInfoQuerySchema = yup\r\n  .object()\r\n  .shape({\r\n    registrationToken: yup.string().required(),\r\n  })\r\n  .required()\r\n  .noUnknown();\r\n\r\nconst adminRegistrationSchema = yup\r\n  .object()\r\n  .shape({\r\n    email: validators.email.required(),\r\n    firstname: validators.firstname.required(),\r\n    lastname: validators.lastname.nullable(),\r\n    password: validators.password.required(),\r\n  })\r\n  .required()\r\n  .noUnknown();\r\n\r\nexport const validateRegistrationInput = validateYupSchema(registrationSchema);\r\nexport const validateRegistrationInfoQuery = validateYupSchema(registrationInfoQuerySchema);\r\nexport const validateAdminRegistrationInput = validateYupSchema(adminRegistrationSchema);\r\n\r\nexport default {\r\n  validateRegistrationInput,\r\n  validateRegistrationInfoQuery,\r\n  validateAdminRegistrationInput,\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\nimport validators from '../common-validators';\r\n\r\nconst forgotPasswordSchema = yup\r\n  .object()\r\n  .shape({\r\n    email: validators.email.required(),\r\n  })\r\n  .required()\r\n  .noUnknown();\r\n\r\nexport default validateYupSchema(forgotPasswordSchema);\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\nimport validators from '../common-validators';\r\n\r\nconst resetPasswordSchema = yup\r\n  .object()\r\n  .shape({\r\n    resetPasswordToken: yup.string().required(),\r\n    password: validators.password.required(),\r\n  })\r\n  .required()\r\n  .noUnknown();\r\n\r\nexport default validateYupSchema(resetPasswordSchema);\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\n\r\nconst renewToken = yup.object().shape({ token: yup.string().required() }).required().noUnknown();\r\n\r\nexport default validateYupSchema(renewToken);\r\n","import type { Context, Next } from 'koa';\r\nimport passport from 'koa-passport';\r\nimport compose from 'koa-compose';\r\nimport '@strapi/types';\r\nimport { errors } from '@strapi/utils';\r\nimport { getService } from '../utils';\r\nimport {\r\n  validateRegistrationInput,\r\n  validateAdminRegistrationInput,\r\n  validateRegistrationInfoQuery,\r\n  validateForgotPasswordInput,\r\n  validateResetPasswordInput,\r\n  validateRenewTokenInput,\r\n} from '../validation/authentication';\r\n\r\nimport type {\r\n  ForgotPassword,\r\n  Login,\r\n  Register,\r\n  RegistrationInfo,\r\n  RenewToken,\r\n  ResetPassword,\r\n} from '../../../shared/contracts/authentication';\r\nimport { AdminUser } from '../../../shared/contracts/shared';\r\n\r\nconst { ApplicationError, ValidationError } = errors;\r\n\r\nexport default {\r\n  login: compose([\r\n    (ctx: Context, next: Next) => {\r\n      return passport.authenticate('local', { session: false }, (err, user, info) => {\r\n        if (err) {\r\n          strapi.eventHub.emit('admin.auth.error', { error: err, provider: 'local' });\r\n          // if this is a recognized error, allow it to bubble up to user\r\n          if (err.details?.code === 'LOGIN_NOT_ALLOWED') {\r\n            throw err;\r\n          }\r\n\r\n          // for all other errors throw a generic error to prevent leaking info\r\n          return ctx.notImplemented();\r\n        }\r\n\r\n        if (!user) {\r\n          strapi.eventHub.emit('admin.auth.error', {\r\n            error: new Error(info.message),\r\n            provider: 'local',\r\n          });\r\n          throw new ApplicationError(info.message);\r\n        }\r\n\r\n        const query = ctx.state as Login.Request['query'];\r\n        query.user = user;\r\n\r\n        const sanitizedUser = getService('user').sanitizeUser(user);\r\n        strapi.eventHub.emit('admin.auth.success', { user: sanitizedUser, provider: 'local' });\r\n\r\n        return next();\r\n      })(ctx, next);\r\n    },\r\n    (ctx: Context) => {\r\n      const { user } = ctx.state as { user: AdminUser };\r\n\r\n      ctx.body = {\r\n        data: {\r\n          token: getService('token').createJwtToken(user),\r\n          user: getService('user').sanitizeUser(ctx.state.user), // TODO: fetch more detailed info\r\n        },\r\n      } satisfies Login.Response;\r\n    },\r\n  ]),\r\n\r\n  async renewToken(ctx: Context) {\r\n    await validateRenewTokenInput(ctx.request.body);\r\n\r\n    const { token } = ctx.request.body as RenewToken.Request['body'];\r\n\r\n    const { isValid, payload } = getService('token').decodeJwtToken(token);\r\n\r\n    if (!isValid) {\r\n      throw new ValidationError('Invalid token');\r\n    }\r\n\r\n    ctx.body = {\r\n      data: {\r\n        token: getService('token').createJwtToken({ id: payload.id }),\r\n      },\r\n    } satisfies RenewToken.Response;\r\n  },\r\n\r\n  async registrationInfo(ctx: Context) {\r\n    await validateRegistrationInfoQuery(ctx.request.query);\r\n\r\n    const { registrationToken } = ctx.request.query as RegistrationInfo.Request['query'];\r\n\r\n    const registrationInfo = await getService('user').findRegistrationInfo(registrationToken);\r\n\r\n    if (!registrationInfo) {\r\n      throw new ValidationError('Invalid registrationToken');\r\n    }\r\n\r\n    ctx.body = { data: registrationInfo } satisfies RegistrationInfo.Response;\r\n  },\r\n\r\n  async register(ctx: Context) {\r\n    const input = ctx.request.body as Register.Request['body'];\r\n\r\n    await validateRegistrationInput(input);\r\n\r\n    const user = await getService('user').register(input);\r\n\r\n    ctx.body = {\r\n      data: {\r\n        token: getService('token').createJwtToken(user),\r\n        user: getService('user').sanitizeUser(user),\r\n      },\r\n    } satisfies Register.Response;\r\n  },\r\n\r\n  async registerAdmin(ctx: Context) {\r\n    const input = ctx.request.body as Register.Request['body'];\r\n\r\n    await validateAdminRegistrationInput(input);\r\n\r\n    const hasAdmin = await getService('user').exists();\r\n\r\n    if (hasAdmin) {\r\n      throw new ApplicationError('You cannot register a new super admin');\r\n    }\r\n\r\n    const superAdminRole = await getService('role').getSuperAdmin();\r\n\r\n    if (!superAdminRole) {\r\n      throw new ApplicationError(\r\n        \"Cannot register the first admin because the super admin role doesn't exist.\"\r\n      );\r\n    }\r\n\r\n    const user = await getService('user').create({\r\n      ...input,\r\n      registrationToken: null,\r\n      isActive: true,\r\n      roles: superAdminRole ? [superAdminRole.id] : [],\r\n    });\r\n\r\n    strapi.telemetry.send('didCreateFirstAdmin');\r\n\r\n    ctx.body = {\r\n      data: {\r\n        token: getService('token').createJwtToken(user),\r\n        user: getService('user').sanitizeUser(user),\r\n      },\r\n    };\r\n  },\r\n\r\n  async forgotPassword(ctx: Context) {\r\n    const input = ctx.request.body as ForgotPassword.Request['body'];\r\n\r\n    await validateForgotPasswordInput(input);\r\n\r\n    getService('auth').forgotPassword(input);\r\n\r\n    ctx.status = 204;\r\n  },\r\n\r\n  async resetPassword(ctx: Context) {\r\n    const input = ctx.request.body as ResetPassword.Request['body'];\r\n\r\n    await validateResetPasswordInput(input);\r\n\r\n    const user = await getService('auth').resetPassword(input);\r\n\r\n    ctx.body = {\r\n      data: {\r\n        token: getService('token').createJwtToken(user),\r\n        user: getService('user').sanitizeUser(user),\r\n      },\r\n    } satisfies ResetPassword.Response;\r\n  },\r\n\r\n  logout(ctx: Context) {\r\n    const sanitizedUser = getService('user').sanitizeUser(ctx.state.user);\r\n    strapi.eventHub.emit('admin.logout', { user: sanitizedUser });\r\n    ctx.body = { data: {} };\r\n  },\r\n};\r\n","import { pick, map } from 'lodash/fp';\r\n\r\n// visible fields for the API\r\nconst publicFields = ['id', 'displayName', 'category'];\r\n\r\nconst formatConditions = map(pick(publicFields));\r\n\r\nexport { formatConditions };\r\n","import type { Context } from 'koa';\r\nimport { validateCheckPermissionsInput } from '../validation/permission';\r\nimport { getService } from '../utils';\r\nimport { formatConditions } from './formatters';\r\nimport type { Action } from '../domain/action';\r\nimport type { GetAll, Check } from '../../../shared/contracts/permissions';\r\nimport { Condition } from '../domain/condition';\r\nimport { Permission } from '../../../shared/contracts/shared';\r\n\r\nexport default {\r\n  /**\r\n   * Check each permissions from `request.body.permissions` and returns an array of booleans\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async check(ctx: Context) {\r\n    const { body: input } = ctx.request as Check.Request;\r\n    const { userAbility } = ctx.state;\r\n\r\n    await validateCheckPermissionsInput(input);\r\n\r\n    const { engine } = getService('permission');\r\n\r\n    const checkPermissionsFn = engine.checkMany(userAbility);\r\n\r\n    ctx.body = {\r\n      data: checkPermissionsFn(input.permissions as Permission[]),\r\n    } satisfies Check.Response;\r\n  },\r\n\r\n  /**\r\n   * Returns every permissions, in nested format\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async getAll(ctx: Context) {\r\n    const { sectionsBuilder, actionProvider, conditionProvider } = getService('permission');\r\n\r\n    const actions = actionProvider.values() as Action[];\r\n    const conditions = conditionProvider.values() as Condition[];\r\n    const sections = await sectionsBuilder.build(actions);\r\n\r\n    ctx.body = {\r\n      data: {\r\n        // @ts-expect-error - refactor to use a proper type\r\n        conditions: formatConditions(conditions),\r\n        sections,\r\n      },\r\n    } satisfies GetAll.Response;\r\n  },\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\n\r\nconst roleCreateSchema = yup\r\n  .object()\r\n  .shape({\r\n    name: yup.string().min(1).required(),\r\n    description: yup.string().nullable(),\r\n  })\r\n  .noUnknown();\r\n\r\nconst rolesDeleteSchema = yup\r\n  .object()\r\n  .shape({\r\n    ids: yup\r\n      .array()\r\n      .of(yup.strapiID())\r\n      .min(1)\r\n      .required()\r\n      .test('roles-deletion-checks', 'Roles deletion checks have failed', async function (ids) {\r\n        try {\r\n          await strapi.service('admin::role').checkRolesIdForDeletion(ids);\r\n        } catch (e) {\r\n          // @ts-expect-error yup types\r\n          return this.createError({ path: 'ids', message: e.message });\r\n        }\r\n\r\n        return true;\r\n      }),\r\n  })\r\n  .noUnknown();\r\n\r\nconst roleDeleteSchema = yup\r\n  .strapiID()\r\n  .required()\r\n  .test('no-admin-single-delete', 'Role deletion checks have failed', async function (id) {\r\n    try {\r\n      await strapi.service('admin::role').checkRolesIdForDeletion([id]);\r\n    } catch (e) {\r\n      // @ts-expect-error yup types\r\n      return this.createError({ path: 'id', message: e.message });\r\n    }\r\n\r\n    return true;\r\n  });\r\n\r\nconst roleUpdateSchema = yup\r\n  .object()\r\n  .shape({\r\n    name: yup.string().min(1),\r\n    description: yup.string().nullable(),\r\n  })\r\n  .noUnknown();\r\n\r\nexport const validateRoleCreateInput = validateYupSchema(roleCreateSchema);\r\nexport const validateRoleUpdateInput = validateYupSchema(roleUpdateSchema);\r\nexport const validateRolesDeleteInput = validateYupSchema(rolesDeleteSchema);\r\nexport const validateRoleDeleteInput = validateYupSchema(roleDeleteSchema);\r\n\r\nexport default {\r\n  validateRoleUpdateInput,\r\n  validateRoleCreateInput,\r\n  validateRolesDeleteInput,\r\n  validateRoleDeleteInput,\r\n};\r\n","import type { Context } from 'koa';\r\nimport { errors } from '@strapi/utils';\r\nimport {\r\n  validateRoleUpdateInput,\r\n  validateRoleCreateInput,\r\n  validateRoleDeleteInput,\r\n  validateRolesDeleteInput,\r\n} from '../validation/role';\r\nimport { validatedUpdatePermissionsInput } from '../validation/permission';\r\nimport constants from '../services/constants';\r\nimport { getService } from '../utils';\r\nimport type {\r\n  Create,\r\n  FindRoles,\r\n  FindRole,\r\n  Update,\r\n  GetPermissions,\r\n  UpdatePermissions,\r\n  Delete,\r\n  BatchDelete,\r\n} from '../../../shared/contracts/roles';\r\nimport { AdminRole } from '../../../shared/contracts/shared';\r\n\r\nconst { ApplicationError } = errors;\r\nconst { SUPER_ADMIN_CODE } = constants;\r\n\r\nexport default {\r\n  /**\r\n   * Create a new role\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async create(ctx: Context) {\r\n    const { body } = ctx.request as Create.Request;\r\n    await validateRoleCreateInput(body);\r\n\r\n    const roleService = getService('role');\r\n\r\n    const role = await roleService.create(body);\r\n    const sanitizedRole = roleService.sanitizeRole(role) as Omit<AdminRole, 'users' | 'permission'>;\r\n\r\n    ctx.created({ data: sanitizedRole } satisfies Create.Response);\r\n  },\r\n\r\n  /**\r\n   * Returns on role by id\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async findOne(ctx: Context) {\r\n    const { id } = ctx.params as FindRole.Request['params'];\r\n    const role = await getService('role').findOneWithUsersCount({ id });\r\n\r\n    if (!role) {\r\n      return ctx.notFound('role.notFound');\r\n    }\r\n\r\n    ctx.body = {\r\n      data: role,\r\n    } satisfies FindRole.Response;\r\n  },\r\n\r\n  /**\r\n   * Returns every roles\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async findAll(ctx: Context) {\r\n    const { query } = ctx.request as FindRoles.Request;\r\n\r\n    const permissionsManager = getService('permission').createPermissionsManager({\r\n      ability: ctx.state.userAbility,\r\n      model: 'admin::role',\r\n    });\r\n\r\n    await permissionsManager.validateQuery(query);\r\n    const sanitizedQuery = await permissionsManager.sanitizeQuery(query);\r\n\r\n    const roles = await getService('role').findAllWithUsersCount(sanitizedQuery);\r\n\r\n    ctx.body = {\r\n      data: roles,\r\n    } satisfies FindRoles.Response;\r\n  },\r\n\r\n  /**\r\n   * Updates a role by id\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async update(ctx: Context) {\r\n    const { id } = ctx.params as Update.Request['params'];\r\n    const { body } = ctx.request as Omit<Update.Request, 'params'>;\r\n\r\n    const roleService = getService('role');\r\n\r\n    await validateRoleUpdateInput(body);\r\n\r\n    const role = await roleService.findOne({ id });\r\n\r\n    if (!role) {\r\n      return ctx.notFound('role.notFound');\r\n    }\r\n\r\n    if (role.code === SUPER_ADMIN_CODE) {\r\n      throw new ApplicationError(\"Super admin can't be edited.\");\r\n    }\r\n\r\n    const updatedRole = await roleService.update({ id }, body);\r\n    const sanitizedRole = roleService.sanitizeRole(updatedRole) as Omit<\r\n      AdminRole,\r\n      'users' | 'permission'\r\n    >;\r\n\r\n    ctx.body = {\r\n      data: sanitizedRole,\r\n    } satisfies Update.Response;\r\n  },\r\n\r\n  /**\r\n   * Returns the permissions assigned to a role\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async getPermissions(ctx: Context) {\r\n    const { id } = ctx.params as GetPermissions.Request['params'];\r\n\r\n    const roleService = getService('role');\r\n    const permissionService = getService('permission');\r\n\r\n    const role = await roleService.findOne({ id });\r\n\r\n    if (!role) {\r\n      return ctx.notFound('role.notFound');\r\n    }\r\n\r\n    const permissions = await permissionService.findMany({ where: { role: { id: role.id } } });\r\n\r\n    const sanitizedPermissions = permissions.map(permissionService.sanitizePermission);\r\n\r\n    ctx.body = {\r\n      // @ts-expect-error - transform response type to sanitized permission\r\n      data: sanitizedPermissions,\r\n    } satisfies GetPermissions.Response;\r\n  },\r\n\r\n  /**\r\n   * Updates the permissions assigned to a role\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async updatePermissions(ctx: Context) {\r\n    const { id } = ctx.params as UpdatePermissions.Request['params'];\r\n    const { body: input } = ctx.request as Omit<UpdatePermissions.Request, 'params'>;\r\n\r\n    const roleService = getService('role');\r\n    const permissionService = getService('permission');\r\n\r\n    const role = await roleService.findOne({ id });\r\n\r\n    if (!role) {\r\n      return ctx.notFound('role.notFound');\r\n    }\r\n\r\n    if (role.code === SUPER_ADMIN_CODE) {\r\n      throw new ApplicationError(\"Super admin permissions can't be edited.\");\r\n    }\r\n\r\n    await validatedUpdatePermissionsInput(input);\r\n\r\n    if (!role) {\r\n      return ctx.notFound('role.notFound');\r\n    }\r\n\r\n    const permissions = await roleService.assignPermissions(role.id, input.permissions);\r\n\r\n    const sanitizedPermissions = permissions.map(permissionService.sanitizePermission);\r\n\r\n    ctx.body = {\r\n      data: sanitizedPermissions,\r\n    } satisfies UpdatePermissions.Response;\r\n  },\r\n\r\n  /**\r\n   * Delete a role\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async deleteOne(ctx: Context) {\r\n    const { id } = ctx.params as Delete.Request['params'];\r\n\r\n    await validateRoleDeleteInput(id);\r\n\r\n    const roleService = getService('role');\r\n\r\n    const roles = await roleService.deleteByIds([id]);\r\n\r\n    const sanitizedRole = roles.map((role) => roleService.sanitizeRole(role))[0] || null;\r\n\r\n    return ctx.deleted({\r\n      data: sanitizedRole,\r\n    } satisfies Delete.Response);\r\n  },\r\n\r\n  /**\r\n   * delete several roles\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async deleteMany(ctx: Context) {\r\n    const { body } = ctx.request as BatchDelete.Request;\r\n\r\n    await validateRolesDeleteInput(body);\r\n\r\n    const roleService = getService('role');\r\n\r\n    const roles = await roleService.deleteByIds(body.ids);\r\n    const sanitizedRoles = roles.map(roleService.sanitizeRole);\r\n\r\n    return ctx.deleted({\r\n      data: sanitizedRoles,\r\n    } satisfies BatchDelete.Response);\r\n  },\r\n};\r\n","import { Context } from 'koa';\r\n\r\nimport { strapi as dataTransferStrapi } from '@strapi/data-transfer';\r\nimport { errors } from '@strapi/utils';\r\nimport dataTransferAuthStrategy from '../../strategies/data-transfer';\r\n\r\nconst {\r\n  remote: {\r\n    handlers: { createPushController, createPullController },\r\n  },\r\n} = dataTransferStrapi;\r\n\r\nconst { UnauthorizedError } = errors;\r\n\r\n/**\r\n * @param ctx the koa context\r\n * @param scope the scope to verify\r\n */\r\nconst verify = async (ctx: Context, scope?: dataTransferStrapi.remote.constants.TransferMethod) => {\r\n  const { auth } = ctx.state;\r\n\r\n  if (!auth) {\r\n    throw new UnauthorizedError();\r\n  }\r\n\r\n  await dataTransferAuthStrategy.verify(auth, { scope });\r\n};\r\n\r\nexport const push = createPushController({ verify });\r\nexport const pull = createPullController({ verify });\r\n\r\nexport default {\r\n  push,\r\n  pull,\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\nimport constants from '../../services/constants';\r\n\r\nconst transferTokenCreationSchema = yup\r\n  .object()\r\n  .shape({\r\n    name: yup.string().min(1).required(),\r\n    description: yup.string().optional(),\r\n    permissions: yup\r\n      .array()\r\n      .min(1)\r\n      .of(yup.string().oneOf(Object.values(constants.TRANSFER_TOKEN_TYPE)))\r\n      .required(),\r\n    lifespan: yup\r\n      .number()\r\n      .min(1)\r\n      .oneOf(Object.values(constants.TRANSFER_TOKEN_LIFESPANS))\r\n      .nullable(),\r\n  })\r\n  .noUnknown()\r\n  .strict();\r\n\r\nconst transferTokenUpdateSchema = yup\r\n  .object()\r\n  .shape({\r\n    name: yup.string().min(1).notNull(),\r\n    description: yup.string().nullable(),\r\n    permissions: yup\r\n      .array()\r\n      .min(1)\r\n      .of(yup.string().oneOf(Object.values(constants.TRANSFER_TOKEN_TYPE)))\r\n      .nullable(),\r\n  })\r\n  .noUnknown()\r\n  .strict();\r\n\r\nexport const validateTransferTokenCreationInput = validateYupSchema(transferTokenCreationSchema);\r\nexport const validateTransferTokenUpdateInput = validateYupSchema(transferTokenUpdateSchema);\r\n\r\nexport default {\r\n  validateTransferTokenCreationInput,\r\n  validateTransferTokenUpdateInput,\r\n};\r\n","import { Context } from 'koa';\r\nimport { trim, has } from 'lodash/fp';\r\nimport { errors, strings } from '@strapi/utils';\r\nimport { getService } from '../../utils';\r\nimport { token } from '../../validation/transfer';\r\n\r\nimport type {\r\n  TokenCreate,\r\n  TokenGetById,\r\n  TokenList,\r\n  TokenRegenerate,\r\n  TokenRevoke,\r\n  TokenUpdate,\r\n} from '../../../../shared/contracts/transfer';\r\n\r\nconst { ApplicationError } = errors;\r\n\r\nconst { validateTransferTokenCreationInput, validateTransferTokenUpdateInput } = token;\r\n\r\nexport default {\r\n  async list(ctx: Context) {\r\n    const transferService = getService('transfer');\r\n    const transferTokens = await transferService.token.list();\r\n\r\n    ctx.body = { data: transferTokens } satisfies TokenList.Response;\r\n  },\r\n\r\n  async getById(ctx: Context) {\r\n    const { id } = ctx.params as TokenGetById.Params;\r\n    const tokenService = getService('transfer').token;\r\n\r\n    const transferToken = await tokenService.getById(id);\r\n\r\n    if (!transferToken) {\r\n      ctx.notFound('Transfer token not found');\r\n      return;\r\n    }\r\n\r\n    ctx.body = { data: transferToken } satisfies TokenGetById.Response;\r\n  },\r\n\r\n  async create(ctx: Context) {\r\n    const { body } = ctx.request as TokenCreate.Request;\r\n    const { token: tokenService } = getService('transfer');\r\n\r\n    /**\r\n     * We trim fields to avoid having issues with either:\r\n     * - having a space at the end or start of the value\r\n     * - having only spaces as value (so that an empty field can be caught in validation)\r\n     */\r\n    const attributes = {\r\n      name: trim(body.name),\r\n      description: trim(body.description),\r\n      permissions: body.permissions,\r\n      lifespan: body.lifespan,\r\n    };\r\n\r\n    await validateTransferTokenCreationInput(attributes);\r\n\r\n    const alreadyExists = await tokenService.exists({ name: attributes.name });\r\n    if (alreadyExists) {\r\n      throw new ApplicationError('Name already taken');\r\n    }\r\n\r\n    const transferTokens = await tokenService.create(attributes);\r\n\r\n    ctx.created({ data: transferTokens } satisfies TokenCreate.Response);\r\n  },\r\n\r\n  async update(ctx: Context) {\r\n    const { body } = ctx.request as TokenUpdate.Request;\r\n    const { id } = ctx.params as TokenUpdate.Params;\r\n    const { token: tokenService } = getService('transfer');\r\n\r\n    const attributes = body;\r\n    /**\r\n     * We trim fields to avoid having issues with either:\r\n     * - having a space at the end or start of the value\r\n     * - having only spaces as value (so that an empty field can be caught in validation)\r\n     */\r\n    if (has('name', attributes)) {\r\n      attributes.name = trim(body.name);\r\n    }\r\n\r\n    if (has('description', attributes) || attributes.description === null) {\r\n      attributes.description = trim(body.description);\r\n    }\r\n\r\n    await validateTransferTokenUpdateInput(attributes);\r\n\r\n    const apiTokenExists = await tokenService.getById(id);\r\n    if (!apiTokenExists) {\r\n      return ctx.notFound('Transfer token not found');\r\n    }\r\n\r\n    if (has('name', attributes)) {\r\n      const nameAlreadyTaken = await tokenService.getByName(attributes.name);\r\n\r\n      /**\r\n       * We cast the ids as string as the one coming from the ctx isn't cast\r\n       * as a Number in case it is supposed to be an integer. It remains\r\n       * as a string. This way we avoid issues with integers in the db.\r\n       */\r\n      if (!!nameAlreadyTaken && !strings.isEqual(nameAlreadyTaken.id, id)) {\r\n        throw new ApplicationError('Name already taken');\r\n      }\r\n    }\r\n\r\n    const apiToken = await tokenService.update(id, attributes);\r\n\r\n    ctx.body = { data: apiToken } satisfies TokenUpdate.Response;\r\n  },\r\n\r\n  async revoke(ctx: Context) {\r\n    const { id } = ctx.params as TokenRevoke.Params;\r\n    const { token: tokenService } = getService('transfer');\r\n\r\n    const transferToken = await tokenService.revoke(id);\r\n\r\n    ctx.deleted({ data: transferToken } satisfies TokenRevoke.Response);\r\n  },\r\n\r\n  async regenerate(ctx: Context) {\r\n    const { id } = ctx.params as TokenRegenerate.Params;\r\n    const { token: tokenService } = getService('transfer');\r\n\r\n    const exists = await tokenService.getById(id);\r\n    if (!exists) {\r\n      ctx.notFound('Transfer token not found');\r\n      return;\r\n    }\r\n\r\n    const accessToken = await tokenService.regenerate(id);\r\n\r\n    ctx.created({ data: accessToken } satisfies TokenRegenerate.Response);\r\n  },\r\n};\r\n","import { mapKeys } from 'lodash/fp';\r\nimport runner from './runner';\r\nimport token from './token';\r\n\r\nconst prefixActionsName = (prefix: string, dict: any) => mapKeys((key) => `${prefix}-${key}`, dict);\r\n\r\nexport default {\r\n  ...prefixActionsName('runner', runner),\r\n  ...prefixActionsName('token', token),\r\n};\r\n","import type { Context } from 'koa';\r\n\r\nimport * as _ from 'lodash';\r\nimport { errors } from '@strapi/utils';\r\nimport {\r\n  validateUserCreationInput,\r\n  validateUserUpdateInput,\r\n  validateUsersDeleteInput,\r\n} from '../validation/user';\r\nimport { getService } from '../utils';\r\nimport {\r\n  Create,\r\n  DeleteMany,\r\n  DeleteOne,\r\n  FindAll,\r\n  FindOne,\r\n  Update,\r\n} from '../../../shared/contracts/user';\r\nimport { AdminUser } from '../../../shared/contracts/shared';\r\n\r\nconst { ApplicationError } = errors;\r\n\r\nexport default {\r\n  async create(ctx: Context) {\r\n    const { body } = ctx.request as Create.Request;\r\n    const cleanData = { ...body, email: _.get(body, `email`, ``).toLowerCase() };\r\n\r\n    await validateUserCreationInput(cleanData);\r\n\r\n    const attributes = _.pick(cleanData, [\r\n      'firstname',\r\n      'lastname',\r\n      'email',\r\n      'roles',\r\n      'preferedLanguage',\r\n    ]);\r\n\r\n    const userAlreadyExists = await getService('user').exists({\r\n      email: attributes.email,\r\n    });\r\n\r\n    if (userAlreadyExists) {\r\n      throw new ApplicationError('Email already taken');\r\n    }\r\n\r\n    const createdUser = await getService('user').create(attributes);\r\n\r\n    const userInfo = getService('user').sanitizeUser(createdUser);\r\n\r\n    // Note: We need to assign manually the registrationToken to the\r\n    // final user payload so that it's not removed in the sanitation process.\r\n    Object.assign(userInfo, { registrationToken: createdUser.registrationToken });\r\n\r\n    // Send 201 created\r\n    ctx.created({ data: userInfo } satisfies Create.Response);\r\n  },\r\n\r\n  async find(ctx: Context) {\r\n    const userService = getService('user');\r\n\r\n    const permissionsManager = strapi.service('admin::permission').createPermissionsManager({\r\n      ability: ctx.state.userAbility,\r\n      model: 'admin::user',\r\n    });\r\n\r\n    await permissionsManager.validateQuery(ctx.query);\r\n    const sanitizedQuery = await permissionsManager.sanitizeQuery(ctx.query);\r\n\r\n    // @ts-expect-error update the service type\r\n    const { results, pagination } = await userService.findPage(sanitizedQuery);\r\n\r\n    ctx.body = {\r\n      data: {\r\n        results: results.map((user: AdminUser) => userService.sanitizeUser(user)),\r\n        pagination,\r\n      },\r\n    } satisfies FindAll.Response;\r\n  },\r\n\r\n  async findOne(ctx: Context) {\r\n    const { id } = ctx.params as FindOne.Params;\r\n\r\n    const user = await getService('user').findOne(id);\r\n\r\n    if (!user) {\r\n      return ctx.notFound('User does not exist');\r\n    }\r\n\r\n    ctx.body = {\r\n      data: getService('user').sanitizeUser(user as AdminUser),\r\n    } as FindOne.Response;\r\n  },\r\n\r\n  async update(ctx: Context) {\r\n    const { id } = ctx.params as Update.Params;\r\n    const { body: input } = ctx.request as Update.Request;\r\n\r\n    await validateUserUpdateInput(input);\r\n\r\n    if (_.has(input, 'email')) {\r\n      const uniqueEmailCheck = await getService('user').exists({\r\n        id: { $ne: id },\r\n        email: input.email,\r\n      });\r\n\r\n      if (uniqueEmailCheck) {\r\n        throw new ApplicationError('A user with this email address already exists');\r\n      }\r\n    }\r\n\r\n    const updatedUser = await getService('user').updateById(id, input);\r\n\r\n    if (!updatedUser) {\r\n      return ctx.notFound('User does not exist');\r\n    }\r\n\r\n    ctx.body = {\r\n      data: getService('user').sanitizeUser(updatedUser),\r\n    } satisfies Update.Response;\r\n  },\r\n\r\n  async deleteOne(ctx: Context) {\r\n    const { id } = ctx.params as DeleteOne.Params;\r\n\r\n    const deletedUser = await getService('user').deleteById(id);\r\n\r\n    if (!deletedUser) {\r\n      return ctx.notFound('User not found');\r\n    }\r\n\r\n    return ctx.deleted({\r\n      data: getService('user').sanitizeUser(deletedUser),\r\n    } satisfies DeleteOne.Response);\r\n  },\r\n\r\n  /**\r\n   * Delete several users\r\n   * @param ctx - koa context\r\n   */\r\n  async deleteMany(ctx: Context) {\r\n    const { body } = ctx.request as DeleteMany.Request;\r\n    await validateUsersDeleteInput(body);\r\n\r\n    const users = await getService('user').deleteByIds(body.ids);\r\n\r\n    const sanitizedUsers = users.map(getService('user').sanitizeUser);\r\n\r\n    return ctx.deleted({\r\n      data: sanitizedUsers,\r\n    } satisfies DeleteMany.Response);\r\n  },\r\n};\r\n","import isLocalhostIp from 'is-localhost-ip';\r\n// Regular import references a deprecated node module,\r\n// See https://www.npmjs.com/package/punycode.js#installation\r\nimport punycode from 'punycode/';\r\nimport type { Context } from 'koa';\r\nimport _ from 'lodash';\r\n\r\nimport { yup, validateYupSchema } from '@strapi/utils';\r\n\r\nimport type { Modules } from '@strapi/types';\r\n\r\nimport {\r\n  CreateWebhook,\r\n  DeleteWebhook,\r\n  DeleteWebhooks,\r\n  GetWebhook,\r\n  UpdateWebhook,\r\n  TriggerWebhook,\r\n  GetWebhooks,\r\n} from '../../../shared/contracts/webhooks';\r\n\r\nconst urlRegex =\r\n  /^(?:([a-z0-9+.-]+):\\/\\/)(?:\\S+(?::\\S*)?@)?(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9_]-*)*[a-z\\u00a1-\\uffff0-9_]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9_]-*)*[a-z\\u00a1-\\uffff0-9_]+)*\\.?)(?::\\d{2,5})?(?:[/?#]\\S*)?$/;\r\n\r\nconst webhookValidator = yup\r\n  .object({\r\n    name: yup.string().required(),\r\n    url: yup\r\n      .string()\r\n      .matches(urlRegex, 'url must be a valid URL')\r\n      .required()\r\n      .test(\r\n        'is-public-url',\r\n        \"Url is not supported because it isn't reachable over the public internet\",\r\n        async (url) => {\r\n          if (process.env.NODE_ENV !== 'production') {\r\n            return true;\r\n          }\r\n\r\n          try {\r\n            const parsedUrl = new URL(punycode.toASCII(url!));\r\n            const isLocalUrl = await isLocalhostIp(parsedUrl.hostname);\r\n            return !isLocalUrl;\r\n          } catch {\r\n            return false;\r\n          }\r\n        }\r\n      ),\r\n    headers: yup.lazy((data) => {\r\n      if (typeof data !== 'object') {\r\n        return yup.object().required();\r\n      }\r\n\r\n      return yup\r\n        .object(\r\n          // @ts-expect-error lodash types\r\n          _.mapValues(data, () => {\r\n            yup.string().min(1).required();\r\n          })\r\n        )\r\n        .required();\r\n    }),\r\n    events: yup.array().of(yup.string()).required(),\r\n  })\r\n  .noUnknown();\r\n\r\nconst updateWebhookValidator = webhookValidator.shape({\r\n  isEnabled: yup.boolean(),\r\n});\r\n\r\nexport default {\r\n  async listWebhooks(ctx: Context) {\r\n    const webhooks = await strapi.get('webhookStore').findWebhooks();\r\n    ctx.send({ data: webhooks } satisfies GetWebhooks.Response);\r\n  },\r\n\r\n  async getWebhook(ctx: Context) {\r\n    const { id } = ctx.params;\r\n    const webhook = await strapi.get('webhookStore').findWebhook(id);\r\n\r\n    if (!webhook) {\r\n      return ctx.notFound('webhook.notFound');\r\n    }\r\n\r\n    ctx.send({ data: webhook } satisfies GetWebhook.Response);\r\n  },\r\n\r\n  async createWebhook(ctx: Context) {\r\n    const { body } = ctx.request as CreateWebhook.Request;\r\n\r\n    await validateYupSchema(webhookValidator)(body);\r\n\r\n    const webhook = await strapi.get('webhookStore').createWebhook(body);\r\n\r\n    strapi.get('webhookRunner').add(webhook);\r\n\r\n    ctx.created({ data: webhook } satisfies CreateWebhook.Response);\r\n  },\r\n\r\n  async updateWebhook(ctx: Context) {\r\n    const { id } = ctx.params as UpdateWebhook.Params;\r\n    const { body } = ctx.request as UpdateWebhook.Request;\r\n\r\n    await validateYupSchema(updateWebhookValidator)(body);\r\n\r\n    const webhook = await strapi.get('webhookStore').findWebhook(id);\r\n\r\n    if (!webhook) {\r\n      return ctx.notFound('webhook.notFound');\r\n    }\r\n\r\n    const updatedWebhook = await strapi.get('webhookStore').updateWebhook(id, {\r\n      ...webhook,\r\n      ...body,\r\n    });\r\n\r\n    if (!updatedWebhook) {\r\n      return ctx.notFound('webhook.notFound');\r\n    }\r\n\r\n    strapi.get('webhookRunner').update(updatedWebhook);\r\n\r\n    ctx.send({ data: updatedWebhook } satisfies UpdateWebhook.Response);\r\n  },\r\n\r\n  async deleteWebhook(ctx: Context) {\r\n    const { id } = ctx.params;\r\n    const webhook = await strapi.get('webhookStore').findWebhook(id);\r\n\r\n    if (!webhook) {\r\n      return ctx.notFound('webhook.notFound');\r\n    }\r\n\r\n    await strapi.get('webhookStore').deleteWebhook(id);\r\n\r\n    strapi.get('webhookRunner').remove(webhook);\r\n\r\n    ctx.body = { data: webhook } satisfies DeleteWebhook.Response;\r\n  },\r\n\r\n  async deleteWebhooks(ctx: Context) {\r\n    const { ids } = ctx.request.body as DeleteWebhooks.Request['body'];\r\n\r\n    if (!Array.isArray(ids) || ids.length === 0) {\r\n      return ctx.badRequest('ids must be an array of id');\r\n    }\r\n\r\n    for (const id of ids) {\r\n      const webhook = await strapi.get('webhookStore').findWebhook(id);\r\n\r\n      if (webhook) {\r\n        await strapi.get('webhookStore').deleteWebhook(id);\r\n        strapi.get('webhookRunner').remove(webhook);\r\n      }\r\n    }\r\n\r\n    ctx.send({ data: ids } satisfies DeleteWebhooks.Response);\r\n  },\r\n\r\n  async triggerWebhook(ctx: Context) {\r\n    const { id } = ctx.params;\r\n\r\n    const webhook = await strapi.get('webhookStore').findWebhook(id);\r\n\r\n    const response = await strapi\r\n      .get('webhookRunner')\r\n      .run(webhook as Modules.WebhookStore.Webhook, 'trigger-test', {});\r\n\r\n    ctx.body = { data: response } satisfies TriggerWebhook.Response;\r\n  },\r\n};\r\n","import type { Context } from 'koa';\r\nimport type { GetRoutes, GetPermissions } from '../../../shared/contracts/content-api';\r\nimport '@strapi/types';\r\n\r\nexport default {\r\n  async getPermissions(ctx: Context) {\r\n    const actionsMap = await strapi.contentAPI.permissions.getActionsMap();\r\n\r\n    ctx.send({ data: actionsMap } satisfies GetPermissions.Response);\r\n  },\r\n\r\n  async getRoutes(ctx: Context) {\r\n    const routesMap = await strapi.contentAPI.getRoutesMap();\r\n\r\n    ctx.send({ data: routesMap } satisfies GetRoutes.Response);\r\n  },\r\n};\r\n","import type {} from 'koa-body';\r\n\r\nimport admin from './admin';\r\nimport apiToken from './api-token';\r\nimport authenticatedUser from './authenticated-user';\r\nimport authentication from './authentication';\r\nimport permission from './permission';\r\nimport role from './role';\r\nimport transfer from './transfer';\r\nimport user from './user';\r\nimport webhooks from './webhooks';\r\nimport contentApi from './content-api';\r\n\r\nexport default {\r\n  admin,\r\n  'api-token': apiToken,\r\n  'authenticated-user': authenticatedUser,\r\n  authentication,\r\n  permission,\r\n  role,\r\n  transfer,\r\n  user,\r\n  webhooks,\r\n  'content-api': contentApi,\r\n};\r\n","/**\r\n * Lifecycle callbacks for the `Permission` model.\r\n */\r\n\r\nexport default {\r\n  collectionName: 'admin_permissions',\r\n  info: {\r\n    name: 'Permission',\r\n    description: '',\r\n    singularName: 'permission',\r\n    pluralName: 'permissions',\r\n    displayName: 'Permission',\r\n  },\r\n  options: {},\r\n  pluginOptions: {\r\n    'content-manager': {\r\n      visible: false,\r\n    },\r\n    'content-type-builder': {\r\n      visible: false,\r\n    },\r\n  },\r\n  attributes: {\r\n    action: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: true,\r\n    },\r\n    actionParameters: {\r\n      type: 'json',\r\n      configurable: false,\r\n      required: false,\r\n      default: {},\r\n    },\r\n    subject: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    properties: {\r\n      type: 'json',\r\n      configurable: false,\r\n      required: false,\r\n      default: {},\r\n    },\r\n    conditions: {\r\n      type: 'json',\r\n      configurable: false,\r\n      required: false,\r\n      default: [],\r\n    },\r\n    role: {\r\n      configurable: false,\r\n      type: 'relation',\r\n      relation: 'manyToOne',\r\n      inversedBy: 'permissions',\r\n      target: 'admin::role',\r\n    },\r\n  },\r\n};\r\n","export default {\r\n  collectionName: 'admin_users',\r\n  info: {\r\n    name: 'User',\r\n    description: '',\r\n    singularName: 'user',\r\n    pluralName: 'users',\r\n    displayName: 'User',\r\n  },\r\n  pluginOptions: {\r\n    'content-manager': {\r\n      visible: false,\r\n    },\r\n    'content-type-builder': {\r\n      visible: false,\r\n    },\r\n  },\r\n  attributes: {\r\n    firstname: {\r\n      type: 'string',\r\n      unique: false,\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    lastname: {\r\n      type: 'string',\r\n      unique: false,\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    username: {\r\n      type: 'string',\r\n      unique: false,\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    email: {\r\n      type: 'email',\r\n      minLength: 6,\r\n      configurable: false,\r\n      required: true,\r\n      unique: true,\r\n      private: true,\r\n    },\r\n    password: {\r\n      type: 'password',\r\n      minLength: 6,\r\n      configurable: false,\r\n      required: false,\r\n      private: true,\r\n      searchable: false,\r\n    },\r\n    resetPasswordToken: {\r\n      type: 'string',\r\n      configurable: false,\r\n      private: true,\r\n      searchable: false,\r\n    },\r\n    registrationToken: {\r\n      type: 'string',\r\n      configurable: false,\r\n      private: true,\r\n      searchable: false,\r\n    },\r\n    isActive: {\r\n      type: 'boolean',\r\n      default: false,\r\n      configurable: false,\r\n      private: true,\r\n    },\r\n    roles: {\r\n      configurable: false,\r\n      private: true,\r\n      type: 'relation',\r\n      relation: 'manyToMany',\r\n      inversedBy: 'users',\r\n      target: 'admin::role',\r\n      // FIXME: Allow setting this\r\n      collectionName: 'strapi_users_roles',\r\n    },\r\n    blocked: {\r\n      type: 'boolean',\r\n      default: false,\r\n      configurable: false,\r\n      private: true,\r\n    },\r\n    preferedLanguage: {\r\n      type: 'string',\r\n      configurable: false,\r\n      required: false,\r\n      searchable: false,\r\n    },\r\n  },\r\n  config: {\r\n    attributes: {\r\n      resetPasswordToken: {\r\n        hidden: true,\r\n      },\r\n      registrationToken: {\r\n        hidden: true,\r\n      },\r\n    },\r\n  },\r\n};\r\n","/**\r\n * Lifecycle callbacks for the `Role` model.\r\n */\r\n\r\nexport default {\r\n  collectionName: 'admin_roles',\r\n  info: {\r\n    name: 'Role',\r\n    description: '',\r\n    singularName: 'role',\r\n    pluralName: 'roles',\r\n    displayName: 'Role',\r\n  },\r\n  options: {},\r\n  pluginOptions: {\r\n    'content-manager': {\r\n      visible: false,\r\n    },\r\n    'content-type-builder': {\r\n      visible: false,\r\n    },\r\n  },\r\n  attributes: {\r\n    name: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      unique: true,\r\n      configurable: false,\r\n      required: true,\r\n    },\r\n    code: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      unique: true,\r\n      configurable: false,\r\n      required: true,\r\n    },\r\n    description: {\r\n      type: 'string',\r\n      configurable: false,\r\n    },\r\n    users: {\r\n      configurable: false,\r\n      type: 'relation',\r\n      relation: 'manyToMany',\r\n      mappedBy: 'roles',\r\n      target: 'admin::user',\r\n    },\r\n    permissions: {\r\n      configurable: false,\r\n      type: 'relation',\r\n      relation: 'oneToMany',\r\n      mappedBy: 'role',\r\n      target: 'admin::permission',\r\n    },\r\n  },\r\n};\r\n","import constants from '../services/constants';\r\n\r\nexport default {\r\n  collectionName: 'strapi_api_tokens',\r\n  info: {\r\n    name: 'Api Token',\r\n    singularName: 'api-token',\r\n    pluralName: 'api-tokens',\r\n    displayName: 'Api Token',\r\n    description: '',\r\n  },\r\n  options: {},\r\n  pluginOptions: {\r\n    'content-manager': {\r\n      visible: false,\r\n    },\r\n    'content-type-builder': {\r\n      visible: false,\r\n    },\r\n  },\r\n  attributes: {\r\n    name: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: true,\r\n      unique: true,\r\n    },\r\n    description: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: false,\r\n      default: '',\r\n    },\r\n    type: {\r\n      type: 'enumeration',\r\n      enum: Object.values(constants.API_TOKEN_TYPE),\r\n      configurable: false,\r\n      required: true,\r\n      default: constants.API_TOKEN_TYPE.READ_ONLY,\r\n    },\r\n    accessKey: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: true,\r\n      searchable: false,\r\n    },\r\n    lastUsedAt: {\r\n      type: 'datetime',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    permissions: {\r\n      type: 'relation',\r\n      target: 'admin::api-token-permission',\r\n      relation: 'oneToMany',\r\n      mappedBy: 'token',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    expiresAt: {\r\n      type: 'datetime',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    lifespan: {\r\n      type: 'biginteger',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n  },\r\n};\r\n","export default {\r\n  collectionName: 'strapi_api_token_permissions',\r\n  info: {\r\n    name: 'API Token Permission',\r\n    description: '',\r\n    singularName: 'api-token-permission',\r\n    pluralName: 'api-token-permissions',\r\n    displayName: 'API Token Permission',\r\n  },\r\n  options: {},\r\n  pluginOptions: {\r\n    'content-manager': {\r\n      visible: false,\r\n    },\r\n    'content-type-builder': {\r\n      visible: false,\r\n    },\r\n  },\r\n  attributes: {\r\n    action: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: true,\r\n    },\r\n    token: {\r\n      configurable: false,\r\n      type: 'relation',\r\n      relation: 'manyToOne',\r\n      inversedBy: 'permissions',\r\n      target: 'admin::api-token',\r\n    },\r\n  },\r\n};\r\n","export default {\r\n  collectionName: 'strapi_transfer_tokens',\r\n  info: {\r\n    name: 'Transfer Token',\r\n    singularName: 'transfer-token',\r\n    pluralName: 'transfer-tokens',\r\n    displayName: 'Transfer Token',\r\n    description: '',\r\n  },\r\n  options: {},\r\n  pluginOptions: {\r\n    'content-manager': {\r\n      visible: false,\r\n    },\r\n    'content-type-builder': {\r\n      visible: false,\r\n    },\r\n  },\r\n  attributes: {\r\n    name: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: true,\r\n      unique: true,\r\n    },\r\n    description: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: false,\r\n      default: '',\r\n    },\r\n    accessKey: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: true,\r\n    },\r\n    lastUsedAt: {\r\n      type: 'datetime',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    permissions: {\r\n      type: 'relation',\r\n      target: 'admin::transfer-token-permission',\r\n      relation: 'oneToMany',\r\n      mappedBy: 'token',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    expiresAt: {\r\n      type: 'datetime',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n    lifespan: {\r\n      type: 'biginteger',\r\n      configurable: false,\r\n      required: false,\r\n    },\r\n  },\r\n};\r\n","export default {\r\n  collectionName: 'strapi_transfer_token_permissions',\r\n  info: {\r\n    name: 'Transfer Token Permission',\r\n    description: '',\r\n    singularName: 'transfer-token-permission',\r\n    pluralName: 'transfer-token-permissions',\r\n    displayName: 'Transfer Token Permission',\r\n  },\r\n  options: {},\r\n  pluginOptions: {\r\n    'content-manager': {\r\n      visible: false,\r\n    },\r\n    'content-type-builder': {\r\n      visible: false,\r\n    },\r\n  },\r\n  attributes: {\r\n    action: {\r\n      type: 'string',\r\n      minLength: 1,\r\n      configurable: false,\r\n      required: true,\r\n    },\r\n    token: {\r\n      configurable: false,\r\n      type: 'relation',\r\n      relation: 'manyToOne',\r\n      inversedBy: 'permissions',\r\n      target: 'admin::transfer-token',\r\n    },\r\n  },\r\n};\r\n","import Permission from './Permission';\r\nimport User from './User';\r\nimport Role from './Role';\r\nimport apiToken from './api-token';\r\nimport apiTokenPermission from './api-token-permission';\r\nimport transferToken from './transfer-token';\r\nimport transferTokenPermission from './transfer-token-permission';\r\n\r\nexport default {\r\n  permission: { schema: Permission },\r\n  user: { schema: User },\r\n  role: { schema: Role },\r\n  'api-token': { schema: apiToken },\r\n  'api-token-permission': { schema: apiTokenPermission },\r\n  'transfer-token': { schema: transferToken },\r\n  'transfer-token-permission': { schema: transferTokenPermission },\r\n};\r\n","import type { Context, Next } from 'koa';\r\nimport path from 'path';\r\nimport utils from '@strapi/utils';\r\nimport { isString, has, toLower, get } from 'lodash/fp';\r\nimport type { Core } from '@strapi/types';\r\n\r\nconst { RateLimitError } = utils.errors;\r\n\r\nexport default (config: any, { strapi }: { strapi: Core.Strapi }) =>\r\n  async (ctx: Context, next: Next) => {\r\n    let rateLimitConfig = strapi.config.get('admin.rateLimit') as any;\r\n\r\n    if (!rateLimitConfig) {\r\n      rateLimitConfig = {\r\n        enabled: true,\r\n      };\r\n    }\r\n\r\n    if (!has('enabled', rateLimitConfig)) {\r\n      rateLimitConfig.enabled = true;\r\n    }\r\n\r\n    if (rateLimitConfig.enabled === true) {\r\n      // TODO: TS - Do the dynamic import\r\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\r\n      const rateLimit = require('koa2-ratelimit').RateLimit;\r\n\r\n      const requestEmail = get('request.body.email')(ctx);\r\n      const userEmail = isString(requestEmail) ? requestEmail.toLowerCase() : 'unknownEmail';\r\n\r\n      const requestPath = isString(ctx.request.path)\r\n        ? toLower(path.normalize(ctx.request.path)).replace(/\\/$/, '')\r\n        : 'invalidPath';\r\n\r\n      const loadConfig = {\r\n        interval: { min: 5 },\r\n        max: 5,\r\n        prefixKey: `${userEmail}:${requestPath}:${ctx.request.ip}`,\r\n        handler() {\r\n          throw new RateLimitError();\r\n        },\r\n        ...rateLimitConfig,\r\n        ...config,\r\n      };\r\n\r\n      return rateLimit.middleware(loadConfig)(ctx, next);\r\n    }\r\n\r\n    return next();\r\n  };\r\n","import type { Context, Next } from 'koa';\r\n\r\nimport { getService } from '../utils';\r\n\r\nexport default () => async (ctx: Context, next: Next) => {\r\n  const transferUtils = getService('transfer').utils;\r\n\r\n  const { hasValidTokenSalt, isRemoteTransferEnabled } = transferUtils;\r\n\r\n  // verify that data transfer is enabled\r\n  if (isRemoteTransferEnabled()) {\r\n    return next();\r\n  }\r\n\r\n  // if it has been manually disabled, return a not found\r\n  if (strapi.config.get('server.transfer.remote.enabled') === false) {\r\n    return ctx.notFound();\r\n  }\r\n\r\n  // if it's enabled but doesn't have a valid salt, throw a not implemented\r\n  if (!hasValidTokenSalt()) {\r\n    return ctx.notImplemented(\r\n      'The server configuration for data transfer is invalid. Please contact your server administrator.',\r\n      {\r\n        code: 'INVALID_TOKEN_SALT',\r\n      }\r\n    );\r\n  }\r\n\r\n  // This should never happen as long as we're handling individual scenarios above\r\n  throw new Error('Unexpected error while trying to access a data transfer route');\r\n};\r\n","import rateLimit from './rateLimit';\r\nimport dataTransfer from './data-transfer';\r\n\r\nexport { default as rateLimit } from './rateLimit';\r\nexport { default as dataTransfer } from './data-transfer';\r\n\r\nexport default {\r\n  rateLimit,\r\n  'data-transfer': dataTransfer,\r\n};\r\n","import type { Core } from '@strapi/types';\r\n\r\nimport executeCERegister from '../../../server/src/register';\r\n\r\nexport default async ({ strapi }: { strapi: Core.Strapi }) => {\r\n  await executeCERegister({ strapi });\r\n};\r\n","import type { Core } from '@strapi/types';\r\n\r\nexport const getService = (\r\n  name: string,\r\n  { strapi }: { strapi: Core.Strapi } = { strapi: global.strapi }\r\n) => {\r\n  return strapi.service(`admin::${name}`);\r\n};\r\n\r\nexport default {\r\n  getService,\r\n};\r\n","export default {\r\n  sso: [\r\n    {\r\n      uid: 'provider-login.read',\r\n      displayName: 'Read',\r\n      pluginName: 'admin',\r\n      section: 'settings',\r\n      category: 'single sign on',\r\n      subCategory: 'options',\r\n    },\r\n    {\r\n      uid: 'provider-login.update',\r\n      displayName: 'Update',\r\n      pluginName: 'admin',\r\n      section: 'settings',\r\n      category: 'single sign on',\r\n      subCategory: 'options',\r\n    },\r\n  ],\r\n  auditLogs: [\r\n    {\r\n      uid: 'audit-logs.read',\r\n      displayName: 'Read',\r\n      pluginName: 'admin',\r\n      section: 'settings',\r\n      category: 'audit logs',\r\n      subCategory: 'options',\r\n    },\r\n  ],\r\n};\r\n","import executeCEBootstrap from '../../../server/src/bootstrap';\r\nimport { getService } from './utils';\r\nimport actions from './config/admin-actions';\r\n\r\nexport default async (args: any) => {\r\n  const { actionProvider } = getService('permission');\r\n  const { persistTablesWithPrefix } = getService('persist-tables');\r\n\r\n  if (strapi.ee.features.isEnabled('sso')) {\r\n    await actionProvider.registerMany(actions.sso);\r\n  }\r\n\r\n  if (strapi.ee.features.isEnabled('audit-logs')) {\r\n    await persistTablesWithPrefix('strapi_audit_logs');\r\n    await actionProvider.registerMany(actions.auditLogs);\r\n  }\r\n\r\n  await getService('seat-enforcement').seatEnforcementWorkflow();\r\n  await executeCEBootstrap(args);\r\n};\r\n","import type { Core } from '@strapi/types';\r\nimport executeCEDestroy from '../../../server/src/destroy';\r\n\r\nexport default async ({ strapi }: { strapi: Core.Strapi }) => {\r\n  await executeCEDestroy();\r\n};\r\n","export default {};\r\n","import { isEmpty } from 'lodash/fp';\r\n\r\nexport const isSsoLocked = async (user: any) => {\r\n  if (!strapi.ee.features.isEnabled('sso')) {\r\n    return false;\r\n  }\r\n\r\n  if (!user) {\r\n    throw new Error('Missing user object');\r\n  }\r\n\r\n  // check if any roles are locked\r\n  const adminStore = await strapi.store({ type: 'core', name: 'admin' });\r\n  const { providers } = (await adminStore.get({ key: 'auth' })) as any;\r\n  const lockedRoles = providers.ssoLockedRoles ?? [];\r\n  if (isEmpty(lockedRoles)) {\r\n    return false;\r\n  }\r\n\r\n  const roles =\r\n    // If the roles are pre-loaded for the given user, then use them\r\n    user.roles ??\r\n    // Otherwise, try to load the role based on the given user ID\r\n    (await strapi.db.query('admin::user').load(user, 'roles', { roles: { fields: ['id'] } })) ??\r\n    // If the query fails somehow, default to an empty array\r\n    [];\r\n\r\n  // Check if any of the user's roles are in lockedRoles\r\n  const isLocked = lockedRoles.some((lockedId: string) =>\r\n    // lockedRoles will be a string to avoid issues with frontend and bigints\r\n    roles.some((role: any) => lockedId === role.id.toString())\r\n  );\r\n\r\n  return isLocked;\r\n};\r\n\r\nexport default {\r\n  isSsoLocked,\r\n};\r\n","import _ from 'lodash';\r\nimport { errors } from '@strapi/utils';\r\nimport { getService } from '../utils';\r\nimport { isSsoLocked } from '../utils/sso-lock';\r\n\r\nconst { ApplicationError } = errors;\r\n/**\r\n * Send an email to the user if it exists and is not locked to SSO\r\n * If those conditions are not met, nothing happens\r\n *\r\n * @param {Object} param params\r\n * @param {string} param.email user email for which to reset the password\r\n */\r\nconst forgotPassword = async ({ email }: any = {}) => {\r\n  const user = await strapi.db.query('admin::user').findOne({ where: { email, isActive: true } });\r\n\r\n  if (!user || (await isSsoLocked(user))) {\r\n    return;\r\n  }\r\n\r\n  const resetPasswordToken = getService('token').createToken();\r\n  await getService('user').updateById(user.id, { resetPasswordToken });\r\n\r\n  // Send an email to the admin.\r\n  const url = `${strapi.config.get(\r\n    'admin.absoluteUrl'\r\n  )}/auth/reset-password?code=${resetPasswordToken}`;\r\n  return strapi\r\n    .plugin('email')\r\n    .service('email')\r\n    .sendTemplatedEmail(\r\n      {\r\n        to: user.email,\r\n        from: strapi.config.get('admin.forgotPassword.from'),\r\n        replyTo: strapi.config.get('admin.forgotPassword.replyTo'),\r\n      },\r\n      strapi.config.get('admin.forgotPassword.emailTemplate'),\r\n      {\r\n        url,\r\n        user: _.pick(user, ['email', 'firstname', 'lastname', 'username']),\r\n      }\r\n    )\r\n    .catch((err: unknown) => {\r\n      // log error server side but do not disclose it to the user to avoid leaking informations\r\n      strapi.log.error(err);\r\n    });\r\n};\r\n\r\n/**\r\n * Reset a user password\r\n * @param {Object} param params\r\n * @param {string} param.resetPasswordToken token generated to request a password reset\r\n * @param {string} param.password new user password\r\n */\r\nconst resetPassword = async ({ resetPasswordToken, password }: any = {}) => {\r\n  const matchingUser = await strapi.db\r\n    .query('admin::user')\r\n    .findOne({ where: { resetPasswordToken, isActive: true } });\r\n\r\n  if (!matchingUser || (await isSsoLocked(matchingUser))) {\r\n    throw new ApplicationError();\r\n  }\r\n\r\n  return getService('user').updateById(matchingUser.id, {\r\n    password,\r\n    resetPasswordToken: null,\r\n  });\r\n};\r\n\r\nexport default {\r\n  forgotPassword,\r\n  resetPassword,\r\n};\r\n","import '@strapi/types';\r\n\r\nexport default () => {\r\n  const registry = new Map();\r\n\r\n  Object.assign(registry, {\r\n    register(provider: unknown) {\r\n      if (strapi.isLoaded) {\r\n        throw new Error(`You can't register new provider after the bootstrap`);\r\n      }\r\n\r\n      // TODO\r\n      // @ts-expect-error check map types\r\n      this.set(provider.uid, provider);\r\n    },\r\n\r\n    registerMany(providers: unknown[]) {\r\n      providers.forEach((provider) => {\r\n        this.register(provider);\r\n      });\r\n    },\r\n\r\n    getAll(): unknown[] {\r\n      // TODO\r\n      // @ts-expect-error check map types\r\n      return Array.from(this.values());\r\n    },\r\n  });\r\n\r\n  return registry;\r\n};\r\n","import '@strapi/types';\r\nimport passport from '../../../../../server/src/services/passport';\r\nimport createProviderRegistry from './provider-registry';\r\n\r\nexport const providerRegistry = createProviderRegistry();\r\nconst errorMessage = 'SSO is disabled. Its functionnalities cannot be accessed.';\r\n\r\nexport const getStrategyCallbackURL = (providerName: string) => {\r\n  if (!strapi.ee.features.isEnabled('sso')) {\r\n    throw new Error(errorMessage);\r\n  }\r\n\r\n  return `/admin/connect/${providerName}`;\r\n};\r\n\r\nexport const syncProviderRegistryWithConfig = () => {\r\n  if (!strapi.ee.features.isEnabled('sso')) {\r\n    throw new Error(errorMessage);\r\n  }\r\n\r\n  const { providers = [] } = strapi.config.get('admin.auth', {}) as any;\r\n\r\n  // TODO\r\n  // @ts-expect-error check map types\r\n  providerRegistry.registerMany(providers);\r\n};\r\n\r\nexport const SSOAuthEventsMapper = {\r\n  onSSOAutoRegistration: 'admin.auth.autoRegistration',\r\n};\r\n\r\nexport default {\r\n  providerRegistry,\r\n  getStrategyCallbackURL,\r\n  syncProviderRegistryWithConfig,\r\n  authEventsMapper: { ...passport.authEventsMapper, ...SSOAuthEventsMapper },\r\n};\r\n","import { errors } from '@strapi/utils';\r\nimport createLocalStrategy from '../../../../server/src/services/passport/local-strategy';\r\nimport sso from './passport/sso';\r\nimport { isSsoLocked } from '../utils/sso-lock';\r\n\r\nconst { UnauthorizedError } = errors;\r\n\r\nconst localStrategyMiddleware = async ([error, user, message]: any, done: any) => {\r\n  // if we got a user, we need to check that it's not sso locked\r\n  if (user && !error && (await isSsoLocked(user))) {\r\n    return done(\r\n      new UnauthorizedError('Login not allowed, please contact your administrator', {\r\n        code: 'LOGIN_NOT_ALLOWED',\r\n      }),\r\n      user,\r\n      message\r\n    );\r\n  }\r\n\r\n  return done(error, user, message);\r\n};\r\n\r\nconst getPassportStrategies = () => {\r\n  if (!strapi.ee.features.isEnabled('sso')) {\r\n    return [createLocalStrategy(strapi)];\r\n  }\r\n\r\n  const localStrategy = createLocalStrategy(strapi, localStrategyMiddleware);\r\n\r\n  if (!strapi.isLoaded) {\r\n    sso.syncProviderRegistryWithConfig();\r\n  }\r\n\r\n  // TODO\r\n  // @ts-expect-error check map types\r\n  const providers = sso.providerRegistry.getAll();\r\n  const strategies = providers.map((provider: any) => provider.createStrategy(strapi));\r\n\r\n  return [localStrategy, ...strategies];\r\n};\r\n\r\nexport default {\r\n  getPassportStrategies,\r\n  ...sso,\r\n};\r\n","import { toString } from 'lodash/fp';\r\nimport { errors } from '@strapi/utils';\r\n\r\nconst { ApplicationError } = errors;\r\n\r\nconst ssoCheckRolesIdForDeletion = async (ids: any) => {\r\n  const adminStore = await strapi.store({ type: 'core', name: 'admin' });\r\n\r\n  const {\r\n    providers: { defaultRole },\r\n  } = (await adminStore.get({ key: 'auth' })) as any;\r\n\r\n  for (const roleId of ids) {\r\n    if (defaultRole && toString(defaultRole) === toString(roleId)) {\r\n      throw new ApplicationError(\r\n        'This role is used as the default SSO role. Make sure to change this configuration before deleting the role'\r\n      );\r\n    }\r\n  }\r\n};\r\n\r\nexport default {\r\n  ssoCheckRolesIdForDeletion,\r\n};\r\n","import _ from 'lodash';\r\nimport { pipe, map, castArray, toNumber } from 'lodash/fp';\r\nimport { arrays, errors } from '@strapi/utils';\r\nimport { hasSuperAdminRole } from '../../../../server/src/domain/user';\r\nimport constants from '../../../../server/src/services/constants';\r\nimport { getService } from '../utils';\r\n\r\nconst { ValidationError } = errors;\r\nconst { SUPER_ADMIN_CODE } = constants;\r\n\r\n/** Checks if ee disabled users list needs to be updated\r\n * @param {string} id\r\n * @param {object} input\r\n */\r\nconst updateEEDisabledUsersList = async (id: string, input: any) => {\r\n  const disabledUsers = await getService('seat-enforcement').getDisabledUserList();\r\n\r\n  if (!disabledUsers) {\r\n    return;\r\n  }\r\n\r\n  const user = disabledUsers.find((user: any) => user.id === Number(id));\r\n  if (!user) {\r\n    return;\r\n  }\r\n\r\n  if (user.isActive !== input.isActive) {\r\n    const newDisabledUsersList = disabledUsers.filter((user: any) => user.id !== Number(id));\r\n    await strapi.store.set({\r\n      type: 'ee',\r\n      key: 'disabled_users',\r\n      value: newDisabledUsersList,\r\n    });\r\n  }\r\n};\r\n\r\nconst castNumberArray = pipe(castArray, map(toNumber));\r\n\r\nconst removeFromEEDisabledUsersList = async (ids: unknown) => {\r\n  let idsToCheck: any;\r\n  if (typeof ids === 'object') {\r\n    idsToCheck = castNumberArray(ids);\r\n  } else {\r\n    idsToCheck = [Number(ids)];\r\n  }\r\n\r\n  const disabledUsers = await getService('seat-enforcement').getDisabledUserList();\r\n\r\n  if (!disabledUsers) {\r\n    return;\r\n  }\r\n\r\n  const newDisabledUsersList = disabledUsers.filter((user: any) => !idsToCheck.includes(user.id));\r\n  await strapi.store.set({\r\n    type: 'ee',\r\n    key: 'disabled_users',\r\n    value: newDisabledUsersList,\r\n  });\r\n};\r\n\r\n/**\r\n * Update a user in database\r\n * @param id query params to find the user to update\r\n * @param attributes A partial user object\r\n * @returns {Promise<user>}\r\n */\r\nconst updateById = async (id: any, attributes: any) => {\r\n  // Check at least one super admin remains\r\n  if (_.has(attributes, 'roles')) {\r\n    const lastAdminUser = await isLastSuperAdminUser(id);\r\n    const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n    const willRemoveSuperAdminRole = !arrays.includesString(attributes.roles, superAdminRole.id);\r\n\r\n    if (lastAdminUser && willRemoveSuperAdminRole) {\r\n      throw new ValidationError('You must have at least one user with super admin role.');\r\n    }\r\n  }\r\n\r\n  // cannot disable last super admin\r\n  if (attributes.isActive === false) {\r\n    const lastAdminUser = await isLastSuperAdminUser(id);\r\n    if (lastAdminUser) {\r\n      throw new ValidationError('You must have at least one user with super admin role.');\r\n    }\r\n  }\r\n\r\n  // hash password if a new one is sent\r\n  if (_.has(attributes, 'password')) {\r\n    const hashedPassword = await getService('auth').hashPassword(attributes.password);\r\n\r\n    const updatedUser = await strapi.db.query('admin::user').update({\r\n      where: { id },\r\n      data: {\r\n        ...attributes,\r\n        password: hashedPassword,\r\n      },\r\n      populate: ['roles'],\r\n    });\r\n\r\n    strapi.eventHub.emit('user.update', { user: sanitizeUser(updatedUser) });\r\n\r\n    return updatedUser;\r\n  }\r\n\r\n  const updatedUser = await strapi.db.query('admin::user').update({\r\n    where: { id },\r\n    data: attributes,\r\n    populate: ['roles'],\r\n  });\r\n\r\n  await updateEEDisabledUsersList(id, attributes);\r\n\r\n  if (updatedUser) {\r\n    strapi.eventHub.emit('user.update', { user: sanitizeUser(updatedUser) });\r\n  }\r\n\r\n  return updatedUser;\r\n};\r\n\r\n/** Delete a user\r\n * @param id id of the user to delete\r\n * @returns {Promise<user>}\r\n */\r\nconst deleteById = async (id: unknown) => {\r\n  // Check at least one super admin remains\r\n  const userToDelete = await strapi.db.query('admin::user').findOne({\r\n    where: { id },\r\n    populate: ['roles'],\r\n  });\r\n\r\n  if (!userToDelete) {\r\n    return null;\r\n  }\r\n\r\n  if (userToDelete) {\r\n    if (userToDelete.roles.some((r: any) => r.code === SUPER_ADMIN_CODE)) {\r\n      const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n      if (superAdminRole.usersCount === 1) {\r\n        throw new ValidationError('You must have at least one user with super admin role.');\r\n      }\r\n    }\r\n  }\r\n\r\n  const deletedUser = await strapi.db\r\n    .query('admin::user')\r\n    .delete({ where: { id }, populate: ['roles'] });\r\n\r\n  await removeFromEEDisabledUsersList(id);\r\n\r\n  strapi.eventHub.emit('user.delete', { user: sanitizeUser(deletedUser) });\r\n\r\n  return deletedUser;\r\n};\r\n\r\n/** Delete a user\r\n * @param ids ids of the users to delete\r\n * @returns {Promise<user>}\r\n */\r\nconst deleteByIds = async (ids: any) => {\r\n  // Check at least one super admin remains\r\n  const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n  const nbOfSuperAdminToDelete = await strapi.db.query('admin::user').count({\r\n    where: {\r\n      id: ids,\r\n      roles: { id: superAdminRole.id },\r\n    },\r\n  });\r\n\r\n  if (superAdminRole.usersCount === nbOfSuperAdminToDelete) {\r\n    throw new ValidationError('You must have at least one user with super admin role.');\r\n  }\r\n\r\n  const deletedUsers = [];\r\n  for (const id of ids) {\r\n    const deletedUser = await strapi.db.query('admin::user').delete({\r\n      where: { id },\r\n      populate: ['roles'],\r\n    });\r\n\r\n    deletedUsers.push(deletedUser);\r\n  }\r\n\r\n  await removeFromEEDisabledUsersList(ids);\r\n\r\n  strapi.eventHub.emit('user.delete', {\r\n    users: deletedUsers.map((deletedUser) => sanitizeUser(deletedUser)),\r\n  });\r\n\r\n  return deletedUsers;\r\n};\r\n\r\nconst sanitizeUserRoles = (role: unknown) => _.pick(role, ['id', 'name', 'description', 'code']);\r\n\r\n/**\r\n * Check if a user is the last super admin\r\n * @param {int|string} userId user's id to look for\r\n */\r\nconst isLastSuperAdminUser = async (userId: unknown) => {\r\n  const user = (await findOne(userId)) as any;\r\n  const superAdminRole = await getService('role').getSuperAdminWithUsersCount();\r\n\r\n  return superAdminRole.usersCount === 1 && hasSuperAdminRole(user);\r\n};\r\n\r\n/**\r\n * Remove private user fields\r\n * @param {Object} user - user to sanitize\r\n */\r\nconst sanitizeUser = (user: any) => {\r\n  return {\r\n    ..._.omit(user, ['password', 'resetPasswordToken', 'registrationToken', 'roles']),\r\n    roles: user.roles && user.roles.map(sanitizeUserRoles),\r\n  };\r\n};\r\n\r\n/**\r\n * Find one user\r\n */\r\nconst findOne = async (id: any, populate = ['roles']) => {\r\n  return strapi.db.query('admin::user').findOne({ where: { id }, populate });\r\n};\r\n\r\nconst getCurrentActiveUserCount = async () => {\r\n  return strapi.db.query('admin::user').count({ where: { isActive: true } });\r\n};\r\n\r\nexport default {\r\n  updateEEDisabledUsersList,\r\n  removeFromEEDisabledUsersList,\r\n  getCurrentActiveUserCount,\r\n  deleteByIds,\r\n  deleteById,\r\n  updateById,\r\n};\r\n","import { assign } from 'lodash/fp';\r\nimport type { Core } from '@strapi/types';\r\nimport { getService } from '../utils';\r\n\r\nconst getSSOProvidersList = async () => {\r\n  const { providerRegistry } = strapi.service('admin::passport');\r\n\r\n  return providerRegistry.getAll().map(({ uid }: { uid: string }) => uid);\r\n};\r\n\r\nconst sendUpdateProjectInformation = async (strapi: Core.Strapi) => {\r\n  let groupProperties = {};\r\n\r\n  const numberOfActiveAdminUsers = await getService('user').count({ isActive: true });\r\n  const numberOfAdminUsers = await getService('user').count();\r\n\r\n  if (strapi.ee.features.isEnabled('sso')) {\r\n    const SSOProviders = await getSSOProvidersList();\r\n\r\n    groupProperties = assign(groupProperties, {\r\n      SSOProviders,\r\n      isSSOConfigured: SSOProviders.length !== 0,\r\n    });\r\n  }\r\n\r\n  if (strapi.ee.features.isEnabled('cms-content-releases')) {\r\n    const numberOfContentReleases = await strapi\r\n      .db!.query('plugin::content-releases.release')\r\n      .count();\r\n\r\n    const numberOfPublishedContentReleases = await strapi\r\n      .db!.query('plugin::content-releases.release')\r\n      .count({\r\n        filters: { releasedAt: { $notNull: true } },\r\n      });\r\n\r\n    groupProperties = assign(groupProperties, {\r\n      numberOfContentReleases,\r\n      numberOfPublishedContentReleases,\r\n    });\r\n  }\r\n\r\n  groupProperties = assign(groupProperties, { numberOfActiveAdminUsers, numberOfAdminUsers });\r\n\r\n  strapi.telemetry.send('didUpdateProjectInformation', {\r\n    groupProperties,\r\n  });\r\n};\r\n\r\nconst startCron = (strapi: Core.Strapi) => {\r\n  strapi.cron.add({\r\n    sendProjectInformation: {\r\n      task: () => sendUpdateProjectInformation(strapi),\r\n      options: '0 0 0 * * *',\r\n    },\r\n  });\r\n};\r\n\r\nexport default { startCron, getSSOProvidersList, sendUpdateProjectInformation };\r\n","import { take, drop, map, prop, pick, reverse, isNil } from 'lodash/fp';\r\nimport { getService } from '../utils';\r\nimport constants from '../../../../server/src/services/constants';\r\n\r\nconst { SUPER_ADMIN_CODE } = constants;\r\n\r\n/**\r\n * Keeps the list of users disabled by the seat enforcement service\r\n */\r\nconst getDisabledUserList = async () => {\r\n  return strapi.store.get({ type: 'ee', key: 'disabled_users' });\r\n};\r\n\r\nconst enableMaximumUserCount = async (numberOfUsersToEnable: number) => {\r\n  const disabledUsers = (await getDisabledUserList()) as any;\r\n  const orderedDisabledUsers = reverse(disabledUsers);\r\n\r\n  const usersToEnable = take(numberOfUsersToEnable, orderedDisabledUsers);\r\n\r\n  await strapi.db.query('admin::user').updateMany({\r\n    where: { id: map(prop('id'), usersToEnable) },\r\n    data: { isActive: true },\r\n  });\r\n\r\n  const remainingDisabledUsers = drop(numberOfUsersToEnable, orderedDisabledUsers);\r\n\r\n  await strapi.store.set({\r\n    type: 'ee',\r\n    key: 'disabled_users',\r\n    value: remainingDisabledUsers,\r\n  });\r\n};\r\n\r\nconst disableUsersAboveLicenseLimit = async (numberOfUsersToDisable: number) => {\r\n  const currentlyDisabledUsers: any = (await getDisabledUserList()) ?? [];\r\n\r\n  const usersToDisable = [];\r\n  const nonSuperAdminUsersToDisable = await strapi.db.query('admin::user').findMany({\r\n    where: {\r\n      isActive: true,\r\n      roles: {\r\n        code: { $ne: SUPER_ADMIN_CODE },\r\n      },\r\n    },\r\n    orderBy: { createdAt: 'DESC' },\r\n    limit: numberOfUsersToDisable,\r\n  });\r\n\r\n  usersToDisable.push(...nonSuperAdminUsersToDisable);\r\n\r\n  if (nonSuperAdminUsersToDisable.length < numberOfUsersToDisable) {\r\n    const superAdminUsersToDisable = await strapi.db.query('admin::user').findMany({\r\n      where: {\r\n        isActive: true,\r\n        roles: { code: SUPER_ADMIN_CODE },\r\n      },\r\n      orderBy: { createdAt: 'DESC' },\r\n      limit: numberOfUsersToDisable - nonSuperAdminUsersToDisable.length,\r\n    });\r\n\r\n    usersToDisable.push(...superAdminUsersToDisable);\r\n  }\r\n\r\n  await strapi.db.query('admin::user').updateMany({\r\n    where: { id: map(prop('id'), usersToDisable) },\r\n    data: { isActive: false },\r\n  });\r\n\r\n  await strapi.store.set({\r\n    type: 'ee',\r\n    key: 'disabled_users',\r\n    value: currentlyDisabledUsers.concat(map(pick(['id', 'isActive']), usersToDisable)),\r\n  });\r\n};\r\n\r\nconst syncDisabledUserRecords = async () => {\r\n  const disabledUsers = await strapi.store.get({ type: 'ee', key: 'disabled_users' });\r\n\r\n  if (!disabledUsers) {\r\n    return;\r\n  }\r\n\r\n  await strapi.db.query('admin::user').updateMany({\r\n    where: { id: map(prop('id'), disabledUsers) },\r\n    data: { isActive: false },\r\n  });\r\n};\r\n\r\nconst seatEnforcementWorkflow = async () => {\r\n  const adminSeats = strapi.ee.seats;\r\n  if (isNil(adminSeats)) {\r\n    return;\r\n  }\r\n\r\n  // TODO: we need to make sure an admin can decide to disable specific user and reactivate others\r\n  await syncDisabledUserRecords();\r\n\r\n  const currentActiveUserCount = await getService('user').getCurrentActiveUserCount();\r\n\r\n  const adminSeatsLeft = adminSeats - currentActiveUserCount;\r\n\r\n  if (adminSeatsLeft > 0) {\r\n    await enableMaximumUserCount(adminSeatsLeft);\r\n  } else if (adminSeatsLeft < 0) {\r\n    await disableUsersAboveLicenseLimit(-adminSeatsLeft);\r\n  }\r\n};\r\n\r\nexport default {\r\n  seatEnforcementWorkflow,\r\n  getDisabledUserList,\r\n};\r\n","import type { Core } from '@strapi/types';\r\nimport { differenceWith, isEqual } from 'lodash/fp';\r\n\r\nexport interface PersistedTable {\r\n  name: string;\r\n  dependsOn?: Array<{ name: string }>;\r\n}\r\n\r\n/**\r\n * Transform table name to the object format\r\n */\r\nconst transformTableName = (table: string | PersistedTable) => {\r\n  if (typeof table === 'string') {\r\n    return { name: table };\r\n  }\r\n  return table;\r\n};\r\n\r\n/**\r\n * Finds all tables in the database matching the regular expression\r\n * @param {Object} ctx\r\n * @param {Strapi} ctx.strapi\r\n * @param {RegExp} regex\r\n * @returns {Promise<string[]>}\r\n */\r\nexport async function findTables({ strapi }: { strapi: Core.Strapi }, regex: any) {\r\n  // @ts-expect-error - getTables is not typed into the schema inspector\r\n  const tables = await strapi.db.dialect.schemaInspector.getTables();\r\n  return tables.filter((tableName: string) => regex.test(tableName));\r\n}\r\n\r\n/**\r\n * Add tables name to the reserved tables in core store\r\n */\r\nasync function addPersistTables(\r\n  { strapi }: { strapi: Core.Strapi },\r\n  tableNames: Array<string | PersistedTable>\r\n) {\r\n  const persistedTables = await getPersistedTables({ strapi });\r\n  const tables = tableNames.map(transformTableName);\r\n\r\n  // Get new tables to be persisted, remove tables if they already were persisted\r\n  const notPersistedTableNames = differenceWith(isEqual, tables, persistedTables);\r\n  // Remove tables that are going to be changed\r\n  const tablesToPersist = differenceWith(\r\n    (t1: any, t2: any) => t1.name === t2.name,\r\n    persistedTables,\r\n    notPersistedTableNames\r\n  );\r\n\r\n  if (!notPersistedTableNames.length) {\r\n    return;\r\n  }\r\n\r\n  // @ts-expect-error lodash types\r\n  tablesToPersist.push(...notPersistedTableNames);\r\n  await strapi.store.set({\r\n    type: 'core',\r\n    key: 'persisted_tables',\r\n    value: tablesToPersist,\r\n  });\r\n}\r\n\r\n/**\r\n * Get all reserved table names from the core store\r\n * @param {Object} ctx\r\n * @param {Strapi} ctx.strapi\r\n * @param {RegExp} regex\r\n * @returns {Promise<string[]>}\r\n */\r\n\r\nasync function getPersistedTables({ strapi }: { strapi: Core.Strapi }) {\r\n  const persistedTables: any = await strapi.store.get({\r\n    type: 'core',\r\n    key: 'persisted_tables',\r\n  });\r\n\r\n  return (persistedTables || []).map(transformTableName);\r\n}\r\n\r\n/**\r\n * Set all reserved table names in the core store\r\n * @param {Object} ctx\r\n * @param {Strapi} ctx.strapi\r\n * @param {Array<string|{ table: string; dependsOn?: Array<{ table: string;}> }>} tableNames\r\n * @returns {Promise<void>}\r\n */\r\nasync function setPersistedTables(\r\n  { strapi }: { strapi: Core.Strapi },\r\n  tableNames: Array<string | PersistedTable>\r\n) {\r\n  await strapi.store.set({\r\n    type: 'core',\r\n    key: 'persisted_tables',\r\n    value: tableNames,\r\n  });\r\n}\r\n/**\r\n * Add all table names that start with a prefix to the reserved tables in\r\n * core store\r\n * @param {string} tableNamePrefix\r\n * @return {Promise<void>}\r\n */\r\n\r\nexport const persistTablesWithPrefix = async (tableNamePrefix: string) => {\r\n  const tableNameRegex = new RegExp(`^${tableNamePrefix}.*`);\r\n  const tableNames = await findTables({ strapi }, tableNameRegex);\r\n\r\n  await addPersistTables({ strapi }, tableNames);\r\n};\r\n\r\n/**\r\n * Remove all table names that end with a suffix from the reserved tables in core store\r\n * @param {string} tableNameSuffix\r\n * @return {Promise<void>}\r\n */\r\nexport const removePersistedTablesWithSuffix = async (tableNameSuffix: string) => {\r\n  const tableNameRegex = new RegExp(`.*${tableNameSuffix}$`);\r\n  const persistedTables = await getPersistedTables({ strapi });\r\n\r\n  const filteredPersistedTables = persistedTables.filter((table: any) => {\r\n    return !tableNameRegex.test(table.name);\r\n  });\r\n\r\n  if (filteredPersistedTables.length === persistedTables.length) {\r\n    return;\r\n  }\r\n\r\n  await setPersistedTables({ strapi }, filteredPersistedTables);\r\n};\r\n\r\n/**\r\n * Add tables to the reserved tables in core store\r\n */\r\nexport const persistTables = async (tables: Array<string | PersistedTable>) => {\r\n  await addPersistTables({ strapi }, tables);\r\n};\r\n\r\nexport default {\r\n  persistTablesWithPrefix,\r\n  removePersistedTablesWithSuffix,\r\n  persistTables,\r\n  findTables,\r\n};\r\n","import auth from './auth';\r\nimport passport from './passport';\r\nimport role from './role';\r\nimport user from './user';\r\nimport metrics from './metrics';\r\nimport seatEnforcement from './seat-enforcement';\r\nimport persistTables from './persist-tables';\r\n\r\nexport default {\r\n  auth,\r\n  passport,\r\n  role,\r\n  user,\r\n  metrics,\r\n  'seat-enforcement': seatEnforcement,\r\n  'persist-tables': persistTables,\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\n\r\nconst providerOptionsUpdateSchema = yup.object().shape({\r\n  autoRegister: yup.boolean().required(),\r\n  defaultRole: yup\r\n    .strapiID()\r\n    .when('autoRegister', (value, initSchema) => {\r\n      return value ? initSchema.required() : initSchema.nullable();\r\n    })\r\n    .test('is-valid-role', 'You must submit a valid default role', (roleId) => {\r\n      if (roleId === null) {\r\n        return true;\r\n      }\r\n      return strapi.service('admin::role').exists({ id: roleId });\r\n    }),\r\n  ssoLockedRoles: yup\r\n    .array()\r\n    .nullable()\r\n    .of(\r\n      yup\r\n        .strapiID()\r\n        .test(\r\n          'is-valid-role',\r\n          'You must submit a valid role for the SSO Locked roles',\r\n          (roleId) => {\r\n            return strapi.service('admin::role').exists({ id: roleId });\r\n          }\r\n        )\r\n    ),\r\n});\r\n\r\nexport const validateProviderOptionsUpdate = validateYupSchema(providerOptionsUpdateSchema);\r\n\r\nexport default {\r\n  validateProviderOptionsUpdate,\r\n};\r\n","export const PROVIDER_REDIRECT_BASE = '/auth/login';\r\nexport const PROVIDER_REDIRECT_SUCCESS = `${PROVIDER_REDIRECT_BASE}/success`;\r\nexport const PROVIDER_REDIRECT_ERROR = `${PROVIDER_REDIRECT_BASE}/error`;\r\n\r\nexport default {\r\n  PROVIDER_REDIRECT_BASE,\r\n  PROVIDER_REDIRECT_SUCCESS,\r\n  PROVIDER_REDIRECT_ERROR,\r\n};\r\n","import { mapValues } from 'lodash/fp';\r\nimport { PROVIDER_REDIRECT_ERROR, PROVIDER_REDIRECT_SUCCESS } from './constants';\r\n\r\nconst PROVIDER_URLS_MAP = {\r\n  success: PROVIDER_REDIRECT_SUCCESS,\r\n  error: PROVIDER_REDIRECT_ERROR,\r\n};\r\n\r\nexport const getAdminStore = async () => strapi.store({ type: 'core', name: 'admin' });\r\n\r\nexport const getPrefixedRedirectUrls = () => {\r\n  const { url: adminUrl } = strapi.config.get('admin') as any;\r\n  const prefixUrl = (url: string) => `${adminUrl || '/admin'}${url}`;\r\n\r\n  return mapValues(prefixUrl, PROVIDER_URLS_MAP);\r\n};\r\n\r\nexport default {\r\n  getAdminStore,\r\n  getPrefixedRedirectUrls,\r\n};\r\n","import type { Core } from '@strapi/types';\r\nimport passport from 'koa-passport';\r\nimport { getService } from '../../utils';\r\nimport utils from './utils';\r\n\r\nconst defaultConnectionError = () => new Error('Invalid connection payload');\r\n\r\nexport const authenticate: Core.MiddlewareHandler = async (ctx, next) => {\r\n  const {\r\n    params: { provider },\r\n  } = ctx;\r\n  const redirectUrls = utils.getPrefixedRedirectUrls();\r\n\r\n  // @ts-expect-error - can not use null to authenticate\r\n  return passport.authenticate(provider, null, async (error, profile) => {\r\n    if (error || !profile || !profile.email) {\r\n      if (error) {\r\n        strapi.log.error(error);\r\n      }\r\n\r\n      strapi.eventHub.emit('admin.auth.error', {\r\n        error: error || defaultConnectionError(),\r\n        provider,\r\n      });\r\n\r\n      return ctx.redirect(redirectUrls.error);\r\n    }\r\n\r\n    const user = await getService('user').findOneByEmail(profile.email);\r\n    const scenario = user ? existingUserScenario : nonExistingUserScenario;\r\n\r\n    return scenario(ctx, next)(user || profile, provider);\r\n  })(ctx, next);\r\n};\r\n\r\nconst existingUserScenario: Core.MiddlewareHandler =\r\n  (ctx, next) => async (user: any, provider: any) => {\r\n    const redirectUrls = utils.getPrefixedRedirectUrls();\r\n\r\n    if (!user.isActive) {\r\n      strapi.eventHub.emit('admin.auth.error', {\r\n        error: new Error(`Deactivated user tried to login (${user.id})`),\r\n        provider,\r\n      });\r\n      return ctx.redirect(redirectUrls.error);\r\n    }\r\n\r\n    ctx.state.user = user;\r\n    return next();\r\n  };\r\n\r\nconst nonExistingUserScenario: Core.MiddlewareHandler =\r\n  (ctx, next) => async (profile: any, provider: any) => {\r\n    const { email, firstname, lastname, username } = profile;\r\n    const redirectUrls = utils.getPrefixedRedirectUrls();\r\n    const adminStore = await utils.getAdminStore();\r\n    const { providers } = (await adminStore.get({ key: 'auth' })) as any;\r\n\r\n    // We need at least the username or the firstname/lastname combination to register a new user\r\n    const isMissingRegisterFields = !username && (!firstname || !lastname);\r\n\r\n    if (!providers.autoRegister || !providers.defaultRole || isMissingRegisterFields) {\r\n      strapi.eventHub.emit('admin.auth.error', { error: defaultConnectionError(), provider });\r\n      return ctx.redirect(redirectUrls.error);\r\n    }\r\n\r\n    const defaultRole = await getService('role').findOne({ id: providers.defaultRole });\r\n\r\n    // If the default role has been misconfigured, redirect with an error\r\n    if (!defaultRole) {\r\n      strapi.eventHub.emit('admin.auth.error', { error: defaultConnectionError(), provider });\r\n      return ctx.redirect(redirectUrls.error);\r\n    }\r\n\r\n    // Register a new user with the information given by the provider and login with it\r\n    ctx.state.user = await getService('user').create({\r\n      email,\r\n      username,\r\n      firstname,\r\n      lastname,\r\n      roles: [defaultRole.id],\r\n      isActive: true,\r\n      registrationToken: null,\r\n    });\r\n\r\n    strapi.eventHub.emit('admin.auth.autoRegistration', {\r\n      user: ctx.state.user,\r\n      provider,\r\n    });\r\n\r\n    return next();\r\n  };\r\n\r\nexport const redirectWithAuth: Core.MiddlewareHandler = (ctx) => {\r\n  const {\r\n    params: { provider },\r\n  } = ctx;\r\n  const redirectUrls = utils.getPrefixedRedirectUrls();\r\n  const domain: string | undefined = strapi.config.get('admin.auth.domain');\r\n  const { user } = ctx.state;\r\n\r\n  const jwt = getService('token').createJwtToken(user);\r\n\r\n  const isProduction = strapi.config.get('environment') === 'production';\r\n\r\n  const cookiesOptions = { httpOnly: false, secure: isProduction, overwrite: true, domain };\r\n\r\n  const sanitizedUser = getService('user').sanitizeUser(user);\r\n  strapi.eventHub.emit('admin.auth.success', { user: sanitizedUser, provider });\r\n\r\n  ctx.cookies.set('jwtToken', jwt, cookiesOptions);\r\n  ctx.redirect(redirectUrls.success);\r\n};\r\n\r\nexport default {\r\n  authenticate,\r\n  redirectWithAuth,\r\n};\r\n","import type { Context, Next } from 'koa';\r\n\r\nimport { pick } from 'lodash/fp';\r\nimport compose from 'koa-compose';\r\nimport { errors } from '@strapi/utils';\r\nimport { validateProviderOptionsUpdate } from '../validation/authentication';\r\nimport { middlewares, utils } from './authentication-utils';\r\n\r\nconst toProviderDTO = pick(['uid', 'displayName', 'icon']);\r\nconst toProviderLoginOptionsDTO = pick(['autoRegister', 'defaultRole', 'ssoLockedRoles']);\r\n\r\nconst { ValidationError } = errors;\r\n\r\nconst providerAuthenticationFlow = compose([\r\n  middlewares.authenticate,\r\n  middlewares.redirectWithAuth,\r\n]);\r\n\r\nexport default {\r\n  async getProviders(ctx: Context) {\r\n    const { providerRegistry } = strapi.service('admin::passport');\r\n\r\n    ctx.body = providerRegistry.getAll().map(toProviderDTO);\r\n  },\r\n\r\n  async getProviderLoginOptions(ctx: Context) {\r\n    const adminStore = await utils.getAdminStore();\r\n    const { providers: providersOptions } = (await adminStore.get({ key: 'auth' })) as any;\r\n\r\n    ctx.body = {\r\n      data: toProviderLoginOptionsDTO(providersOptions),\r\n    };\r\n  },\r\n\r\n  async updateProviderLoginOptions(ctx: Context) {\r\n    const {\r\n      request: { body },\r\n    } = ctx;\r\n\r\n    await validateProviderOptionsUpdate(body);\r\n\r\n    const adminStore = await utils.getAdminStore();\r\n    const currentAuthOptions = (await adminStore.get({ key: 'auth' })) as any;\r\n    const newAuthOptions = { ...currentAuthOptions, providers: body };\r\n    await adminStore.set({ key: 'auth', value: newAuthOptions });\r\n\r\n    strapi.telemetry.send('didUpdateSSOSettings');\r\n\r\n    ctx.body = {\r\n      data: toProviderLoginOptionsDTO(newAuthOptions.providers),\r\n    };\r\n  },\r\n\r\n  providerLogin(ctx: Context, next: Next) {\r\n    const {\r\n      params: { provider: providerName },\r\n    } = ctx;\r\n\r\n    const { providerRegistry } = strapi.service('admin::passport');\r\n\r\n    if (!providerRegistry.has(providerName)) {\r\n      throw new ValidationError(`Invalid provider supplied: ${providerName}`);\r\n    }\r\n\r\n    return providerAuthenticationFlow(ctx, next);\r\n  },\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\n\r\nconst roleCreateSchema = yup\r\n  .object()\r\n  .shape({\r\n    name: yup.string().min(1).required(),\r\n    description: yup.string().nullable(),\r\n  })\r\n  .noUnknown();\r\n\r\nconst rolesDeleteSchema = yup\r\n  .object()\r\n  .shape({\r\n    ids: yup\r\n      .array()\r\n      .of(yup.strapiID())\r\n      .min(1)\r\n      .required()\r\n      .test(\r\n        'roles-deletion-checks',\r\n        'Roles deletion checks have failed',\r\n        async function rolesDeletionChecks(ids) {\r\n          try {\r\n            await strapi.service('admin::role').checkRolesIdForDeletion(ids);\r\n\r\n            if (strapi.ee.features.isEnabled('sso')) {\r\n              await strapi.service('admin::role').ssoCheckRolesIdForDeletion(ids);\r\n            }\r\n          } catch (e: any) {\r\n            return this.createError({ path: 'ids', message: e.message });\r\n          }\r\n\r\n          return true;\r\n        }\r\n      ),\r\n  })\r\n  .noUnknown();\r\n\r\nconst roleDeleteSchema = yup\r\n  .strapiID()\r\n  .required()\r\n  .test(\r\n    'no-admin-single-delete',\r\n    'Role deletion checks have failed',\r\n    async function noAdminSingleDelete(id) {\r\n      try {\r\n        await strapi.service('admin::role').checkRolesIdForDeletion([id]);\r\n\r\n        if (strapi.ee.features.isEnabled('sso')) {\r\n          await strapi.service('admin::role').ssoCheckRolesIdForDeletion([id]);\r\n        }\r\n      } catch (e: any) {\r\n        return this.createError({ path: 'id', message: e.message });\r\n      }\r\n\r\n      return true;\r\n    }\r\n  );\r\n\r\nexport const validateRoleCreateInput = validateYupSchema(roleCreateSchema);\r\nexport const validateRolesDeleteInput = validateYupSchema(rolesDeleteSchema);\r\nexport const validateRoleDeleteInput = validateYupSchema(roleDeleteSchema);\r\n\r\nexport default {\r\n  validateRoleCreateInput,\r\n  validateRolesDeleteInput,\r\n  validateRoleDeleteInput,\r\n};\r\n","import type { Context } from 'koa';\r\n\r\nimport {\r\n  validateRoleCreateInput,\r\n  validateRoleDeleteInput,\r\n  validateRolesDeleteInput,\r\n} from '../validation/role';\r\nimport { getService } from '../utils';\r\n\r\nexport default {\r\n  /**\r\n   * Create a new role\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async create(ctx: Context) {\r\n    await validateRoleCreateInput(ctx.request.body);\r\n\r\n    const roleService = getService('role');\r\n\r\n    const role = await roleService.create(ctx.request.body);\r\n    const sanitizedRole = roleService.sanitizeRole(role);\r\n\r\n    ctx.created({ data: sanitizedRole });\r\n  },\r\n\r\n  /**\r\n   * Delete a role\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async deleteOne(ctx: Context) {\r\n    const { id } = ctx.params;\r\n\r\n    await validateRoleDeleteInput(id);\r\n\r\n    const roleService = getService('role');\r\n\r\n    const roles = await roleService.deleteByIds([id]);\r\n\r\n    const sanitizedRole = roles.map((role: unknown) => roleService.sanitizeRole(role))[0] || null;\r\n\r\n    return ctx.deleted({\r\n      data: sanitizedRole,\r\n    });\r\n  },\r\n\r\n  /**\r\n   * delete several roles\r\n   * @param {KoaContext} ctx - koa context\r\n   */\r\n  async deleteMany(ctx: Context) {\r\n    const { body } = ctx.request;\r\n\r\n    await validateRolesDeleteInput(body);\r\n\r\n    const roleService = getService('role');\r\n\r\n    const roles = await roleService.deleteByIds(body.ids);\r\n    const sanitizedRoles = roles.map(roleService.sanitizeRole);\r\n\r\n    return ctx.deleted({\r\n      data: sanitizedRoles,\r\n    });\r\n  },\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\nimport { schemas } from '../../../../server/src/validation/user';\r\n\r\nconst ssoUserCreationInputExtension = yup\r\n  .object()\r\n  .shape({\r\n    useSSORegistration: yup.boolean(),\r\n  })\r\n  .noUnknown();\r\n\r\nexport const validateUserCreationInput = (data: any) => {\r\n  let schema = schemas.userCreationSchema;\r\n\r\n  if (strapi.ee.features.isEnabled('sso')) {\r\n    schema = schema.concat(ssoUserCreationInputExtension);\r\n  }\r\n\r\n  return validateYupSchema(schema)(data);\r\n};\r\n\r\nexport default {\r\n  validateUserCreationInput,\r\n};\r\n","import type { Context } from 'koa';\r\n\r\nimport _ from 'lodash';\r\nimport { pick, isNil } from 'lodash/fp';\r\nimport { errors } from '@strapi/utils';\r\nimport { validateUserCreationInput } from '../validation/user';\r\nimport { validateUserUpdateInput } from '../../../../server/src/validation/user';\r\nimport { getService } from '../utils';\r\nimport { isSsoLocked } from '../utils/sso-lock';\r\n\r\nconst { ApplicationError, ForbiddenError } = errors;\r\n\r\nconst pickUserCreationAttributes = pick(['firstname', 'lastname', 'email', 'roles']);\r\n\r\nconst hasAdminSeatsAvaialble = async () => {\r\n  if (!strapi.EE) {\r\n    return true;\r\n  }\r\n\r\n  const permittedSeats = strapi.ee.seats as any;\r\n  if (isNil(permittedSeats)) {\r\n    return true;\r\n  }\r\n\r\n  const userCount = await strapi.service('admin::user').getCurrentActiveUserCount();\r\n\r\n  if (userCount < permittedSeats) {\r\n    return true;\r\n  }\r\n};\r\n\r\nexport default {\r\n  async create(ctx: Context) {\r\n    if (!(await hasAdminSeatsAvaialble())) {\r\n      throw new ForbiddenError('License seat limit reached. You cannot create a new user');\r\n    }\r\n\r\n    const { body } = ctx.request;\r\n    const cleanData = { ...body, email: _.get(body, `email`, ``).toLowerCase() };\r\n\r\n    await validateUserCreationInput(cleanData);\r\n\r\n    const attributes = pickUserCreationAttributes(cleanData);\r\n    const { useSSORegistration } = cleanData;\r\n\r\n    const userAlreadyExists = await getService('user').exists({ email: attributes.email });\r\n\r\n    if (userAlreadyExists) {\r\n      throw new ApplicationError('Email already taken');\r\n    }\r\n\r\n    if (useSSORegistration) {\r\n      Object.assign(attributes, { registrationToken: null, isActive: true });\r\n    }\r\n\r\n    const createdUser = await getService('user').create(attributes);\r\n    const userInfo = getService('user').sanitizeUser(createdUser);\r\n\r\n    // Note: We need to assign manually the registrationToken to the\r\n    // final user payload so that it's not removed in the sanitation process.\r\n    Object.assign(userInfo, { registrationToken: createdUser.registrationToken });\r\n\r\n    ctx.created({ data: userInfo });\r\n  },\r\n\r\n  async update(ctx: Context) {\r\n    const { id } = ctx.params;\r\n    const { body: input } = ctx.request;\r\n\r\n    await validateUserUpdateInput(input);\r\n\r\n    if (_.has(input, 'email')) {\r\n      const uniqueEmailCheck = await getService('user').exists({\r\n        id: { $ne: id },\r\n        email: input.email,\r\n      });\r\n\r\n      if (uniqueEmailCheck) {\r\n        throw new ApplicationError('A user with this email address already exists');\r\n      }\r\n    }\r\n\r\n    const user = await getService('user').findOne(id, null);\r\n\r\n    if (!(await hasAdminSeatsAvaialble()) && !user.isActive && input.isActive) {\r\n      throw new ForbiddenError('License seat limit reached. You cannot active this user');\r\n    }\r\n\r\n    const updatedUser = await getService('user').updateById(id, input);\r\n\r\n    if (!updatedUser) {\r\n      return ctx.notFound('User does not exist');\r\n    }\r\n\r\n    ctx.body = {\r\n      data: getService('user').sanitizeUser(updatedUser),\r\n    };\r\n  },\r\n\r\n  async isSSOLocked(ctx: Context) {\r\n    const { user } = ctx.state;\r\n    const isSSOLocked = await isSsoLocked(user);\r\n\r\n    ctx.body = {\r\n      data: {\r\n        isSSOLocked,\r\n      },\r\n    };\r\n  },\r\n};\r\n","import { isNil } from 'lodash/fp';\r\nimport { env } from '@strapi/utils';\r\nimport { getService } from '../utils';\r\n\r\nexport default {\r\n  // NOTE: Overrides CE admin controller\r\n  async getProjectType() {\r\n    const flags = strapi.config.get('admin.flags', {});\r\n    try {\r\n      return { data: { isEE: strapi.EE, features: strapi.ee.features.list(), flags } };\r\n    } catch (err) {\r\n      return { data: { isEE: false, features: [], flags } };\r\n    }\r\n  },\r\n\r\n  async licenseLimitInformation() {\r\n    const permittedSeats = strapi.ee.seats;\r\n\r\n    let shouldNotify = false;\r\n    let licenseLimitStatus = null;\r\n    let enforcementUserCount;\r\n\r\n    const currentActiveUserCount = await getService('user').getCurrentActiveUserCount();\r\n\r\n    const eeDisabledUsers = await getService('seat-enforcement').getDisabledUserList();\r\n\r\n    if (eeDisabledUsers) {\r\n      enforcementUserCount = currentActiveUserCount + eeDisabledUsers.length;\r\n    } else {\r\n      enforcementUserCount = currentActiveUserCount;\r\n    }\r\n\r\n    if (!isNil(permittedSeats) && enforcementUserCount > permittedSeats) {\r\n      shouldNotify = true;\r\n      licenseLimitStatus = 'OVER_LIMIT';\r\n    }\r\n\r\n    if (!isNil(permittedSeats) && enforcementUserCount === permittedSeats) {\r\n      shouldNotify = true;\r\n      licenseLimitStatus = 'AT_LIMIT';\r\n    }\r\n\r\n    const data = {\r\n      enforcementUserCount,\r\n      currentActiveUserCount,\r\n      permittedSeats,\r\n      shouldNotify,\r\n      shouldStopCreate: isNil(permittedSeats) ? false : currentActiveUserCount >= permittedSeats,\r\n      licenseLimitStatus,\r\n      isHostedOnStrapiCloud: env('STRAPI_HOSTING', null) === 'strapi.cloud',\r\n      features: strapi.ee.features.list() ?? [],\r\n    };\r\n\r\n    return { data };\r\n  },\r\n};\r\n","import type {} from 'koa-body';\r\n\r\nimport authentication from './authentication';\r\nimport role from './role';\r\nimport user from './user';\r\nimport admin from './admin';\r\n\r\nexport default {\r\n  authentication,\r\n  role,\r\n  user,\r\n  admin,\r\n};\r\n","import type { Core } from '@strapi/types';\r\n\r\nexport const enableFeatureMiddleware =\r\n  (featureName: string): Core.MiddlewareHandler =>\r\n  (ctx, next) => {\r\n    if (strapi.ee.features.isEnabled(featureName)) {\r\n      return next();\r\n    }\r\n\r\n    ctx.status = 404;\r\n  };\r\n","import { enableFeatureMiddleware } from './utils';\r\n\r\nexport default {\r\n  type: 'admin',\r\n  routes: [\r\n    {\r\n      method: 'GET',\r\n      path: '/providers',\r\n      handler: 'authentication.getProviders',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('sso')],\r\n        auth: false,\r\n      },\r\n    },\r\n    {\r\n      method: 'GET',\r\n      path: '/connect/:provider',\r\n      handler: 'authentication.providerLogin',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('sso')],\r\n        auth: false,\r\n      },\r\n    },\r\n    {\r\n      method: 'POST',\r\n      path: '/connect/:provider',\r\n      handler: 'authentication.providerLogin',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('sso')],\r\n        auth: false,\r\n      },\r\n    },\r\n    {\r\n      method: 'GET',\r\n      path: '/providers/options',\r\n      handler: 'authentication.getProviderLoginOptions',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('sso')],\r\n        policies: [\r\n          'admin::isAuthenticatedAdmin',\r\n          { name: 'admin::hasPermissions', config: { actions: ['admin::provider-login.read'] } },\r\n        ],\r\n      },\r\n    },\r\n    {\r\n      method: 'PUT',\r\n      path: '/providers/options',\r\n      handler: 'authentication.updateProviderLoginOptions',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('sso')],\r\n        policies: [\r\n          'admin::isAuthenticatedAdmin',\r\n          { name: 'admin::hasPermissions', config: { actions: ['admin::provider-login.update'] } },\r\n        ],\r\n      },\r\n    },\r\n    {\r\n      method: 'GET',\r\n      path: '/providers/isSSOLocked',\r\n      handler: 'user.isSSOLocked',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('sso')],\r\n        policies: ['admin::isAuthenticatedAdmin'],\r\n      },\r\n    },\r\n  ],\r\n};\r\n","export default {\r\n  type: 'admin',\r\n  routes: [\r\n    // License limit infos\r\n    {\r\n      method: 'GET',\r\n      path: '/license-limit-information',\r\n      handler: 'admin.licenseLimitInformation',\r\n      config: {\r\n        policies: [\r\n          'admin::isAuthenticatedAdmin',\r\n          {\r\n            name: 'admin::hasPermissions',\r\n            config: {\r\n              actions: [\r\n                'admin::users.create',\r\n                'admin::users.read',\r\n                'admin::users.update',\r\n                'admin::users.delete',\r\n              ],\r\n            },\r\n          },\r\n        ],\r\n      },\r\n    },\r\n  ],\r\n};\r\n","import sso from './sso';\r\nimport licenseLimit from './license-limit';\r\n\r\nexport default {\r\n  sso,\r\n  'license-limit': licenseLimit,\r\n};\r\n","import { enableFeatureMiddleware } from '../../routes/utils';\r\n\r\nexport default {\r\n  type: 'admin',\r\n  routes: [\r\n    {\r\n      method: 'GET',\r\n      path: '/audit-logs',\r\n      handler: 'audit-logs.findMany',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('audit-logs')],\r\n        policies: [\r\n          'admin::isAuthenticatedAdmin',\r\n          {\r\n            name: 'admin::hasPermissions',\r\n            config: {\r\n              actions: ['admin::audit-logs.read'],\r\n            },\r\n          },\r\n        ],\r\n      },\r\n    },\r\n    {\r\n      method: 'GET',\r\n      path: '/audit-logs/:id',\r\n      handler: 'audit-logs.findOne',\r\n      config: {\r\n        middlewares: [enableFeatureMiddleware('audit-logs')],\r\n        policies: [\r\n          'admin::isAuthenticatedAdmin',\r\n          {\r\n            name: 'admin::hasPermissions',\r\n            config: {\r\n              actions: ['admin::audit-logs.read'],\r\n            },\r\n          },\r\n        ],\r\n      },\r\n    },\r\n  ],\r\n};\r\n","import { yup, validateYupSchema } from '@strapi/utils';\r\n\r\nconst ALLOWED_SORT_STRINGS = ['action:ASC', 'action:DESC', 'date:ASC', 'date:DESC'];\r\n\r\nconst validateFindManySchema = yup\r\n  .object()\r\n  .shape({\r\n    page: yup.number().integer().min(1),\r\n    pageSize: yup.number().integer().min(1).max(100),\r\n    sort: yup.mixed().oneOf(ALLOWED_SORT_STRINGS),\r\n  })\r\n  .required();\r\n\r\nexport const validateFindMany = validateYupSchema(validateFindManySchema, { strict: false });\r\n\r\nexport default {\r\n  validateFindMany,\r\n};\r\n","import type { Context } from 'koa';\r\n\r\nimport { validateFindMany } from '../validation/audit-logs';\r\n\r\nexport default {\r\n  async findMany(ctx: Context) {\r\n    const { query } = ctx.request;\r\n    await validateFindMany(query);\r\n\r\n    const auditLogs = strapi.get('audit-logs');\r\n    const body = await auditLogs.findMany(query);\r\n\r\n    ctx.body = body;\r\n  },\r\n\r\n  async findOne(ctx: Context) {\r\n    const { id } = ctx.params;\r\n\r\n    const auditLogs = strapi.get('audit-logs');\r\n    const body = await auditLogs.findOne(id);\r\n\r\n    ctx.body = body;\r\n\r\n    strapi.telemetry.send('didWatchAnAuditLog');\r\n  },\r\n};\r\n","import type { Core } from '@strapi/types';\r\n\r\ninterface Event {\r\n  action: string;\r\n  date: Date;\r\n  userId: string | number;\r\n  payload: Record<string, unknown>;\r\n}\r\n\r\ninterface Log extends Omit<Event, 'userId'> {\r\n  user: string | number;\r\n}\r\n\r\nconst getSanitizedUser = (user: any) => {\r\n  let displayName = user.email;\r\n\r\n  if (user.username) {\r\n    displayName = user.username;\r\n  } else if (user.firstname && user.lastname) {\r\n    displayName = `${user.firstname} ${user.lastname}`;\r\n  }\r\n\r\n  return {\r\n    id: user.id,\r\n    email: user.email,\r\n    displayName,\r\n  };\r\n};\r\n\r\n/**\r\n * @description\r\n * Manages audit logs interaction with the database. Accessible via strapi.get('audit-logs')\r\n */\r\nconst createAuditLogsService = (strapi: Core.Strapi) => {\r\n  return {\r\n    async saveEvent(event: Event) {\r\n      const { userId, ...rest } = event;\r\n\r\n      const auditLog: Log = { ...rest, user: userId };\r\n\r\n      // Save to database\r\n      await strapi.db?.query('admin::audit-log').create({ data: auditLog });\r\n\r\n      return this;\r\n    },\r\n\r\n    async findMany(query: unknown) {\r\n      const { results, pagination } = await strapi.db?.query('admin::audit-log').findPage({\r\n        populate: ['user'],\r\n        select: ['action', 'date', 'payload'],\r\n        ...strapi.get('query-params').transform('admin::audit-log', query),\r\n      });\r\n\r\n      const sanitizedResults = results.map((result: any) => {\r\n        const { user, ...rest } = result;\r\n        return {\r\n          ...rest,\r\n          user: user ? getSanitizedUser(user) : null,\r\n        };\r\n      });\r\n\r\n      return {\r\n        results: sanitizedResults,\r\n        pagination,\r\n      };\r\n    },\r\n\r\n    async findOne(id: unknown) {\r\n      const result: any = await strapi.db?.query('admin::audit-log').findOne({\r\n        where: { id },\r\n        populate: ['user'],\r\n        select: ['action', 'date', 'payload'],\r\n      });\r\n\r\n      if (!result) {\r\n        return null;\r\n      }\r\n\r\n      const { user, ...rest } = result;\r\n      return {\r\n        ...rest,\r\n        user: user ? getSanitizedUser(user) : null,\r\n      };\r\n    },\r\n\r\n    deleteExpiredEvents(expirationDate: Date) {\r\n      return strapi.db?.query('admin::audit-log').deleteMany({\r\n        where: {\r\n          date: {\r\n            $lt: expirationDate.toISOString(),\r\n          },\r\n        },\r\n      });\r\n    },\r\n  };\r\n};\r\n\r\nexport { createAuditLogsService };\r\n","import type { Core } from '@strapi/types';\r\nimport { scheduleJob } from 'node-schedule';\r\n\r\nconst DEFAULT_RETENTION_DAYS = 90;\r\n\r\nconst defaultEvents = [\r\n  'entry.create',\r\n  'entry.update',\r\n  'entry.delete',\r\n  'entry.publish',\r\n  'entry.unpublish',\r\n  'media.create',\r\n  'media.update',\r\n  'media.delete',\r\n  'media-folder.create',\r\n  'media-folder.update',\r\n  'media-folder.delete',\r\n  'user.create',\r\n  'user.update',\r\n  'user.delete',\r\n  'admin.auth.success',\r\n  'admin.logout',\r\n  'content-type.create',\r\n  'content-type.update',\r\n  'content-type.delete',\r\n  'component.create',\r\n  'component.update',\r\n  'component.delete',\r\n  'role.create',\r\n  'role.update',\r\n  'role.delete',\r\n  'permission.create',\r\n  'permission.update',\r\n  'permission.delete',\r\n];\r\n\r\nconst getEventMap = (defaultEvents: any) => {\r\n  const getDefaultPayload = (...args: any) => args[0];\r\n\r\n  // Use the default payload for all default events\r\n  return defaultEvents.reduce((acc: any, event: any) => {\r\n    acc[event] = getDefaultPayload;\r\n    return acc;\r\n  }, {} as any);\r\n};\r\n\r\nconst getRetentionDays = (strapi: Core.Strapi) => {\r\n  const featureConfig = strapi.ee.features.get('audit-logs');\r\n  const licenseRetentionDays =\r\n    typeof featureConfig === 'object' && featureConfig?.options.retentionDays;\r\n  const userRetentionDays = strapi.config.get('admin.auditLogs.retentionDays');\r\n\r\n  // For enterprise plans, use 90 days by default, but allow users to override it\r\n  if (licenseRetentionDays == null) {\r\n    return userRetentionDays ?? DEFAULT_RETENTION_DAYS;\r\n  }\r\n\r\n  // Allow users to override the license retention days, but not to increase it\r\n  if (userRetentionDays && userRetentionDays < licenseRetentionDays) {\r\n    return userRetentionDays;\r\n  }\r\n\r\n  // User didn't provide a retention days value, use the license one\r\n  return licenseRetentionDays;\r\n};\r\n\r\n/**\r\n * @description\r\n * Manages the the lifecycle of audit logs. Accessible via strapi.get('audit-logs-lifecycles')\r\n */\r\nconst createAuditLogsLifecycleService = (strapi: Core.Strapi) => {\r\n  // Manage internal service state privately\r\n  const state = {} as any;\r\n  const auditLogsService = strapi.get('audit-logs');\r\n\r\n  // NOTE: providers should be able to replace getEventMap to add or remove events\r\n  const eventMap = getEventMap(defaultEvents);\r\n\r\n  const processEvent = (name: string, ...args: any) => {\r\n    const requestState = strapi.requestContext.get()?.state;\r\n\r\n    // Ignore events with auth strategies different from admin\r\n    const isUsingAdminAuth = requestState?.route.info.type === 'admin';\r\n    const user = requestState?.user;\r\n    if (!isUsingAdminAuth || !user) {\r\n      return null;\r\n    }\r\n\r\n    const getPayload = eventMap[name];\r\n\r\n    // Ignore the event if it's not in the map\r\n    if (!getPayload) {\r\n      return null;\r\n    }\r\n\r\n    // Ignore some events based on payload\r\n    // TODO: What does this ignore in upload? Why would we want to ignore anything?\r\n    const ignoredUids = ['plugin::upload.file', 'plugin::upload.folder'];\r\n    if (ignoredUids.includes(args[0]?.uid)) {\r\n      return null;\r\n    }\r\n\r\n    return {\r\n      action: name,\r\n      date: new Date().toISOString(),\r\n      payload: getPayload(...args) || {},\r\n      userId: user.id,\r\n    };\r\n  };\r\n\r\n  const handleEvent = async (name: string, ...args: any) => {\r\n    const processedEvent = processEvent(name, ...args);\r\n\r\n    if (processedEvent) {\r\n      await auditLogsService.saveEvent(processedEvent);\r\n    }\r\n  };\r\n\r\n  return {\r\n    async register() {\r\n      // Handle license being enabled\r\n      if (!state.eeEnableUnsubscribe) {\r\n        // @ts-expect-error- update event hub to receive callback argument\r\n        state.eeEnableUnsubscribe = strapi.eventHub.on('ee.enable', () => {\r\n          // Recreate the service to use the new license info\r\n          this.destroy();\r\n          this.register();\r\n        });\r\n      }\r\n\r\n      // Handle license being updated\r\n      if (!state.eeUpdateUnsubscribe) {\r\n        // @ts-expect-error- update event hub to receive callback argument\r\n        state.eeUpdateUnsubscribe = strapi.eventHub.on('ee.update', () => {\r\n          // Recreate the service to use the new license info\r\n          this.destroy();\r\n          this.register();\r\n        });\r\n      }\r\n\r\n      // Handle license being disabled\r\n      // @ts-expect-error- update event hub to receive callback argument\r\n      state.eeDisableUnsubscribe = strapi.eventHub.on('ee.disable', () => {\r\n        // Turn off service when the license gets disabled\r\n        // Only ee.enable and ee.update listeners remain active to recreate the service\r\n        this.destroy();\r\n      });\r\n\r\n      // Check current state of license\r\n      if (!strapi.ee.features.isEnabled('audit-logs')) {\r\n        return this;\r\n      }\r\n\r\n      // Start saving events\r\n      state.eventHubUnsubscribe = strapi.eventHub.subscribe(handleEvent);\r\n\r\n      // Manage audit logs auto deletion\r\n      const retentionDays = getRetentionDays(strapi);\r\n      state.deleteExpiredJob = scheduleJob('0 0 * * *', () => {\r\n        const expirationDate = new Date(Date.now() - retentionDays * 24 * 60 * 60 * 1000);\r\n        auditLogsService.deleteExpiredEvents(expirationDate);\r\n      });\r\n\r\n      return this;\r\n    },\r\n\r\n    unsubscribe() {\r\n      if (state.eeDisableUnsubscribe) {\r\n        state.eeDisableUnsubscribe();\r\n      }\r\n\r\n      if (state.eventHubUnsubscribe) {\r\n        state.eventHubUnsubscribe();\r\n      }\r\n\r\n      if (state.deleteExpiredJob) {\r\n        state.deleteExpiredJob.cancel();\r\n      }\r\n\r\n      return this;\r\n    },\r\n\r\n    destroy() {\r\n      return this.unsubscribe();\r\n    },\r\n  };\r\n};\r\n\r\nexport { createAuditLogsLifecycleService };\r\n","export const auditLog = {\r\n  schema: {\r\n    kind: 'collectionType',\r\n    collectionName: 'strapi_audit_logs',\r\n    info: {\r\n      singularName: 'audit-log',\r\n      pluralName: 'audit-logs',\r\n      displayName: 'Audit Log',\r\n    },\r\n    options: {\r\n      timestamps: false,\r\n    },\r\n    pluginOptions: {\r\n      'content-manager': {\r\n        visible: false,\r\n      },\r\n      'content-type-builder': {\r\n        visible: false,\r\n      },\r\n    },\r\n    attributes: {\r\n      action: {\r\n        type: 'string',\r\n        required: true,\r\n      },\r\n      date: {\r\n        type: 'datetime',\r\n        required: true,\r\n      },\r\n      user: {\r\n        type: 'relation',\r\n        relation: 'oneToOne',\r\n        target: 'admin::user',\r\n      },\r\n      payload: {\r\n        type: 'json',\r\n      },\r\n    },\r\n  },\r\n};\r\n","import register from './register';\r\nimport bootstrap from './bootstrap';\r\nimport destroy from './destroy';\r\nimport adminContentTypes from './content-types';\r\nimport services from './services';\r\nimport controllers from './controllers';\r\nimport routes from './routes';\r\nimport auditLogsRoutes from './audit-logs/routes/audit-logs';\r\nimport auditLogsController from './audit-logs/controllers/audit-logs';\r\nimport { createAuditLogsService } from './audit-logs/services/audit-logs';\r\nimport { createAuditLogsLifecycleService } from './audit-logs/services/lifecycles';\r\nimport { auditLog } from './audit-logs/content-types/audit-log';\r\nimport { Core } from '@strapi/types';\r\n\r\nconst getAdminEE = () => {\r\n  const eeAdmin = {\r\n    register,\r\n    bootstrap,\r\n    destroy,\r\n    contentTypes: {\r\n      // Always register the audit-log content type to prevent data loss\r\n      'audit-log': auditLog,\r\n      ...adminContentTypes,\r\n    },\r\n    services,\r\n    controllers,\r\n    routes,\r\n  };\r\n\r\n  // Only add the other audit-logs APIs if the feature is enabled by the user and the license\r\n  if (\r\n    strapi.config.get('admin.auditLogs.enabled', true) &&\r\n    strapi.ee.features.isEnabled('audit-logs')\r\n  ) {\r\n    return {\r\n      ...eeAdmin,\r\n      controllers: {\r\n        ...eeAdmin.controllers,\r\n        'audit-logs': auditLogsController,\r\n      },\r\n      routes: {\r\n        ...eeAdmin.routes,\r\n        'audit-logs': auditLogsRoutes,\r\n      },\r\n      async register({ strapi }: { strapi: Core.Strapi }) {\r\n        // Run the the default registration\r\n        await eeAdmin.register({ strapi });\r\n        // Register an internal audit logs service\r\n        strapi.add('audit-logs', createAuditLogsService(strapi));\r\n        // Register an internal audit logs lifecycle service\r\n        const auditLogsLifecycle = createAuditLogsLifecycleService(strapi);\r\n        strapi.add('audit-logs-lifecycle', auditLogsLifecycle);\r\n\r\n        await auditLogsLifecycle.register();\r\n      },\r\n      async destroy({ strapi }: { strapi: Core.Strapi }) {\r\n        strapi.get('audit-logs-lifecycle').destroy();\r\n        await eeAdmin.destroy({ strapi });\r\n      },\r\n    };\r\n  }\r\n\r\n  return eeAdmin;\r\n};\r\n\r\nexport default getAdminEE;\r\n","import _ from 'lodash';\r\n\r\nimport bootstrap from './bootstrap';\r\nimport register from './register';\r\nimport destroy from './destroy';\r\nimport config from './config';\r\nimport policies from './policies';\r\nimport routes from './routes';\r\nimport services from './services';\r\nimport controllers from './controllers';\r\nimport contentTypes from './content-types';\r\nimport middlewares from './middlewares';\r\nimport getEEAdmin from '../../ee/server/src';\r\n\r\n// eslint-disable-next-line import/no-mutable-exports\r\nlet admin = {\r\n  bootstrap,\r\n  register,\r\n  destroy,\r\n  config,\r\n  policies,\r\n  routes,\r\n  services,\r\n  controllers,\r\n  contentTypes,\r\n  middlewares,\r\n};\r\n\r\nconst mergeRoutes = (a: any, b: any, key: string) => {\r\n  return _.isArray(a) && _.isArray(b) && key === 'routes' ? a.concat(b) : undefined;\r\n};\r\n\r\nif (strapi.EE) {\r\n  admin = _.mergeWith({}, admin, getEEAdmin(), mergeRoutes);\r\n}\r\n\r\nexport default admin;\r\n"],"names":["getService","name","actions","user","sendDidChangeInterfaceLanguage","merge","async","map","uniq","difference","strapi","resolve","fse","join","path","extname","koaStatic","basename","authenticate","token","constants","UnauthorizedError","ForbiddenError","errors","extractToken","apiToken","isNil","differenceInHours","parseISO","ability","action","verify","auth","config","castArray","conditionProvider","actionProvider","forgotPassword","yup","_","validateYupSchema","createPolicy","policy","permissions","subject","transferToken","routes","admin","authentication","roles","webhooks","contentApi","transfer","ApplicationError","password","bcrypt","hash","email","resetPassword","SUPER_ADMIN_CODE","hasSuperAdminRole","role","pick","set","omit","curry","pipe","prop","includes","isArray","create","permission","isEmpty","has","ValidationError","sanitizeUserRoles","sanitizeUser","updateById","isLastSuperAdminUser","arrays","updatedUser","passwordValidator","findOne","exists","register","defaults","deleteById","deleteByIds","count","users","condition","conditions","remove","eq","get","roleConstants","hooksUtils","isEqual","dates","update","differenceWith","differenceBy","createMany","sanitizeConditions","LocalStrategy","toLower","isFunction","getPassportStrategies","authEventsMapper","passport","sendUpdateProjectInformation","startCron","crypto","jwt","validateYupSchemaSync","providerFactory","hooks","domain","sanitize","isScalarAttribute","getNonVisibleAttributes","getWritableAttributes","contentTypes","ID_ATTRIBUTE","DOC_ID_ATTRIBUTE","CREATED_AT_ATTRIBUTE","UPDATED_AT_ATTRIBUTE","PUBLISHED_AT_ATTRIBUTE","CREATED_BY_ATTRIBUTE","UPDATED_BY_ATTRIBUTE","COMPONENT_FIELDS","STATIC_FIELDS","traverse","isObject","cloneDeep","traverseEntity","permittedFieldsOf","some","flatMap","detectSubjectType","asSubject","schema","getOr","intersection","validate","rulesToQuery","v","isPlainObject","providers","engine","matchesProperty","contentType","propEq","pluginsHandler","settingsHandler","xor","pmap","createSectionsBuilder","contentTypesUtils","startsWith","isString","NotFoundError","SELECT_FIELDS","POPULATE_FIELDS","isValidLifespan","isNumber","assertValidLifespan","flattenTokenPermissions","getBy","getExpirationFields","regenerate","checkSaltIsDefined","list","revoke","getById","getByName","assert","hasValidTokenSalt","utils","env","fs","projectSettings","updateProjectSettings","metrics","z","validateZod","tsUtils","values","sumBy","plugins","trim","apiTokens","strings","isUndefined","validateUserCreationInput","findUserPermissions","sanitizePermission","compose","sectionsBuilder","roleCreateSchema","rolesDeleteSchema","roleDeleteSchema","validateRoleCreateInput","validateRolesDeleteInput","validateRoleDeleteInput","dataTransferStrapi","validateTransferTokenCreationInput","validateTransferTokenUpdateInput","mapKeys","punycode","isLocalhostIp","rateLimit","isRemoteTransferEnabled","executeCERegister","persistTablesWithPrefix","executeCEBootstrap","executeCEDestroy","sso","toString","toNumber","providerRegistry","assign","reverse","take","drop","persistTables","mapValues","firstname","lastname","username","auditLog","defaultEvents","scheduleJob","bootstrap","destroy","services","controllers","middlewares","getEEAdmin"],"mappings":"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"}