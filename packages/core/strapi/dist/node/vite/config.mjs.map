{"version":3,"file":"config.mjs","sources":["../../../src/node/vite/config.ts"],"sourcesContent":["import type { InlineConfig, UserConfig } from 'vite';\r\nimport browserslistToEsbuild from 'browserslist-to-esbuild';\r\nimport react from '@vitejs/plugin-react-swc';\r\n\r\nimport { getUserConfig } from '../core/config';\r\nimport { loadStrapiMonorepo } from '../core/monorepo';\r\nimport { getMonorepoAliases } from '../core/aliases';\r\nimport type { BuildContext } from '../create-build-context';\r\nimport { buildFilesPlugin } from './plugins';\r\n\r\nconst resolveBaseConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\r\n  const target = browserslistToEsbuild(ctx.target);\r\n\r\n  return {\r\n    root: ctx.cwd,\r\n    build: {\r\n      emptyOutDir: false, // Rely on CLI to do this\r\n      outDir: ctx.distDir,\r\n      target,\r\n    },\r\n    cacheDir: 'node_modules/.strapi/vite',\r\n    configFile: false,\r\n    define: {\r\n      'process.env': ctx.env,\r\n    },\r\n    envPrefix: 'STRAPI_ADMIN_',\r\n    optimizeDeps: {\r\n      include: [\r\n        // pre-bundle React dependencies to avoid React duplicates,\r\n        // even if React dependencies are not direct dependencies\r\n        // https://react.dev/warnings/invalid-hook-call-warning#duplicate-react\r\n        'react',\r\n        `react/jsx-runtime`,\r\n        'react-dom/client',\r\n        'styled-components',\r\n        'react-router-dom',\r\n      ],\r\n    },\r\n    resolve: {\r\n      // https://react.dev/warnings/invalid-hook-call-warning#duplicate-react\r\n      dedupe: ['react', 'react-dom', 'react-router-dom', 'styled-components'],\r\n    },\r\n    plugins: [react(), buildFilesPlugin(ctx)],\r\n  };\r\n};\r\n\r\nconst resolveProductionConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\r\n  const {\r\n    options: { minify, sourcemaps },\r\n  } = ctx;\r\n\r\n  const baseConfig = await resolveBaseConfig(ctx);\r\n\r\n  return {\r\n    ...baseConfig,\r\n    base: ctx.basePath,\r\n    logLevel: 'silent',\r\n    mode: 'production',\r\n    build: {\r\n      ...baseConfig.build,\r\n      assetsDir: '',\r\n      minify,\r\n      sourcemap: sourcemaps,\r\n      rollupOptions: {\r\n        input: {\r\n          strapi: ctx.entry,\r\n        },\r\n      },\r\n    },\r\n  };\r\n};\r\n\r\nconst resolveDevelopmentConfig = async (ctx: BuildContext): Promise<InlineConfig> => {\r\n  const monorepo = await loadStrapiMonorepo(ctx.cwd);\r\n  const baseConfig = await resolveBaseConfig(ctx);\r\n\r\n  return {\r\n    ...baseConfig,\r\n    mode: 'development',\r\n    resolve: {\r\n      ...baseConfig.resolve,\r\n      alias: {\r\n        ...baseConfig.resolve?.alias,\r\n        ...getMonorepoAliases({ monorepo }),\r\n      },\r\n    },\r\n    server: {\r\n      middlewareMode: true,\r\n      open: ctx.options.open,\r\n      hmr: {\r\n        server: ctx.options.hmrServer,\r\n        clientPort: ctx.options.hmrClientPort,\r\n      },\r\n    },\r\n    appType: 'custom',\r\n  };\r\n};\r\n\r\nconst USER_CONFIGS = ['vite.config.js', 'vite.config.mjs', 'vite.config.ts'];\r\n\r\ntype UserViteConfig = (config: UserConfig) => UserConfig;\r\n\r\nconst mergeConfigWithUserConfig = async (config: InlineConfig, ctx: BuildContext) => {\r\n  const userConfig = await getUserConfig<UserViteConfig>(USER_CONFIGS, ctx);\r\n\r\n  if (userConfig) {\r\n    return userConfig(config);\r\n  }\r\n\r\n  return config;\r\n};\r\n\r\nexport { mergeConfigWithUserConfig, resolveProductionConfig, resolveDevelopmentConfig };\r\n"],"names":[],"mappings":";;;;;;AAUA,MAAM,oBAAoB,OAAO,QAA6C;AACtE,QAAA,SAAS,sBAAsB,IAAI,MAAM;AAExC,SAAA;AAAA,IACL,MAAM,IAAI;AAAA,IACV,OAAO;AAAA,MACL,aAAa;AAAA;AAAA,MACb,QAAQ,IAAI;AAAA,MACZ;AAAA,IACF;AAAA,IACA,UAAU;AAAA,IACV,YAAY;AAAA,IACZ,QAAQ;AAAA,MACN,eAAe,IAAI;AAAA,IACrB;AAAA,IACA,WAAW;AAAA,IACX,cAAc;AAAA,MACZ,SAAS;AAAA;AAAA;AAAA;AAAA,QAIP;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MAAA;AAAA,IAEJ;AAAA,IACA,SAAS;AAAA;AAAA,MAEP,QAAQ,CAAC,SAAS,aAAa,oBAAoB,mBAAmB;AAAA,IACxE;AAAA,IACA,SAAS,CAAC,SAAS,iBAAiB,GAAG,CAAC;AAAA,EAC1C;AACF;AAEM,MAAA,0BAA0B,OAAO,QAA6C;AAC5E,QAAA;AAAA,IACJ,SAAS,EAAE,QAAQ,WAAW;AAAA,EAAA,IAC5B;AAEE,QAAA,aAAa,MAAM,kBAAkB,GAAG;AAEvC,SAAA;AAAA,IACL,GAAG;AAAA,IACH,MAAM,IAAI;AAAA,IACV,UAAU;AAAA,IACV,MAAM;AAAA,IACN,OAAO;AAAA,MACL,GAAG,WAAW;AAAA,MACd,WAAW;AAAA,MACX;AAAA,MACA,WAAW;AAAA,MACX,eAAe;AAAA,QACb,OAAO;AAAA,UACL,QAAQ,IAAI;AAAA,QAAA;AAAA,MACd;AAAA,IACF;AAAA,EAEJ;AACF;AAEM,MAAA,2BAA2B,OAAO,QAA6C;AACnF,QAAM,WAAW,MAAM,mBAAmB,IAAI,GAAG;AAC3C,QAAA,aAAa,MAAM,kBAAkB,GAAG;AAEvC,SAAA;AAAA,IACL,GAAG;AAAA,IACH,MAAM;AAAA,IACN,SAAS;AAAA,MACP,GAAG,WAAW;AAAA,MACd,OAAO;AAAA,QACL,GAAG,WAAW,SAAS;AAAA,QACvB,GAAG,mBAAmB,EAAE,SAAU,CAAA;AAAA,MAAA;AAAA,IAEtC;AAAA,IACA,QAAQ;AAAA,MACN,gBAAgB;AAAA,MAChB,MAAM,IAAI,QAAQ;AAAA,MAClB,KAAK;AAAA,QACH,QAAQ,IAAI,QAAQ;AAAA,QACpB,YAAY,IAAI,QAAQ;AAAA,MAAA;AAAA,IAE5B;AAAA,IACA,SAAS;AAAA,EACX;AACF;AAEA,MAAM,eAAe,CAAC,kBAAkB,mBAAmB,gBAAgB;AAIrE,MAAA,4BAA4B,OAAO,QAAsB,QAAsB;AACnF,QAAM,aAAa,MAAM,cAA8B,cAAc,GAAG;AAExE,MAAI,YAAY;AACd,WAAO,WAAW,MAAM;AAAA,EAAA;AAGnB,SAAA;AACT;"}